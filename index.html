<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Studio Smart - AI Enhanced Pro</title>
    <style>
        :root {
            --primary-color: #8b5cf6;
            --primary-dark: #7c3aed;
            --primary-light: #a78bfa;
            --secondary-color: #06d6a0;
            --secondary-dark: #05c296;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #10b981;
            
            /* Dark theme colors */
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1b3a;
            --bg-tertiary: #2d2f4f;
            --bg-card: #1e1f3f;
            --bg-hover: #252647;
            
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --text-accent: #f1f5f9;
            
            --border-color: #374151;
            --border-light: #4b5563;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            
            --glow-primary: 0 0 20px rgba(139, 92, 246, 0.3);
            --glow-secondary: 0 0 20px rgba(6, 214, 160, 0.3);
            --glow-accent: 0 0 20px rgba(245, 158, 11, 0.3);

            /* Colori per heatmap */
            --heatmap-empty: #374151;
            --heatmap-low: #ef4444;
            --heatmap-medium: #f59e0b;
            --heatmap-high: #10b981;
            --heatmap-very-high: #22c55e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animazioni */
        .section {
            display: none;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: sectionSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes sectionSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(50px) scale(0.95);
                filter: blur(5px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            transform: translateY(0);
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-light);
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(6, 214, 160, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        /* Container Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            background-size: 200% 200%;
            animation: gradientShift 6s ease infinite;
            color: white;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 8s infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(30deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(30deg); }
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, #fff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            overflow-x: auto;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        .nav-tab {
            flex: 1;
            min-width: 140px;
            padding: 16px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--glow-primary), var(--shadow);
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .card h3 {
            color: var(--primary-light);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .required {
            color: var(--danger-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--glow-primary);
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }

        /* Buttons */
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: all 0.3s;
            transform: translate(-50%, -50%);
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--glow-primary), var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: var(--glow-secondary), var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* TODAY SECTION STYLES */
        .oggi-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
            color: var(--text-primary);
            box-shadow: var(--shadow-xl);
            border: 2px solid var(--primary-color);
        }

        .oggi-card::before {
            background: var(--primary-color);
        }

        .oggi-card h3 {
            color: var(--primary-light) !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .prossimo-task {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-light);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .task-corrente {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .materia-nome {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .tempo-stimato {
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: var(--shadow);
        }

        .task-descrizione {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .task-motivazione {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--text-primary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-color);
        }

        .task-options {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .task-options h5 {
            color: var(--primary-light);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .task-option-btn {
            width: 100%;
            margin-bottom: 0.75rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .task-option-btn:hover {
            border-color: var(--primary-color);
            background: var(--bg-hover);
            transform: translateX(8px);
        }

        .task-option-btn.selected {
            border-color: var(--primary-color);
            background: rgba(139, 92, 246, 0.1);
            box-shadow: var(--glow-primary);
        }

        .timeline-oggi {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .timeline-time {
            font-weight: 700;
            min-width: 80px;
            color: var(--accent-color);
            font-size: 1rem;
        }

        .timeline-content {
            flex: 1;
            margin-left: 1rem;
            color: var(--text-primary);
        }

        /* RECOVERY DASHBOARD */
        .recovery-dashboard {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .missed-time {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .highlight {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-weight: 700;
        }

        .recovery-plan {
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        /* MICRO TASKS */
        .micro-tasks {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .micro-task-item {
            background: rgba(16, 185, 129, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .micro-task-item:hover {
            background: rgba(16, 185, 129, 0.15);
            transform: translateX(8px);
        }

        .micro-task-duration {
            font-size: 0.8rem;
            color: var(--secondary-color);
            font-weight: 600;
        }

        /* SLOT TEMPORALI STYLES */
        .weekly-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .day-slots {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .day-slots h4 {
            color: var(--primary-light);
            margin-bottom: 1rem;
            text-align: center;
        }

        .time-slots {
            space-y: 1rem;
        }

        .slot-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .slot-item input[type="time"] {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            width: auto;
            min-width: 100px;
        }

        .add-slot {
            width: 100%;
            padding: 0.75rem;
            border: 2px dashed var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .add-slot:hover {
            border-color: var(--primary-color);
            color: var(--primary-light);
            background: rgba(139, 92, 246, 0.1);
        }

        .remove-slot {
            background: var(--danger-color);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .remove-slot:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 6px;
            margin-top: 0.5rem;
        }

        .star {
            font-size: 1.8rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 3px rgba(0,0,0,0.3));
        }

        .star:hover {
            transform: scale(1.2);
        }

        .star.active {
            color: #fbbf24;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.5));
        }

        /* Subject Items */
        .subject-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .subject-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
        }

        .subject-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-light);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .subject-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-light);
        }

        .subject-actions {
            display: flex;
            gap: 0.75rem;
        }

        .subject-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        /* Priority Badges */
        .priority-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-alta { 
            background: rgba(239, 68, 68, 0.2); 
            color: #fca5a5; 
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .priority-media { 
            background: rgba(245, 158, 11, 0.2); 
            color: #fcd34d; 
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .priority-bassa { 
            background: rgba(16, 185, 129, 0.2); 
            color: #6ee7b7; 
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Timer */
        .timer-container {
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .timer-display {
            font-size: 5rem;
            font-weight: 800;
            color: var(--primary-light);
            margin: 3rem 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
            transition: all 0.3s ease;
        }

        .timer-display.break-mode {
            color: var(--secondary-color);
            text-shadow: 0 0 30px rgba(6, 214, 160, 0.5);
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 3rem;
            flex-wrap: wrap;
        }

        .timer-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 3rem;
        }

        .preset-btn {
            padding: 1rem;
            border: 2px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
        }

        .preset-btn:hover {
            border-color: var(--primary-color);
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .preset-btn.active {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--glow-primary);
        }

        /* Daily Goal Settings */
        .daily-goal-settings {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .daily-goal-settings h4 {
            color: var(--primary-light);
            margin-bottom: 1rem;
        }

        .goal-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .goal-input {
            width: 100px;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 600;
            text-align: center;
        }

        .goal-input:focus {
            border-color: var(--primary-color);
            box-shadow: var(--glow-primary);
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        /* Streak */
        .streak-card {
            background: linear-gradient(135deg, var(--accent-color), #d97706);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }

        @keyframes pulseGlow {
            from { box-shadow: var(--shadow-lg); }
            to { box-shadow: 0 0 30px rgba(245, 158, 11, 0.4), var(--shadow-lg); }
        }

        .streak-number {
            font-size: 4rem;
            font-weight: 800;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            animation: modalEnter 0.3s ease;
        }

        @keyframes modalEnter {
            from { 
                opacity: 0; 
                transform: scale(0.8) translateY(50px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        .modal h3 {
            color: var(--primary-light);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Rating Modal Post-Sessione */
        .rating-modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 3rem 2rem;
            max-width: 450px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            text-align: center;
            animation: ratingModalEnter 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes ratingModalEnter {
            from { 
                opacity: 0; 
                transform: scale(0.5) translateY(100px) rotate(-10deg);
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0) rotate(0deg);
            }
        }

        .rating-modal h3 {
            color: var(--primary-light);
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .rating-modal p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 2.5rem;
            line-height: 1.5;
        }

        .rating-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .rating-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            padding: 2rem 1rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .rating-btn:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: var(--shadow-xl);
        }

        .rating-btn.sleepy:hover {
            border-color: #6b7280;
            background: rgba(107, 114, 128, 0.1);
            box-shadow: 0 0 20px rgba(107, 114, 128, 0.3);
        }

        .rating-btn.neutral:hover {
            border-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }

        .rating-btn.good:hover {
            border-color: var(--secondary-color);
            background: rgba(6, 214, 160, 0.1);
            box-shadow: 0 0 20px rgba(6, 214, 160, 0.3);
        }

        .rating-btn.excellent:hover {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .rating-emoji {
            font-size: 3.5rem;
            transition: all 0.3s ease;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .rating-btn:hover .rating-emoji {
            transform: scale(1.2) rotate(5deg);
        }

        .rating-label {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .rating-btn.sleepy .rating-label { color: #9ca3af; }
        .rating-btn.neutral .rating-label { color: var(--warning-color); }
        .rating-btn.good .rating-label { color: var(--secondary-color); }
        .rating-btn.excellent .rating-label { color: var(--success-color); }

        /* Session List Styles */
        .session-list {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .session-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .session-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-light);
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .session-time {
            font-weight: 700;
            color: var(--primary-light);
            font-size: 1.1rem;
        }

        .session-materia {
            color: var(--secondary-color);
            font-weight: 600;
        }

        .session-note {
            color: var(--text-secondary);
            font-style: italic;
            margin-left: 0.5rem;
        }

        .session-rating {
            display: flex;
            gap: 2px;
        }

        .session-rating .star {
            font-size: 1rem;
            color: #fbbf24;
        }

        .session-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.5rem;
            font-size: 0.8rem;
            min-width: auto;
        }

        /* Heatmap 24 ore */
        .hourly-heatmap {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 1.5rem;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            min-height: 50px;
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: var(--shadow-lg);
        }

        .heatmap-cell.empty {
            background: var(--heatmap-empty);
            color: var(--text-muted);
        }

        .heatmap-cell.low {
            background: var(--heatmap-low);
            color: white;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }

        .heatmap-cell.medium {
            background: var(--heatmap-medium);
            color: white;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }

        .heatmap-cell.high {
            background: var(--heatmap-high);
            color: white;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }

        .heatmap-cell.very-high {
            background: var(--heatmap-very-high);
            color: white;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
            animation: pulseHeat 2s ease-in-out infinite alternate;
        }

        @keyframes pulseHeat {
            from { box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
            to { box-shadow: 0 0 25px rgba(34, 197, 94, 0.6); }
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Top Hours Section */
        .top-hours-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .top-hours-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .top-hour-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .top-hour-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--success-color), var(--secondary-color));
        }

        .top-hour-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--success-color);
        }

        .top-hour-rank {
            font-size: 2rem;
            font-weight: 800;
            color: var(--success-color);
            margin-bottom: 0.5rem;
        }

        .top-hour-time {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 0.5rem;
        }

        .top-hour-rating {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .productivity-suggestion {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            border-left: 4px solid var(--primary-color);
        }

        .productivity-suggestion h4 {
            color: var(--primary-light);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .productivity-suggestion p {
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Tooltip per heatmap */
        .tooltip {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-primary);
            box-shadow: var(--shadow-lg);
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Focus Mode */
        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .focus-content {
            text-align: center;
            animation: focusEnter 0.5s ease;
        }

        .focus-timer {
            font-size: 8rem;
            font-weight: 800;
            margin: 3rem 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            text-shadow: 0 0 50px rgba(139, 92, 246, 0.8);
        }

        .close-focus {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            padding: 1rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .close-focus:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        @keyframes focusEnter {
            from { 
                opacity: 0; 
                transform: scale(0.8) translateY(50px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        /* Calendario Styles */
        .calendar-container {
            width: 100%;
            max-width: 100%;
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-day-header {
            padding: 1rem 0.5rem;
            text-align: center;
            font-weight: 600;
            color: var(--primary-light);
            font-size: 0.9rem;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-color);
        }

        .calendar-day-header:last-child {
            border-right: none;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg-card);
        }

        .calendar-day {
            min-height: 120px;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day:hover {
            background: var(--bg-hover);
            transform: scale(1.02);
            z-index: 10;
            box-shadow: var(--shadow-lg);
        }

        .calendar-day.other-month {
            background: var(--bg-secondary);
            opacity: 0.5;
        }

        .calendar-day.today {
            background: var(--bg-card);
            border: 2px solid var(--accent-color);
            font-weight: 700;
        }

        .calendar-day.has-sessions {
            background: rgba(139, 92, 246, 0.1);
            border-left: 4px solid var(--primary-color);
        }

        .calendar-day.has-scheduled {
            background: rgba(6, 214, 160, 0.1);
            border-left: 4px solid var(--secondary-color);
        }

        .calendar-day-number {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .calendar-sessions {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .calendar-session-dot {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            margin-bottom: 2px;
        }

        .session-completed {
            background: var(--primary-color);
        }

        .session-scheduled {
            background: var(--secondary-color);
        }

        .session-manual {
            background: var(--warning-color);
        }

        .calendar-session-count {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: auto;
        }

        /* Modal Aggiungi Sessione */
        .add-session-modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .add-session-modal h3 {
            color: var(--primary-light);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* Day Detail Modal */
        .day-detail-modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 95%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .day-sessions-grid {
            display: grid;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .day-session-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .day-session-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-light);
        }

        .session-details {
            flex: 1;
        }

        .session-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-light);
            margin-bottom: 0.25rem;
        }

        .session-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                padding: 2rem 1rem;
            }

            .header h1 {
                font-size: 2.5rem;
            }

            .timer-display {
                font-size: 4rem;
            }

            .focus-timer {
                font-size: 6rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .subject-info {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                padding: 6px;
            }

            .nav-tab {
                padding: 12px 16px;
                min-width: 100px;
                font-size: 0.9rem;
            }

            .card {
                padding: 1.5rem;
            }

            .timer-controls {
                flex-direction: column;
                align-items: center;
            }

            .modal-buttons {
                flex-direction: column;
            }

            .streak-number {
                font-size: 3rem;
            }

            .weekly-slots {
                grid-template-columns: 1fr;
            }

            .task-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .heatmap-grid {
                grid-template-columns: repeat(6, 1fr);
            }

            .rating-buttons {
                grid-template-columns: 1fr;
            }

            .rating-btn {
                padding: 1.5rem 1rem;
            }

            .rating-emoji {
                font-size: 2.5rem;
            }

            .calendar-day {
                min-height: 80px;
                padding: 0.25rem;
            }

            .calendar-day-number {
                font-size: 0.9rem;
            }

            .calendar-day-header {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }

            .calendar-session-count {
                font-size: 0.6rem;
            }

            .session-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        /* ESAMI STYLES */
        .media-laurea-card {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }

        .media-display {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 2rem;
            align-items: center;
        }

        .media-number {
            font-size: 4rem;
            font-weight: 800;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .media-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .esame-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .esame-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--success-color), var(--secondary-color));
        }

        .esame-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-light);
        }

        .esame-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .esame-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-light);
        }

        .esame-voto {
            font-size: 2rem;
            font-weight: 800;
            color: var(--success-color);
        }

        .esame-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .voto-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .voto-18-21 { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .voto-22-24 { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        .voto-25-27 { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        .voto-28-30 { background: rgba(34, 197, 94, 0.2); color: #86efac; }
        .voto-lode { background: rgba(255, 215, 0, 0.2); color: #ffd700; }

        /* PROCRASTINATION ALERT */
        .procrastination-alert {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            animation: procrastinationPulse 1s ease-in-out infinite alternate;
        }

        @keyframes procrastinationPulse {
            from { box-shadow: var(--shadow-lg); }
            to { box-shadow: 0 0 30px rgba(239, 68, 68, 0.4), var(--shadow-lg); }
        }

        /* PERFORMANCE OPTIMIZATION INDICATOR */
        .optimization-indicator {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0.5rem 0;
            font-size: 0.9rem;
            color: var(--primary-light);
        }

        .google-calendar-event {
            background: var(--success-color);
            border-radius: 2px;
            height: 3px;
            margin-bottom: 1px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1> Piano Studio Smart AI Pro</h1>
            <p>Il tuo assistente intelligente anti-procrastinazione personalizzato</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" id="nav-oggi"> Oggi</button>
            <button class="nav-tab" id="nav-materie"> Materie</button>
            <button class="nav-tab" id="nav-piano"> Piano Studio</button>
            <button class="nav-tab" id="nav-pomodoro"> Pomodoro</button>
            <button class="nav-tab" id="nav-calendario"> Calendario</button>
            <button class="nav-tab" id="nav-esami"> Esami</button>
            <button class="nav-tab" id="nav-statistiche"> Statistiche</button>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sezione OGGI -->
            <section id="oggi" class="section active">
                <!-- Recovery Dashboard -->
                <div class="recovery-dashboard" id="recoveryDashboard" style="display: none;">
                    <h4> Stato Recupero</h4>
                    <div class="missed-time">Tempo da recuperare: <span class="highlight" id="missedTime">0h 0min</span></div>
                    <div class="recovery-plan" id="recoveryPlan">Piano: Distribuzione automatica attiva</div>
                    <button class="btn btn-warning" onclick="showRecoveryOptions()"> Modifica Piano</button>
                </div>

                <div class="card oggi-card">
                    <h3> Il Tuo Piano di Oggi</h3>
                    
                    <div class="prossimo-task">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;"> PROSSIMO TASK:</h4>
                        <div class="task-corrente" id="taskCorrente">
                            <div class="task-header">
                                <span class="materia-nome" id="currentTaskMateria">Nessun task programmato</span>
                                <span class="tempo-stimato" id="currentTaskTime"> -- min</span>
                            </div>
                            <div class="task-descrizione" id="currentTaskDesc">
                                Aggiungi delle materie per iniziare a studiare in modo intelligente!
                            </div>
                            <div class="task-motivazione" id="currentTaskMotivation">
                                 Il sistema pianificher automaticamente le tue sessioni di studio
                            </div>

                            <div class="task-options" id="taskOptions" style="display: none;">
                                <h5> Cosa vuoi fare specificamente?</h5>
                                <div id="taskOptionsList"></div>
                            </div>

                            <button class="btn btn-primary" onclick="iniziaTask()" id="startTaskBtn" disabled> Inizia Subito</button>
                        </div>
                    </div>

                    <!-- Micro Tasks per Anti-Procrastinazione -->
                    <div class="micro-tasks" id="microTasks" style="display: none;">
                        <h4 style="color: var(--secondary-color); margin-bottom: 1rem;"> Task Micro (Anti-Procrastinazione)</h4>
                        <p style="opacity: 0.8; margin-bottom: 1rem;">Inizia con qualcosa di facile per creare momentum:</p>
                        <div id="microTasksList"></div>
                    </div>

                    <div class="programma-giornata">
                        <h4 style="color: var(--primary-light);"> Programma Completo di Oggi:</h4>
                        <div class="timeline-oggi" id="timelineOggi">
                            <div class="empty-state">
                                <div class="empty-state-icon"></div>
                                <p>Aggiungi materie con slot temporali per vedere il piano giornaliero</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Materie -->
            <section id="materie" class="section">
                <!-- Study Streak Card -->
                <div class="streak-card">
                    <h3 style="margin-bottom: 1rem; color: white;"> Studio Streak</h3>
                    <div class="streak-number" id="streakNumber">0</div>
                    <p style="font-size: 1.1rem; opacity: 0.9;">giorni consecutivi</p>
                </div>

                <div class="card">
                    <h3> Aggiungi Nuova Materia</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomeMateria">Nome Materia <span class="required">*</span></label>
                            <input type="text" id="nomeMateria" required placeholder="Es. Analisi Matematica I">
                        </div>
                        <div class="form-group">
                            <label for="cfu">CFU <span class="required">*</span></label>
                            <input type="number" id="cfu" min="1" max="30" required placeholder="Es. 9">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pagine">Pagine Totali <span class="required">*</span></label>
                            <input type="number" id="pagine" min="1" required placeholder="Es. 450">
                        </div>
                        <div class="form-group">
                            <label for="pagineStudiate">Pagine gi Studiate</label>
                            <input type="number" id="pagineStudiate" min="0" value="0" placeholder="Es. 120">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pagineOra">Pagine per Ora</label>
                            <input type="number" id="pagineOra" min="1" max="50" value="8" placeholder="Es. 8">
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">Quante pagine riesci a studiare in 1 ora per questa materia</small>
                        </div>
                        <div class="form-group">
                            <label for="eserciziTotali">Esercizi Totali</label>
                            <input type="number" id="eserciziTotali" min="0" value="0" placeholder="Es. 150">
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">Numero totale di esercizi da completare (opzionale)</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="eserciziCompletati">Esercizi Completati</label>
                            <input type="number" id="eserciziCompletati" min="0" value="0" placeholder="Es. 45">
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">Esercizi gi completati</small>
                        </div>
                        <div class="form-group">
                            <label for="dataEsame">Data Esame</label>
                            <input type="date" id="dataEsame">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="priorita">Priorit</label>
                            <select id="priorita">
                                <option value="alta">Alta</option>
                                <option value="media" selected>Media</option>
                                <option value="bassa">Bassa</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Difficolt Percepita</label>
                            <div class="star-rating" id="difficolta">
                                <span class="star" data-rating="1"></span>
                                <span class="star" data-rating="2"></span>
                                <span class="star" data-rating="3"></span>
                                <span class="star" data-rating="4"></span>
                                <span class="star" data-rating="5"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Sistema Slot Temporali -->
                    <div class="form-group">
                        <label> Slot Temporali Settimanali</label>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Definisci gli slot orari specifici in cui puoi studiare questa materia durante la settimana
                        </p>
                        <div class="weekly-slots" id="weeklySlots">
                            <!-- Slot per ogni giorno generati dinamicamente -->
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="addMateria()"> Aggiungi Materia</button>
                </div>

                <div class="card">
                    <h3> Le Tue Materie</h3>
                    <div id="materieList">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessuna materia aggiunta ancora.</p>
                            <p>Inizia aggiungendo la tua prima materia!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Piano Studio -->
            <section id="piano" class="section">
                <div class="card">
                    <h3> Piano di Studio Intelligente</h3>
                    <div id="aiInsights" style="margin-bottom: 2rem;"></div>
                    <div id="pianoStudio">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Aggiungi delle materie per generare il tuo piano di studio personalizzato!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Pomodoro -->
            <section id="pomodoro" class="section">
                <!-- Impostazioni Obiettivo Giornaliero -->
                <div class="daily-goal-settings">
                    <h4> Obiettivo Giornaliero Personalizzato</h4>
                    <div class="goal-input-group">
                        <label for="dailyGoal" style="margin: 0; color: var(--text-primary);">Pomodori da completare oggi:</label>
                        <input type="number" id="dailyGoal" class="goal-input" min="1" max="20" value="8" onchange="updateDailyGoal()">
                        <span style="color: var(--text-secondary);">sessioni</span>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Personalizza il tuo obiettivo giornaliero in base al tempo che hai disponibile
                    </p>
                </div>

                <div class="card">
                    <div class="timer-container">
                        <h3> Timer Pomodoro</h3>
                        
                        <div class="timer-presets">
                            <button class="preset-btn active" onclick="setPreset(25, 5, this)">25/5 min</button>
                            <button class="preset-btn" onclick="setPreset(50, 10, this)">50/10 min</button>
                            <button class="preset-btn" onclick="setPreset(90, 20, this)">90/20 min</button>
                            <button class="preset-btn" onclick="showCustomTimerDialog()">Personalizza</button>
                        </div>

                        <div class="timer-display" id="timerDisplay">25:00</div>

                        <div class="timer-controls">
                            <button class="btn btn-primary" id="startBtn" onclick="startTimer()"> Inizia</button>
                            <button class="btn btn-warning" id="pauseBtn" onclick="pauseTimer()" style="display: none;"> Pausa</button>
                            <button class="btn btn-danger" onclick="resetTimer()"> Reset</button>
                            <button class="btn btn-secondary" onclick="toggleFocusMode()"> Focus</button>
                        </div>

                        <div class="form-group">
                            <p><strong>Sessioni completate oggi:</strong> <span id="sessionCount">0</span> / <span id="sessionGoal">8</span></p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="sessionProgress" style="width: 0%"></div>
                            </div>
                            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;" id="progressText">Inizia la tua prima sessione!</small>
                        </div>
                    </div>
                </div>

                <!-- Lista Sessioni di Oggi -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0;"> Sessioni di Oggi</h3>
                        <button class="btn btn-danger btn-small" onclick="showDeleteAllTodaySessionsModal()"> Elimina tutte</button>
                    </div>
                    
                    <div id="todaySessionsList" class="session-list">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessuna sessione completata oggi.</p>
                            <p>Avvia una sessione per iniziare!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Calendario -->
            <section id="calendario" class="section">
                <!-- Controlli Calendario -->
                <div class="card">
                    <h3> Navigazione Calendario</h3>
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button class="btn btn-secondary" onclick="changeMonth(-1)" style="padding: 0.75rem 1rem;"> Precedente</button>
                            <h4 id="currentMonthYear" style="margin: 0; color: var(--primary-light); min-width: 200px; text-align: center;">Gennaio 2024</h4>
                            <button class="btn btn-secondary" onclick="changeMonth(1)" style="padding: 0.75rem 1rem;">Successivo </button>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="goToToday()" style="padding: 0.75rem 1rem;"> Oggi</button>
                            <button class="btn btn-warning" onclick="addManualSession()" style="padding: 0.75rem 1rem;"> Aggiungi Sessione</button>
                            <button class="btn btn-secondary" onclick="syncGoogleCalendar()" style="padding: 0.75rem 1rem;"> Sync Google Calendar</button>
                        </div>
                    </div>
                </div>

                <!-- Alert Procrastinazione -->
                <div class="procrastination-alert" id="procrastinationAlert" style="display: none;">
                    <h4> Alert Procrastinazione</h4>
                    <div id="procrastinationContent"></div>
                    <button class="btn btn-primary" onclick="dismissProcrastinationAlert()">Ho capito, studio ora!</button>
                </div>

                <!-- Legenda -->
                <div class="card" style="padding: 1rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 2rem; align-items: center; justify-content: center;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 20px; height: 20px; background: var(--primary-color); border-radius: 4px;"></div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Sessioni completate</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 20px; height: 20px; background: var(--secondary-color); border-radius: 4px;"></div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Slot programmati</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 20px; height: 20px; background: var(--warning-color); border-radius: 4px;"></div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Sessioni manuali</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 20px; height: 20px; background: var(--accent-color); border: 2px solid var(--text-primary); border-radius: 4px;"></div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Oggi</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 20px; height: 20px; background: var(--success-color); border-radius: 4px;"></div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Eventi Google Calendar</span>
                        </div>
                    </div>
                </div>

                <!-- Calendario Principale -->
                <div class="card">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-day-header">Lun</div>
                            <div class="calendar-day-header">Mar</div>
                            <div class="calendar-day-header">Mer</div>
                            <div class="calendar-day-header">Gio</div>
                            <div class="calendar-day-header">Ven</div>
                            <div class="calendar-day-header">Sab</div>
                            <div class="calendar-day-header">Dom</div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Giorni generati dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Statistiche Mensili -->
                <div class="card">
                    <h3> Statistiche del Mese</h3>
                    <div class="form-row">
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-light);" id="monthSessions">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Sessioni Totali</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--secondary-color);" id="monthHours">0h</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Ore di Studio</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 20px; height: 20px; background: var(--warning-color); border-radius: 4px;"></div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Giorni Attivi</span>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-color);" id="monthAverage">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Media Sessioni/Giorno</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Esami -->
            <section id="esami" class="section">
                <!-- Media Laurea Card -->
                <div class="media-laurea-card">
                    <h3 style="margin-bottom: 1rem; color: white;"> Media di Laurea</h3>
                    <div class="media-display">
                        <div class="media-number" id="mediaLaurea">0.00</div>
                        <div class="media-info">
                            <div>Media Ponderata: <span id="mediaPonderata">0.00</span></div>
                            <div>CFU Totali: <span id="cfuCompletati">0</span></div>
                            <div>Esami Sostenuti: <span id="esamiSostenuti">0</span></div>
                        </div>
                    </div>
                </div>

                <!-- Aggiungi Nuovo Esame -->
                <div class="card">
                    <h3> Aggiungi Esame Sostenuto</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomeEsame">Nome Esame <span class="required">*</span></label>
                            <select id="nomeEsame" onchange="loadMateriaData()">
                                <option value="">Seleziona una materia esistente</option>
                                <option value="custom">Esame personalizzato</option>
                            </select>
                        </div>
                        <div class="form-group" id="customEsameGroup" style="display: none;">
                            <label for="customEsameName">Nome Esame Personalizzato</label>
                            <input type="text" id="customEsameName" placeholder="Es. Tirocinio">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="votoEsame">Voto <span class="required">*</span></label>
                            <input type="number" id="votoEsame" min="18" max="30" required placeholder="Es. 28">
                        </div>
                        <div class="form-group">
                            <label for="lodeEsame">Lode</label>
                            <input type="checkbox" id="lodeEsame" style="width: auto; margin-top: 0.5rem;">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cfuEsame">CFU <span class="required">*</span></label>
                            <input type="number" id="cfuEsame" min="1" max="30" required placeholder="Es. 9">
                        </div>
                        <div class="form-group">
                            <label for="dataEsameVoto">Data Esame</label>
                            <input type="date" id="dataEsameVoto">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="noteEsame">Note (opzionale)</label>
                        <textarea id="noteEsame" placeholder="Es. Professore molto esigente, domande su tutto il programma..."></textarea>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="addEsame()"> Aggiungi Esame</button>
                </div>

                <!-- Lista Esami -->
                <div class="card">
                    <h3> I Tuoi Esami</h3>
                    <div id="esamiList">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessun esame sostenuto ancora.</p>
                            <p>Aggiungi il tuo primo esame per iniziare a calcolare la media!</p>
                        </div>
                    </div>
                </div>

                <!-- Proiezioni Laurea -->
                <div class="card" id="proiezioniCard" style="display: none;">
                    <h3> Proiezioni Laurea</h3>
                    <div class="form-row">
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-light);">Voto Base</div>
                            <div style="font-size: 2rem; color: var(--secondary-color);" id="votoBase">0</div>
                            <small style="color: var(--text-secondary);">Media * 11 / 3</small>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-light);">Con Tesi (max +7)</div>
                            <div style="font-size: 2rem; color: var(--warning-color);" id="votoConTesi">0</div>
                            <small style="color: var(--text-secondary);">Ipotesi tesi eccellente</small>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-light);">110 e Lode</div>
                            <div style="font-size: 1.5rem; color: var(--accent-color);" id="needFor110">Media necessaria</div>
                            <div style="font-size: 2rem; color: var(--success-color);" id="mediaFor110">0.00</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Statistiche -->
            <section id="statistiche" class="section">
                <div class="card">
                    <h3> Statistiche e Progressi</h3>
                    <div id="statisticheContent">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessuna statistica disponibile.</p>
                            <p>Aggiungi delle materie per vedere i tuoi progressi!</p>
                        </div>
                    </div>
                </div>

                <!-- Sezione Produttivit -->
                <div class="card">
                    <h3> La Tua Produttivit</h3>
                    
                    <!-- Heatmap 24 ore -->
                    <div class="hourly-heatmap">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;"> Heatmap Oraria della Produttivit</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Visualizza i tuoi momenti pi produttivi durante la giornata
                        </p>
                        <div class="heatmap-grid" id="heatmapGrid">
                            <!-- Celle generate dinamicamente per ogni ora (0-23) -->
                        </div>
                        <div class="heatmap-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-empty);"></div>
                                <span>Nessun dato</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-low);"></div>
                                <span>Bassa</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-medium);"></div>
                                <span>Media</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-high);"></div>
                                <span>Alta</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-very-high);"></div>
                                <span>Eccellente</span>
                            </div>
                        </div>
                    </div>

                    <!-- Top 3 Ore Migliori -->
                    <div class="top-hours-section">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;"> Le Tue Top 3 Ore Migliori</h4>
                        <div class="top-hours-grid" id="topHoursGrid">
                            <!-- Top ore generate dinamicamente -->
                        </div>
                        
                        <!-- Suggerimento AI -->
                        <div class="productivity-suggestion" id="productivitySuggestion">
                            <h4> Suggerimento Smart</h4>
                            <p>Aggiungi delle sessioni di studio per scoprire i tuoi momenti pi produttivi!</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Focus Mode Overlay -->
    <div class="focus-mode" id="focusMode">
        <button class="close-focus" onclick="toggleFocusMode()"></button>
        <div class="focus-content">
            <h2 style="font-size: 2rem; margin-bottom: 1rem;"> Modalit Focus</h2>
            <div class="focus-timer" id="focusTimer">25:00</div>
            <p style="font-size: 1.2rem; opacity: 0.8;">Resta concentrato! Stai facendo un ottimo lavoro.</p>
        </div>
    </div>

    <!-- Modal Rating Post-Sessione con Note -->
    <div class="modal-overlay" id="ratingModal">
        <div class="rating-modal">
            <h3> Sessione Completata!</h3>
            <p>Come ti senti dopo questa sessione di studio?<br>La tua valutazione ci aiuta a ottimizzare i tuoi orari migliori.</p>
            
            <div class="form-group">
                <label for="sessionNote"> Note sulla sessione (opzionale):</label>
                <input type="text" id="sessionNote" placeholder="Es. Ho studiato il capitolo 3..." style="margin-bottom: 1rem;">
            </div>
            
            <div class="rating-buttons">
                <div class="rating-btn sleepy" onclick="submitRating(1)">
                    <div class="rating-emoji"></div>
                    <div class="rating-label">Stanco</div>
                </div>
                <div class="rating-btn neutral" onclick="submitRating(2)">
                    <div class="rating-emoji"></div>
                    <div class="rating-label">Normale</div>
                </div>
                <div class="rating-btn good" onclick="submitRating(3)">
                    <div class="rating-emoji"></div>
                    <div class="rating-label">Bene</div>
                </div>
                <div class="rating-btn excellent" onclick="submitRating(4)">
                    <div class="rating-emoji"></div>
                    <div class="rating-label">Eccellente</div>
                </div>
            </div>
            
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 1rem;">
                Clicca per salvare automaticamente
            </p>
        </div>
    </div>

    <!-- Modal per Timer Personalizzato -->
    <div class="modal-overlay" id="customTimerModal">
        <div class="modal">
            <h3> Personalizza Timer</h3>
            <div class="form-group">
                <label for="customWorkTime">Minuti di Lavoro (1-180):</label>
                <input type="number" id="customWorkTime" min="1" max="180" value="25">
            </div>
            <div class="form-group">
                <label for="customBreakTime">Minuti di Pausa (1-60):</label>
                <input type="number" id="customBreakTime" min="1" max="60" value="5">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="applyCustomTimer()"> Applica</button>
                <button class="btn btn-secondary" onclick="closeCustomTimerModal()"> Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per Aggiungere Sessione Manuale -->
    <div class="modal-overlay" id="addSessionModal">
        <div class="add-session-modal">
            <h3> Aggiungi Sessione Studio</h3>
            <div class="form-group">
                <label for="sessionDate">Data:</label>
                <input type="date" id="sessionDate">
            </div>
            <div class="form-group">
                <label for="sessionMateria">Materia (opzionale):</label>
                <select id="sessionMateria">
                    <option value="">Sessione generica</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sessionDuration">Durata (minuti):</label>
                <input type="number" id="sessionDuration" min="5" max="300" value="25">
            </div>
            <div class="form-group">
                <label for="manualSessionNote">Note (opzionale):</label>
                <input type="text" id="manualSessionNote" placeholder="Es. Ripasso capitolo 3">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveManualSession()"> Aggiungi</button>
                <button class="btn btn-secondary" onclick="closeAddSessionModal()"> Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per Visualizzare Giorno Specifico -->
    <div class="modal-overlay" id="dayDetailModal">
        <div class="day-detail-modal">
            <h3 id="dayDetailTitle"> Dettagli Giorno</h3>
            <div id="dayDetailContent">
                <!-- Contenuto generato dinamicamente -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeDayDetailModal()"> Chiudi</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="recoveryModal">
        <div class="modal">
            <h3> Opzioni Recupero</h3>
            <div class="form-group">
                <label>Strategia di Recupero:</label>
                <select id="recoveryStrategy">
                    <option value="graduale">Graduale (distribuisci su 7 giorni)</option>
                    <option value="intensivo">Intensivo (recupera in 2-3 giorni)</option>
                    <option value="weekend">Weekend (solo sabato e domenica)</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="applyRecoveryStrategy()"> Applica</button>
                <button class="btn btn-secondary" onclick="closeRecoveryModal()"> Annulla</button>
            </div>
        </div>
    </div>

    <!-- Tooltip per heatmap -->
    <div class="tooltip" id="heatmapTooltip"></div>

    <script>
        // === UTILITY FUNZIONI PER GESTIONE DATE LOCALI (TIMEZONE NAPOLI) ===
        function getLocalDate(date = new Date()) {
            // Crea sempre date in timezone locale (Italia/Napoli)
            return new Date(date.getFullYear(), date.getMonth(), date.getDate());
        }

        function getLocalDateKey(date = new Date()) {
            // Restituisce YYYY-MM-DD in timezone locale
            const localDate = getLocalDate(date);
            const year = localDate.getFullYear();
            const month = String(localDate.getMonth() + 1).padStart(2, '0');
            const day = String(localDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getTodayKey() {
            // Sempre data di oggi in timezone locale
            return getLocalDateKey(new Date());
        }

        // === STATO GLOBALE APPLICAZIONE ===
        let materie = JSON.parse(localStorage.getItem('materie')) || [];
        let currentCalendarDate = new Date();
        let calendarSessions = JSON.parse(localStorage.getItem('calendarSessions')) || {};
        let sessionRatings = JSON.parse(localStorage.getItem('sessionRatings')) || {};
        let difficoltaSelezionata = 3;
        let timerInterval = null;
        let selectedTaskOption = null;
        let currentSessionStartTime = null;
        let currentSessionData = null;

        // Task micro universali anti-procrastinazione
        const universalMicroTasks = [
            { text: " Leggi il sommario del primo capitolo", durata: 5 },
            { text: " Scrivi 3 concetti che gi conosci dell'argomento", durata: 3 },
            { text: " Prepara il materiale di studio sulla scrivania", durata: 2 },
            { text: " Definisci 1 obiettivo specifico per oggi", durata: 2 },
            { text: " Controlla il tuo progresso attuale", durata: 3 },
            { text: " Cerca 1 video introduttivo sull'argomento", durata: 5 },
            { text: " Crea una lista di 3 domande da fare", durata: 4 },
            { text: " Fai 10 respiri profondi per concentrarti", durata: 1 }
        ];
        
        let timerState = {
            minutes: 25,
            seconds: 0,
            isRunning: false,
            isBreak: false,
            workTime: 25,
            breakTime: 5,
            sessionsToday: parseInt(localStorage.getItem('sessionsToday')) || 0,
            lastSessionDate: localStorage.getItem('lastSessionDate') || '',
            dailyGoal: parseInt(localStorage.getItem('dailyGoal')) || 8
        };

        let studyData = {
            streak: parseInt(localStorage.getItem('studyStreak')) || 0,
            lastStudyDate: localStorage.getItem('lastStudyDate') || '',
            totalSessions: parseInt(localStorage.getItem('totalSessions')) || 0,
            missedTime: parseInt(localStorage.getItem('missedTime')) || 0
        };

        // Array per salvare le sessioni dettagliate di oggi
        let todayDetailedSessions = JSON.parse(localStorage.getItem('todayDetailedSessions')) || [];

        // NUOVO: Sistema esami e Google Calendar
        let esami = JSON.parse(localStorage.getItem('esami')) || [];
        let googleCalendarEvents = JSON.parse(localStorage.getItem('googleCalendarEvents')) || {};
        let lastProcrastinationCheck = localStorage.getItem('lastProcrastinationCheck') || '';
        let slotOptimizations = JSON.parse(localStorage.getItem('slotOptimizations')) || {};

        // === CORREZIONE ERRORE showSection ===
        function showSection(sectionName, targetElement) {
            try {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });

                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                const targetSection = document.getElementById(sectionName);
                if (targetSection) {
                    targetSection.classList.add('active');
                }

                if (targetElement) {
                    targetElement.classList.add('active');
                }

                // Aggiorna contenuto dinamico
                if (sectionName === 'oggi') {
                    generateTodaySchedule();
                    checkProcrastinationAlert();
                } else if (sectionName === 'piano') {
                    generatePianoStudio();
                } else if (sectionName === 'statistiche') {
                    updateStatistiche();
                    updateHeatmap();
                    updateProductivitySection();
                } else if (sectionName === 'calendario') {
                    renderCalendar();
                    checkProcrastinationAlert();
                } else if (sectionName === 'materie') {
                    setTimeout(() => {
                        initializeWeeklySlots();
                        setupStarRating();
                    }, 100);
                } else if (sectionName === 'pomodoro') {
                    updateTodaySessionsList();
                } else if (sectionName === 'esami') {
                    loadEsamiList();
                    updateMediaLaurea();
                }

            } catch (error) {
                console.error('Errore nel cambio sezione:', error);
            }
        }

        // === SISTEMA ESAMI CON CALCOLO MEDIA ===
        function loadMateriaData() {
            const select = document.getElementById('nomeEsame');
            const customGroup = document.getElementById('customEsameGroup');
            const cfuInput = document.getElementById('cfuEsame');
            
            if (select.value === 'custom') {
                customGroup.style.display = 'block';
                cfuInput.value = '';
            } else if (select.value === '') {
                customGroup.style.display = 'none';
                cfuInput.value = '';
            } else {
                customGroup.style.display = 'none';
                const materia = materie.find(m => m.nome === select.value);
                if (materia) {
                    cfuInput.value = materia.cfu;
                }
            }
        }

        function addEsame() {
            try {
                const nomeSelect = document.getElementById('nomeEsame');
                const customName = document.getElementById('customEsameName');
                const voto = parseInt(document.getElementById('votoEsame').value);
                const lode = document.getElementById('lodeEsame').checked;
                const cfu = parseInt(document.getElementById('cfuEsame').value);
                const dataEsame = document.getElementById('dataEsameVoto').value;
                const note = document.getElementById('noteEsame').value;

                let nomeEsame;
                if (nomeSelect.value === 'custom') {
                    nomeEsame = customName.value.trim();
                    if (!nomeEsame) {
                        showSuccessMessage(' Inserisci il nome dell\'esame personalizzato');
                        return;
                    }
                } else if (nomeSelect.value) {
                    nomeEsame = nomeSelect.value;
                } else {
                    showSuccessMessage(' Seleziona una materia o inserisci un esame personalizzato');
                    return;
                }

                if (!voto || voto < 18 || voto > 30 || !cfu || cfu < 1) {
                    showSuccessMessage(' Voto (18-30) e CFU sono obbligatori');
                    return;
                }

                // Controlla se l'esame esiste gi
                const esameDuplicato = esami.find(e => e.nome.toLowerCase() === nomeEsame.toLowerCase());
                if (esameDuplicato) {
                    if (!confirm(`L'esame "${nomeEsame}" esiste gi. Vuoi sostituirlo?`)) {
                        return;
                    }
                    // Rimuovi il duplicato
                    esami = esami.filter(e => e.nome.toLowerCase() !== nomeEsame.toLowerCase());
                }

                const esame = {
                    id: Date.now(),
                    nome: nomeEsame,
                    voto: voto,
                    lode: lode,
                    cfu: cfu,
                    data: dataEsame || getTodayKey(),
                    note: note.trim()
                };

                esami.push(esame);
                localStorage.setItem('esami', JSON.stringify(esami));

                // Aggiorna materia se non  custom
                if (nomeSelect.value !== 'custom' && nomeSelect.value !== '') {
                    const materia = materie.find(m => m.nome === nomeSelect.value);
                    if (materia) {
                        materia.esameSostenuto = true;
                        materia.votoEsame = voto;
                        materia.lodeEsame = lode;
                        saveMaterie();
                        loadMaterie();
                    }
                }

                resetEsameForm();
                loadEsamiList();
                updateMediaLaurea();
                showSuccessMessage(` Esame "${nomeEsame}" aggiunto con voto ${voto}${lode ? ' e lode' : ''}!`);

            } catch (error) {
                console.error('Errore nell\'aggiunta esame:', error);
                showSuccessMessage(' Errore nell\'aggiunta dell\'esame');
            }
        }

        function resetEsameForm() {
            document.getElementById('nomeEsame').value = '';
            document.getElementById('customEsameName').value = '';
            document.getElementById('votoEsame').value = '';
            document.getElementById('lodeEsame').checked = false;
            document.getElementById('cfuEsame').value = '';
            document.getElementById('dataEsameVoto').value = '';
            document.getElementById('noteEsame').value = '';
            document.getElementById('customEsameGroup').style.display = 'none';
        }

        function loadEsamiList() {
            const container = document.getElementById('esamiList');
            
            // Popola anche il select con le materie
            const nomeEsameSelect = document.getElementById('nomeEsame');
            if (nomeEsameSelect) {
                nomeEsameSelect.innerHTML = '<option value="">Seleziona una materia esistente</option>';
                
                materie.forEach(materia => {
                    // Mostra solo materie non ancora sostenute
                    const giaSostenuto = esami.find(e => e.nome.toLowerCase() === materia.nome.toLowerCase());
                    if (!giaSostenuto) {
                        const option = document.createElement('option');
                        option.value = materia.nome;
                        option.textContent = `${materia.nome} (${materia.cfu} CFU)`;
                        nomeEsameSelect.appendChild(option);
                    }
                });
                
                const customOption = document.createElement('option');
                customOption.value = 'custom';
                customOption.textContent = 'Esame personalizzato';
                nomeEsameSelect.appendChild(customOption);
            }
            
            if (esami.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>Nessun esame sostenuto ancora.</p>
                        <p>Aggiungi il tuo primo esame per iniziare a calcolare la media!</p>
                    </div>
                `;
                return;
            }

            // Ordina per data pi recente
            const esamiOrdinati = [...esami].sort((a, b) => new Date(b.data) - new Date(a.data));

            container.innerHTML = esamiOrdinati.map(esame => {
                const votoClass = esame.lode ? 'voto-lode' : 
                                 esame.voto >= 28 ? 'voto-28-30' :
                                 esame.voto >= 25 ? 'voto-25-27' :
                                 esame.voto >= 22 ? 'voto-22-24' : 'voto-18-21';

                return `
                    <div class="esame-item">
                        <div class="esame-header">
                            <div class="esame-name">${esame.nome}</div>
                            <div class="esame-actions">
                                <span class="voto-badge ${votoClass}">
                                    ${esame.voto}${esame.lode ? ' e Lode' : ''}
                                    <small style="opacity: 0.8;">(${esame.cfu} CFU)</small>
                                </span>
                                <button class="btn btn-warning" onclick="editEsame(${esame.id})" style="padding: 0.5rem;" title="Modifica esame"></button>
                                <button class="btn btn-danger" onclick="deleteEsame(${esame.id})" style="padding: 0.5rem;" title="Elimina esame"></button>
                            </div>
                        </div>
                        
                        <div class="esame-info">
                            <div><strong>Data:</strong> ${new Date(esame.data).toLocaleDateString('it-IT')}</div>
                            <div><strong>Contributo media:</strong> ${((esame.voto * esame.cfu)).toFixed(1)} punti</div>
                            ${esame.note ? `<div style="grid-column: 1 / -1;"><strong>Note:</strong> ${esame.note}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editEsame(id) {
            const esame = esami.find(e => e.id === id);
            if (!esame) return;

            // Popola il form con i dati dell'esame
            document.getElementById('nomeEsame').value = 'custom';
            document.getElementById('customEsameGroup').style.display = 'block';
            document.getElementById('customEsameName').value = esame.nome;
            document.getElementById('votoEsame').value = esame.voto;
            document.getElementById('lodeEsame').checked = esame.lode;
            document.getElementById('cfuEsame').value = esame.cfu;
            document.getElementById('dataEsameVoto').value = esame.data;
            document.getElementById('noteEsame').value = esame.note;

            // Rimuovi l'esame (sar ri-aggiunto al salvataggio)
            esami = esami.filter(e => e.id !== id);
            localStorage.setItem('esami', JSON.stringify(esami));
            loadEsamiList();
            updateMediaLaurea();

            showSuccessMessage(' Esame caricato per modifica');
        }

        function deleteEsame(id) {
            const esame = esami.find(e => e.id === id);
            if (!esame) return;

            const conferma = confirm(`Sei sicuro di voler eliminare l'esame "${esame.nome}" con voto ${esame.voto}${esame.lode ? ' e lode' : ''}?`);
            if (!conferma) return;

            esami = esami.filter(e => e.id !== id);
            localStorage.setItem('esami', JSON.stringify(esami));

            // Rimuovi riferimento dalla materia se esiste
            const materia = materie.find(m => m.nome === esame.nome);
            if (materia) {
                delete materia.esameSostenuto;
                delete materia.votoEsame;
                delete materia.lodeEsame;
                saveMaterie();
                loadMaterie();
            }

            loadEsamiList();
            updateMediaLaurea();
            showSuccessMessage(` Esame "${esame.nome}" eliminato`);
        }

        function updateMediaLaurea() {
            if (esami.length === 0) {
                document.getElementById('mediaLaurea').textContent = '0.00';
                document.getElementById('mediaPonderata').textContent = '0.00';
                document.getElementById('cfuCompletati').textContent = '0';
                document.getElementById('esamiSostenuti').textContent = '0';
                document.getElementById('proiezioniCard').style.display = 'none';
                return;
            }

            // Calcola media ponderata
            let sommaProdotti = 0;
            let sommaCFU = 0;

            esami.forEach(esame => {
                sommaProdotti += esame.voto * esame.cfu;
                sommaCFU += esame.cfu;
            });

            const mediaPonderata = sommaProdotti / sommaCFU;
            
            // Aggiorna display
            document.getElementById('mediaLaurea').textContent = mediaPonderata.toFixed(2);
            document.getElementById('mediaPonderata').textContent = mediaPonderata.toFixed(2);
            document.getElementById('cfuCompletati').textContent = sommaCFU;
            document.getElementById('esamiSostenuti').textContent = esami.length;

            // Calcola proiezioni
            updateProiezioniLaurea(mediaPonderata);
            document.getElementById('proiezioniCard').style.display = 'block';
        }

        function updateProiezioniLaurea(mediaPonderata) {
            // Voto base (media * 11 / 3)
            const votoBase = Math.round((mediaPonderata * 11) / 3);
            document.getElementById('votoBase').textContent = Math.min(110, votoBase);

            // Con tesi (max +7 punti)
            const votoConTesi = Math.min(110, votoBase + 7);
            document.getElementById('votoConTesi').textContent = votoConTesi;

            // Per 110 e lode serve media >= 28.2 circa
            const mediaPerLode = 28.2;
            const needFor110El = document.getElementById('needFor110');
            const mediaFor110El = document.getElementById('mediaFor110');

            if (mediaPonderata >= mediaPerLode) {
                needFor110El.textContent = ' Possibile!';
                mediaFor110El.textContent = '110 e Lode';
                mediaFor110El.style.color = 'var(--success-color)';
            } else {
                needFor110El.textContent = 'Media necessaria:';
                mediaFor110El.textContent = mediaPerLode.toFixed(2);
                mediaFor110El.style.color = 'var(--warning-color)';
            }
        }

        // === ALERT PROCRASTINAZIONE ===
        function checkProcrastinationAlert() {
            const today = getTodayKey();
            
            // Controlla solo una volta al giorno
            if (lastProcrastinationCheck === today) return;
            
            const alerts = [];
            
            // 1. Materie non studiate da giorni
            materie.forEach(materia => {
                const lastStudyDate = getLastStudyDateForMateria(materia.nome);
                if (lastStudyDate) {
                    const daysSinceLastStudy = Math.floor((new Date() - new Date(lastStudyDate)) / (1000 * 60 * 60 * 24));
                    if (daysSinceLastStudy >= 3) {
                        alerts.push(` ${materia.nome}: non studiata da ${daysSinceLastStudy} giorni`);
                    }
                }
            });

            // 2. Obiettivo giornaliero non raggiunto per 2+ giorni
            if (timerState.sessionsToday < timerState.dailyGoal / 2) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayKey = getLocalDateKey(yesterday);
                
                const yesterdaySessions = Object.keys(sessionRatings[yesterdayKey] || {}).length;
                if (yesterdaySessions < timerState.dailyGoal / 2) {
                    alerts.push(` Sotto obiettivo per 2+ giorni consecutivi`);
                }
            }

            // 3. Esami vicini ma poco progresso
            materie.forEach(materia => {
                if (materia.dataEsame) {
                    const daysToExam = Math.floor((new Date(materia.dataEsame) - new Date()) / (1000 * 60 * 60 * 24));
                    const progressPercent = ((materia.pagineStudiate || 0) / materia.pagine) * 100;
                    
                    if (daysToExam <= 14 && progressPercent < 50) {
                        alerts.push(` ${materia.nome}: esame in ${daysToExam} giorni, progresso solo ${Math.round(progressPercent)}%`);
                    }
                }
            });

            // Mostra alert se ce ne sono
            if (alerts.length > 0) {
                showProcrastinationAlert(alerts);
            }
            
            lastProcrastinationCheck = today;
            localStorage.setItem('lastProcrastinationCheck', today);
        }

        function showProcrastinationAlert(alerts) {
            const alertDiv = document.getElementById('procrastinationAlert');
            const contentDiv = document.getElementById('procrastinationContent');
            
            contentDiv.innerHTML = `
                <p style="margin-bottom: 1rem; font-weight: 600;">Hai bisogno di una spinta motivazionale:</p>
                <ul style="margin-left: 2rem; line-height: 1.8;">
                    ${alerts.map(alert => `<li>${alert}</li>`).join('')}
                </ul>
                <p style="margin-top: 1rem; font-style: italic;">Non preoccuparti, puoi recuperare! Inizia con una sessione breve.</p>
            `;
            
            alertDiv.style.display = 'block';
        }

        function dismissProcrastinationAlert() {
            document.getElementById('procrastinationAlert').style.display = 'none';
        }

        function getLastStudyDateForMateria(nomeMateria) {
            let lastDate = null;
            
            // Cerca nelle sessioni dettagliate
            todayDetailedSessions.forEach(session => {
                if (session.materia === nomeMateria) {
                    if (!lastDate || session.date > lastDate) {
                        lastDate = session.date;
                    }
                }
            });
            
            // Cerca nei rating passati
            Object.keys(sessionRatings).forEach(dateKey => {
                Object.keys(sessionRatings[dateKey]).forEach(hour => {
                    sessionRatings[dateKey][hour].forEach(session => {
                        if (session.note && session.note.toLowerCase().includes(nomeMateria.toLowerCase())) {
                            if (!lastDate || dateKey > lastDate) {
                                lastDate = dateKey;
                            }
                        }
                    });
                });
            });
            
            return lastDate;
        }

        // === OTTIMIZZAZIONE AUTOMATICA SLOT ===
        function optimizeSlots() {
            if (Object.keys(sessionRatings).length < 7) {
                return; // Servono almeno 7 giorni di dati
            }

            const hourlyPerformance = {};
            
            // Analizza performance per ogni ora
            for (let hour = 6; hour < 24; hour++) {
                let totalRating = 0;
                let sessionCount = 0;
                
                Object.keys(sessionRatings).forEach(dateKey => {
                    if (sessionRatings[dateKey][hour]) {
                        sessionRatings[dateKey][hour].forEach(session => {
                            totalRating += session.rating;
                            sessionCount++;
                        });
                    }
                });
                
                if (sessionCount >= 2) {
                    hourlyPerformance[hour] = {
                        avgRating: totalRating / sessionCount,
                        sessionCount: sessionCount
                    };
                }
            }

            // Identifica ore migliori (rating >= 3.0)
            const bestHours = Object.keys(hourlyPerformance)
                .filter(hour => hourlyPerformance[hour].avgRating >= 3.0)
                .sort((a, b) => hourlyPerformance[b].avgRating - hourlyPerformance[a].avgRating)
                .slice(0, 8);

            if (bestHours.length >= 3) {
                // Suggerisci ottimizzazione
                slotOptimizations = {
                    suggestedHours: bestHours,
                    lastUpdate: getTodayKey(),
                    performance: hourlyPerformance
                };
                localStorage.setItem('slotOptimizations', JSON.stringify(slotOptimizations));
                
                showSlotOptimizationSuggestion(bestHours, hourlyPerformance);
            }
        }

        function showSlotOptimizationSuggestion(bestHours, performance) {
            const suggestion = bestHours.slice(0, 3).map(hour => {
                const rating = performance[hour].avgRating.toFixed(1);
                return `${hour}:00-${parseInt(hour)+1}:00 (rating ${rating})`;
            }).join(', ');

            const optimizationDiv = document.createElement('div');
            optimizationDiv.className = 'optimization-indicator';
            optimizationDiv.innerHTML = `
                <strong> Ottimizzazione Slot Automatica:</strong><br>
                Le tue ore migliori sono: ${suggestion}<br>
                Considera di spostare gli slot di studio difficile in questi orari.
                <button class="btn btn-primary btn-small" onclick="applySlotOptimization()" style="margin-left: 1rem;">Applica Suggerimenti</button>
            `;

            // Mostra nella sezione Piano Studio
            const pianoContainer = document.getElementById('pianoStudio');
            if (pianoContainer && !document.querySelector('.optimization-indicator')) {
                pianoContainer.insertBefore(optimizationDiv, pianoContainer.firstChild);
            }
        }

        function applySlotOptimization() {
            showSuccessMessage(' Suggerimenti salvati! Modifica manualmente le materie per ottimizzare gli slot negli orari consigliati.');
            document.querySelector('.optimization-indicator')?.remove();
        }

        // === SYNC GOOGLE CALENDAR (SIMULAZIONE) ===
        function syncGoogleCalendar() {
            // Simulazione di eventi Google Calendar
            const sampleEvents = [
                { date: getTodayKey(), title: 'Lezione Analisi', time: '09:00-11:00' },
                { date: getTodayKey(), title: 'Ricevimento Prof. Rossi', time: '14:00-15:00' },
                { date: getLocalDateKey(new Date(Date.now() + 86400000)), title: 'Seminario', time: '10:00-12:00' }
            ];

            sampleEvents.forEach(event => {
                if (!googleCalendarEvents[event.date]) {
                    googleCalendarEvents[event.date] = [];
                }
                
                const exists = googleCalendarEvents[event.date].find(e => e.title === event.title);
                if (!exists) {
                    googleCalendarEvents[event.date].push(event);
                }
            });

            localStorage.setItem('googleCalendarEvents', JSON.stringify(googleCalendarEvents));
            renderCalendar();
            
            showSuccessMessage(' Google Calendar sincronizzato! Trovati nuovi eventi.');
        }

        // === PIANIFICAZIONE INTELLIGENTE MIGLIORATA ===
        function calcolaOreSensate(materia) {
            try {
                const cfu = materia.cfu || 6;
                const pagine = materia.pagine || 0;
                const pagineStudiate = materia.pagineStudiate || 0;
                const pagineOra = Math.max(1, materia.pagineOra || 8);
                const difficolta = materia.difficolta || 3;
                const priorita = materia.priorita || 'media';
                
                // 1. CALCOLO BASE CFU (pi realistico)
                let oreBaseCFU = cfu * 20; // 20 ore per CFU (pi realistico di 25)
                
                // 2. MOLTIPLICATORE DIFFICOLTA (pi preciso)
                const moltiplicatoriDifficolta = {
                    1: 0.7,  // Molto facile
                    2: 0.85, // Facile
                    3: 1.0,  // Media
                    4: 1.3,  // Difficile
                    5: 1.6   // Molto difficile
                };
                const multDifficolta = moltiplicatoriDifficolta[difficolta] || 1.0;
                
                // 3. MOLTIPLICATORE PRIORIT
                const moltiplicatoriPriorita = {
                    'bassa': 0.9,
                    'media': 1.0,
                    'alta': 1.15
                };
                const multPriorita = moltiplicatoriPriorita[priorita] || 1.0;
                
                // 4. ORE TOTALI NECESSARIE (CFU)
                let oreTotaliCFU = Math.ceil(oreBaseCFU * multDifficolta * multPriorita);
                
                // 5. ORE BASATE SU PAGINE
                const pagineRimanenti = Math.max(0, pagine - pagineStudiate);
                let oreTotaliPagine = Math.ceil(pagineRimanenti / pagineOra);
                
                // 6. FATTORE CORREZIONE PAGINE PER DIFFICOLTA
                oreTotaliPagine = Math.ceil(oreTotaliPagine * multDifficolta);
                
                // 7. USA IL MAGGIORE TRA CFU E PAGINE, CON LOGICA INTELLIGENTE
                let oreNecessarie;
                if (pagineRimanenti > 0) {
                    // Se ci sono pagine, usa una media pesata tra CFU e pagine
                    const pesoPageine = 0.7;
                    const pesoCFU = 0.3;
                    oreNecessarie = Math.ceil((oreTotaliPagine * pesoPageine) + (oreTotaliCFU * pesoCFU));
                } else {
                    // Se non ci sono pagine specifiche, usa solo CFU
                    oreNecessarie = oreTotaliCFU;
                }
                
                // 8. AGGIUNGI TEMPO EXTRA PER RIPASSO (intelligente)
                const percentualeCompletamento = pagine > 0 ? (pagineStudiate / pagine) * 100 : 0;
                let tempoRipasso = 0;
                
                if (percentualeCompletamento > 60) {
                    // Aggiungi tempo per ripasso finale
                    tempoRipasso = Math.ceil(oreNecessarie * 0.2); // 20% extra per ripasso
                } else if (percentualeCompletamento > 30) {
                    // Aggiungi tempo per consolidamento
                    tempoRipasso = Math.ceil(oreNecessarie * 0.1); // 10% extra
                }
                
                oreNecessarie += tempoRipasso;
                
                // 9. LIMITI RAGIONEVOLI
                const minOre = Math.max(10, cfu * 8);  // Minimo 8 ore per CFU
                const maxOre = cfu * 35;                // Massimo 35 ore per CFU
                
                oreNecessarie = Math.max(minOre, Math.min(maxOre, oreNecessarie));
                
                return {
                    oreNecessarie,
                    oreTotaliCFU,
                    oreTotaliPagine,
                    tempoRipasso,
                    pagineRimanenti,
                    percentualeCompletamento,
                    multDifficolta,
                    multPriorita
                };
                
            } catch (error) {
                console.error('Errore nel calcolo ore:', error);
                // Fallback: calcolo semplice
                const cfu = materia.cfu || 6;
                return {
                    oreNecessarie: cfu * 20,
                    oreTotaliCFU: cfu * 20,
                    oreTotaliPagine: 0,
                    tempoRipasso: 0,
                    pagineRimanenti: materia.pagine - (materia.pagineStudiate || 0),
                    percentualeCompletamento: 0,
                    multDifficolta: 1,
                    multPriorita: 1
                };
            }
        }

        function generaPianoStudioIntelligente(materia) {
            try {
                const calcoli = calcolaOreSensate(materia);
                const oggi = new Date();
                const dataEsame = materia.dataEsame ? new Date(materia.dataEsame) : new Date(oggi.getTime() + (60 * 24 * 60 * 60 * 1000));
                
                // Calcola giorni rimanenti (escludendo domeniche e riducendo sabati)
                let giorniRimanenti = 0;
                let dataCorrente = new Date(oggi);
                
                while (dataCorrente < dataEsame) {
                    const giornoSettimana = dataCorrente.getDay();
                    if (giornoSettimana === 0) {
                        // Domenica: non conta
                    } else if (giornoSettimana === 6) {
                        // Sabato: conta come mezzo giorno
                        giorniRimanenti += 0.5;
                    } else {
                        // Giorni feriali: contano pieni
                        giorniRimanenti += 1;
                    }
                    dataCorrente.setDate(dataCorrente.getDate() + 1);
                }
                
                giorniRimanenti = Math.max(1, Math.floor(giorniRimanenti));
                
                // Calcola ore settimanali dagli slot REALI
                let oreSettimanaliReali = 0;
                if (materia.slotSettimanali) {
                    Object.keys(materia.slotSettimanali).forEach(giorno => {
                        const slots = materia.slotSettimanali[giorno];
                        if (slots && Array.isArray(slots)) {
                            slots.forEach(slot => {
                                if (slot.inizio && slot.fine) {
                                    const durata = calculateTaskDuration(slot.inizio, slot.fine);
                                    oreSettimanaliReali += durata / 60;
                                }
                            });
                        }
                    });
                }
                
                // Calcola settimane rimanenti
                const settimaneRimanenti = Math.max(0.5, giorniRimanenti / 7);
                const oreTotaliDisponibili = Math.floor(oreSettimanaliReali * settimaneRimanenti);
                
                // Calcola intensit necessaria
                const oreAlGiorno = oreSettimanaliReali / 7;
                const intensitaRichiesta = calcoli.oreNecessarie / Math.max(1, settimaneRimanenti * 7);
                
                // Determina urgenza con logica migliorata
                let urgenza = 'normale';
                let raccomandazioni = [];
                let warning = null;
                
                const ratioDisponibilita = oreTotaliDisponibili / calcoli.oreNecessarie;
                
                if (giorniRimanenti <= 7) {
                    urgenza = 'critica';
                    raccomandazioni.push(' MODALIT EMERGENZA: Solo concetti essenziali');
                    raccomandazioni.push(' Studia almeno 6-8 ore al giorno');
                    raccomandazioni.push(' Fai riassunti ultra-sintetici');
                    raccomandazioni.push(' Concentrati su esercizi tipo esame');
                } else if (giorniRimanenti <= 21) {
                    urgenza = 'alta';
                    raccomandazioni.push(' Incrementa le sessioni giornaliere');
                    raccomandazioni.push(' Focalizzati sui capitoli pi importanti');
                    raccomandazioni.push(' Alterna teoria ed esercizi');
                } else if (ratioDisponibilit < 0.8) {
                    urgenza = 'moderata';
                    raccomandazioni.push(' Considera di aggiungere pi slot settimanali');
                    raccomandazioni.push(' Ottimizza l\'efficienza di studio');
                    raccomandazioni.push(' Monitora i progressi settimanalmente');
                } else {
                    raccomandazioni.push(' Programma ottimale: mantieni il ritmo');
                    raccomandazioni.push(' Dedica tempo extra agli argomenti difficili');
                    raccomandazioni.push(' Pianifica ripasso regolare');
                }
                
                // Genera warning specifico
                if (ratioDisponibilit < 0.7) {
                    const oreExtra = Math.ceil(calcoli.oreNecessarie - oreTotaliDisponibili);
                    const settimaneExtra = Math.ceil(oreExtra / Math.max(1, oreSettimanaliReali));
                    warning = `Tempo insufficiente! Servono ${oreExtra} ore extra (circa ${settimaneExtra} settimane in pi con il ritmo attuale).`;
                } else if (ratioDisponibilit < 0.85) {
                    warning = `Tempo appena sufficiente. Evita di saltare sessioni programmate.`;
                }
                
                // Calcola piano giornaliero realistico
                const pagineAlGiorno = calcoli.pagineRimanenti > 0 ? 
                    Math.ceil(calcoli.pagineRimanenti / Math.max(1, giorniRimanenti * 0.8)) : 0;
                
                return {
                    ...calcoli,
                    giorniRimanenti: Math.max(0, giorniRimanenti),
                    settimaneRimanenti: Math.round(settimaneRimanenti * 10) / 10,
                    oreSettimanaliReali: Math.round(oreSettimanaliReali * 10) / 10,
                    oreTotaliDisponibili,
                    ratioDisponibilit: Math.round(ratioDisponibilit * 100) / 100,
                    intensitaRichiesta: Math.round(intensitaRichiesta * 10) / 10,
                    oreAlGiorno: Math.round(oreAlGiorno * 10) / 10,
                    pagineAlGiorno,
                    urgenza,
                    raccomandazioni,
                    warning
                };
                
            } catch (error) {
                console.error('Errore nella pianificazione:', error);
                // Fallback semplice
                return calcolaPianoMateria(materia);
            }
        }

        // Sistema Rating Sessioni con gestione errori migliorata
        function showRatingModal() {
            try {
                const modal = document.getElementById('ratingModal');
                if (!modal) {
                    console.error('Rating modal not found');
                    return;
                }
                
                // Resetta la nota
                const noteInput = document.getElementById('sessionNote');
                if (noteInput) noteInput.value = '';
                
                modal.style.display = 'flex';
                
                // Suono di notifica
                playNotificationSound();
                
                // Notifica browser se supportata
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(' Sessione completata!', { 
                        body: 'Come ti senti? Valuta la tua produttivit.',
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"><text y="32" font-size="32"></text></svg>'
                    });
                }
            } catch (error) {
                console.error('Errore nella visualizzazione del modal rating:', error);
                // Fallback: mostra il messaggio di completamento sessione senza modal
                showSuccessMessage(' Sessione completata! Ottimo lavoro!');
            }
        }

        function submitRating(rating) {
            try {
                const now = new Date();
                const hour = now.getHours();
                
                // FIXED per timezone Italia/Napoli - usa data locale
                const dateKey = getTodayKey();
                const timestamp = now.getTime();
                
                // Ottieni la nota dalla sessione
                const noteInput = document.getElementById('sessionNote');
                const sessionNote = noteInput ? noteInput.value.trim() : '';
                
                // Salva rating con timestamp e ora
                if (!sessionRatings[dateKey]) {
                    sessionRatings[dateKey] = {};
                }
                
                if (!sessionRatings[dateKey][hour]) {
                    sessionRatings[dateKey][hour] = [];
                }
                
                sessionRatings[dateKey][hour].push({
                    rating: rating,
                    timestamp: timestamp,
                    duration: timerState.workTime,
                    note: sessionNote
                });
                
                localStorage.setItem('sessionRatings', JSON.stringify(sessionRatings));
                
                // Salva sessione dettagliata per la lista di oggi
                const sessionDetails = {
                    id: timestamp,
                    startTime: currentSessionStartTime ? currentSessionStartTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
                    endTime: now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
                    duration: timerState.workTime,
                    rating: rating,
                    note: sessionNote,
                    materia: currentSessionData?.materia || 'Studio generale',
                    date: dateKey
                };
                
                todayDetailedSessions.push(sessionDetails);
                localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                
                // Aggiorna lista sessioni
                updateTodaySessionsList();
                
                // Chiudi modal con animazione
                const modal = document.getElementById('ratingModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // Aggiorna heatmap e statistiche
                updateHeatmap();
                updateProductivitySection();
                
                // Feedback visivo
                const ratingTexts = [' Riposa un po\'', ' Va bene cos', ' Ottimo lavoro!', ' Sei in fiammata!'];
                showSuccessMessage(`${ratingTexts[rating-1]} Rating salvato per le ${hour}:00`);
                
                console.log(`Rating salvato: ${rating}/4 alle ${hour}:00`);
            } catch (error) {
                console.error('Errore nel salvataggio rating:', error);
                showSuccessMessage(' Errore nel salvataggio del rating, ma sessione completata!');
                
                // Chiudi comunque il modal
                const modal = document.getElementById('ratingModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // === LISTA SESSIONI DI OGGI ===
        function updateTodaySessionsList() {
            const container = document.getElementById('todaySessionsList');
            if (!container) return;
            
            // FIXED per timezone Italia - usa data locale
            const today = getTodayKey();
            const lastSessionDate = localStorage.getItem('lastDetailedSessionDate') || '';
            
            if (lastSessionDate !== today) {
                todayDetailedSessions = [];
                localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                localStorage.setItem('lastDetailedSessionDate', today);
            }
            
            if (todayDetailedSessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>Nessuna sessione completata oggi.</p>
                        <p>Avvia una sessione per iniziare!</p>
                    </div>
                `;
                return;
            }
            
            // Ordina le sessioni per ora di inizio (pi recenti prima)
            const sortedSessions = [...todayDetailedSessions].sort((a, b) => b.id - a.id);
            
            container.innerHTML = sortedSessions.map(session => {
                const ratingStars = ''.repeat(session.rating) + ''.repeat(4 - session.rating);
                
                return `
                    <div class="session-item">
                        <div class="session-info">
                            <div class="session-time">${session.startTime} - ${session.endTime}</div>
                            <div>
                                <span class="session-materia">${session.materia}</span>
                                <span style="color: var(--text-secondary); margin-left: 1rem;">${session.duration} min</span>
                            </div>
                            ${session.note ? `<div class="session-note">"${session.note}"</div>` : ''}
                            <div class="session-rating">
                                <span style="color: #fbbf24; font-size: 0.9rem;">${ratingStars}</span>
                            </div>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-danger btn-small" onclick="deleteSpecificSession(${session.id})" title="Elimina questa sessione"></button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteSpecificSession(sessionId) {
            try {
                // Trova la sessione da eliminare
                const sessionIndex = todayDetailedSessions.findIndex(s => s.id === sessionId);
                if (sessionIndex === -1) {
                    showSuccessMessage(' Sessione non trovata');
                    return;
                }
                
                const session = todayDetailedSessions[sessionIndex];
                
                const conferma = confirm(`Sei sicuro di voler eliminare questa sessione?\n\n` +
                    `Materia: ${session.materia}\n` +
                    `Durata: ${session.duration} min\n` +
                    `Orario: ${session.startTime} - ${session.endTime}\n` +
                    `Rating: ${''.repeat(session.rating)}${''.repeat(4 - session.rating)}\n` +
                    `${session.note ? `Nota: ${session.note}` : ''}`);
                
                if (!conferma) return;
                
                // Rimuovi dalla lista dettagliata
                todayDetailedSessions.splice(sessionIndex, 1);
                localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                
                // Aggiorna contatori generali
                if (timerState.sessionsToday > 0) {
                    timerState.sessionsToday--;
                    localStorage.setItem('sessionsToday', timerState.sessionsToday.toString());
                }
                
                if (studyData.totalSessions > 0) {
                    studyData.totalSessions--;
                    localStorage.setItem('totalSessions', studyData.totalSessions.toString());
                }
                
                // Rimuovi dal rating se esiste
                const sessionHour = parseInt(session.startTime.split(':')[0]);
                const dateKey = session.date;
                
                if (sessionRatings[dateKey] && sessionRatings[dateKey][sessionHour]) {
                    const ratingIndex = sessionRatings[dateKey][sessionHour].findIndex(r => r.timestamp === session.id);
                    if (ratingIndex !== -1) {
                        sessionRatings[dateKey][sessionHour].splice(ratingIndex, 1);
                        if (sessionRatings[dateKey][sessionHour].length === 0) {
                            delete sessionRatings[dateKey][sessionHour];
                        }
                        localStorage.setItem('sessionRatings', JSON.stringify(sessionRatings));
                    }
                }
                
                // Aggiorna anche il calendario
                const today = getTodayKey();
                if (calendarSessions[today] && calendarSessions[today].completed > 0) {
                    calendarSessions[today].completed--;
                    localStorage.setItem('calendarSessions', JSON.stringify(calendarSessions));
                }
                
                // Aggiorna UI
                updateTodaySessionsList();
                updateSessionDisplay();
                renderCalendar();
                updateHeatmap();
                updateProductivitySection();
                
                showSuccessMessage(` Sessione di ${session.duration} min eliminata`);
                
            } catch (error) {
                console.error('Errore nell\'eliminazione della sessione:', error);
                showSuccessMessage(' Errore nell\'eliminazione della sessione');
            }
        }

        function showDeleteAllTodaySessionsModal() {
            if (todayDetailedSessions.length === 0) {
                showSuccessMessage(' Nessuna sessione da eliminare oggi');
                return;
            }
            
            const totalMinutes = todayDetailedSessions.reduce((sum, session) => sum + session.duration, 0);
            
            const conferma = confirm(`Sei sicuro di voler eliminare tutte le ${todayDetailedSessions.length} sessioni di oggi?\n\n` +
                `Tempo totale: ${totalMinutes} minuti\n` +
                `Questa azione non pu essere annullata.`);
            
            if (!conferma) return;
            
            try {
                // Azzera tutto
                const sessionsDeleted = todayDetailedSessions.length;
                
                todayDetailedSessions = [];
                localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                
                timerState.sessionsToday = 0;
                localStorage.setItem('sessionsToday', '0');
                
                studyData.totalSessions = Math.max(0, studyData.totalSessions - sessionsDeleted);
                localStorage.setItem('totalSessions', studyData.totalSessions.toString());
                
                // Pulisci anche i rating di oggi
                const today = getTodayKey();
                if (sessionRatings[today]) {
                    delete sessionRatings[today];
                    localStorage.setItem('sessionRatings', JSON.stringify(sessionRatings));
                }
                
                // Pulisci calendario di oggi
                if (calendarSessions[today]) {
                    calendarSessions[today].completed = 0;
                    localStorage.setItem('calendarSessions', JSON.stringify(calendarSessions));
                }
                
                // Aggiorna UI
                updateTodaySessionsList();
                updateSessionDisplay();
                renderCalendar();
                updateHeatmap();
                updateProductivitySection();
                
                showSuccessMessage(` Tutte le ${sessionsDeleted} sessioni di oggi sono state eliminate`);
                
            } catch (error) {
                console.error('Errore nell\'eliminazione di tutte le sessioni:', error);
                showSuccessMessage(' Errore nell\'eliminazione delle sessioni');
            }
        }

        // === HEATMAP 24 ORE ===
        function initializeHeatmap() {
            const heatmapGrid = document.getElementById('heatmapGrid');
            if (!heatmapGrid) return;
            
            heatmapGrid.innerHTML = '';
            
            // Genera 24 celle (0-23 ore)
            for (let hour = 0; hour < 24; hour++) {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell empty';
                cell.textContent = hour.toString().padStart(2, '0');
                cell.dataset.hour = hour;
                
                // Event listeners per tooltip
                cell.addEventListener('mouseenter', (e) => showHeatmapTooltip(e, hour));
                cell.addEventListener('mouseleave', hideHeatmapTooltip);
                
                heatmapGrid.appendChild(cell);
            }
            
            updateHeatmap();
        }

        function updateHeatmap() {
            const cells = document.querySelectorAll('.heatmap-cell');
            
            cells.forEach((cell, hour) => {
                const avgRating = calculateHourlyAverageRating(hour);
                
                // Reset classi
                cell.className = 'heatmap-cell';
                
                if (avgRating === 0) {
                    cell.classList.add('empty');
                } else if (avgRating <= 1.5) {
                    cell.classList.add('low');
                } else if (avgRating <= 2.5) {
                    cell.classList.add('medium');
                } else if (avgRating <= 3.5) {
                    cell.classList.add('high');
                } else {
                    cell.classList.add('very-high');
                }
            });
        }

        function calculateHourlyAverageRating(hour) {
            let totalRating = 0;
            let sessionCount = 0;
            
            // Analizza gli ultimi 30 giorni
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            Object.keys(sessionRatings).forEach(dateKey => {
                const date = new Date(dateKey);
                if (date >= thirtyDaysAgo && sessionRatings[dateKey][hour]) {
                    sessionRatings[dateKey][hour].forEach(session => {
                        totalRating += session.rating;
                        sessionCount++;
                    });
                }
            });
            
            return sessionCount > 0 ? totalRating / sessionCount : 0;
        }

        function showHeatmapTooltip(event, hour) {
            const tooltip = document.getElementById('heatmapTooltip');
            if (!tooltip) return;
            
            const avgRating = calculateHourlyAverageRating(hour);
            const sessionCount = getHourlySessionCount(hour);
            
            let content = `<strong>${hour}:00 - ${hour + 1}:00</strong><br>`;
            
            if (sessionCount === 0) {
                content += 'Nessuna sessione registrata';
            } else {
                const ratingText = avgRating <= 1.5 ? 'Bassa' : 
                                 avgRating <= 2.5 ? 'Media' : 
                                 avgRating <= 3.5 ? 'Alta' : 'Eccellente';
                content += `Produttivit: ${ratingText}<br>`;
                content += `${sessionCount} sessioni<br>`;
                content += `Rating medio: ${avgRating.toFixed(1)}/4`;
            }
            
            tooltip.innerHTML = content;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.classList.add('show');
        }

        function hideHeatmapTooltip() {
            const tooltip = document.getElementById('heatmapTooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
            }
        }

        function getHourlySessionCount(hour) {
            let sessionCount = 0;
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            Object.keys(sessionRatings).forEach(dateKey => {
                const date = new Date(dateKey);
                if (date >= thirtyDaysAgo && sessionRatings[dateKey][hour]) {
                    sessionCount += sessionRatings[dateKey][hour].length;
                }
            });
            
            return sessionCount;
        }

        // === SEZIONE PRODUTTIVIT ===
        function updateProductivitySection() {
            updateTopHours();
            updateProductivitySuggestion();
        }

        function updateTopHours() {
            const topHoursGrid = document.getElementById('topHoursGrid');
            if (!topHoursGrid) return;
            
            // Calcola rating medio per ogni ora
            const hourlyRatings = [];
            for (let hour = 0; hour < 24; hour++) {
                const avgRating = calculateHourlyAverageRating(hour);
                const sessionCount = getHourlySessionCount(hour);
                
                if (sessionCount > 0) {
                    hourlyRatings.push({
                        hour: hour,
                        avgRating: avgRating,
                        sessionCount: sessionCount
                    });
                }
            }
            
            // Ordina per rating e prendi i top 3
            hourlyRatings.sort((a, b) => b.avgRating - a.avgRating);
            const top3 = hourlyRatings.slice(0, 3);
            
            if (top3.length === 0) {
                topHoursGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;"></div>
                        <p>Completa alcune sessioni per scoprire i tuoi orari migliori!</p>
                    </div>
                `;
                return;
            }
            
            topHoursGrid.innerHTML = top3.map((hour, index) => {
                const ratingText = hour.avgRating <= 1.5 ? 'Bassa' : 
                                  hour.avgRating <= 2.5 ? 'Media' : 
                                  hour.avgRating <= 3.5 ? 'Alta' : 'Eccellente';
                
                const rankEmojis = ['', '', ''];
                
                return `
                    <div class="top-hour-item">
                        <div class="top-hour-rank">${rankEmojis[index]}</div>
                        <div class="top-hour-time">${hour.hour}:00 - ${hour.hour + 1}:00</div>
                        <div class="top-hour-rating">
                            ${ratingText} (${hour.avgRating.toFixed(1)}/4)<br>
                            <small style="color: var(--text-muted);">${hour.sessionCount} sessioni</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateProductivitySuggestion() {
            const suggestionEl = document.getElementById('productivitySuggestion');
            if (!suggestionEl) return;
            
            // Calcola statistics per il suggerimento
            const hourlyRatings = [];
            for (let hour = 0; hour < 24; hour++) {
                const avgRating = calculateHourlyAverageRating(hour);
                const sessionCount = getHourlySessionCount(hour);
                
                if (sessionCount > 0) {
                    hourlyRatings.push({
                        hour: hour,
                        avgRating: avgRating,
                        sessionCount: sessionCount
                    });
                }
            }
            
            if (hourlyRatings.length === 0) {
                suggestionEl.innerHTML = `
                    <h4> Suggerimento Smart</h4>
                    <p>Aggiungi delle sessioni di studio per scoprire i tuoi momenti pi produttivi!</p>
                `;
                return;
            }
            
            // Trova le ore migliori
            hourlyRatings.sort((a, b) => b.avgRating - a.avgRating);
            const bestHours = hourlyRatings.slice(0, 3);
            
            // Genera suggerimento personalizzato
            let suggestion = '';
            if (bestHours.length >= 2) {
                const topHour = bestHours[0];
                const secondHour = bestHours[1];
                
                const materieComplesse = materie.filter(m => m.difficolta >= 4);
                
                if (materieComplesse.length > 0) {
                    suggestion = `Le tue ore migliori sono ${topHour.hour}:00-${topHour.hour + 1}:00 e ${secondHour.hour}:00-${secondHour.hour + 1}:00. 
                        Perfette per ${materieComplesse[0].nome} che richiede maggiore concentrazione!`;
                } else {
                    suggestion = `Le tue ore migliori sono ${topHour.hour}:00-${topHour.hour + 1}:00 e ${secondHour.hour}:00-${secondHour.hour + 1}:00. 
                        Programma le sessioni pi impegnative in questi orari.`;
                }
            } else {
                const topHour = bestHours[0];
                suggestion = `La tua ora migliore  ${topHour.hour}:00-${topHour.hour + 1}:00 con un rating medio di ${topHour.avgRating.toFixed(1)}/4. 
                    Concentra qui le attivit pi difficili!`;
            }
            
            suggestionEl.innerHTML = `
                <h4> Suggerimento Smart</h4>
                <p>${suggestion}</p>
            `;
        }

        // === NAVIGAZIONE ===
        function showSection(sectionName, targetElement) {
            try {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });

                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                const targetSection = document.getElementById(sectionName);
                if (targetSection) {
                    targetSection.classList.add('active');
                }

                if (targetElement) {
                    targetElement.classList.add('active');
                }

                // Aggiorna contenuto dinamico
                if (sectionName === 'oggi') {
                    generateTodaySchedule();
                } else if (sectionName === 'piano') {
                    generatePianoStudio();
                } else if (sectionName === 'statistiche') {
                    updateStatistiche();
                    updateHeatmap();
                    updateProductivitySection();
                } else if (sectionName === 'calendario') {
                    renderCalendar();
                } else if (sectionName === 'materie') {
                    setTimeout(() => {
                        initializeWeeklySlots();
                        setupStarRating();
                    }, 100);
                } else if (sectionName === 'pomodoro') {
                    updateTodaySessionsList();
                }

            } catch (error) {
                console.error('Errore nel cambio sezione:', error);
            }
        }

        // === OBIETTIVO GIORNALIERO PERSONALIZZABILE ===
        function updateDailyGoal() {
            const goalInput = document.getElementById('dailyGoal');
            const newGoal = parseInt(goalInput.value);
            
            if (newGoal && newGoal > 0 && newGoal <= 20) {
                timerState.dailyGoal = newGoal;
                localStorage.setItem('dailyGoal', newGoal.toString());
                updateSessionDisplay();
                updateDailyGoalDisplay();
                showSuccessMessage(` Obiettivo aggiornato: ${newGoal} pomodori al giorno`);
            } else {
                goalInput.value = timerState.dailyGoal;
                showSuccessMessage(' Inserisci un obiettivo valido (1-20 sessioni)');
            }
        }

        function updateDailyGoalDisplay() {
            const goalInput = document.getElementById('dailyGoal');
            const sessionGoalEl = document.getElementById('sessionGoal');
            
            if (goalInput) goalInput.value = timerState.dailyGoal;
            if (sessionGoalEl) sessionGoalEl.textContent = timerState.dailyGoal;
        }

        // === SISTEMA SLOT TEMPORALI ===
        function initializeWeeklySlots() {
            const container = document.getElementById('weeklySlots');
            if (!container) {
                console.error('Container weeklySlots non trovato!');
                return;
            }
            
            const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
            const giorniLabel = ['Luned', 'Marted', 'Mercoled', 'Gioved', 'Venerd', 'Sabato', 'Domenica'];

            const slotsHTML = giorni.map((giorno, index) => `
                <div class="day-slots">
                    <h4>${giorniLabel[index]}</h4>
                    <div class="time-slots" id="slots-${giorno}">
                        <button type="button" class="add-slot" onclick="addTimeSlot('${giorno}')">+ Aggiungi Slot</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = slotsHTML;
            console.log('Slot temporali inizializzati correttamente');
        }

        function addTimeSlot(giorno) {
            const container = document.getElementById(`slots-${giorno}`);
            if (!container) {
                console.error(`Container slots-${giorno} non trovato!`);
                return;
            }
            
            const slotId = `${giorno}-${Date.now()}`;
            
            const slotHTML = `
                <div class="slot-item" id="${slotId}">
                    <input type="time" value="09:00" onchange="validateSlots('${giorno}')" style="margin-right: 0.5rem;">
                    <span style="color: var(--text-secondary); margin: 0 0.5rem;">-</span>
                    <input type="time" value="11:00" onchange="validateSlots('${giorno}')" style="margin-right: 0.5rem;">
                    <button type="button" class="remove-slot" onclick="removeTimeSlot('${slotId}', '${giorno}')" title="Rimuovi slot"></button>
                </div>
            `;
            
            const addButton = container.querySelector('.add-slot');
            if (addButton) {
                addButton.insertAdjacentHTML('beforebegin', slotHTML);
                console.log(`Slot aggiunto per ${giorno}`);
            } else {
                console.error(`Pulsante add-slot non trovato per ${giorno}`);
            }
        }

        function removeTimeSlot(slotId, giorno) {
            const slot = document.getElementById(slotId);
            if (slot) {
                slot.remove();
                validateSlots(giorno);
            }
        }

        function validateSlots(giorno) {
            const container = document.getElementById(`slots-${giorno}`);
            if (!container) return true;
            
            const slots = container.querySelectorAll('.slot-item');
            
            const timeRanges = [];
            let hasOverlap = false;

            slots.forEach(slot => {
                const inputs = slot.querySelectorAll('input[type="time"]');
                const start = inputs[0].value;
                const end = inputs[1].value;
                
                // Reset stili
                inputs.forEach(input => {
                    input.style.borderColor = 'var(--border-color)';
                });

                if (start && end) {
                    if (start >= end) {
                        // Orario di fine deve essere dopo l'inizio
                        inputs.forEach(input => {
                            input.style.borderColor = 'var(--danger-color)';
                        });
                        hasOverlap = true;
                    } else {
                        timeRanges.push({ start, end, element: slot });
                    }
                }
            });

            // Controlla sovrapposizioni tra slot
            for (let i = 0; i < timeRanges.length; i++) {
                for (let j = i + 1; j < timeRanges.length; j++) {
                    const range1 = timeRanges[i];
                    const range2 = timeRanges[j];
                    
                    if (timeOverlap(range1.start, range1.end, range2.start, range2.end)) {
                        range1.element.querySelectorAll('input').forEach(input => {
                            input.style.borderColor = 'var(--danger-color)';
                        });
                        range2.element.querySelectorAll('input').forEach(input => {
                            input.style.borderColor = 'var(--danger-color)';
                        });
                        hasOverlap = true;
                    }
                }
            }

            return !hasOverlap;
        }

        function timeOverlap(start1, end1, start2, end2) {
            return (start1 < end2) && (end1 > start2);
        }

        function getWeeklySlots() {
            const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
            const slotSettimanali = {};

            giorni.forEach(giorno => {
                const container = document.getElementById(`slots-${giorno}`);
                if (!container) {
                    slotSettimanali[giorno] = [];
                    return;
                }
                
                const slots = container.querySelectorAll('.slot-item');
                slotSettimanali[giorno] = [];

                slots.forEach(slot => {
                    const inputs = slot.querySelectorAll('input[type="time"]');
                    const start = inputs[0].value;
                    const end = inputs[1].value;
                    
                    if (start && end && start < end) {
                        slotSettimanali[giorno].push({
                            inizio: start,
                            fine: end,
                            disponibile: true
                        });
                    }
                });
            });

            return slotSettimanali;
        }

        // === SMART SCHEDULER CON OPZIONI PERSONALIZZABILI ===
        function generateTodaySchedule() {
            if (materie.length === 0) {
                updateTodayDisplay(null, []);
                return;
            }

            const oggi = new Date();
            const giornoSettimana = ['domenica', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato'][oggi.getDay()];
            
            // Genera il piano smart per oggi
            const scheduleOggi = generateSmartSchedule(giornoSettimana);
            
            updateTodayDisplay(scheduleOggi.nextTask, scheduleOggi.timeline);
            updateMicroTasks(scheduleOggi.nextTask);
            updateRecoveryDashboard();
        }

        function generateSmartSchedule(giornoSettimana) {
            const materieFiltrate = materie.filter(materia => {
                const slots = materia.slotSettimanali && materia.slotSettimanali[giornoSettimana];
                return slots && slots.length > 0;
            });

            if (materieFiltrate.length === 0) {
                return { nextTask: null, timeline: [] };
            }

            const timeline = [];
            const now = new Date();
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            // Ordina materie per priorit e urgenza usando la pianificazione migliorata
            const materiePrioritarie = materieFiltrate.sort((a, b) => {
                const urgenzaA = generaPianoStudioIntelligente(a).urgenza;
                const urgenzaB = generaPianoStudioIntelligente(b).urgenza;
                const priorityOrder = { 'critica': 4, 'alta': 3, 'moderata': 2, 'normale': 1 };
                
                return (priorityOrder[urgenzaB] || 0) - (priorityOrder[urgenzaA] || 0);
            });

            let nextTask = null;

            materiePrioritarie.forEach(materia => {
                const slots = materia.slotSettimanali[giornoSettimana] || [];
                
                slots.forEach(slot => {
                    if (slot.disponibile) {
                        const durata = calculateTaskDuration(slot.inizio, slot.fine);
                        
                        const task = {
                            materia: materia.nome,
                            durata: durata,
                            orarioInizio: slot.inizio,
                            orarioFine: slot.fine,
                            difficolta: materia.difficolta,
                            pagineRimanenti: Math.max(0, materia.pagine - (materia.pagineStudiate || 0)),
                            percentualeCompletamento: ((materia.pagineStudiate || 0) / materia.pagine) * 100,
                            opzioni: generateTaskOptions(materia)
                        };

                        timeline.push(task);

                        // Il primo task futuro diventa il prossimo task
                        if (!nextTask && slot.inizio > currentTime) {
                            nextTask = task;
                        }
                    }
                });
            });

            // Se non ci sono task futuri, prendi il primo disponibile
            if (!nextTask && timeline.length > 0) {
                nextTask = timeline[0];
            }

            return { nextTask, timeline: timeline.sort((a, b) => a.orarioInizio.localeCompare(b.orarioInizio)) };
        }

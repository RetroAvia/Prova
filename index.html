<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Studio Smart - AI Enhanced Pro v3.1 Ingegneria Edition</title>
    
    <!-- ===================================================================== -->
    <!-- 🎨 SEZIONE CSS STYLES -->
    <!-- ===================================================================== -->
    <style>
        :root {
            --primary: #8b5cf6; --primary-dark: #7c3aed; --primary-light: #a78bfa;
            --secondary: #06d6a0; --secondary-dark: #05c296;
            --accent: #f59e0b; --danger: #ef4444; --warning: #f59e0b; --success: #10b981;
            --engineering: #3b82f6; --lab: #8b5cf6; --theory: #06b6d4; --exercise: #f59e0b;
            --bg-primary: #0f0f23; --bg-secondary: #1a1b3a; --bg-tertiary: #2d2f4f;
            --bg-card: #1e1f3f; --bg-hover: #252647;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8; --text-muted: #64748b;
            --border: #374151; --border-light: #4b5563;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            --transition: 0.3s ease; --border-radius: 12px; --border-radius-lg: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary); line-height: 1.6; min-height: 100vh; overflow-x: hidden;
        }

        /* Layout Components */
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .flex { display: flex; }
        .gap-2 { gap: 1rem; }
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 1rem; }
        .hidden { display: none !important; }
        .loading { opacity: 0.6; pointer-events: none; }
        .required { color: var(--danger); }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--engineering), var(--primary-dark));
            color: white; padding: 3rem 2rem; margin-bottom: 2rem;
            border-radius: var(--border-radius-lg); text-align: center;
            box-shadow: var(--shadow-xl); position: relative; overflow: hidden;
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 3rem); margin-bottom: 0.5rem; font-weight: 800;
            background: linear-gradient(45deg, #fff, #e0e7ff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p { font-size: clamp(1rem, 2.5vw, 1.2rem); opacity: 0.95; }

        /* Navigation */
        .nav-container {
            background: var(--bg-card); border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg); margin-bottom: 2rem; border: 1px solid var(--border);
            position: sticky; top: 20px; z-index: 100;
        }

        .nav-tabs {
            display: flex; padding: 8px; gap: 4px; overflow-x: auto;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .nav-tabs::-webkit-scrollbar { display: none; }

        .nav-tab {
            flex: 0 0 auto; min-width: 120px; padding: 16px 20px; border: none;
            background: transparent; color: var(--text-secondary); cursor: pointer;
            border-radius: var(--border-radius); transition: all var(--transition);
            font-weight: 600; font-size: 0.9rem; white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--engineering), var(--primary-dark));
            color: white; box-shadow: var(--shadow); transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: var(--bg-hover); color: var(--text-primary); transform: translateY(-1px);
        }

        /* Mobile Navigation */
        .mobile-nav-toggle {
            display: none; padding: 1rem; background: none; border: none;
            color: var(--text-primary); font-size: 1.5rem; cursor: pointer;
            border-radius: var(--border-radius);
        }

        .nav-dropdown {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: var(--bg-card); border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
            border-top: 1px solid var(--border); max-height: 60vh; overflow-y: auto;
        }

        .nav-dropdown.show { display: block; }
        .nav-dropdown .nav-tab {
            display: block; width: 100%; text-align: left; border-radius: 0;
            border-bottom: 1px solid var(--border-light);
        }

        /* Sections */
        .section { display: none; opacity: 0; transform: translateY(20px); transition: all 0.5s ease; }
        .section.active { display: block; opacity: 1; transform: translateY(0); }

        /* Cards */
        .card {
            background: var(--bg-card); border-radius: var(--border-radius-lg);
            padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow-lg);
            border: 1px solid var(--border); transition: all var(--transition);
            position: relative; overflow: hidden;
        }

        .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-xl); }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, var(--engineering), var(--secondary));
        }

        /* Buttons */
        .btn {
            padding: 16px 32px; border: none; border-radius: var(--border-radius);
            cursor: pointer; font-weight: 600; font-size: 1rem; transition: all var(--transition);
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            min-height: 48px; position: relative; overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--engineering), var(--primary-dark));
            color: white; box-shadow: var(--shadow);
        }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }

        .btn-secondary { background: linear-gradient(135deg, var(--secondary), var(--secondary-dark)); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #d97706); color: white; }
        .btn-engineering { background: linear-gradient(135deg, var(--engineering), #2563eb); color: white; }
        .btn-small { padding: 0.75rem 1rem; font-size: 0.85rem; min-height: 40px; }

        /* Forms */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; position: relative; }

        label {
            display: block; margin-bottom: 0.75rem; font-weight: 600;
            color: var(--text-primary); font-size: 0.95rem;
        }

        input, select, textarea {
            width: 100%; padding: 16px 20px; border: 2px solid var(--border);
            border-radius: var(--border-radius); font-size: 1rem;
            background: var(--bg-tertiary); color: var(--text-primary);
            transition: all var(--transition); font-family: inherit; min-height: 48px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--engineering); background: var(--bg-secondary);
            transform: translateY(-2px); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        /* Subject Selection for Pomodoro */
        .subject-selector {
            background: var(--bg-tertiary); border-radius: var(--border-radius-lg);
            padding: 2rem; margin-bottom: 2rem; border: 1px solid var(--border);
        }

        .subject-option {
            background: var(--bg-card); border: 2px solid var(--border);
            border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 1rem;
            cursor: pointer; transition: all var(--transition); position: relative;
        }

        .subject-option:hover {
            border-color: var(--engineering); transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .subject-option.selected {
            border-color: var(--engineering); background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .subject-option .progress-mini {
            height: 6px; background: var(--bg-tertiary); border-radius: 3px; margin-top: 0.5rem;
        }

        .subject-option .progress-mini-fill {
            height: 100%; border-radius: 3px; transition: width 0.3s ease;
            background: linear-gradient(90deg, var(--secondary), var(--engineering));
        }

        /* Stats */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-tertiary); border-radius: var(--border-radius);
            padding: 1.5rem; text-align: center; border: 1px solid var(--border);
            transition: all var(--transition);
        }

        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }

        .stat-number { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
        .stat-label { color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; }

        /* Progress Bar */
        .progress-bar {
            width: 100%; height: 12px; background: var(--bg-tertiary);
            border-radius: 6px; overflow: hidden; margin: 1rem 0;
        }

        .progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--secondary), var(--engineering));
            transition: width 0.8s ease; border-radius: 6px;
        }

        /* Timer */
        .timer-display {
            font-size: clamp(4rem, 10vw, 5rem); font-weight: 800;
            color: var(--engineering); margin: 3rem 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            text-align: center; transition: all var(--transition);
        }

        .timer-display.break-mode { color: var(--secondary); }

        /* Study Type Selector */
        .study-type-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem; margin: 1.5rem 0;
        }

        .study-type-card {
            background: var(--bg-card); border: 2px solid var(--border);
            border-radius: var(--border-radius); padding: 1.5rem; cursor: pointer;
            transition: all var(--transition); text-align: center;
        }

        .study-type-card:hover {
            transform: translateY(-3px); box-shadow: var(--shadow);
        }

        .study-type-card.selected {
            border-color: var(--engineering); background: rgba(59, 130, 246, 0.1);
        }

        .study-type-icon { font-size: 2.5rem; margin-bottom: 1rem; }
        .study-type-title { font-weight: 700; margin-bottom: 0.5rem; }
        .study-type-desc { font-size: 0.9rem; color: var(--text-secondary); }

        /* Weekly Slots */
        .weekly-slots-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem; margin: 2rem 0;
        }

        .day-slots {
            background: var(--bg-tertiary); border-radius: var(--border-radius);
            padding: 1.5rem; border: 1px solid var(--border);
        }

        .slot-item {
            display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;
            padding: 0.75rem; background: var(--bg-card); border-radius: 8px;
            border: 1px solid var(--border); flex-wrap: wrap;
        }

        /* Calendar */
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            background: var(--bg-card); border-radius: var(--border-radius);
            overflow: hidden; border: 1px solid var(--border);
        }

        .calendar-day {
            min-height: 120px; padding: 0.5rem; border: 1px solid var(--border);
            cursor: pointer; transition: all var(--transition);
            display: flex; flex-direction: column; position: relative;
        }

        .calendar-day:hover { background: var(--bg-hover); transform: scale(1.02); }
        .calendar-day.today { border: 2px solid var(--engineering); font-weight: 700; }
        .calendar-day.has-sessions { border-left: 4px solid var(--engineering); }

        /* Heatmap */
        .heatmap-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px; margin-top: 1.5rem;
        }

        .heatmap-cell {
            aspect-ratio: 1; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; transition: all var(--transition); min-height: 50px;
        }

        .heatmap-cell:hover { transform: scale(1.1); z-index: 10; }
        .heatmap-cell.empty { background: #374151; color: var(--text-muted); }
        .heatmap-cell.low { background: #ef4444; color: white; }
        .heatmap-cell.medium { background: #f59e0b; color: white; }
        .heatmap-cell.high { background: #10b981; color: white; }
        .heatmap-cell.very-high { background: #22c55e; color: white; }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: none; align-items: center;
            justify-content: center; z-index: 1000; padding: 20px;
        }

        .modal {
            background: var(--bg-card); border-radius: var(--border-radius-lg);
            padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh;
            overflow-y: auto; box-shadow: var(--shadow-xl); border: 1px solid var(--border);
        }

        .modal-large { max-width: 800px; width: 95%; }

        /* Star Rating */
        .star-rating { display: flex; gap: 6px; margin-top: 0.5rem; }
        .star {
            font-size: 1.8rem; color: var(--text-muted); cursor: pointer;
            transition: all var(--transition);
        }
        .star:hover { transform: scale(1.2); }
        .star.active { color: #fbbf24; }

        /* Empty State */
        .empty-state { text-align: center; padding: 3rem; color: var(--text-secondary); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

        /* Session Items */
        .session-item {
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1rem;
            display: flex; justify-content: space-between; align-items: center;
            transition: all var(--transition);
        }

        .session-item:hover { transform: translateX(4px); }

        /* Subject Items */
        .subject-item {
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 1.5rem;
            transition: all var(--transition); border-left: 4px solid var(--engineering);
        }

        .subject-item:hover { transform: translateX(8px); box-shadow: var(--shadow-lg); }

        /* Conflict indicator for timeline */
        .timeline-conflict {
            background: rgba(239, 68, 68, 0.1) !important;
            border-left-color: var(--danger) !important;
        }

        .timeline-conflict::after {
            content: '⚠️ Conflitto';
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in-up { animation: fadeInUp 0.6s ease; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse { animation: pulse 2s infinite; }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .nav-tabs { display: none; }
            .mobile-nav-toggle { display: block; }
            .nav-container { position: relative; }
            .container { padding: 15px; }
            .header { padding: 2rem 1rem; }
            .timer-display { font-size: 4rem; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 1.5rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .study-type-grid { grid-template-columns: 1fr; }
            .weekly-slots-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ===================================================================== -->
        <!-- 🔗 SEZIONE HEADER -->
        <!-- ===================================================================== -->
        <header class="header">
            <h1>🚀 Piano Studio Smart AI Pro v3.1</h1>
            <p>Ingegneria Edition - Assistente intelligente con gestione conflitti orari e modifica materie</p>
            <div style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
                Università di Napoli Vanvitelli - Ingegneria Aerospaziale
            </div>
        </header>

        <!-- ===================================================================== -->
        <!-- 🧭 SEZIONE NAVIGATION -->
        <!-- ===================================================================== -->
        <nav class="nav-container">
            <button class="mobile-nav-toggle" onclick="Navigation.toggleMobile()">☰ Menu</button>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="Navigation.showSection('oggi', this)">🌅 Oggi</button>
                <button class="nav-tab" onclick="Navigation.showSection('pomodoro', this)">🍅 Focus Timer</button>
                <button class="nav-tab" onclick="Navigation.showSection('materie', this)">📖 Materie</button>
                <button class="nav-tab" onclick="Navigation.showSection('curriculum', this)">🎓 Curriculum</button>
                <button class="nav-tab" onclick="Navigation.showSection('esami', this)">📊 Esami</button>
                <button class="nav-tab" onclick="Navigation.showSection('piano', this)">📋 Piano Studio</button>
                <button class="nav-tab" onclick="Navigation.showSection('calendario', this)">📅 Calendario</button>
                <button class="nav-tab" onclick="Navigation.showSection('statistiche', this)">📈 Analytics</button>
                <button class="nav-tab" onclick="Navigation.showSection('helper', this)">🎯 Helper</button>
                <button class="nav-tab" onclick="Navigation.showSection('impostazioni', this)">⚙️ Impostazioni</button>
            </div>
            <div class="nav-dropdown" id="navDropdown">
                <button class="nav-tab" onclick="Navigation.showSection('oggi', this); Navigation.closeMobile()">🌅 Oggi</button>
                <button class="nav-tab" onclick="Navigation.showSection('pomodoro', this); Navigation.closeMobile()">🍅 Focus Timer</button>
                <button class="nav-tab" onclick="Navigation.showSection('materie', this); Navigation.closeMobile()">📖 Materie</button>
                <button class="nav-tab" onclick="Navigation.showSection('curriculum', this); Navigation.closeMobile()">🎓 Curriculum</button>
                <button class="nav-tab" onclick="Navigation.showSection('esami', this); Navigation.closeMobile()">📊 Esami</button>
                <button class="nav-tab" onclick="Navigation.showSection('piano', this); Navigation.closeMobile()">📋 Piano Studio</button>
                <button class="nav-tab" onclick="Navigation.showSection('calendario', this); Navigation.closeMobile()">📅 Calendario</button>
                <button class="nav-tab" onclick="Navigation.showSection('statistiche', this); Navigation.closeMobile()">📈 Analytics</button>
                <button class="nav-tab" onclick="Navigation.showSection('helper', this); Navigation.closeMobile()">🎯 Helper</button>
                <button class="nav-tab" onclick="Navigation.showSection('impostazioni', this); Navigation.closeMobile()">⚙️ Impostazioni</button>
            </div>
        </nav>

        <!-- ===================================================================== -->
        <!-- 🔔 SEZIONE NOTIFICATIONS -->
        <!-- ===================================================================== -->
        <div class="notification-banner" id="notificationBanner">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 700;">📅 Promemoria Esame</div>
                    <div id="notificationText">Hai un esame tra 7 giorni!</div>
                </div>
                <button onclick="NotificationManager.hide()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer;">×</button>
            </div>
        </div>

        <!-- ===================================================================== -->
        <!-- 📱 SEZIONE MAIN CONTENT - TUTTE LE SEZIONI -->
        <!-- ===================================================================== -->
        <div class="main-content">
            
            <!-- ============= SEZIONE OGGI ============= -->
            <section id="oggi" class="section active">
                <!-- Anti-Procrastination Quick Start -->
                <div class="card fade-in-up" style="background: linear-gradient(135deg, var(--accent), #d97706); color: white; text-align: center;">
                    <h3>⚡ Quick Start Anti-Procrastinazione</h3>
                    <p style="opacity: 0.9; margin-bottom: 1.5rem;">Non sai da dove iniziare? Prova una micro-sessione!</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <button class="btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="AntiProcrastination.quickStart(5)">
                            🚀 5 min Quick Start
                        </button>
                        <button class="btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="AntiProcrastination.quickStart(10)">
                            ⚡ 10 min Warm-up
                        </button>
                        <button class="btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="AntiProcrastination.showBreakdown()">
                            🎯 Spezza l'Obiettivo
                        </button>
                    </div>
                    
                    <div id="motivationalQuote" style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; font-style: italic;">
                        "Il modo migliore per iniziare è smettere di parlare e iniziare a fare." - Walt Disney
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>🌅 Dashboard Ingegneria</h3>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--engineering);" id="todayStudyHours">0h</div>
                            <div class="stat-label">Ore Oggi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--success);" id="completedExams">0</div>
                            <div class="stat-label">Esami Completati</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning);" id="totalCFU">0</div>
                            <div class="stat-label">CFU Acquisiti</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--secondary);" id="averageGrade">0.0</div>
                            <div class="stat-label">Media Ponderata</div>
                        </div>
                    </div>

                    <div id="nextTaskCard" class="card" style="background: linear-gradient(135deg, var(--engineering), var(--primary-dark)); color: white;">
                        <h4>🎯 Prossimo Focus Intelligente</h4>
                        <div id="nextTaskContent">
                            <p>Aggiungi materie per vedere il tuo piano di studio intelligente!</p>
                        </div>
                        <button class="btn" style="background: rgba(255,255,255,0.2); color: white; margin-top: 1rem;" onclick="Navigation.showSection('pomodoro', document.querySelector('.nav-tab[onclick*=pomodoro]'))">
                            🚀 Inizia Sessione Studio
                        </button>
                    </div>

                    <div id="todayTimeline" class="card">
                        <h4>📋 Programma di Oggi</h4>
                        <div id="todayTimelineContent">
                            <div class="empty-state">
                                <div class="empty-state-icon">📅</div>
                                <p>Aggiungi slot temporali alle materie per vedere il piano giornaliero</p>
                            </div>
                        </div>
                    </div>

                    <!-- Study Assistant Chat -->
                    <div class="card fade-in-up" style="background: linear-gradient(135deg, var(--secondary), var(--secondary-dark)); color: white;">
                        <h4 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            🤖 Study Assistant AI
                            <button onclick="StudyAssistant.toggle()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-size: 0.8rem;">
                                Chat
                            </button>
                        </h4>
                        <div id="aiSuggestion" style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">
                                🎯 Basandomi sui tuoi dati, ti consiglio di iniziare con una sessione di teoria per la materia con priorità più alta.
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ============= SEZIONE POMODORO ============= -->
            <section id="pomodoro" class="section">
                <!-- Subject Selection Card -->
                <div class="subject-selector" id="subjectSelectorCard">
                    <h3>📚 Seleziona Materia da Studiare</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Scegli la materia e il tipo di studio per iniziare la tua sessione focus
                    </p>
                    
                    <div id="subjectSelection" class="hidden">
                        <div id="subjectList">
                            <!-- Populated by JavaScript -->
                        </div>
                        
                        <div class="study-type-grid" id="studyTypeSelection" style="margin-top: 2rem;">
                            <div class="study-type-card" data-type="theory" onclick="StudyTypeManager.select('theory', this)">
                                <div class="study-type-icon">📖</div>
                                <div class="study-type-title">Teoria</div>
                                <div class="study-type-desc">Studio di concetti, definizioni e teoremi</div>
                            </div>
                            <div class="study-type-card" data-type="exercise" onclick="StudyTypeManager.select('exercise', this)">
                                <div class="study-type-icon">💪</div>
                                <div class="study-type-title">Esercizi</div>
                                <div class="study-type-desc">Risoluzione di problemi e applicazioni</div>
                            </div>
                            <div class="study-type-card" data-type="lab" onclick="StudyTypeManager.select('lab', this)">
                                <div class="study-type-icon">🔬</div>
                                <div class="study-type-title">Laboratorio</div>
                                <div class="study-type-desc">Progetti pratici e sperimentazioni</div>
                            </div>
                            <div class="study-type-card" data-type="review" onclick="StudyTypeManager.select('review', this)">
                                <div class="study-type-icon">🔄</div>
                                <div class="study-type-title">Ripasso</div>
                                <div class="study-type-desc">Revisione e consolidamento</div>
                            </div>
                        </div>
                    </div>

                    <div id="noSubjectsMessage">
                        <div class="empty-state">
                            <div class="empty-state-icon">📚</div>
                            <p>Nessuna materia disponibile</p>
                            <button class="btn btn-engineering mt-2" onclick="Navigation.showSection('materie', document.querySelector('.nav-tab[onclick*=materie]'))">
                                ➕ Aggiungi Prima Materia
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Timer Card -->
                <div class="card fade-in-up" id="timerCard">
                    <div style="text-align: center;">
                        <h3>🍅 Focus Timer</h3>
                        
                        <div id="selectedStudyInfo" class="hidden" style="background: rgba(59, 130, 246, 0.1); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0;">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                <div style="font-size: 1.1rem; font-weight: 600; color: var(--engineering);" id="selectedSubjectName">-</div>
                                <div style="padding: 0.5rem 1rem; background: var(--engineering); color: white; border-radius: 20px; font-size: 0.9rem;" id="selectedStudyType">-</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin: 2rem 0;">
                            <button class="btn btn-secondary active" onclick="TimerManager.setPreset(25, 5, this)">25/5 min</button>
                            <button class="btn btn-secondary" onclick="TimerManager.setPreset(50, 10, this)">50/10 min</button>
                            <button class="btn btn-secondary" onclick="TimerManager.setPreset(90, 20, this)">90/20 min</button>
                            <button class="btn btn-secondary" onclick="UI.showCustomTimerDialog()">Personalizza</button>
                        </div>

                        <div class="timer-display" id="timerDisplay">25:00</div>

                        <div class="flex gap-2" style="justify-content: center; margin-bottom: 3rem; flex-wrap: wrap;">
                            <button class="btn btn-engineering" id="startBtn" onclick="TimerManager.start()">▶️ Inizia Focus</button>
                            <button class="btn btn-warning hidden" id="pauseBtn" onclick="TimerManager.pause()">⏸️ Pausa</button>
                            <button class="btn btn-danger" onclick="TimerManager.reset()">🔄 Reset</button>
                        </div>

                        <div>
                            <p><strong>Sessioni completate oggi:</strong> <span id="sessionCount">0</span> / <span id="sessionGoal">8</span></p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="sessionProgress" style="width: 0%"></div>
                            </div>
                            <small id="progressText" style="color: var(--text-secondary);">Seleziona una materia per iniziare!</small>
                        </div>
                    </div>
                </div>

                <!-- Today's Sessions -->
                <div class="card fade-in-up">
                    <div class="flex gap-2 mb-2" style="justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <h3 style="margin: 0;">📊 Sessioni di Oggi</h3>
                        <button class="btn btn-danger btn-small" onclick="SessionManager.deleteAllToday()">🗑️ Elimina tutte</button>
                    </div>
                    <div id="todaySessionsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">🍅</div>
                            <p>Nessuna sessione completata oggi.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ============= SEZIONE MATERIE ============= -->
            <section id="materie" class="section">
                <div class="card" style="background: linear-gradient(135deg, var(--accent), #d97706); color: white; text-align: center;">
                    <h3>🔥 Studio Streak</h3>
                    <div id="streakNumber" style="font-size: clamp(3rem, 8vw, 4rem); font-weight: 800;">0</div>
                    <p style="font-size: 1.1rem; opacity: 0.9;">giorni consecutivi</p>
                </div>

                <div class="card fade-in-up">
                    <h3 id="materieFormTitle">➕ Aggiungi Nuova Materia</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomeMateria">Nome Materia <span class="required">*</span></label>
                            <input type="text" id="nomeMateria" required placeholder="Es. Analisi Matematica I">
                        </div>
                        <div class="form-group">
                            <label for="cfu">CFU <span class="required">*</span></label>
                            <input type="number" id="cfu" min="1" max="30" required placeholder="Es. 9">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="anno">Anno <span class="required">*</span></label>
                            <select id="anno" required>
                                <option value="">Seleziona Anno</option>
                                <option value="1">1° Anno</option>
                                <option value="2">2° Anno</option>
                                <option value="3">3° Anno</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="semestre">Semestre <span class="required">*</span></label>
                            <select id="semestre" required>
                                <option value="">Seleziona Semestre</option>
                                <option value="1">I Semestre</option>
                                <option value="2">II Semestre</option>
                                <option value="annuale">Annuale</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="materiaType">Tipo Materia</label>
                            <select id="materiaType">
                                <option value="theory">Teorica</option>
                                <option value="practical">Pratica</option>
                                <option value="mixed">Mista</option>
                                <option value="lab">Laboratorio</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dataEsame">Data Esame</label>
                            <input type="date" id="dataEsame">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pagineStudio">Pagine di Studio</label>
                            <input type="number" id="pagineStudio" min="0" placeholder="Es. 450">
                        </div>
                        <div class="form-group">
                            <label for="numeroEsercizi">Numero Esercizi Totali</label>
                            <input type="number" id="numeroEsercizi" min="0" placeholder="Es. 150">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="priorita">Priorità</label>
                            <select id="priorita">
                                <option value="alta">Alta</option>
                                <option value="media" selected>Media</option>
                                <option value="bassa">Bassa</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Difficoltà Percepita</label>
                            <div class="star-rating" id="difficolta">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>⏰ Slot Temporali Settimanali</label>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Definisci gli slot orari in cui puoi studiare questa materia
                        </p>
                        <div id="weeklySlots" class="weekly-slots-container"></div>
                    </div>

                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                        <button type="button" class="btn btn-engineering" id="saveBtn" onclick="MaterieManager.add()">✅ Aggiungi Materia</button>
                        <button type="button" class="btn btn-secondary hidden" id="updateBtn" onclick="MaterieManager.update()">💾 Salva Modifiche</button>
                        <button type="button" class="btn btn-danger hidden" id="cancelBtn" onclick="MaterieManager.cancelEdit()">❌ Annulla</button>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>📚 Le Tue Materie</h3>
                    <div id="materieList">
                        <div class="empty-state">
                            <div class="empty-state-icon">📚</div>
                            <p>Nessuna materia aggiunta ancora.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ============= SEZIONE CURRICULUM ============= -->
            <section id="curriculum" class="section">
                <div class="flex gap-2 mb-2" style="align-items: center; flex-wrap: wrap;">
                    <div style="background: var(--bg-tertiary); border-radius: var(--border-radius); padding: 4px; border: 1px solid var(--border);">
                        <button class="nav-tab active" onclick="CurriculumManager.showYear(1, this)">1° Anno</button>
                        <button class="nav-tab" onclick="CurriculumManager.showYear(2, this)">2° Anno</button>
                        <button class="nav-tab" onclick="CurriculumManager.showYear(3, this)">3° Anno</button>
                    </div>
                    <button class="btn btn-engineering btn-small" onclick="UI.showAddSubjectModal()">➕ Aggiungi</button>
                    <button class="btn btn-secondary btn-small" onclick="CurriculumManager.export()">📤 Esporta</button>
                </div>

                <div id="curriculumContainer">
                    <div id="year-1" class="year-content active">
                        <div class="card fade-in-up">
                            <div class="flex gap-2 mb-2" style="justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
                                <h3>🎓 Primo Anno</h3>
                                <div class="flex gap-2" style="flex-wrap: wrap;">
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--secondary);" id="year1-subjects">0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">Materie</div>
                                    </div>
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--warning);" id="year1-cfu">0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">CFU</div>
                                    </div>
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--primary);" id="year1-average">0.0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">Media</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                                <div>
                                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">📚 I Semestre</h4>
                                    <div id="year1-semester1-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia aggiunta</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">📚 II Semestre</h4>
                                    <div id="year1-semester2-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia aggiunta</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: var(--accent); margin-bottom: 1rem;">📅 Annuali</h4>
                                    <div id="year1-annuale-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia annuale</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="year-2" class="year-content hidden">
                        <div class="card fade-in-up">
                            <div class="flex gap-2 mb-2" style="justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
                                <h3>🎓 Secondo Anno</h3>
                                <div class="flex gap-2" style="flex-wrap: wrap;">
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--secondary);" id="year2-subjects">0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">Materie</div>
                                    </div>
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--warning);" id="year2-cfu">0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">CFU</div>
                                    </div>
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--primary);" id="year2-average">0.0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">Media</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                                <div>
                                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">📚 I Semestre</h4>
                                    <div id="year2-semester1-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia aggiunta</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">📚 II Semestre</h4>
                                    <div id="year2-semester2-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia aggiunta</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: var(--accent); margin-bottom: 1rem;">📅 Annuali</h4>
                                    <div id="year2-annuale-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia annuale</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="year-3" class="year-content hidden">
                        <div class="card fade-in-up">
                            <div class="flex gap-2 mb-2" style="justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
                                <h3>🎓 Terzo Anno</h3>
                                <div class="flex gap-2" style="flex-wrap: wrap;">
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--secondary);" id="year3-subjects">0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">Materie</div>
                                    </div>
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--warning);" id="year3-cfu">0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">CFU</div>
                                    </div>
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--primary);" id="year3-average">0.0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">Media</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                                <div>
                                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">📚 I Semestre</h4>
                                    <div id="year3-semester1-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia aggiunta</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">📚 II Semestre</h4>
                                    <div id="year3-semester2-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia aggiunta</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: var(--accent); margin-bottom: 1rem;">📅 Annuali</h4>
                                    <div id="year3-annuale-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia annuale</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ============= SEZIONE ESAMI ============= -->
            <section id="esami" class="section">
                <div class="card fade-in-up">
                    <h3>📊 Statistiche Esami</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--success);" id="examTotalExams">0</div>
                            <div class="stat-label">Esami Sostenuti</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning);" id="examTotalCFU">0</div>
                            <div class="stat-label">CFU Acquisiti</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--primary);" id="examWeightedAverage">0.00</div>
                            <div class="stat-label">Media Ponderata</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--secondary);" id="examProjectedGrade">0</div>
                            <div class="stat-label">Voto Laurea Est.</div>
                        </div>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>🎓 Esami Sostenuti</h3>
                    <div id="examsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">🎓</div>
                            <p>Nessun esame sostenuto ancora.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ============= SEZIONE PIANO STUDIO ============= -->
            <section id="piano" class="section">
                <div class="card fade-in-up" style="background: linear-gradient(135deg, var(--engineering), var(--primary-dark)); color: white;">
                    <h4>🎯 Piano di Studio Intelligente</h4>
                    <p id="planSummary">Caricamento piano personalizzato...</p>
                    
                    <div class="stats-grid mt-2">
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: var(--border-radius); text-align: center;">
                            <div id="totalWeeklyHours" style="font-size: 1.8rem; font-weight: 800; margin-bottom: 0.25rem;">0h</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Ore Settimanali</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: var(--border-radius); text-align: center;">
                            <div id="avgDailyHours" style="font-size: 1.8rem; font-weight: 800; margin-bottom: 0.25rem;">0h</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Media Giornaliera</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: var(--border-radius); text-align: center;">
                            <div id="totalPages" style="font-size: 1.8rem; font-weight: 800; margin-bottom: 0.25rem;">0</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Pagine Rimanenti</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: var(--border-radius); text-align: center;">
                            <div id="completionWeeks" style="font-size: 1.8rem; font-weight: 800; margin-bottom: 0.25rem;">0</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Settimane Stimate</div>
                        </div>
                    </div>
                </div>

                <div class="card fade-in-up" style="background: rgba(6, 214, 160, 0.1); border: 1px solid rgba(6, 214, 160, 0.3);">
                    <h3 style="color: var(--secondary);">🤖 Suggerimenti AI</h3>
                    <div id="suggestionsList">
                        <div style="background: rgba(6, 214, 160, 0.05); border: 1px solid rgba(6, 214, 160, 0.2); border-radius: 12px; padding: 1rem;">
                            <div style="font-weight: 600; color: var(--secondary); margin-bottom: 0.5rem;">💡 Analizzando i tuoi dati...</div>
                            <div style="color: var(--text-primary);">Il sistema sta elaborando raccomandazioni personalizzate.</div>
                        </div>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>📋 Dettagli Piano</h3>
                    <div id="pianDetails">
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <p>Aggiungi delle materie per generare il tuo piano personalizzato!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ============= SEZIONE CALENDARIO ============= -->
            <section id="calendario" class="section">
                <div class="card fade-in-up">
                    <h3>📅 Navigazione Calendario</h3>
                    <div class="flex gap-2" style="justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <div class="flex gap-2" style="align-items: center;">
                            <button class="btn btn-secondary btn-small" onclick="CalendarManager.changeMonth(-1)">◀ Prec</button>
                            <h4 id="currentMonthYear" style="margin: 0; min-width: 200px; text-align: center;">Gennaio 2024</h4>
                            <button class="btn btn-secondary btn-small" onclick="CalendarManager.changeMonth(1)">Succ ▶</button>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-engineering btn-small" onclick="CalendarManager.goToToday()">📍 Oggi</button>
                            <button class="btn btn-warning btn-small" onclick="CalendarManager.addManualSession()">➕ Sessione</button>
                        </div>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <div style="background: var(--bg-card); border-radius: var(--border-radius-lg); overflow: hidden; box-shadow: var(--shadow-lg); border: 1px solid var(--border);">
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); background: var(--bg-tertiary); border-bottom: 1px solid var(--border);">
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--engineering);">Lun</div>
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--engineering);">Mar</div>
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--engineering);">Mer</div>
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--engineering);">Gio</div>
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--engineering);">Ven</div>
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--engineering);">Sab</div>
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--engineering);">Dom</div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>📊 Statistiche del Mese</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--engineering);" id="monthSessions">0</div>
                            <div class="stat-label">Sessioni Totali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--secondary);" id="monthHours">0h</div>
                            <div class="stat-label">Ore di Studio</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning);" id="monthDays">0</div>
                            <div class="stat-label">Giorni Attivi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--accent);" id="monthAverage">0</div>
                            <div class="stat-label">Media/Giorno</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ============= SEZIONE STATISTICHE ============= -->
            <section id="statistiche" class="section">
                <div class="card fade-in-up">
                    <h3>📊 Statistiche e Progressi</h3>
                    <div id="statisticheContent">
                        <div class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <p>Aggiungi delle materie per vedere i tuoi progressi!</p>
                        </div>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>🔥 Heatmap Oraria della Produttività</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Visualizza i tuoi momenti più produttivi durante la giornata
                    </p>
                    <div class="heatmap-grid" id="heatmapGrid"></div>
                    <div class="flex gap-2" style="justify-content: center; margin-top: 1.5rem; flex-wrap: wrap;">
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 16px; height: 16px; background: #374151; border-radius: 4px;"></div>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Nessun dato</span>
                        </div>
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 16px; height: 16px; background: #ef4444; border-radius: 4px;"></div>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Bassa</span>
                        </div>
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 16px; height: 16px; background: #f59e0b; border-radius: 4px;"></div>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Media</span>
                        </div>
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 16px; height: 16px; background: #10b981; border-radius: 4px;"></div>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Alta</span>
                        </div>
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 16px; height: 16px; background: #22c55e; border-radius: 4px;"></div>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Eccellente</span>
                        </div>
                    </div>

                    <div class="mt-2">
                        <h4 style="margin-bottom: 1rem;">🏆 Le Tue Top 3 Ore Migliori</h4>
                        <div id="topHoursGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">📊</div>
                                <p>Completa alcune sessioni per scoprire i tuoi orari migliori!</p>
                            </div>
                        </div>
                        
                        <div id="productivitySuggestion" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 1.5rem;">
                            <h4 style="color: var(--engineering); margin-bottom: 0.75rem;">💡 Suggerimento Smart</h4>
                            <p style="color: var(--text-primary);">Aggiungi delle sessioni di studio per scoprire i tuoi momenti più produttivi!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ============= SEZIONE HELPER ============= -->
            <section id="helper" class="section">
                <div class="card fade-in-up" style="background: linear-gradient(135deg, var(--accent), #d97706); color: white;">
                    <h3>🎯 Assistente Organizzazione Semestre</h3>
                    <p style="margin-bottom: 1.5rem; opacity: 0.9;">Non sai come organizzarti? Lascia che ti guidi nella pianificazione!</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                        <div onclick="SemesterWizard.open()" style="background: rgba(255, 255, 255, 0.1); padding: 1.5rem; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition); border: 2px solid transparent;">
                            <h4 style="margin-bottom: 0.5rem;">🎓 Wizard Semestre</h4>
                            <p style="opacity: 0.9;">Pianificazione completa e personalizzata per tutto il semestre</p>
                        </div>
                        
                        <div onclick="HelperManager.prioritizeByDate()" style="background: rgba(255, 255, 255, 0.1); padding: 1.5rem; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition); border: 2px solid transparent;">
                            <h4 style="margin-bottom: 0.5rem;">📅 Priorità per Scadenze</h4>
                            <p style="opacity: 0.9;">Ordina le materie in base alle date degli esami</p>
                        </div>
                        
                        <div onclick="HelperManager.prioritizeByDifficulty()" style="background: rgba(255, 255, 255, 0.1); padding: 1.5rem; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition); border: 2px solid transparent;">
                            <h4 style="margin-bottom: 0.5rem;">⭐ Priorità per Difficoltà</h4>
                            <p style="opacity: 0.9;">Inizia dalle materie più difficili</p>
                        </div>
                        
                        <div onclick="HelperManager.balancedApproach()" style="background: rgba(255, 255, 255, 0.1); padding: 1.5rem; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition); border: 2px solid transparent;">
                            <h4 style="margin-bottom: 0.5rem;">⚖️ Approccio Bilanciato</h4>
                            <p style="opacity: 0.9;">Mix intelligente tra scadenze e difficoltà</p>
                        </div>
                    </div>
                </div>

                <div class="card hidden fade-in-up" id="helperResults">
                    <h3>📋 Piano Raccomandato</h3>
                    <div id="helperContent"></div>
                </div>
            </section>

            <!-- ============= SEZIONE IMPOSTAZIONI ============= -->
            <section id="impostazioni" class="section">
                <div class="card fade-in-up" style="background: linear-gradient(135deg, var(--danger), #dc2626); color: white; text-align: center;">
                    <h3>⚙️ Impostazioni App</h3>
                    <p style="margin-bottom: 1.5rem;">Gestisci i dati dell'applicazione e le configurazioni</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;">
                        <button onclick="DataManager.exportAll()" style="background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); color: white; padding: 1rem 2rem; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; transition: all var(--transition);">
                            📤 Esporta Dati
                        </button>
                        <button onclick="DataManager.importAll()" style="background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); color: white; padding: 1rem 2rem; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; transition: all var(--transition);">
                            📥 Importa Dati
                        </button>
                        <button onclick="DataManager.showResetConfirmation()" style="background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); color: white; padding: 1rem 2rem; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; transition: all var(--transition);">
                            🗑️ Reset Completo
                        </button>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>🔧 Preferenze App</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="autoBackup">💾 Backup Automatico</label>
                            <select id="autoBackup" onchange="SettingsManager.updateAutoBackup()">
                                <option value="disabled">Disabilitato</option>
                                <option value="daily" selected>Giornaliero</option>
                                <option value="weekly">Settimanale</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="examNotifications">🔔 Notifiche Esami</label>
                            <select id="examNotifications" onchange="SettingsManager.updateExamNotifications()">
                                <option value="disabled">Disabilitate</option>
                                <option value="7days" selected>7 giorni prima</option>
                                <option value="3days">3 giorni prima</option>
                                <option value="1day">1 giorno prima</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Study Assistant Chat Modal -->
    <div class="modal-overlay" id="studyAssistantModal">
        <div class="modal modal-large">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 2px solid var(--border); padding-bottom: 1rem;">
                <h3 style="margin: 0;">🤖 Study Assistant AI</h3>
                <button onclick="StudyAssistant.close()" style="background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer;">×</button>
            </div>
            
            <div id="chatContainer" style="height: 400px; overflow-y: auto; background: var(--bg-tertiary); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--border);">
                <div class="chat-message assistant-message">
                    <div style="background: var(--secondary); color: white; padding: 0.75rem; border-radius: 12px; margin-bottom: 1rem; max-width: 80%;">
                        Ciao! Sono il tuo assistente di studio AI. Posso aiutarti con consigli personalizzati, motivazione e strategie di studio. Come posso aiutarti oggi?
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="chatInput" placeholder="Scrivi qui la tua domanda..." style="flex: 1;" onkeypress="if(event.key==='Enter') StudyAssistant.sendMessage()">
                <button class="btn btn-engineering" onclick="StudyAssistant.sendMessage()">Invia</button>
            </div>
            
            <div style="margin-top: 1rem;">
                <h4 style="margin-bottom: 0.5rem;">💡 Domande Rapide:</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                    <button class="btn btn-secondary btn-small" onclick="StudyAssistant.quickQuestion('Come posso smettere di procrastinare?')">🚀 Anti-procrastinazione</button>
                    <button class="btn btn-secondary btn-small" onclick="StudyAssistant.quickQuestion('Quale materia dovrei studiare per prima?')">📚 Priorità materie</button>
                    <button class="btn btn-secondary btn-small" onclick="StudyAssistant.quickQuestion('Come posso migliorare la concentrazione?')">🎯 Concentrazione</button>
                    <button class="btn btn-secondary btn-small" onclick="StudyAssistant.quickQuestion('Dammi consigli motivazionali')">💪 Motivazione</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Micro Goals Breakdown Modal -->
    <div class="modal-overlay" id="microGoalsModal">
        <div class="modal">
            <h3>🎯 Spezza l'Obiettivo in Micro-Task</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Trasforma un grande obiettivo in piccoli passi gestibili per ridurre l'ansia da studio.
            </p>
            
            <div class="form-group">
                <label for="mainGoal">Qual è il tuo obiettivo principale oggi?</label>
                <input type="text" id="mainGoal" placeholder="Es. Studiare il capitolo 3 di Analisi Matematica">
            </div>
            
            <div id="microTasksList" style="margin: 1.5rem 0;">
                <!-- Popolato dinamicamente -->
            </div>
            
            <div class="flex gap-2 mt-2">
                <button class="btn btn-engineering" onclick="AntiProcrastination.generateMicroTasks()">🎯 Genera Micro-Task</button>
                <button class="btn btn-secondary" onclick="AntiProcrastination.closeMicroGoals()">❌ Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Semester Planning Wizard Modal -->
    <div class="modal-overlay" id="semesterWizardModal">
        <div class="modal modal-large">
            <h3>🎓 Wizard Pianificazione Semestre</h3>
            
            <div id="wizardStep1" class="wizard-step">
                <h4>Passo 1: Analisi delle Materie</h4>
                <p>Analizziamo le tue materie per creare il piano ottimale:</p>
                
                <div style="margin: 1.5rem 0;">
                    <h5>Priorità principali per questo semestre:</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" value="cfu"> Massimizzare i CFU
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" value="media"> Mantenere media alta
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" value="scadenze"> Rispettare scadenze
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" value="difficolta"> Affrontare materie difficili
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-engineering" onclick="SemesterWizard.nextStep(2)">Avanti →</button>
            </div>
            
            <div id="wizardStep2" class="wizard-step hidden">
                <h4>Passo 2: Piano Personalizzato</h4>
                <div id="recommendedPlan">
                    <!-- Popolato dinamicamente -->
                </div>
                
                <div class="flex gap-2 mt-2">
                    <button class="btn btn-secondary" onclick="SemesterWizard.nextStep(1)">← Indietro</button>
                    <button class="btn btn-engineering" onclick="SemesterWizard.applyPlan()">✅ Applica Piano</button>
                    <button class="btn btn-danger" onclick="SemesterWizard.close()">❌ Chiudi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================================================================== -->
    <!-- 🔧 SEZIONE MODALS -->
    <!-- ===================================================================== -->
    
    <!-- Session Rating Modal Enhanced -->
    <div class="modal-overlay" id="sessionRatingModal">
        <div class="modal">
            <h3>🎉 Sessione Completata!</h3>
            
            <div id="sessionSummary" style="background: rgba(59, 130, 246, 0.1); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="font-weight: 700;" id="completedSubject">Materia</div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);" id="completedDuration">25 min</div>
                </div>
                <div style="font-size: 0.9rem; color: var(--engineering);" id="completedType">Tipo di studio</div>
            </div>

            <div class="form-group">
                <label for="progressInput">Progresso completato in questa sessione:</label>
                <div id="progressInputContainer">
                    <!-- Dinamically populated based on study type -->
                </div>
            </div>

            <div class="form-group">
                <label for="sessionNotes">Note (opzionale):</label>
                <textarea id="sessionNotes" rows="3" placeholder="Es. Completato capitolo 3, risolti 5 esercizi..."></textarea>
            </div>

            <div class="form-group">
                <label>Come ti sei sentito durante questa sessione?</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="SessionTracker.rate(1)">😴 Stanco</button>
                    <button class="btn btn-secondary" onclick="SessionTracker.rate(2)">😐 Normale</button>
                    <button class="btn btn-secondary" onclick="SessionTracker.rate(3)">😊 Bene</button>
                    <button class="btn btn-secondary" onclick="SessionTracker.rate(4)">🔥 Eccellente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Timer Modal -->
    <div class="modal-overlay" id="customTimerModal">
        <div class="modal">
            <h3>⚙️ Timer Personalizzato</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="customWorkTime">Minuti di Studio:</label>
                    <input type="number" id="customWorkTime" min="1" max="180" value="25" placeholder="25">
                </div>
                <div class="form-group">
                    <label for="customBreakTime">Minuti di Pausa:</label>
                    <input type="number" id="customBreakTime" min="0" max="60" value="5" placeholder="5">
                </div>
            </div>
            <div class="flex gap-2 mt-2">
                <button class="btn btn-engineering" onclick="TimerManager.applyCustom()">✅ Applica</button>
                <button class="btn btn-secondary" onclick="UI.closeCustomTimerModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- Add Subject Modal -->
    <div class="modal-overlay" id="addSubjectModal">
        <div class="modal">
            <h3>➕ Aggiungi Materia al Curriculum</h3>
            <div class="form-group">
                <label for="currSubjectName">Nome Materia <span class="required">*</span></label>
                <input type="text" id="currSubjectName" required placeholder="Es. Analisi Matematica I">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="currSubjectYear">Anno <span class="required">*</span></label>
                    <select id="currSubjectYear" required>
                        <option value="1">1° Anno</option>
                        <option value="2">2° Anno</option>
                        <option value="3">3° Anno</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="currSubjectSemester">Semestre <span class="required">*</span></label>
                    <select id="currSubjectSemester" required>
                        <option value="1">I Semestre</option>
                        <option value="2">II Semestre</option>
                        <option value="annuale">Annuale (Entrambi)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="currSubjectCFU">CFU <span class="required">*</span></label>
                <input type="number" id="currSubjectCFU" min="1" max="30" required placeholder="Es. 9">
            </div>
            <div class="flex gap-2 mt-2">
                <button class="btn btn-engineering" onclick="CurriculumManager.saveSubject()">✅ Aggiungi</button>
                <button class="btn btn-secondary" onclick="UI.closeAddSubjectModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- Exam Modal -->
    <div class="modal-overlay" id="examModal">
        <div class="modal">
            <h3>🎓 Registra Esame Sostenuto</h3>
            <div class="form-group">
                <label for="examSubject">Materia:</label>
                <input type="text" id="examSubject" readonly style="background: var(--bg-secondary);">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="examGrade">Voto (18-30):</label>
                    <input type="number" id="examGrade" min="18" max="30" placeholder="30">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="examLode"> Lode
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label for="examDate">Data Esame:</label>
                <input type="date" id="examDate">
            </div>
            <div class="flex gap-2 mt-2">
                <button class="btn btn-success" onclick="ExamManager.saveGrade()">✅ Salva</button>
                <button class="btn btn-secondary" onclick="UI.closeExamModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- Add Session Modal -->
    <div class="modal-overlay" id="addSessionModal">
        <div class="modal">
            <h3>➕ Aggiungi Sessione Studio</h3>
            <div class="form-group">
                <label for="sessionDate">Data:</label>
                <input type="date" id="sessionDate">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="sessionMateria">Materia:</label>
                    <select id="sessionMateria">
                        <option value="">Sessione generica</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sessionDuration">Durata (minuti):</label>
                    <input type="number" id="sessionDuration" min="5" max="300" value="25">
                </div>
            </div>
            <div class="form-group">
                <label for="sessionNote">Note (opzionale):</label>
                <input type="text" id="sessionNote" placeholder="Es. Capitolo 3 - Derivate">
            </div>
            <div class="flex gap-2 mt-2">
                <button class="btn btn-engineering" onclick="CalendarManager.saveManualSession()">✅ Aggiungi</button>
                <button class="btn btn-secondary" onclick="UI.closeAddSessionModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div class="modal-overlay" id="resetConfirmationModal">
        <div class="modal">
            <h3>⚠️ Conferma Reset Completo</h3>
            <div style="text-align: center; margin: 2rem 0;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🗑️</div>
                <p style="margin-bottom: 1rem;"><strong>ATTENZIONE:</strong> Eliminerai TUTTI i dati dell'app!</p>
                <p style="color: var(--danger); font-weight: 600;">Questa azione NON può essere annullata!</p>
            </div>
            <div class="form-group">
                <label for="resetConfirmText">Scrivi "RESET" per confermare:</label>
                <input type="text" id="resetConfirmText" placeholder="RESET" style="text-align: center; text-transform: uppercase;">
            </div>
            <div class="flex gap-2 mt-2">
                <button class="btn btn-danger" onclick="DataManager.performReset()">🗑️ Reset</button>
                <button class="btn btn-secondary" onclick="DataManager.closeResetModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- ===================================================================== -->
    <!-- 💾 SEZIONE JAVASCRIPT - STATO GLOBALE E MANAGERS -->
    <!-- ===================================================================== -->
    <script>
        
        // ========================================
        // 🌐 STATO GLOBALE DELL'APPLICAZIONE
        // ========================================
        const APP_STATE = {
            // Core data
            materie: JSON.parse(localStorage.getItem('materie_v3')) || [],
            esami: JSON.parse(localStorage.getItem('esami_v3')) || [],
            sessioni: JSON.parse(localStorage.getItem('sessioni_v3')) || [],
            curriculum: JSON.parse(localStorage.getItem('curriculum_v3')) || [],
            calendarSessions: JSON.parse(localStorage.getItem('calendarSessions_v3')) || {},
            sessionRatings: JSON.parse(localStorage.getItem('sessionRatings_v3')) || {},
            
            // Current session and editing
            currentSession: { materia: null, studyType: null, startTime: null, duration: 25 },
            editingMateriaId: null,
            
            // Timer state
            timer: {
                minutes: 25, seconds: 0, isRunning: false, isBreak: false,
                workTime: 25, breakTime: 5, interval: null,
                sessionsToday: parseInt(localStorage.getItem('sessionsToday_v3')) || 0,
                sessionGoal: parseInt(localStorage.getItem('sessionGoal_v3')) || 8,
                lastSessionDate: localStorage.getItem('lastSessionDate_v3') || ''
            },
            
            // Study data
            studyData: {
                streak: parseInt(localStorage.getItem('studyStreak_v3')) || 0,
                lastStudyDate: localStorage.getItem('lastStudyDate_v3') || '',
                totalSessions: parseInt(localStorage.getItem('totalSessions_v3')) || 0
            },
            
            // UI state
            difficoltaSelezionata: 3,
            mobileNavOpen: false,
            currentCalendarDate: new Date(),
            autoBackupEnabled: localStorage.getItem('autoBackup_v3') !== 'disabled'
        };

        // ========================================
        // 🛠️ UTILITÀ E FUNZIONI HELPER
        // ========================================
        const Utils = {
            showMessage(message, type = 'success') {
                const toast = document.createElement('div');
                const bgColor = type === 'error' ? 'var(--danger)' : 'var(--engineering)';
                toast.style.cssText = `
                    position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, ${bgColor}, ${bgColor}dd);
                    color: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: var(--shadow-xl);
                    z-index: 10000; font-weight: 600; max-width: 400px;
                    transform: translateX(100%); transition: transform 0.3s ease;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => toast.style.transform = 'translateX(0)', 100);
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 4000);
            },

            formatTime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return hours > 0 ? `${hours}h ${mins}min` : `${mins}min`;
            },

            calculateProgress(materia) {
                const studyPages = materia.pagineStudiate || 0;
                const exercisesDone = materia.eserciziCompletati || 0;
                const totalPages = materia.pagineStudio || 1;
                const totalExercises = materia.numeroEsercizi || 0;
                
                if (totalPages > 0 && totalExercises > 0) {
                    const pageProgress = (studyPages / totalPages) * 50;
                    const exerciseProgress = (exercisesDone / totalExercises) * 50;
                    return Math.round(pageProgress + exerciseProgress);
                } else if (totalPages > 0) {
                    return Math.round((studyPages / totalPages) * 100);
                } else if (totalExercises > 0) {
                    return Math.round((exercisesDone / totalExercises) * 100);
                }
                return 0;
            },

            calculateSmartPriority(materia) {
                let score = 0;
                const daysToExam = this.getDaysToExam(materia.dataEsame);
                
                if (daysToExam !== null) {
                    if (daysToExam <= 3) score += 50;
                    else if (daysToExam <= 7) score += 45;
                    else if (daysToExam <= 14) score += 35;
                    else if (daysToExam <= 30) score += 25;
                    else if (daysToExam <= 60) score += 15;
                    else score += 5;
                }
                
                const priorityMap = { 'alta': 25, 'media': 15, 'bassa': 5 };
                score += priorityMap[materia.priorita] || 15;
                score += (materia.difficolta || 3) * 4;
                score += Math.min(materia.cfu * 1.5, 15);
                
                const progress = this.calculateProgress(materia);
                if (progress < 10) score += 12;
                else if (progress > 80) score += 10;
                else if (progress < 30) score += 8;
                else score += 5;
                
                return Math.round(score);
            },

            getDaysToExam(dataEsame) {
                if (!dataEsame) return null;
                const today = new Date();
                const examDate = new Date(dataEsame);
                const diffTime = examDate - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            },

            formatDateForInput(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            calculateTaskDuration(inizio, fine) {
                const start = new Date(`1970-01-01T${inizio}:00`);
                const end = new Date(`1970-01-01T${fine}:00`);
                return Math.round((end - start) / (1000 * 60));
            },

            saveData() {
                try {
                    const dataKeys = [
                        'materie_v3', 'esami_v3', 'sessioni_v3', 'curriculum_v3', 
                        'calendarSessions_v3', 'sessionRatings_v3'
                    ];
                    
                    localStorage.setItem('materie_v3', JSON.stringify(APP_STATE.materie));
                    localStorage.setItem('esami_v3', JSON.stringify(APP_STATE.esami));
                    localStorage.setItem('sessioni_v3', JSON.stringify(APP_STATE.sessioni));
                    localStorage.setItem('curriculum_v3', JSON.stringify(APP_STATE.curriculum));
                    localStorage.setItem('calendarSessions_v3', JSON.stringify(APP_STATE.calendarSessions));
                    localStorage.setItem('sessionRatings_v3', JSON.stringify(APP_STATE.sessionRatings));
                    localStorage.setItem('sessionsToday_v3', APP_STATE.timer.sessionsToday);
                    localStorage.setItem('sessionGoal_v3', APP_STATE.timer.sessionGoal);
                    localStorage.setItem('lastSessionDate_v3', APP_STATE.timer.lastSessionDate);
                    localStorage.setItem('studyStreak_v3', APP_STATE.studyData.streak);
                    localStorage.setItem('lastStudyDate_v3', APP_STATE.studyData.lastStudyDate);
                    localStorage.setItem('totalSessions_v3', APP_STATE.studyData.totalSessions);
                } catch (error) {
                    console.error('Errore nel salvataggio:', error);
                    Utils.showMessage('❌ Errore nel salvataggio dei dati', 'error');
                }
            }
        };

        // ========================================
        // 🧭 GESTIONE NAVIGAZIONE
        // ========================================
        const Navigation = {
            showSection(sectionName, targetElement) {
                try {
                    this.closeMobile();
                    
                    document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

                    const targetSection = document.getElementById(sectionName);
                    if (targetSection) targetSection.classList.add('active');
                    if (targetElement) targetElement.classList.add('active');

                    const sectionHandlers = {
                        'oggi': () => { DashboardManager.update(); SmartPlanner.generateTodaySchedule(); },
                        'pomodoro': () => PomodoroManager.init(),
                        'materie': () => { MaterieManager.load(); WeeklySlots.initialize(); StarRating.setup(); },
                        'curriculum': () => CurriculumManager.load(),
                        'esami': () => ExamManager.updateSection(),
                        'piano': () => PlanManager.generate(),
                        'calendario': () => CalendarManager.render(),
                        'statistiche': () => { StatisticsManager.update(); HeatmapManager.update(); ProductivityAnalyzer.update(); },
                        'helper': () => HelperManager.init(),
                        'impostazioni': () => SettingsManager.load()
                    };
                    
                    if (sectionHandlers[sectionName]) sectionHandlers[sectionName]();
                } catch (error) {
                    console.error('Errore nel cambio sezione:', error);
                }
            },

            toggleMobile() {
                const dropdown = document.getElementById('navDropdown');
                APP_STATE.mobileNavOpen = !APP_STATE.mobileNavOpen;
                dropdown.classList.toggle('show', APP_STATE.mobileNavOpen);
            },

            closeMobile() {
                const dropdown = document.getElementById('navDropdown');
                dropdown.classList.remove('show');
                APP_STATE.mobileNavOpen = false;
            }
        };

        // ========================================
        // 🧠 SMART PLANNER CON GESTIONE CONFLITTI
        // ========================================
        const SmartPlanner = {
            generateTodaySchedule() {
                if (APP_STATE.materie.length === 0) {
                    this.updateTodayDisplay(null, []);
                    return;
                }

                const oggi = new Date();
                const giornoSettimana = ['domenica', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato'][oggi.getDay()];
                
                const scheduleOggi = this.generateIntelligentSchedule(giornoSettimana);
                this.updateTodayDisplay(scheduleOggi.nextTask, scheduleOggi.timeline);
            },

            generateIntelligentSchedule(giornoSettimana) {
                const materieFiltrate = APP_STATE.materie.filter(materia => {
                    if (materia.status === 'completato') return false;
                    const slots = materia.slotSettimanali && materia.slotSettimanali[giornoSettimana];
                    return slots && slots.length > 0;
                });

                if (materieFiltrate.length === 0) {
                    return { nextTask: null, timeline: [] };
                }

                // Crea mappa dei conflitti orari
                const conflictMap = this.detectTimeConflicts(materieFiltrate, giornoSettimana);
                
                // Risolvi conflitti e costruisci timeline
                const timeline = this.resolveConflictsAndBuildTimeline(materieFiltrate, giornoSettimana, conflictMap);
                const nextTask = this.findNextTask(timeline);

                return { nextTask, timeline };
            },

            detectTimeConflicts(materie, giornoSettimana) {
                const timeSlots = {};
                const conflicts = {};

                materie.forEach(materia => {
                    const slots = materia.slotSettimanali[giornoSettimana] || [];
                    slots.forEach(slot => {
                        const timeKey = `${slot.inizio}-${slot.fine}`;
                        
                        if (!timeSlots[timeKey]) {
                            timeSlots[timeKey] = [];
                        }
                        timeSlots[timeKey].push(materia);
                    });
                });

                // Identifica conflitti
                Object.keys(timeSlots).forEach(timeKey => {
                    if (timeSlots[timeKey].length > 1) {
                        conflicts[timeKey] = timeSlots[timeKey];
                    }
                });

                return conflicts;
            },

            resolveConflictsAndBuildTimeline(materie, giornoSettimana, conflicts) {
                const timeline = [];
                const processedSlots = new Set();

                materie.forEach(materia => {
                    const slots = materia.slotSettimanali[giornoSettimana] || [];
                    slots.forEach(slot => {
                        const timeKey = `${slot.inizio}-${slot.fine}`;
                        
                        if (processedSlots.has(timeKey)) return;
                        
                        let selectedMateria = materia;
                        let hasConflict = false;
                        
                        // Se c'è un conflitto, seleziona la materia con priorità più alta
                        if (conflicts[timeKey]) {
                            hasConflict = true;
                            const conflictingMaterias = conflicts[timeKey]
                                .map(m => ({ ...m, smartPriority: Utils.calculateSmartPriority(m) }))
                                .sort((a, b) => b.smartPriority - a.smartPriority);
                            
                            selectedMateria = conflictingMaterias[0];
                        }

                        timeline.push({
                            materia: selectedMateria.nome,
                            durata: Utils.calculateTaskDuration(slot.inizio, slot.fine),
                            orarioInizio: slot.inizio,
                            orarioFine: slot.fine,
                            difficolta: selectedMateria.difficolta,
                            priority: Utils.calculateSmartPriority(selectedMateria),
                            pagineRimanenti: Math.max(0, selectedMateria.pagineStudio - (selectedMateria.pagineStudiate || 0)),
                            percentualeCompletamento: Utils.calculateProgress(selectedMateria),
                            hasConflict: hasConflict,
                            conflictingSubjects: hasConflict ? conflicts[timeKey].filter(m => m.id !== selectedMateria.id).map(m => m.nome) : []
                        });

                        processedSlots.add(timeKey);
                    });
                });

                return timeline.sort((a, b) => a.orarioInizio.localeCompare(b.orarioInizio));
            },

            findNextTask(timeline) {
                const now = new Date();
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                let nextTask = timeline.find(task => task.orarioInizio > currentTime);
                if (!nextTask && timeline.length > 0) {
                    nextTask = timeline[0];
                }
                
                return nextTask;
            },

            updateTodayDisplay(nextTask, timeline) {
                const timelineContainer = document.getElementById('todayTimelineContent');
                
                if (timeline.length === 0) {
                    timelineContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📅</div>
                            <p>Aggiungi slot temporali alle materie per vedere il piano giornaliero</p>
                        </div>
                    `;
                    return;
                }

                timelineContainer.innerHTML = timeline.map(task => `
                    <div style="display: flex; align-items: flex-start; padding: 1rem; margin-bottom: 1rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; border-left: 4px solid var(--engineering); gap: 1rem; position: relative;" class="${task.hasConflict ? 'timeline-conflict' : ''}">
                        <div style="font-weight: 700; min-width: 80px; color: var(--engineering); font-size: 1rem;">${task.orarioInizio}</div>
                        <div style="flex: 1;">
                            <strong>${task.materia}</strong><br>
                            <small style="color: var(--secondary);">
                                ${task.durata} min • ${Math.round(task.percentualeCompletamento)}% completato • Score: ${task.priority}
                            </small>
                            ${task.hasConflict ? `
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.3);">
                                    <small style="color: var(--danger); font-weight: 600;">
                                        ⚠️ Conflitto risolto: priorità data a questa materia su ${task.conflictingSubjects.join(', ')}
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
        };

        // ========================================
        // 📊 DASHBOARD MANAGER
        // ========================================
        const DashboardManager = {
            update() {
                this.updateStats();
                this.updateNextTask();
            },

            updateStats() {
                const todaySessionsTime = this.getTodayStudyTime();
                const completedExams = APP_STATE.esami.length;
                const totalCFU = APP_STATE.esami.reduce((sum, exam) => {
                    const materia = APP_STATE.materie.find(m => m.id === exam.materiaId);
                    return sum + (materia ? materia.cfu : 0);
                }, 0);
                const averageGrade = this.calculateAverageGrade();

                document.getElementById('todayStudyHours').textContent = Utils.formatTime(todaySessionsTime);
                document.getElementById('completedExams').textContent = completedExams;
                document.getElementById('totalCFU').textContent = totalCFU;
                document.getElementById('averageGrade').textContent = averageGrade.toFixed(1);
            },

            getTodayStudyTime() {
                const today = new Date().toDateString();
                return APP_STATE.sessioni
                    .filter(s => new Date(s.timestamp).toDateString() === today)
                    .reduce((sum, s) => sum + s.duration, 0);
            },

            calculateAverageGrade() {
                if (APP_STATE.esami.length === 0) return 0;
                
                let totalWeighted = 0;
                let totalCFU = 0;
                
                APP_STATE.esami.forEach(exam => {
                    const materia = APP_STATE.materie.find(m => m.id === exam.materiaId);
                    if (materia) {
                        totalWeighted += exam.voto * materia.cfu;
                        totalCFU += materia.cfu;
                    }
                });
                
                return totalCFU > 0 ? totalWeighted / totalCFU : 0;
            },

            updateNextTask() {
                const nextTask = this.getNextRecommendedTask();
                const container = document.getElementById('nextTaskContent');
                
                if (nextTask) {
                    container.innerHTML = `
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem;">${nextTask.nome}</div>
                            <div style="opacity: 0.9;">Raccomandato: ${nextTask.recommendedType}</div>
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.5rem;">${nextTask.reason}</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p>Aggiungi materie per vedere il tuo piano di studio intelligente!</p>';
                }
            },

            getNextRecommendedTask() {
                const activeMaterie = APP_STATE.materie.filter(m => m.status !== 'completato');
                if (activeMaterie.length === 0) return null;

                const scored = activeMaterie.map(materia => {
                    let score = 0;
                    const progress = Utils.calculateProgress(materia);
                    const daysToExam = Utils.getDaysToExam(materia.dataEsame);
                    
                    if (daysToExam !== null) {
                        if (daysToExam <= 7) score += 100;
                        else if (daysToExam <= 14) score += 50;
                        else if (daysToExam <= 30) score += 25;
                    }
                    
                    score += (100 - progress);
                    const priorityScore = { alta: 30, media: 15, bassa: 5 };
                    score += priorityScore[materia.priorita] || 15;
                    
                    let recommendedType = 'Teoria';
                    let reason = 'Pianificazione intelligente';
                    
                    if (progress < 30) {
                        recommendedType = 'Teoria';
                        reason = 'Costruire basi solide';
                    } else if (progress < 70) {
                        recommendedType = 'Esercizi';
                        reason = 'Consolidare con la pratica';
                    } else {
                        recommendedType = 'Ripasso';
                        reason = 'Preparazione finale';
                    }
                    
                    if (daysToExam !== null && daysToExam <= 7) {
                        reason = `🚨 Esame tra ${daysToExam} giorni!`;
                    }
                    
                    return { ...materia, score, recommendedType, reason };
                });
                
                return scored.sort((a, b) => b.score - a.score)[0];
            }
        };

        // ========================================
        // 🍅 POMODORO E TIMER MANAGER
        // ========================================
        const PomodoroManager = {
            init() {
                this.loadSubjects();
                this.updateSessionDisplay();
            },

            loadSubjects() {
                const activeMaterie = APP_STATE.materie.filter(m => m.status !== 'completato');
                const subjectSelection = document.getElementById('subjectSelection');
                const noSubjectsMessage = document.getElementById('noSubjectsMessage');
                const subjectList = document.getElementById('subjectList');

                if (activeMaterie.length === 0) {
                    subjectSelection.classList.add('hidden');
                    noSubjectsMessage.classList.remove('hidden');
                    return;
                }

                noSubjectsMessage.classList.add('hidden');
                subjectSelection.classList.remove('hidden');

                subjectList.innerHTML = activeMaterie.map(materia => {
                    const progress = Utils.calculateProgress(materia);
                    const daysToExam = Utils.getDaysToExam(materia.dataEsame);
                    
                    return `
                        <div class="subject-option" data-subject-id="${materia.id}" onclick="PomodoroManager.selectSubject(${materia.id}, this)">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                <div style="font-weight: 700; color: var(--text-primary);">${materia.nome}</div>
                                <div style="font-size: 0.8rem; color: var(--engineering); font-weight: 600;">${materia.cfu} CFU</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">${progress}% completato</div>
                                ${daysToExam ? `<div style="color: ${daysToExam <= 7 ? 'var(--danger)' : 'var(--warning)'}; font-size: 0.8rem; font-weight: 600;">Esame tra ${daysToExam}gg</div>` : ''}
                            </div>
                            <div class="progress-mini">
                                <div class="progress-mini-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            selectSubject(materiaId, element) {
                document.querySelectorAll('.subject-option').forEach(opt => opt.classList.remove('selected'));
                element.classList.add('selected');
                
                APP_STATE.currentSession.materia = APP_STATE.materie.find(m => m.id === materiaId);
                this.updateSelectedStudyInfo();
            },

            updateSelectedStudyInfo() {
                const infoEl = document.getElementById('selectedStudyInfo');
                const subjectNameEl = document.getElementById('selectedSubjectName');
                const studyTypeEl = document.getElementById('selectedStudyType');
                
                if (APP_STATE.currentSession.materia && APP_STATE.currentSession.studyType) {
                    infoEl.classList.remove('hidden');
                    subjectNameEl.textContent = APP_STATE.currentSession.materia.nome;
                    studyTypeEl.textContent = this.getStudyTypeLabel(APP_STATE.currentSession.studyType);
                } else {
                    infoEl.classList.add('hidden');
                }
            },

            getStudyTypeLabel(type) {
                const labels = {
                    theory: '📖 Teoria',
                    exercise: '💪 Esercizi', 
                    lab: '🔬 Laboratorio',
                    review: '🔄 Ripasso'
                };
                return labels[type] || type;
            },

            updateSessionDisplay() {
                const today = new Date().toDateString();
                if (APP_STATE.timer.lastSessionDate !== today) {
                    APP_STATE.timer.sessionsToday = 0;
                    APP_STATE.timer.lastSessionDate = today;
                    localStorage.setItem('sessionsToday_v3', 0);
                    localStorage.setItem('lastSessionDate_v3', today);
                }

                document.getElementById('sessionCount').textContent = APP_STATE.timer.sessionsToday;
                document.getElementById('sessionGoal').textContent = APP_STATE.timer.sessionGoal;
                document.getElementById('sessionProgress').style.width = Math.min(100, (APP_STATE.timer.sessionsToday / APP_STATE.timer.sessionGoal) * 100) + '%';
                
                const progressText = document.getElementById('progressText');
                if (APP_STATE.timer.sessionsToday === 0) {
                    progressText.textContent = 'Seleziona una materia per iniziare!';
                } else if (APP_STATE.timer.sessionsToday >= APP_STATE.timer.sessionGoal) {
                    progressText.textContent = '🎉 Obiettivo raggiunto! Ottimo lavoro!';
                } else {
                    const remaining = APP_STATE.timer.sessionGoal - APP_STATE.timer.sessionsToday;
                    progressText.textContent = `Ancora ${remaining} sessioni per raggiungere l'obiettivo`;
                }
            }
        };

        // Study Type Manager
        const StudyTypeManager = {
            select(type, element) {
                document.querySelectorAll('.study-type-card').forEach(card => card.classList.remove('selected'));
                element.classList.add('selected');
                
                APP_STATE.currentSession.studyType = type;
                PomodoroManager.updateSelectedStudyInfo();
            }
        };

        // Timer Manager Enhanced
        const TimerManager = {
            setPreset(workTime, breakTime, element) {
                if (APP_STATE.timer.isRunning) return;
                
                APP_STATE.timer.workTime = workTime;
                APP_STATE.timer.breakTime = breakTime;
                APP_STATE.timer.minutes = workTime;
                APP_STATE.timer.seconds = 0;
                APP_STATE.timer.isBreak = false;
                
                this.updateDisplay();
                
                document.querySelectorAll('.btn-secondary').forEach(btn => btn.classList.remove('active'));
                if (element) element.classList.add('active');
            },

            updateDisplay() {
                const display = `${APP_STATE.timer.minutes.toString().padStart(2, '0')}:${APP_STATE.timer.seconds.toString().padStart(2, '0')}`;
                const timerDisplayEl = document.getElementById('timerDisplay');
                
                if (timerDisplayEl) {
                    timerDisplayEl.textContent = display;
                    timerDisplayEl.classList.toggle('break-mode', APP_STATE.timer.isBreak);
                }
            },

            start() {
                if (!APP_STATE.currentSession.materia || !APP_STATE.currentSession.studyType) {
                    Utils.showMessage('⚠️ Seleziona prima una materia e il tipo di studio', 'error');
                    return;
                }
                
                if (APP_STATE.timer.isRunning) return;
                
                APP_STATE.timer.isRunning = true;
                APP_STATE.currentSession.startTime = new Date();
                
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('pauseBtn').classList.remove('hidden');
                
                APP_STATE.timer.interval = setInterval(() => {
                    if (APP_STATE.timer.seconds === 0) {
                        if (APP_STATE.timer.minutes === 0) {
                            this.complete();
                            return;
                        } else {
                            APP_STATE.timer.minutes--;
                            APP_STATE.timer.seconds = 59;
                        }
                    } else {
                        APP_STATE.timer.seconds--;
                    }
                    this.updateDisplay();
                }, 1000);
                
                Utils.showMessage('🚀 Sessione di studio iniziata!');
            },

            pause() {
                if (!APP_STATE.timer.isRunning) return;
                
                APP_STATE.timer.isRunning = false;
                clearInterval(APP_STATE.timer.interval);
                
                document.getElementById('startBtn').classList.remove('hidden');
                document.getElementById('pauseBtn').classList.add('hidden');
            },

            reset() {
                APP_STATE.timer.isRunning = false;
                clearInterval(APP_STATE.timer.interval);
                
                APP_STATE.timer.minutes = APP_STATE.timer.workTime;
                APP_STATE.timer.seconds = 0;
                APP_STATE.timer.isBreak = false;
                
                document.getElementById('startBtn').classList.remove('hidden');
                document.getElementById('pauseBtn').classList.add('hidden');
                
                this.updateDisplay();
            },

            complete() {
                APP_STATE.timer.isRunning = false;
                clearInterval(APP_STATE.timer.interval);
                
                if (!APP_STATE.timer.isBreak) {
                    SessionTracker.showModal();
                    
                    APP_STATE.timer.sessionsToday++;
                    APP_STATE.studyData.totalSessions++;
                    
                    const today = new Date().toDateString();
                    if (APP_STATE.studyData.lastStudyDate !== today) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        
                        if (APP_STATE.studyData.lastStudyDate === yesterday.toDateString()) {
                            APP_STATE.studyData.streak++;
                        } else {
                            APP_STATE.studyData.streak = 1;
                        }
                        APP_STATE.studyData.lastStudyDate = today;
                    }
                    
                    Utils.saveData();
                    PomodoroManager.updateSessionDisplay();
                    this.updateStreakDisplay();
                    
                    if (APP_STATE.timer.breakTime > 0) {
                        setTimeout(() => {
                            APP_STATE.timer.isBreak = true;
                            APP_STATE.timer.minutes = APP_STATE.timer.breakTime;
                            APP_STATE.timer.seconds = 0;
                            this.updateDisplay();
                            Utils.showMessage('⏸️ Inizia la tua pausa!');
                        }, 2000);
                    }
                } else {
                    APP_STATE.timer.isBreak = false;
                    APP_STATE.timer.minutes = APP_STATE.timer.workTime;
                    APP_STATE.timer.seconds = 0;
                    this.updateDisplay();
                    Utils.showMessage('🚀 Pausa finita! Torna al lavoro!');
                }
                
                this.reset();
            },

            updateStreakDisplay() {
                const streakEl = document.getElementById('streakNumber');
                if (streakEl) {
                    streakEl.textContent = APP_STATE.studyData.streak;
                }
            },

            applyCustom() {
                const workTime = parseInt(document.getElementById('customWorkTime').value);
                const breakTime = parseInt(document.getElementById('customBreakTime').value);
                
                if (!workTime || workTime < 1 || workTime > 180) {
                    Utils.showMessage('❌ Inserisci un tempo di studio valido (1-180 minuti)', 'error');
                    return;
                }
                
                if (breakTime < 0 || breakTime > 60) {
                    Utils.showMessage('❌ Inserisci un tempo di pausa valido (0-60 minuti)', 'error');
                    return;
                }
                
                document.querySelectorAll('.btn-secondary').forEach(btn => btn.classList.remove('active'));
                
                this.setPreset(workTime, breakTime, null);
                UI.closeCustomTimerModal();
                
                Utils.showMessage(`✅ Timer personalizzato: ${workTime}/${breakTime} minuti`);
            }
        };

        // ========================================
        // 📊 SESSION TRACKING E MANAGEMENT
        // ========================================
        const SessionTracker = {
            showModal() {
                const modal = document.getElementById('sessionRatingModal');
                
                document.getElementById('completedSubject').textContent = APP_STATE.currentSession.materia.nome;
                document.getElementById('completedDuration').textContent = `${APP_STATE.timer.workTime} min`;
                document.getElementById('completedType').textContent = PomodoroManager.getStudyTypeLabel(APP_STATE.currentSession.studyType);
                
                this.setupProgressInput();
                modal.style.display = 'flex';
            },

            setupProgressInput() {
                const container = document.getElementById('progressInputContainer');
                const studyType = APP_STATE.currentSession.studyType;
                
                const inputConfigs = {
                    theory: { placeholder: "Pagine studiate", label: "Numero di pagine di teoria studiate", id: "pagesStudied" },
                    exercise: { placeholder: "Esercizi completati", label: "Numero di esercizi risolti", id: "exercisesCompleted" },
                    lab: { placeholder: "% progresso laboratorio", label: "Percentuale di avanzamento del progetto", id: "labProgress" },
                    review: { placeholder: "Argomenti ripassati", label: "Numero di argomenti/capitoli ripassati", id: "reviewTopics" }
                };
                
                const config = inputConfigs[studyType] || inputConfigs.theory;
                container.innerHTML = `
                    <input type="number" id="${config.id}" min="0" max="${studyType === 'lab' ? '100' : '50'}" placeholder="${config.placeholder}" style="margin-bottom: 0.5rem;">
                    <small style="color: var(--text-secondary);">${config.label}</small>
                `;
            },

            rate(rating) {
                const sessionData = {
                    id: Date.now(),
                    materiaId: APP_STATE.currentSession.materia.id,
                    materia: APP_STATE.currentSession.materia.nome,
                    studyType: APP_STATE.currentSession.studyType,
                    duration: APP_STATE.timer.workTime,
                    rating: rating,
                    notes: document.getElementById('sessionNotes').value || '',
                    timestamp: new Date().toISOString(),
                    progress: this.getProgressData()
                };
                
                APP_STATE.sessioni.push(sessionData);
                this.updateMateriaProgress(sessionData);
                
                Utils.saveData();
                PomodoroManager.updateSessionDisplay();
                SessionManager.updateTodayList();
                DashboardManager.update();
                
                document.getElementById('sessionRatingModal').style.display = 'none';
                
                const ratingEmojis = ['😴', '😐', '😊', '🔥'];
                Utils.showMessage(`${ratingEmojis[rating - 1]} Sessione salvata! Progresso aggiornato.`);
                
                // Reset current session
                APP_STATE.currentSession = { materia: null, studyType: null, startTime: null, duration: 25 };
                
                document.querySelectorAll('.subject-option').forEach(opt => opt.classList.remove('selected'));
                document.querySelectorAll('.study-type-card').forEach(card => card.classList.remove('selected'));
                document.getElementById('selectedStudyInfo').classList.add('hidden');
                document.getElementById('sessionNotes').value = '';
            },

            getProgressData() {
                const studyType = APP_STATE.currentSession.studyType;
                const dataMap = {
                    theory: { type: 'pages', id: 'pagesStudied' },
                    exercise: { type: 'exercises', id: 'exercisesCompleted' },
                    lab: { type: 'lab_progress', id: 'labProgress' },
                    review: { type: 'review_topics', id: 'reviewTopics' }
                };
                
                const config = dataMap[studyType] || dataMap.theory;
                return {
                    type: config.type,
                    value: parseInt(document.getElementById(config.id)?.value) || 0
                };
            },

            updateMateriaProgress(sessionData) {
                const materia = APP_STATE.currentSession.materia;
                if (!materia) return;
                
                const progress = sessionData.progress;
                
                switch(progress.type) {
                    case 'pages':
                        materia.pagineStudiate = (materia.pagineStudiate || 0) + progress.value;
                        if (materia.pagineStudio && materia.pagineStudiate > materia.pagineStudio) {
                            materia.pagineStudiate = materia.pagineStudio;
                        }
                        break;
                    case 'exercises':
                        materia.eserciziCompletati = (materia.eserciziCompletati || 0) + progress.value;
                        if (materia.numeroEsercizi && materia.eserciziCompletati > materia.numeroEsercizi) {
                            materia.eserciziCompletati = materia.numeroEsercizi;
                        }
                        break;
                    case 'lab_progress':
                        materia.laboratorioProgress = Math.min(100, (materia.laboratorioProgress || 0) + progress.value);
                        break;
                }
                
                const materiaIndex = APP_STATE.materie.findIndex(m => m.id === materia.id);
                if (materiaIndex !== -1) {
                    APP_STATE.materie[materiaIndex] = materia;
                }
            }
        };

        // Session Manager
        const SessionManager = {
            updateTodayList() {
                const container = document.getElementById('todaySessionsList');
                if (!container) return;
                
                const today = new Date().toDateString();
                const todaySessions = APP_STATE.sessioni.filter(s => 
                    new Date(s.timestamp).toDateString() === today
                );
                
                if (todaySessions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">🍅</div>
                            <p>Nessuna sessione completata oggi.</p>
                        </div>
                    `;
                    return;
                }
                
                const sortedSessions = todaySessions.sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                container.innerHTML = sortedSessions.map((session, index) => {
                    const time = new Date(session.timestamp).toLocaleTimeString('it-IT', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const ratingEmojis = ['😴', '😐', '😊', '🔥'];
                    const ratingStars = '★'.repeat(session.rating) + '☆'.repeat(4 - session.rating);
                    
                    return `
                        <div class="session-item fade-in-up">
                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 200px;">
                                <div style="font-weight: 700; min-width: 80px; color: var(--engineering);">${time}</div>
                                <div>
                                    <div style="color: var(--secondary); font-weight: 600;">${session.materia}</div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">${session.notes || PomodoroManager.getStudyTypeLabel(session.studyType)}</div>
                                    <div style="color: var(--text-muted); font-size: 0.8rem;">${session.duration}min • ${session.progress ? session.progress.value : 0} unità</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.2rem;">${ratingEmojis[session.rating - 1]}</span>
                                    <small style="color: var(--text-secondary);">${ratingStars}</small>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="SessionManager.delete(${index})" title="Elimina sessione">🗑️</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            delete(index) {
                if (confirm('Sei sicuro di voler eliminare questa sessione?')) {
                    const today = new Date().toDateString();
                    const todaySessions = APP_STATE.sessioni.filter(s => 
                        new Date(s.timestamp).toDateString() === today
                    );
                    
                    if (index >= 0 && index < todaySessions.length) {
                        const sessionToDelete = todaySessions[index];
                        APP_STATE.sessioni = APP_STATE.sessioni.filter(s => s.id !== sessionToDelete.id);
                        APP_STATE.timer.sessionsToday = Math.max(0, APP_STATE.timer.sessionsToday - 1);
                        
                        Utils.saveData();
                        this.updateTodayList();
                        PomodoroManager.updateSessionDisplay();
                        
                        Utils.showMessage('🗑️ Sessione eliminata');
                    }
                }
            },

            deleteAllToday() {
                const today = new Date().toDateString();
                const todaySessions = APP_STATE.sessioni.filter(s => 
                    new Date(s.timestamp).toDateString() === today
                );
                
                if (todaySessions.length === 0) {
                    Utils.showMessage('📝 Non ci sono sessioni da eliminare');
                    return;
                }
                
                if (confirm(`Sei sicuro di voler eliminare tutte le ${todaySessions.length} sessioni di oggi?\n\nQuesta azione non può essere annullata.`)) {
                    APP_STATE.sessioni = APP_STATE.sessioni.filter(s => 
                        new Date(s.timestamp).toDateString() !== today
                    );
                    APP_STATE.timer.sessionsToday = 0;
                    
                    Utils.saveData();
                    this.updateTodayList();
                    PomodoroManager.updateSessionDisplay();
                    
                    Utils.showMessage('🗑️ Tutte le sessioni di oggi sono state eliminate');
                }
            }
        };

        // ========================================
        // 📚 GESTIONE MATERIE CON EDIT E SLOT SETTIMANALI
        // ========================================
        const WeeklySlots = {
            initialize() {
                const container = document.getElementById('weeklySlots');
                if (!container) return;
                
                const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
                const giorniLabel = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];

                container.innerHTML = giorni.map((giorno, index) => `
                    <div class="day-slots fade-in-up">
                        <h4 style="color: var(--engineering); margin-bottom: 1rem; text-align: center;">${giorniLabel[index]}</h4>
                        <div id="slots-${giorno}">
                            <button type="button" onclick="WeeklySlots.addSlot('${giorno}')" style="width: 100%; padding: 0.75rem; border: 2px dashed var(--border); background: transparent; color: var(--text-secondary); border-radius: 8px; cursor: pointer; transition: all var(--transition); font-weight: 600;">+ Aggiungi Slot</button>
                        </div>
                    </div>
                `).join('');
            },

            addSlot(giorno) {
                const container = document.getElementById(`slots-${giorno}`);
                if (!container) return;
                
                const slotId = `${giorno}-${Date.now()}`;
                
                const slotHTML = `
                    <div id="${slotId}" class="slot-item">
                        <input type="time" value="09:00" style="padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: auto; min-width: 120px;">
                        <span style="color: var(--text-secondary);">-</span>
                        <input type="time" value="11:00" style="padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: auto; min-width: 120px;">
                        <button type="button" onclick="WeeklySlots.removeSlot('${slotId}')" style="background: var(--danger); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold;" title="Rimuovi slot">×</button>
                    </div>
                `;
                
                const addButton = container.querySelector('button');
                if (addButton) {
                    addButton.insertAdjacentHTML('beforebegin', slotHTML);
                }
            },

            removeSlot(slotId) {
                const slot = document.getElementById(slotId);
                if (slot) slot.remove();
            },

            get() {
                const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
                const slotSettimanali = {};

                giorni.forEach(giorno => {
                    const container = document.getElementById(`slots-${giorno}`);
                    if (!container) {
                        slotSettimanali[giorno] = [];
                        return;
                    }
                    
                    const slots = container.querySelectorAll('div[id^="' + giorno + '-"]');
                    slotSettimanali[giorno] = [];

                    slots.forEach(slot => {
                        const inputs = slot.querySelectorAll('input[type="time"]');
                        const start = inputs[0].value;
                        const end = inputs[1].value;
                        
                        if (start && end && start < end) {
                            slotSettimanali[giorno].push({
                                inizio: start,
                                fine: end,
                                disponibile: true
                            });
                        }
                    });
                });

                return slotSettimanali;
            },

            loadFromMateria(materia) {
                if (!materia.slotSettimanali) return;
                
                const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
                
                giorni.forEach(giorno => {
                    const container = document.getElementById(`slots-${giorno}`);
                    if (!container) return;
                    
                    // Rimuovi slot esistenti
                    const existingSlots = container.querySelectorAll('div[id^="' + giorno + '-"]');
                    existingSlots.forEach(slot => slot.remove());
                    
                    // Aggiungi slot della materia
                    const slots = materia.slotSettimanali[giorno] || [];
                    slots.forEach(slot => {
                        this.addSlot(giorno);
                        const newSlot = container.querySelector('div[id^="' + giorno + '-"]:last-of-type');
                        if (newSlot) {
                            const inputs = newSlot.querySelectorAll('input[type="time"]');
                            inputs[0].value = slot.inizio;
                            inputs[1].value = slot.fine;
                        }
                    });
                });
            }
        };

        // Materie Manager Enhanced con Edit
        const MaterieManager = {
            add() {
                try {
                    const formData = this.getFormData();
                    if (!this.validateFormData(formData)) return;

                    const slotSettimanali = WeeklySlots.get();

                    const nuovaMateria = {
                        id: Date.now(),
                        ...formData,
                        pagineStudiate: 0,
                        eserciziCompletati: 0,
                        laboratorioProgress: 0,
                        slotSettimanali,
                        status: 'studio',
                        dataCreazione: new Date().toISOString()
                    };

                    APP_STATE.materie.push(nuovaMateria);
                    this.addToCurriculumIfNeeded(formData);
                    
                    Utils.saveData();
                    this.load();
                    this.resetForm();
                    this.updateOtherSections();
                    
                    Utils.showMessage('✅ Materia aggiunta con successo!');
                    
                } catch (error) {
                    console.error('Errore nell\'aggiunta materia:', error);
                    Utils.showMessage('❌ Errore nell\'aggiunta della materia', 'error');
                }
            },

            update() {
                try {
                    const formData = this.getFormData();
                    if (!this.validateFormData(formData)) return;

                    const materiaIndex = APP_STATE.materie.findIndex(m => m.id === APP_STATE.editingMateriaId);
                    if (materiaIndex === -1) {
                        Utils.showMessage('❌ Materia non trovata', 'error');
                        return;
                    }

                    const slotSettimanali = WeeklySlots.get();
                    const materia = APP_STATE.materie[materiaIndex];
                    
                    // Mantieni i dati di progresso esistenti
                    Object.assign(materia, formData, { slotSettimanali });
                    
                    Utils.saveData();
                    this.load();
                    this.resetForm();
                    this.updateOtherSections();
                    
                    Utils.showMessage('✅ Materia modificata con successo!');
                    
                } catch (error) {
                    console.error('Errore nella modifica materia:', error);
                    Utils.showMessage('❌ Errore nella modifica della materia', 'error');
                }
            },

            edit(id) {
                const materia = APP_STATE.materie.find(m => m.id === id);
                if (!materia) {
                    Utils.showMessage('❌ Materia non trovata', 'error');
                    return;
                }

                APP_STATE.editingMateriaId = id;
                
                // Popola il form con i dati della materia
                document.getElementById('nomeMateria').value = materia.nome;
                document.getElementById('cfu').value = materia.cfu;
                document.getElementById('anno').value = materia.anno;
                document.getElementById('semestre').value = materia.semestre;
                document.getElementById('materiaType').value = materia.tipo || 'theory';
                document.getElementById('dataEsame').value = materia.dataEsame || '';
                document.getElementById('pagineStudio').value = materia.pagineStudio || '';
                document.getElementById('numeroEsercizi').value = materia.numeroEsercizi || '';
                document.getElementById('priorita').value = materia.priorita;
                
                // Imposta difficoltà
                APP_STATE.difficoltaSelezionata = materia.difficolta || 3;
                StarRating.update();
                
                // Carica slot settimanali
                WeeklySlots.loadFromMateria(materia);
                
                // Cambia UI per edit mode
                document.getElementById('materieFormTitle').textContent = '✏️ Modifica Materia';
                document.getElementById('saveBtn').classList.add('hidden');
                document.getElementById('updateBtn').classList.remove('hidden');
                document.getElementById('cancelBtn').classList.remove('hidden');
                
                // Scorri al form
                document.getElementById('materieFormTitle').scrollIntoView({ behavior: 'smooth' });
                
                Utils.showMessage('📝 Modalità modifica attivata');
            },

            cancelEdit() {
                APP_STATE.editingMateriaId = null;
                this.resetForm();
                Utils.showMessage('❌ Modifica annullata');
            },

            getFormData() {
                return {
                    nome: document.getElementById('nomeMateria').value.trim(),
                    cfu: parseInt(document.getElementById('cfu').value),
                    anno: parseInt(document.getElementById('anno').value),
                    semestre: document.getElementById('semestre').value,
                    tipo: document.getElementById('materiaType').value,
                    dataEsame: document.getElementById('dataEsame').value,
                    pagineStudio: parseInt(document.getElementById('pagineStudio').value) || 0,
                    numeroEsercizi: parseInt(document.getElementById('numeroEsercizi').value) || 0,
                    priorita: document.getElementById('priorita').value,
                    difficolta: APP_STATE.difficoltaSelezionata
                };
            },

            validateFormData(formData) {
                if (!formData.nome || !formData.cfu || !formData.anno || !formData.semestre) {
                    Utils.showMessage('❌ Compila tutti i campi obbligatori', 'error');
                    return false;
                }
                return true;
            },

            addToCurriculumIfNeeded(formData) {
                const existingCurrSubject = APP_STATE.curriculum.find(c => 
                    c.nome === formData.nome && c.anno === formData.anno && 
                    (c.semestre === formData.semestre || formData.semestre === 'annuale')
                );
                
                if (!existingCurrSubject) {
                    const curriculumSubject = {
                        id: Date.now() + 1,
                        nome: formData.nome, 
                        anno: formData.anno, 
                        semestre: formData.semestre, 
                        cfu: formData.cfu,
                        professore: '', 
                        note: 'Aggiunta automaticamente dalla sezione Materie',
                        completato: false, 
                        dataCreazione: new Date().toISOString()
                    };
                    
                    APP_STATE.curriculum.push(curriculumSubject);
                }
            },

            updateOtherSections() {
                CurriculumManager.load();
                SmartPlanner.generateTodaySchedule();
                PlanManager.generate();
            },

            load() {
                const container = document.getElementById('materieList');
                
                if (APP_STATE.materie.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📚</div>
                            <p>Nessuna materia aggiunta ancora.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = APP_STATE.materie.map(materia => {
                    const progress = Utils.calculateProgress(materia);
                    const daysToExam = Utils.getDaysToExam(materia.dataEsame);
                    const isCompleted = materia.status === 'completato';
                    const examData = APP_STATE.esami.find(e => e.materiaId === materia.id);
                    const smartPriority = Utils.calculateSmartPriority(materia);
                    
                    let oreTotaliSettimanali = 0;
                    if (materia.slotSettimanali) {
                        Object.values(materia.slotSettimanali).forEach(slots => {
                            slots.forEach(slot => {
                                const durata = Utils.calculateTaskDuration(slot.inizio, slot.fine);
                                oreTotaliSettimanali += durata;
                            });
                        });
                        oreTotaliSettimanali = Math.round(oreTotaliSettimanali / 60 * 10) / 10;
                    }
                    
                    const getSemesterBadges = (semestre) => {
                        if (semestre === 'annuale') {
                            return `
                                <div class="semester-badges">
                                    <span class="semester-badge">I Sem</span>
                                    <span class="semester-badge">II Sem</span>
                                </div>
                            `;
                        }
                        return `<span class="semester-badge">${semestre}° Semestre</span>`;
                    };
                    
                    return `
                        <div class="subject-item fade-in-up ${isCompleted ? 'exam-completed' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                                <div style="font-size: 1.3rem; font-weight: 700; color: var(--engineering); flex: 1; min-width: 200px;">${materia.nome}</div>
                                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                                    <span style="padding: 8px 16px; border-radius: 25px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; ${isCompleted ? 'background: rgba(16, 185, 129, 0.2); color: var(--success);' : 'background: rgba(59, 130, 246, 0.2); color: var(--engineering);'}">
                                        ${isCompleted ? '🎓 Completato' : '📚 In Studio'}
                                    </span>
                                    <span style="padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; background: rgba(245, 158, 11, 0.2); color: #fcd34d;">${materia.priorita}</span>
                                    ${!isCompleted ? `
                                        <span style="background: rgba(59, 130, 246, 0.2); color: var(--engineering); padding: 4px 8px; border-radius: 8px; font-size: 0.75rem; font-weight: 600;" title="Score Intelligente: ${smartPriority} punti">
                                            Score: ${smartPriority}
                                        </span>
                                        <button class="btn btn-success btn-small" onclick="MaterieManager.markAsExamCompleted(${materia.id})" title="Segna esame come completato">🎓</button>
                                        <button class="btn btn-warning btn-small" onclick="MaterieManager.edit(${materia.id})" title="Modifica materia">✏️</button>
                                    ` : `
                                        <button class="btn btn-warning btn-small" onclick="ExamManager.edit(${materia.id})" title="Modifica esame">✏️</button>
                                    `}
                                    <button class="btn btn-danger btn-small" onclick="MaterieManager.delete(${materia.id})" title="Elimina materia">🗑️</button>
                                </div>
                            </div>
                            
                            ${!isCompleted ? `
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <strong style="color: var(--engineering);">Progresso Studio:</strong>
                                    <span style="color: var(--secondary); font-weight: 600;">${progress}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; font-size: 0.9rem;">
                                    ${materia.pagineStudio > 0 ? `<div>📖 Pagine: ${materia.pagineStudiate || 0}/${materia.pagineStudio}</div>` : ''}
                                    ${materia.numeroEsercizi > 0 ? `<div>💪 Esercizi: ${materia.eserciziCompletati || 0}/${materia.numeroEsercizi}</div>` : ''}
                                    ${materia.tipo === 'lab' ? `<div>🔬 Lab: ${materia.laboratorioProgress || 0}%</div>` : ''}
                                    ${daysToExam ? `<div style="color: ${daysToExam <= 7 ? 'var(--danger)' : 'var(--warning)'};">📅 Esame tra ${daysToExam} giorni</div>` : ''}
                                </div>
                            </div>
                            ` : examData ? `
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                <div style="font-size: 2rem; font-weight: 800; color: var(--success);">${examData.voto}${examData.lode ? 'L' : ''}</div>
                                <div>
                                    <div style="color: var(--success); font-weight: 600;">Esame sostenuto</div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                        ${examData.dataEsame ? new Date(examData.dataEsame).toLocaleDateString('it-IT') : ''}
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.95rem; color: var(--text-secondary);">
                                <div><strong>Anno:</strong> ${materia.anno}° Anno</div>
                                <div>
                                    <strong>Semestre:</strong> 
                                    ${getSemesterBadges(materia.semestre)}
                                </div>
                                <div><strong>CFU:</strong> ${materia.cfu}</div>
                                <div><strong>Tipo:</strong> ${materia.tipo}</div>
                                <div><strong>Ore settimanali:</strong> ${oreTotaliSettimanali}h</div>
                                <div><strong>Esame:</strong> ${materia.dataEsame ? new Date(materia.dataEsame).toLocaleDateString('it-IT') : 'Non impostato'}</div>
                                <div><strong>Difficoltà:</strong> ${'★'.repeat(materia.difficolta || 3)}${'☆'.repeat(5-(materia.difficolta || 3))}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            resetForm() {
                APP_STATE.editingMateriaId = null;
                
                ['nomeMateria', 'cfu', 'anno', 'semestre', 'dataEsame', 'pagineStudio', 'numeroEsercizi'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                document.getElementById('materiaType').value = 'theory';
                document.getElementById('priorita').value = 'media';
                APP_STATE.difficoltaSelezionata = 3;
                
                // Reset UI
                document.getElementById('materieFormTitle').textContent = '➕ Aggiungi Nuova Materia';
                document.getElementById('saveBtn').classList.remove('hidden');
                document.getElementById('updateBtn').classList.add('hidden');
                document.getElementById('cancelBtn').classList.add('hidden');
                
                WeeklySlots.initialize();
                StarRating.setup();
            },

            markAsExamCompleted(materiaId) {
                const materia = APP_STATE.materie.find(m => m.id === materiaId);
                if (!materia) {
                    Utils.showMessage('❌ Materia non trovata', 'error');
                    return;
                }

                document.getElementById('examSubject').value = materia.nome;
                document.getElementById('examModal').style.display = 'flex';
                document.getElementById('examModal').dataset.materiaId = materiaId;
            },

            delete(id) {
                const materia = APP_STATE.materie.find(m => m.id === id);
                if (!materia) return;

                if (confirm(`Sei sicuro di voler eliminare "${materia.nome}"?\n\nQuesta azione eliminerà anche l'eventuale esame associato e tutte le sessioni.`)) {
                    APP_STATE.esami = APP_STATE.esami.filter(e => e.materiaId !== id);
                    APP_STATE.sessioni = APP_STATE.sessioni.filter(s => s.materiaId !== id);
                    
                    const currSubjectIndex = APP_STATE.curriculum.findIndex(c => 
                        c.nome === materia.nome && c.anno === materia.anno && 
                        (c.semestre === materia.semestre || materia.semestre === 'annuale')
                    );
                    if (currSubjectIndex !== -1) {
                        APP_STATE.curriculum.splice(currSubjectIndex, 1);
                    }
                    
                    APP_STATE.materie = APP_STATE.materie.filter(m => m.id !== id);
                    
                    Utils.saveData();
                    this.load();
                    this.updateOtherSections();
                    ExamManager.updateSection();
                    
                    Utils.showMessage('🗑️ Materia eliminata completamente');
                }
            }
        };

        // Star Rating Manager
        const StarRating = {
            setup() {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star) => {
                    star.replaceWith(star.cloneNode(true));
                });
                
                const freshStars = document.querySelectorAll('.star');
                freshStars.forEach((star) => {
                    star.addEventListener('click', (e) => {
                        e.preventDefault();
                        APP_STATE.difficoltaSelezionata = parseInt(star.dataset.rating);
                        this.update();
                    });

                    star.addEventListener('mouseover', () => {
                        const rating = parseInt(star.dataset.rating);
                        this.highlight(rating);
                    });
                    
                    star.addEventListener('mouseout', () => {
                        this.update();
                    });
                });

                this.update();
            },

            highlight(rating) {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
            },

            update() {
                this.highlight(APP_STATE.difficoltaSelezionata);
            }
        };

        // ========================================
        // 🎓 CURRICULUM E ESAMI MANAGER (OTTIMIZZATO)
        // ========================================
        const CurriculumManager = {
            load() {
                this.updateYearStats();
                this.loadYearSubjects();
            },

            updateYearStats() {
                for (let year = 1; year <= 3; year++) {
                    const yearSubjects = APP_STATE.curriculum.filter(s => s.anno === year);
                    const completedSubjects = yearSubjects.filter(s => s.completato);
                    
                    const totalCFU = yearSubjects.reduce((sum, s) => sum + (s.cfu || 0), 0);
                    const avgGrade = completedSubjects.length > 0 ? 
                        (completedSubjects.reduce((sum, s) => sum + (s.voto || 0), 0) / completedSubjects.length).toFixed(1) : 0;

                    const elements = {
                        subjects: document.getElementById(`year${year}-subjects`),
                        cfu: document.getElementById(`year${year}-cfu`),
                        average: document.getElementById(`year${year}-average`)
                    };

                    if (elements.subjects) elements.subjects.textContent = yearSubjects.length;
                    if (elements.cfu) elements.cfu.textContent = totalCFU;
                    if (elements.average) elements.average.textContent = avgGrade;
                }
            },

            loadYearSubjects() {
                const semesters = [
                    { id: 1, name: 'I Semestre' },
                    { id: 2, name: 'II Semestre' },
                    { id: 'annuale', name: 'Annuali' }
                ];
                
                for (let year = 1; year <= 3; year++) {
                    semesters.forEach(semester => {
                        const containerId = semester.id === 'annuale' ? 
                            `year${year}-annuale-subjects` : 
                            `year${year}-semester${semester.id}-subjects`;
                        const container = document.getElementById(containerId);
                        if (!container) return;

                        const subjects = APP_STATE.curriculum.filter(s => 
                            s.anno === year && s.semestre === semester.id
                        );
                        
                        if (subjects.length === 0) {
                            container.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-state-icon">📖</div>
                                    <p>Nessuna materia ${semester.id === 'annuale' ? 'annuale' : 'aggiunta'}</p>
                                </div>
                            `;
                            return;
                        }

                        container.innerHTML = subjects.map(subject => `
                            <div class="fade-in-up" style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; ${subject.completato ? 'border-color: var(--success); background: rgba(16, 185, 129, 0.05);' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; gap: 1rem; flex-wrap: wrap;">
                                    <div style="font-weight: 700; color: var(--text-primary); font-size: 1.1rem; flex: 1; min-width: 150px;">${subject.nome}</div>
                                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                        ${subject.completato && subject.voto ? 
                                            `<span style="font-size: 1.2rem; font-weight: 700; color: var(--success);">${subject.voto}${subject.lode ? 'L' : ''}</span>` : ''
                                        }
                                        <input type="checkbox" ${subject.completato ? 'checked' : ''} 
                                               onchange="CurriculumManager.toggleCompletion(${subject.id})" style="width: 20px; height: 20px; cursor: pointer;" title="Segna come completato">
                                        <button class="btn btn-danger btn-small" onclick="CurriculumManager.deleteSubject(${subject.id})" title="Elimina materia">🗑️</button>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                                    <div><strong>CFU:</strong> ${subject.cfu}</div>
                                    ${subject.professore ? `<div><strong>Prof:</strong> ${subject.professore}</div>` : ''}
                                    ${subject.semestre === 'annuale' ? `<div><strong>Tipo:</strong> <span style="color: var(--accent); font-weight: 600;">Annuale</span></div>` : ''}
                                </div>
                            </div>
                        `).join('');
                    });
                }
            },

            showYear(year, tabElement) {
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    if (tab.textContent.includes('Anno')) {
                        tab.classList.remove('active');
                    }
                });
                if (tabElement) tabElement.classList.add('active');
                
                document.querySelectorAll('.year-content').forEach(content => content.classList.add('hidden'));
                const targetContent = document.getElementById(`year-${year}`);
                if (targetContent) targetContent.classList.remove('hidden');
            },

            saveSubject() {
                const nome = document.getElementById('currSubjectName').value.trim();
                const anno = parseInt(document.getElementById('currSubjectYear').value);
                const semestre = document.getElementById('currSubjectSemester').value;
                const cfu = parseInt(document.getElementById('currSubjectCFU').value);
                
                if (!nome || !anno || !semestre || !cfu) {
                    Utils.showMessage('❌ Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                const nuovaMateria = {
                    id: Date.now(),
                    nome, anno, semestre, cfu,
                    professore: '', note: '',
                    completato: false,
                    dataCreazione: new Date().toISOString()
                };
                
                APP_STATE.curriculum.push(nuovaMateria);
                Utils.saveData();
                this.load();
                
                UI.closeAddSubjectModal();
                
                ['currSubjectName', 'currSubjectYear', 'currSubjectSemester', 'currSubjectCFU'].forEach(id => {
                    document.getElementById(id).value = id === 'currSubjectYear' ? '1' : id === 'currSubjectSemester' ? '1' : '';
                });
                
                Utils.showMessage('✅ Materia aggiunta al curriculum!');
            },

            toggleCompletion(subjectId) {
                const subject = APP_STATE.curriculum.find(s => s.id === subjectId);
                if (!subject) return;

                if (!subject.completato) {
                    const voto = prompt(`Inserisci il voto per "${subject.nome}" (18-30):`);
                    if (voto === null) return;
                    
                    const votoNum = parseInt(voto);
                    if (isNaN(votoNum) || votoNum < 18 || votoNum > 30) {
                        alert('Voto non valido. Inserisci un numero tra 18 e 30.');
                        return;
                    }

                    const lode = votoNum === 30 ? confirm('Lode?') : false;
                    
                    subject.completato = true;
                    subject.voto = votoNum;
                    subject.lode = lode;
                    subject.dataCompletamento = new Date().toISOString().split('T')[0];
                } else {
                    subject.completato = false;
                    delete subject.voto;
                    delete subject.lode;
                    delete subject.dataCompletamento;
                }

                Utils.saveData();
                this.load();
            },

            deleteSubject(subjectId) {
                const subject = APP_STATE.curriculum.find(s => s.id === subjectId);
                if (!subject) return;

                if (confirm(`Sei sicuro di voler eliminare "${subject.nome}" dal curriculum?`)) {
                    APP_STATE.curriculum = APP_STATE.curriculum.filter(s => s.id !== subjectId);
                    Utils.saveData();
                    this.load();
                    Utils.showMessage('🗑️ Materia eliminata dal curriculum');
                }
            },

            export() {
                const data = JSON.stringify(APP_STATE.curriculum, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `curriculum_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                Utils.showMessage('📤 Curriculum esportato!');
            }
        };

        // Exam Manager (Ottimizzato)
        const ExamManager = {
            updateSection() {
                this.updateStats();
                this.updateList();
            },

            updateStats() {
                const elements = {
                    totalExams: document.getElementById('examTotalExams'),
                    totalCFU: document.getElementById('examTotalCFU'),
                    weightedAverage: document.getElementById('examWeightedAverage'),
                    projectedGrade: document.getElementById('examProjectedGrade')
                };

                if (APP_STATE.esami.length === 0) {
                    Object.values(elements).forEach(el => el && (el.textContent = '0'));
                    return;
                }

                let totalCFU = 0;
                let weightedSum = 0;

                APP_STATE.esami.forEach(esame => {
                    const materia = APP_STATE.materie.find(m => m.id === esame.materiaId);
                    if (materia) {
                        const cfu = materia.cfu;
                        totalCFU += cfu;
                        weightedSum += esame.voto * cfu;
                    }
                });

                const weightedAverage = totalCFU > 0 ? (weightedSum / totalCFU).toFixed(2) : 0;
                const projectedGrade = totalCFU > 0 ? Math.round((weightedSum / totalCFU) * 110 / 30) : 0;

                if (elements.totalExams) elements.totalExams.textContent = APP_STATE.esami.length;
                if (elements.totalCFU) elements.totalCFU.textContent = totalCFU;
                if (elements.weightedAverage) elements.weightedAverage.textContent = weightedAverage;
                if (elements.projectedGrade) elements.projectedGrade.textContent = projectedGrade;
            },

            updateList() {
                const container = document.getElementById('examsList');
                if (!container) return;

                if (APP_STATE.esami.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">🎓</div>
                            <p>Nessun esame sostenuto ancora.</p>
                        </div>
                    `;
                    return;
                }

                const sortedExams = APP_STATE.esami.sort((a, b) => {
                    const dateA = new Date(a.dataEsame || '1970-01-01');
                    const dateB = new Date(b.dataEsame || '1970-01-01');
                    return dateB - dateA;
                });

                container.innerHTML = sortedExams.map(esame => {
                    const materia = APP_STATE.materie.find(m => m.id === esame.materiaId);
                    if (!materia) return '';

                    return `
                        <div class="subject-item fade-in-up" style="border-color: var(--success); background: rgba(16, 185, 129, 0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                                <div style="font-size: 1.3rem; font-weight: 700; color: var(--text-primary);">${materia.nome}</div>
                                <div style="display: flex; gap: 0.75rem; align-items: center;">
                                    <div style="font-size: 2rem; font-weight: 800; color: var(--success);">${esame.voto}${esame.lode ? 'L' : ''}</div>
                                    <button class="btn btn-warning btn-small" onclick="ExamManager.edit(${materia.id})" title="Modifica esame">✏️</button>
                                    <button class="btn btn-danger btn-small" onclick="ExamManager.delete(${esame.id})" title="Elimina esame">🗑️</button>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minwidth(200px, 1fr)); gap: 1rem; font-size: 0.95rem; color: var(--text-secondary);">
                                <div><strong>CFU:</strong> ${materia.cfu}</div>
                                <div><strong>Data:</strong> ${esame.dataEsame ? new Date(esame.dataEsame).toLocaleDateString('it-IT') : 'Non specificata'}</div>
                                ${esame.note ? `<div style="grid-column: 1 / -1;"><strong>Note:</strong> ${esame.note}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            saveGrade() {
                const materiaId = parseInt(document.getElementById('examModal').dataset.materiaId);
                const voto = parseInt(document.getElementById('examGrade').value);
                const lode = document.getElementById('examLode').checked;
                const dataEsame = document.getElementById('examDate').value;
                
                if (!voto || voto < 18 || voto > 30) {
                    Utils.showMessage('❌ Inserisci un voto valido (18-30)', 'error');
                    return;
                }
                
                const materia = APP_STATE.materie.find(m => m.id === materiaId);
                if (!materia) return;
                
                materia.status = 'completato';
                
                const nuovoEsame = {
                    id: Date.now(),
                    materiaId: materiaId,
                    voto: voto,
                    lode: lode && voto === 30,
                    dataEsame: dataEsame || new Date().toISOString().split('T')[0],
                    dataCreazione: new Date().toISOString()
                };
                
                APP_STATE.esami.push(nuovoEsame);
                
                // Update curriculum
                const currSubjects = APP_STATE.curriculum.filter(c => 
                    c.nome === materia.nome && c.anno === materia.anno && 
                    (c.semestre === materia.semestre || materia.semestre === 'annuale')
                );
                
                currSubjects.forEach(currSubject => {
                    currSubject.completato = true;
                    currSubject.voto = voto;
                    currSubject.lode = lode && voto === 30;
                    currSubject.dataCompletamento = dataEsame || new Date().toISOString().split('T')[0];
                });
                
                Utils.saveData();
                MaterieManager.load();
                this.updateSection();
                CurriculumManager.load();
                DashboardManager.update();
                
                UI.closeExamModal();
                
                Utils.showMessage(`🎓 Esame di ${materia.nome} registrato con voto ${voto}${lode ? 'L' : ''}!`);
            },

            edit(materiaId) {
                Utils.showMessage('⚙️ Funzione di modifica esame in sviluppo');
            },

            delete(esameId) {
                const esame = APP_STATE.esami.find(e => e.id === esameId);
                if (!esame) return;

                const materia = APP_STATE.materie.find(m => m.id === esame.materiaId);
                if (!materia) return;

                if (confirm(`Sei sicuro di voler eliminare l'esame di "${materia.nome}"?\n\nLa materia tornerà allo stato "In Studio".`)) {
                    APP_STATE.esami = APP_STATE.esami.filter(e => e.id !== esameId);
                    materia.status = 'studio';
                    
                    Utils.saveData();
                    MaterieManager.load();
                    this.updateSection();
                    DashboardManager.update();
                    
                    Utils.showMessage('🗑️ Esame eliminato con successo');
                }
            }
        };

        // ========================================
        // 📋 PLAN MANAGER - PIANO DI STUDIO OTTIMIZZATO
        // ========================================
        const PlanManager = {
            generate() {
                try {
                    const materieInStudio = APP_STATE.materie.filter(m => m.status !== 'completato');
                    
                    if (materieInStudio.length === 0) {
                        this.showEmptyState();
                        return;
                    }

                    const planMetrics = this.calculateMetrics(materieInStudio);
                    this.updateOverview(planMetrics);
                    this.generateSuggestions(materieInStudio, planMetrics);
                    this.generateDetails(materieInStudio);
                    
                } catch (error) {
                    console.error('Errore nella generazione del piano:', error);
                }
            },

            calculateMetrics(materieInStudio) {
                let totalWeeklyHours = 0;
                let totalPages = 0;
                let totalRemainingPages = 0;
                let estimatedCompletionWeeks = 0;

                materieInStudio.forEach(materia => {
                    let oreSettimanali = 0;
                    if (materia.slotSettimanali) {
                        Object.values(materia.slotSettimanali).forEach(slots => {
                            slots.forEach(slot => {
                                const durata = Utils.calculateTaskDuration(slot.inizio, slot.fine);
                                oreSettimanali += durata;
                            });
                        });
                    }
                    totalWeeklyHours += oreSettimanali / 60;
                    
                    totalPages += materia.pagineStudio || 0;
                    const pagineRimanenti = (materia.pagineStudio || 0) - (materia.pagineStudiate || 0);
                    totalRemainingPages += Math.max(0, pagineRimanenti);
                    
                    if (oreSettimanali > 0 && pagineRimanenti > 0) {
                        const paginePerSettimana = (oreSettimanali / 60) * 8;
                        const settimaneRimanenti = Math.ceil(pagineRimanenti / paginePerSettimana);
                        estimatedCompletionWeeks = Math.max(estimatedCompletionWeeks, settimaneRimanenti);
                    }
                });

                return {
                    totalWeeklyHours: Math.round(totalWeeklyHours * 10) / 10,
                    avgDailyHours: Math.round((totalWeeklyHours / 7) * 10) / 10,
                    totalPages,
                    totalRemainingPages,
                    estimatedCompletionWeeks,
                    subjectsCount: materieInStudio.length
                };
            },

            updateOverview(metrics) {
                const elements = {
                    planSummary: document.getElementById('planSummary'),
                    totalWeeklyHours: document.getElementById('totalWeeklyHours'),
                    avgDailyHours: document.getElementById('avgDailyHours'),
                    totalPages: document.getElementById('totalPages'),
                    completionWeeks: document.getElementById('completionWeeks')
                };

                if (elements.planSummary) {
                    const summaryText = `Piano ottimizzato per ${metrics.subjectsCount} materie con un carico di studio di ${metrics.totalWeeklyHours}h settimanali. Completamento stimato in ${metrics.estimatedCompletionWeeks || 'N/A'} settimane.`;
                    elements.planSummary.textContent = summaryText;
                }

                if (elements.totalWeeklyHours) elements.totalWeeklyHours.textContent = `${metrics.totalWeeklyHours}h`;
                if (elements.avgDailyHours) elements.avgDailyHours.textContent = `${metrics.avgDailyHours}h`;
                if (elements.totalPages) elements.totalPages.textContent = metrics.totalRemainingPages;
                if (elements.completionWeeks) elements.completionWeeks.textContent = metrics.estimatedCompletionWeeks || 'N/A';
            },

            generateSuggestions(materieInStudio, metrics) {
                const suggestionsList = document.getElementById('suggestionsList');
                if (!suggestionsList) return;

                const suggestions = [];
                
                if (metrics.avgDailyHours > 6) {
                    suggestions.push({
                        title: "⚠️ Carico di Studio Intenso",
                        description: `Con ${metrics.avgDailyHours}h al giorno, considera di distribuire meglio il carico per evitare il burnout.`
                    });
                } else if (metrics.avgDailyHours < 2) {
                    suggestions.push({
                        title: "⚡ Opportunità di Ottimizzazione",
                        description: `Con solo ${metrics.avgDailyHours}h al giorno, potresti aumentare le ore di studio per raggiungere prima i tuoi obiettivi.`
                    });
                }

                const materieConScadenza = materieInStudio.filter(m => m.dataEsame);
                if (materieConScadenza.length > 0) {
                    const prossimeScadenze = materieConScadenza
                        .map(m => ({ ...m, daysToExam: Utils.getDaysToExam(m.dataEsame) }))
                        .filter(m => m.daysToExam <= 30 && m.daysToExam > 0)
                        .sort((a, b) => a.daysToExam - b.daysToExam);

                    if (prossimeScadenze.length > 0) {
                        suggestions.push({
                            title: "🎯 Focus su Priorità",
                            description: `${prossimeScadenze[0].nome} ha l'esame tra ${prossimeScadenze[0].daysToExam} giorni. Concentra i tuoi sforzi!`
                        });
                    }
                }

                if (suggestions.length === 0) {
                    suggestions.push({
                        title: "✅ Piano Ottimale",
                        description: "Il tuo piano di studio è ben bilanciato! Continua così e mantieni la costanza."
                    });
                }

                suggestionsList.innerHTML = suggestions.map(s => `
                    <div class="fade-in-up" style="background: rgba(6, 214, 160, 0.05); border: 1px solid rgba(6, 214, 160, 0.2); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="font-weight: 600; color: var(--secondary); margin-bottom: 0.5rem;">${s.title}</div>
                        <div style="color: var(--text-primary);">${s.description}</div>
                    </div>
                `).join('');
            },

            generateDetails(materieInStudio) {
                const detailsContainer = document.getElementById('pianDetails');
                if (!detailsContainer) return;

                const materieOrdinate = materieInStudio
                    .map(m => ({ ...m, smartPriority: Utils.calculateSmartPriority(m) }))
                    .sort((a, b) => b.smartPriority - a.smartPriority);

                detailsContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; margin-top: 2rem;">
                        ${materieOrdinate.map((materia, index) => {
                            const progress = Utils.calculateProgress(materia);
                            const pagineRimanenti = (materia.pagineStudio || 0) - (materia.pagineStudiate || 0);
                            const daysToExam = Utils.getDaysToExam(materia.dataEsame);
                            
                            let oreTotaliSettimanali = 0;
                            if (materia.slotSettimanali) {
                                Object.values(materia.slotSettimanali).forEach(slots => {
                                    slots.forEach(slot => {
                                        const durata = Utils.calculateTaskDuration(slot.inizio, slot.fine);
                                        oreTotaliSettimanali += durata;
                                    });
                                });
                            }
                            
                            const oreSettimanaliFormatted = Math.round(oreTotaliSettimanali / 60 * 10) / 10;
                            const settimaneRimanenti = oreSettimanaliFormatted > 0 ? 
                                Math.ceil(pagineRimanenti / ((oreSettimanaliFormatted) * 8)) : 'N/A';
                            
                            let borderColor = 'var(--border)';
                            let priorityIcon = '📚';
                            if (index === 0) { borderColor = 'var(--danger)'; priorityIcon = '🚨'; }
                            else if (index === 1) { borderColor = 'var(--warning)'; priorityIcon = '🔥'; }
                            else if (index === 2) { borderColor = 'var(--engineering)'; priorityIcon = '⭐'; }
                            
                            return `
                                <div class="fade-in-up" style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--border-radius); padding: 1.5rem; border-left: 4px solid ${borderColor}; transition: all var(--transition);">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap;">
                                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--engineering); flex: 1; min-width: 150px;">${materia.nome}</div>
                                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                            <div style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; background: rgba(245, 158, 11, 0.2); color: #fcd34d;">${materia.priorita}</div>
                                            <div style="background: ${borderColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.7rem; font-weight: 600; display: flex; align-items: center; gap: 0.25rem;" title="Posizione nella priorità">
                                                ${priorityIcon} #${index + 1}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                        <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--engineering);">${progress}%</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Completato</div>
                                        </div>
                                        <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${Math.max(0, pagineRimanenti)}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Pagine Rim.</div>
                                        </div>
                                        <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);">${oreSettimanaliFormatted}h</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Ore/Sett.</div>
                                        </div>
                                        <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${settimaneRimanenti}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Sett. Stim.</div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                                        <div style="font-weight: 600; color: var(--engineering); margin-bottom: 0.5rem;">🎯 Score Intelligente</div>
                                        <div style="font-size: 0.9rem; color: var(--text-primary);">
                                            <strong>${materia.smartPriority} punti</strong> • Posizione: <strong>#${index + 1}</strong>
                                        </div>
                                    </div>
                                    
                                    ${materia.dataEsame ? `
                                        <div style="margin-top: 1rem; padding: 0.75rem; background: ${daysToExam <= 14 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; border-radius: 8px;">
                                            <strong>📅 Esame:</strong> ${new Date(materia.dataEsame).toLocaleDateString('it-IT')}<br>
                                            <small style="color: ${daysToExam <= 14 ? 'var(--danger)' : 'var(--warning)'};">
                                                ${daysToExam <= 7 ? '🚨 URGENTE: ' : '⚠️ '}Giorni rimanenti: ${daysToExam || 'N/A'}
                                            </small>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            showEmptyState() {
                const detailsContainer = document.getElementById('pianDetails');
                const suggestionsList = document.getElementById('suggestionsList');
                
                if (detailsContainer) {
                    detailsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <p>Aggiungi delle materie per generare il tuo piano personalizzato!</p>
                            <p style="margin-top: 1rem;">
                                <button class="btn btn-engineering" onclick="Navigation.showSection('materie', document.querySelector('.nav-tab[onclick*=materie]'))">
                                    ➕ Aggiungi Prima Materia
                                </button>
                            </p>
                        </div>
                    `;
                }
                
                if (suggestionsList) {
                    suggestionsList.innerHTML = `
                        <div style="background: rgba(6, 214, 160, 0.05); border: 1px solid rgba(6, 214, 160, 0.2); border-radius: 12px; padding: 1rem;">
                            <div style="font-weight: 600; color: var(--secondary); margin-bottom: 0.5rem;">💡 Inizia il tuo percorso</div>
                            <div style="color: var(--text-primary);">Aggiungi materie per ricevere suggerimenti personalizzati!</div>
                        </div>
                    `;
                }
            }
        };

        // ========================================
        // 📅 CALENDAR MANAGER OTTIMIZZATO
        // ========================================
        const CalendarManager = {
            render() {
                const grid = document.getElementById('calendarGrid');
                const monthYearEl = document.getElementById('currentMonthYear');
                
                if (!grid || !monthYearEl) return;
                
                const year = APP_STATE.currentCalendarDate.getFullYear();
                const month = APP_STATE.currentCalendarDate.getMonth();
                
                monthYearEl.textContent = new Date(year, month).toLocaleDateString('it-IT', {
                    month: 'long',
                    year: 'numeric'
                });
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - (firstDay.getDay() + 6) % 7);
                
                grid.innerHTML = '';
                
                for (let i = 0; i < 42; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    
                    const dayEl = this.createDayElement(date, month);
                    grid.appendChild(dayEl);
                }
                
                this.updateMonthStats();
            },
            
            createDayElement(date, currentMonth) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                
                const dateStr = date.toDateString();
                const today = new Date().toDateString();
                
                if (date.getMonth() !== currentMonth) {
                    dayEl.style.opacity = '0.5';
                }
                
                if (dateStr === today) {
                    dayEl.classList.add('today');
                }
                
                const sessions = this.getSessionsForDate(dateStr);
                if (sessions.length > 0) {
                    dayEl.classList.add('has-sessions');
                }
                
                dayEl.innerHTML = `
                    <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">${date.getDate()}</div>
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                        ${sessions.slice(0, 3).map(session => 
                            `<div style="width: 100%; height: 4px; border-radius: 2px; background: var(--engineering);"></div>`
                        ).join('')}
                    </div>
                    ${sessions.length > 0 ? 
                        `<div style="font-size: 0.7rem; color: var(--text-secondary); text-align: center; margin-top: auto;">${sessions.length} sessioni</div>` : ''
                    }
                `;
                
                dayEl.addEventListener('click', () => this.showDayDetail(dateStr, sessions));
                
                return dayEl;
            },
            
            getSessionsForDate(dateStr) {
                const sessions = [];
                
                APP_STATE.sessioni.forEach(session => {
                    const sessionDate = new Date(session.timestamp).toDateString();
                    if (sessionDate === dateStr) {
                        sessions.push({ ...session, type: 'session' });
                    }
                });
                
                if (APP_STATE.calendarSessions[dateStr]) {
                    APP_STATE.calendarSessions[dateStr].forEach(session => {
                        sessions.push({ ...session, type: 'manual' });
                    });
                }
                
                return sessions.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            },

            showDayDetail(dateStr, sessions) {
                const sessionCount = sessions.length;
                const totalTime = sessions.reduce((sum, s) => sum + (s.duration || 25), 0);
                
                Utils.showMessage(`📅 ${new Date(dateStr).toLocaleDateString('it-IT')}: ${sessionCount} sessioni, ${Utils.formatTime(totalTime)} totali`);
            },

            changeMonth(direction) {
                APP_STATE.currentCalendarDate.setMonth(APP_STATE.currentCalendarDate.getMonth() + direction);
                this.render();
            },

            goToToday() {
                APP_STATE.currentCalendarDate = new Date();
                this.render();
            },

            addManualSession() {
                document.getElementById('sessionDate').value = Utils.formatDateForInput(new Date());
                
                const select = document.getElementById('sessionMateria');
                select.innerHTML = '<option value="">Sessione generica</option>';
                APP_STATE.materie.forEach(materia => {
                    if (materia.status !== 'completato') {
                        select.innerHTML += `<option value="${materia.nome}">${materia.nome}</option>`;
                    }
                });
                
                document.getElementById('addSessionModal').style.display = 'flex';
            },

            saveManualSession() {
                const dateInput = document.getElementById('sessionDate').value;
                const materia = document.getElementById('sessionMateria').value || 'Sessione generica';
                const duration = parseInt(document.getElementById('sessionDuration').value) || 25;
                const note = document.getElementById('sessionNote').value || '';
                
                if (!dateInput) {
                    Utils.showMessage('❌ Seleziona una data', 'error');
                    return;
                }
                
                const selectedDate = new Date(dateInput);
                const dateStr = selectedDate.toDateString();
                
                if (!APP_STATE.calendarSessions[dateStr]) {
                    APP_STATE.calendarSessions[dateStr] = [];
                }
                
                const sessionData = {
                    id: Date.now(),
                    materia,
                    duration,
                    note,
                    timestamp: selectedDate.toISOString(),
                    type: 'manual',
                    rating: 3
                };
                
                APP_STATE.calendarSessions[dateStr].push(sessionData);
                Utils.saveData();
                
                this.render();
                UI.closeAddSessionModal();
                
                document.getElementById('sessionNote').value = '';
                
                Utils.showMessage('✅ Sessione aggiunta al calendario!');
            },
            
            updateMonthStats() {
                const year = APP_STATE.currentCalendarDate.getFullYear();
                const month = APP_STATE.currentCalendarDate.getMonth();
                
                let totalSessions = 0;
                let totalMinutes = 0;
                let activeDays = new Set();
                
                for (let day = 1; day <= new Date(year, month + 1, 0).getDate(); day++) {
                    const date = new Date(year, month, day);
                    const dateStr = date.toDateString();
                    const sessions = this.getSessionsForDate(dateStr);
                    
                    if (sessions.length > 0) {
                        totalSessions += sessions.length;
                        totalMinutes += sessions.reduce((sum, s) => sum + (s.duration || 25), 0);
                        activeDays.add(day);
                    }
                }
                
                const avgSessionsPerDay = activeDays.size > 0 ? Math.round(totalSessions / activeDays.size * 10) / 10 : 0;
                
                const elements = {
                    monthSessions: document.getElementById('monthSessions'),
                    monthHours: document.getElementById('monthHours'),
                    monthDays: document.getElementById('monthDays'),
                    monthAverage: document.getElementById('monthAverage')
                };
                
                if (elements.monthSessions) elements.monthSessions.textContent = totalSessions;
                if (elements.monthHours) elements.monthHours.textContent = `${Math.round(totalMinutes / 60 * 10) / 10}h`;
                if (elements.monthDays) elements.monthDays.textContent = activeDays.size;
                if (elements.monthAverage) elements.monthAverage.textContent = avgSessionsPerDay;
            }
        };

        // ========================================
        // 📈 STATISTICS E ANALYTICS MANAGERS OTTIMIZZATI
        // ========================================
        const StatisticsManager = {
            update() {
                const container = document.getElementById('statisticheContent');
                if (!container) return;
                
                if (APP_STATE.materie.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <p>Aggiungi delle materie per vedere i tuoi progressi!</p>
                        </div>
                    `;
                    return;
                }
                
                const stats = this.calculateStats();
                
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--engineering);">${stats.totalSubjects}</div>
                            <div class="stat-label">Materie Totali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--success);">${stats.completedSubjects}</div>
                            <div class="stat-label">Materie Completate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning);">${stats.totalPages}</div>
                            <div class="stat-label">Pagine Totali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--secondary);">${stats.studiedPages}</div>
                            <div class="stat-label">Pagine Studiate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--accent);">${stats.weeklyHours}h</div>
                            <div class="stat-label">Ore Settimanali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--engineering);">${stats.avgProgress}%</div>
                            <div class="stat-label">Progresso Medio</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <h4 style="margin-bottom: 1rem;">📈 Progresso per Materia</h4>
                        ${APP_STATE.materie.filter(m => m.status !== 'completato').map(materia => {
                            const progress = Utils.calculateProgress(materia);
                            return `
                                <div class="fade-in-up" style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 1rem;">
                                        <span style="font-weight: 600; flex: 1; min-width: 150px;">${materia.nome}</span>
                                        <span style="color: var(--secondary); font-weight: 600;">${progress}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <small style="color: var(--text-secondary);">
                                        ${materia.pagineStudiate || 0}/${materia.pagineStudio || 0} pagine
                                        ${materia.numeroEsercizi > 0 ? ` • ${materia.eserciziCompletati || 0}/${materia.numeroEsercizi} esercizi` : ''}
                                    </small>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },
            
            calculateStats() {
                const totalSubjects = APP_STATE.materie.length;
                const completedSubjects = APP_STATE.materie.filter(m => m.status === 'completato').length;
                const totalPages = APP_STATE.materie.reduce((sum, m) => sum + (m.pagineStudio || 0), 0);
                const studiedPages = APP_STATE.materie.reduce((sum, m) => sum + (m.pagineStudiate || 0), 0);
                
                let weeklyHours = 0;
                APP_STATE.materie.forEach(materia => {
                    if (materia.slotSettimanali) {
                        Object.values(materia.slotSettimanali).forEach(slots => {
                            slots.forEach(slot => {
                                weeklyHours += Utils.calculateTaskDuration(slot.inizio, slot.fine);
                            });
                        });
                    }
                });
                weeklyHours = Math.round(weeklyHours / 60 * 10) / 10;
                
                const avgProgress = totalPages > 0 ? Math.round((studiedPages / totalPages) * 100) : 0;
                
                return {
                    totalSubjects,
                    completedSubjects,
                    totalPages,
                    studiedPages,
                    weeklyHours,
                    avgProgress
                };
            }
        };

        // Heatmap Manager Ottimizzato
        const HeatmapManager = {
            update() {
                const heatmapGrid = document.getElementById('heatmapGrid');
                if (!heatmapGrid) return;
                
                heatmapGrid.innerHTML = '';
                
                for (let hour = 0; hour < 24; hour++) {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    cell.textContent = hour.toString().padStart(2, '0');
                    cell.dataset.hour = hour;
                    
                    const avgRating = this.calculateHourlyAverageRating(hour);
                    
                    if (avgRating === 0) {
                        cell.classList.add('empty');
                    } else if (avgRating <= 1.5) {
                        cell.classList.add('low');
                    } else if (avgRating <= 2.5) {
                        cell.classList.add('medium');
                    } else if (avgRating <= 3.5) {
                        cell.classList.add('high');
                    } else {
                        cell.classList.add('very-high');
                    }
                    
                    cell.addEventListener('mouseenter', (e) => this.showTooltip(e, hour));
                    
                    heatmapGrid.appendChild(cell);
                }
            },

            calculateHourlyAverageRating(hour) {
                let totalRating = 0;
                let sessionCount = 0;
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                APP_STATE.sessioni.forEach(session => {
                    const sessionDate = new Date(session.timestamp);
                    const sessionHour = sessionDate.getHours();
                    
                    if (sessionDate >= thirtyDaysAgo && sessionHour === hour) {
                        totalRating += session.rating;
                        sessionCount++;
                    }
                });
                
                return sessionCount > 0 ? totalRating / sessionCount : 0;
            },

            getHourlySessionCount(hour) {
                let sessionCount = 0;
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                APP_STATE.sessioni.forEach(session => {
                    const sessionDate = new Date(session.timestamp);
                    const sessionHour = sessionDate.getHours();
                    
                    if (sessionDate >= thirtyDaysAgo && sessionHour === hour) {
                        sessionCount++;
                    }
                });
                
                return sessionCount;
            },

            showTooltip(event, hour) {
                const avgRating = this.calculateHourlyAverageRating(hour);
                const sessionCount = this.getHourlySessionCount(hour);
                
                let tooltipText = `${hour}:00-${hour + 1}:00\n`;
                
                if (sessionCount === 0) {
                    tooltipText += 'Nessuna sessione';
                } else {
                    const ratingText = avgRating <= 1.5 ? 'Bassa' : 
                                     avgRating <= 2.5 ? 'Media' : 
                                     avgRating <= 3.5 ? 'Alta' : 'Eccellente';
                    tooltipText += `Produttività: ${ratingText}\n${sessionCount} sessioni\nRating: ${avgRating.toFixed(1)}/4`;
                }
                
                event.target.title = tooltipText;
            }
        };

        // Productivity Analyzer Ottimizzato
        const ProductivityAnalyzer = {
            update() {
                this.updateTopHours();
                this.updateSuggestion();
            },

            updateTopHours() {
                const topHoursGrid = document.getElementById('topHoursGrid');
                if (!topHoursGrid) return;
                
                const hourlyRatings = [];
                for (let hour = 0; hour < 24; hour++) {
                    const avgRating = HeatmapManager.calculateHourlyAverageRating(hour);
                    const sessionCount = HeatmapManager.getHourlySessionCount(hour);
                    
                    if (sessionCount > 0) {
                        hourlyRatings.push({
                            hour: hour,
                            avgRating: avgRating,
                            sessionCount: sessionCount
                        });
                    }
                }
                
                hourlyRatings.sort((a, b) => b.avgRating - a.avgRating);
                const top3 = hourlyRatings.slice(0, 3);
                
                if (top3.length === 0) {
                    topHoursGrid.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">📊</div>
                            <p>Completa alcune sessioni per scoprire i tuoi orari migliori!</p>
                        </div>
                    `;
                    return;
                }
                
                topHoursGrid.innerHTML = top3.map((hour, index) => {
                    const ratingText = hour.avgRating <= 1.5 ? 'Bassa' : 
                                      hour.avgRating <= 2.5 ? 'Media' : 
                                      hour.avgRating <= 3.5 ? 'Alta' : 'Eccellente';
                    
                    const rankEmojis = ['🥇', '🥈', '🥉'];
                    
                    return `
                        <div class="fade-in-up" style="background: var(--bg-card); border-radius: 12px; padding: 1.5rem; text-align: center; border: 2px solid var(--border); transition: all 0.3s ease;">
                            <div style="font-size: 2rem; font-weight: 800; color: var(--success); margin-bottom: 0.5rem;">${rankEmojis[index]}</div>
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--engineering); margin-bottom: 0.5rem;">${hour.hour}:00 - ${hour.hour + 1}:00</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                ${ratingText} (${hour.avgRating.toFixed(1)}/4)<br>
                                <small style="color: var(--text-muted);">${hour.sessionCount} sessioni</small>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            updateSuggestion() {
                const suggestionEl = document.getElementById('productivitySuggestion');
                if (!suggestionEl) return;
                
                const hourlyRatings = [];
                for (let hour = 0; hour < 24; hour++) {
                    const avgRating = HeatmapManager.calculateHourlyAverageRating(hour);
                    const sessionCount = HeatmapManager.getHourlySessionCount(hour);
                    
                    if (sessionCount > 0) {
                        hourlyRatings.push({
                            hour: hour,
                            avgRating: avgRating,
                            sessionCount: sessionCount
                        });
                    }
                }
                
                if (hourlyRatings.length === 0) {
                    suggestionEl.innerHTML = `
                        <h4 style="color: var(--engineering); margin-bottom: 0.75rem;">💡 Suggerimento Smart</h4>
                        <p style="color: var(--text-primary);">Aggiungi delle sessioni di studio per scoprire i tuoi momenti più produttivi!</p>
                    `;
                    return;
                }
                
                hourlyRatings.sort((a, b) => b.avgRating - a.avgRating);
                const bestHour = hourlyRatings[0];
                const worstHour = hourlyRatings[hourlyRatings.length - 1];
                
                let suggestion = '';
                
                if (bestHour.avgRating >= 3.5) {
                    suggestion = `🌟 Ottimo! Il tuo momento migliore è alle ${bestHour.hour}:00 con un rating di ${bestHour.avgRating.toFixed(1)}/4. Cerca di programmare le materie più difficili in questo orario.`;
                } else if (bestHour.avgRating >= 2.5) {
                    suggestion = `📈 Il tuo orario più produttivo è alle ${bestHour.hour}:00. Prova a ottimizzare questo slot con pause regolari.`;
                } else {
                    suggestion = `⚡ Il tuo orario migliore è alle ${bestHour.hour}:00, ma puoi migliorare. Sperimenta con diverse tecniche di studio.`;
                }
                
                if (worstHour.avgRating < 2 && hourlyRatings.length > 3) {
                    suggestion += ` Evita di studiare alle ${worstHour.hour}:00 quando possibile.`;
                }
                
                suggestionEl.innerHTML = `
                    <h4 style="color: var(--engineering); margin-bottom: 0.75rem;">💡 Suggerimento Smart</h4>
                    <p style="color: var(--text-primary);">${suggestion}</p>
                `;
            }
        };

        // ========================================
        // 🎯 HELPER MANAGER OTTIMIZZATO
        // ========================================
        const HelperManager = {
            init() {
                // Initialize helper with current state
            },

            prioritizeByDate() {
                if (APP_STATE.materie.length === 0) {
                    Utils.showMessage('❌ Aggiungi prima delle materie', 'error');
                    return;
                }

                const materieConDate = APP_STATE.materie
                    .filter(m => m.status !== 'completato' && m.dataEsame)
                    .sort((a, b) => new Date(a.dataEsame) - new Date(b.dataEsame));

                const materieSenzaDate = APP_STATE.materie
                    .filter(m => m.status !== 'completato' && !m.dataEsame)
                    .sort((a, b) => Utils.calculateSmartPriority(b) - Utils.calculateSmartPriority(a));

                const strategia = [...materieConDate, ...materieSenzaDate];
                
                this.showResults('📅 Strategia: Priorità per Scadenze', strategia, 
                    'Ordinate per data di esame. Concentrati sulle scadenze più vicine prima di passare alle altre materie.');
            },

            prioritizeByDifficulty() {
                if (APP_STATE.materie.length === 0) {
                    Utils.showMessage('❌ Aggiungi prima delle materie', 'error');
                    return;
                }

                const strategia = APP_STATE.materie
                    .filter(m => m.status !== 'completato')
                    .sort((a, b) => (b.difficolta || 3) - (a.difficolta || 3));
                
                this.showResults('⭐ Strategia: Priorità per Difficoltà', strategia,
                    'Inizia dalle materie più difficili quando la tua mente è fresca. Affronta le sfide maggiori per prime.');
            },

            balancedApproach() {
                if (APP_STATE.materie.length === 0) {
                    Utils.showMessage('❌ Aggiungi prima delle materie', 'error');
                    return;
                }

                const strategia = APP_STATE.materie
                    .filter(m => m.status !== 'completato')
                    .sort((a, b) => Utils.calculateSmartPriority(b) - Utils.calculateSmartPriority(a));
                
                this.showResults('⚖️ Strategia: Approccio Bilanciato', strategia,
                    'Algoritmo intelligente che bilancia scadenze, difficoltà, CFU e progresso per il piano ottimale.');
            },

            showResults(title, strategia, explanation) {
                const resultsContainer = document.getElementById('helperResults');
                const contentContainer = document.getElementById('helperContent');

                contentContainer.innerHTML = `
                    <div style="background: rgba(6, 214, 160, 0.1); border: 1px solid rgba(6, 214, 160, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                        <h4 style="color: var(--secondary); margin-bottom: 1rem;">📋 ${title}</h4>
                        <p style="color: var(--text-primary); line-height: 1.6; margin-bottom: 1.5rem;">${explanation}</p>
                        <button class="btn btn-engineering" onclick="HelperManager.apply()">✅ Applica Questa Strategia</button>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                        ${strategia.map((materia, index) => {
                            const priority = Utils.calculateSmartPriority(materia);
                            const progress = Utils.calculateProgress(materia);
                            const daysToExam = Utils.getDaysToExam(materia.dataEsame);
                            
                            const getPriorityColor = (index) => {
                                if (index === 0) return 'var(--danger)';
                                if (index === 1) return 'var(--warning)';
                                if (index === 2) return 'var(--engineering)';
                                return 'var(--secondary)';
                            };
                            
                            return `
                                <div class="fade-in-up" style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; border-left: 4px solid ${getPriorityColor(index)};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                        <h4 style="color: var(--text-primary); margin: 0;">${index + 1}. ${materia.nome}</h4>
                                        <span style="background: ${getPriorityColor(index)}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                            Pos. ${index + 1}
                                        </span>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                        <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px;">
                                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--engineering);">${priority}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Score</div>
                                        </div>
                                        <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px;">
                                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--secondary);">${progress}%</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Progresso</div>
                                        </div>
                                    </div>
                                    
                                    <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.4;">
                                        <div><strong>CFU:</strong> ${materia.cfu}</div>
                                        <div><strong>Difficoltà:</strong> ${'★'.repeat(materia.difficolta || 3)}${'☆'.repeat(5-(materia.difficolta || 3))}</div>
                                        <div><strong>Priorità:</strong> ${materia.priorita}</div>
                                        ${daysToExam ? `<div><strong>Esame tra:</strong> ${daysToExam} giorni</div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;

                resultsContainer.classList.remove('hidden');
                APP_STATE.helperCurrentStrategy = strategia;
            },

            apply() {
                if (!APP_STATE.helperCurrentStrategy) return;

                APP_STATE.helperCurrentStrategy.forEach((materia, index) => {
                    const original = APP_STATE.materie.find(m => m.id === materia.id);
                    if (original) {
                        if (index < 2) original.priorita = 'alta';
                        else if (index < 4) original.priorita = 'media';
                        else original.priorita = 'bassa';
                    }
                });

                Utils.saveData();
                MaterieManager.load();
                SmartPlanner.generateTodaySchedule();
                PlanManager.generate();

                Utils.showMessage('✅ Strategia applicata! Le priorità delle materie sono state aggiornate.');
                
                document.getElementById('helperResults').classList.add('hidden');
            }
        };

        // ========================================
        // 🚀 ANTI-PROCRASTINATION SYSTEM
        // ========================================
        const AntiProcrastination = {
            motivationalQuotes: [
                "Il modo migliore per iniziare è smettere di parlare e iniziare a fare. - Walt Disney",
                "Un viaggio di mille miglia inizia con un singolo passo. - Lao Tzu",
                "Il segreto per andare avanti è iniziare. - Mark Twain",
                "Non aspettare il momento perfetto. Prendi il momento e rendilo perfetto.",
                "Ogni esperto è stato una volta un principiante. - Robin Sharma",
                "Il progresso, non la perfezione, è l'obiettivo. - Winston Churchill",
                "Piccoli passi ogni giorno portano a grandi cambiamenti nel tempo.",
                "La disciplina è la scelta tra quello che vuoi ora e quello che vuoi di più."
            ],

            init() {
                this.showMotivationalQuote();
                this.checkAndShowQuickStart();
            },

            showMotivationalQuote() {
                const quoteEl = document.getElementById('motivationalQuote');
                if (quoteEl) {
                    const randomQuote = this.motivationalQuotes[Math.floor(Math.random() * this.motivationalQuotes.length)];
                    quoteEl.textContent = randomQuote;
                }
            },

            checkAndShowQuickStart() {
                const today = new Date().toDateString();
                const todaySessions = APP_STATE.sessioni.filter(s => 
                    new Date(s.timestamp).toDateString() === today
                );
                
                if (todaySessions.length === 0) {
                    setTimeout(() => {
                        Utils.showMessage('🌅 Buongiorno! Inizia con una micro-sessione per rompere la procrastinazione!');
                    }, 2000);
                }
            },

            quickStart(minutes) {
                const activeSubjects = APP_STATE.materie.filter(m => m.status !== 'completato');
                if (activeSubjects.length === 0) {
                    Utils.showMessage('❌ Aggiungi prima delle materie per iniziare', 'error');
                    return;
                }

                const sortedSubjects = activeSubjects
                    .map(m => ({ ...m, priority: Utils.calculateSmartPriority(m) }))
                    .sort((a, b) => b.priority - a.priority);

                const topSubject = sortedSubjects[0];
                
                APP_STATE.currentSession.materia = topSubject;
                APP_STATE.currentSession.studyType = 'theory';
                
                TimerManager.setPreset(minutes, Math.ceil(minutes / 5), null);
                Navigation.showSection('pomodoro', document.querySelector('.nav-tab[onclick*=pomodoro]'));
                
                setTimeout(() => {
                    PomodoroManager.updateSelectedStudyInfo();
                    
                    const subjectOption = document.querySelector(`[data-subject-id="${topSubject.id}"]`);
                    if (subjectOption) {
                        subjectOption.classList.add('selected');
                    }
                    
                    const theoryCard = document.querySelector('[data-type="theory"]');
                    if (theoryCard) {
                        theoryCard.classList.add('selected');
                    }
                }, 500);
                
                Utils.showMessage(`🚀 Quick Start di ${minutes} minuti per ${topSubject.nome}! Inizia subito!`);
            },

            showBreakdown() {
                document.getElementById('microGoalsModal').style.display = 'flex';
            },

            generateMicroTasks() {
                const mainGoal = document.getElementById('mainGoal').value.trim();
                if (!mainGoal) {
                    Utils.showMessage('❌ Inserisci un obiettivo principale', 'error');
                    return;
                }

                const microTasks = this.breakDownGoal(mainGoal);
                const container = document.getElementById('microTasksList');
                
                container.innerHTML = `
                    <h4 style="margin-bottom: 1rem;">📝 I tuoi micro-task:</h4>
                    ${microTasks.map((task, index) => `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--engineering);">
                            <input type="checkbox" onchange="AntiProcrastination.toggleTask(${index})" style="width: 20px; height: 20px;">
                            <span style="flex: 1;">${index + 1}. ${task}</span>
                            <span style="color: var(--secondary); font-size: 0.8rem;">~${Math.ceil(Math.random() * 10 + 5)} min</span>
                        </div>
                    `).join('')}
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(6, 214, 160, 0.1); border-radius: 8px; border: 1px solid rgba(6, 214, 160, 0.3);">
                        <h5 style="color: var(--secondary); margin-bottom: 0.5rem;">💡 Consiglio Smart:</h5>
                        <p style="color: var(--text-primary); font-size: 0.9rem;">Inizia dal primo task. Completane uno alla volta senza pensare agli altri. Ogni piccolo passo ti avvicina al successo!</p>
                    </div>
                `;
            },

            breakDownGoal(goal) {
                const commonBreakdowns = {
                    'capitolo': [
                        'Leggi l\'introduzione e gli obiettivi del capitolo',
                        'Scorri velocemente tutto il capitolo per avere una panoramica',
                        'Leggi attentamente la prima sezione',
                        'Prendi appunti sui concetti chiave della prima sezione',
                        'Fai una pausa di 5 minuti',
                        'Leggi la seconda sezione',
                        'Crea una mappa mentale dei concetti principali',
                        'Rileggi le parti difficili',
                        'Fai un riassunto di una pagina',
                        'Rispondi alle domande di fine capitolo (se presenti)'
                    ],
                    'esercizi': [
                        'Rileggi la teoria relativa agli esercizi',
                        'Guarda l\'esempio svolto (se presente)',
                        'Prova il primo esercizio senza guardare la soluzione',
                        'Controlla la soluzione e correggi gli errori',
                        'Identifica i passaggi che non hai capito',
                        'Riprova l\'esercizio da capo',
                        'Passa al secondo esercizio',
                        'Confronta i metodi usati nei diversi esercizi',
                        'Annota le formule e strategie utili',
                        'Fai un esercizio simile per verificare la comprensione'
                    ]
                };

                const goalLower = goal.toLowerCase();
                
                if (goalLower.includes('capitolo') || goalLower.includes('lezione') || goalLower.includes('teoria')) {
                    return commonBreakdowns.capitolo;
                } else if (goalLower.includes('esercizi') || goalLower.includes('problemi') || goalLower.includes('homework')) {
                    return commonBreakdowns.esercizi;
                } else {
                    return [
                        'Prepara tutto il materiale necessario',
                        'Definisci l\'obiettivo specifico della sessione',
                        'Inizia con 5 minuti di lettura veloce',
                        'Identifica i concetti principali',
                        'Approfondisci il primo concetto',
                        'Prendi appunti schematici',
                        'Fai una pausa di 5 minuti',
                        'Continua con il secondo concetto',
                        'Collega i concetti tra loro',
                        'Riassumi quello che hai imparato'
                    ];
                }
            },

            toggleTask(index) {
                const taskElements = document.querySelectorAll('#microTasksList input[type="checkbox"]');
                const completedTasks = Array.from(taskElements).filter(el => el.checked).length;
                const totalTasks = taskElements.length;
                
                if (completedTasks === totalTasks) {
                    setTimeout(() => {
                        Utils.showMessage('🎉 Complimenti! Hai completato tutti i micro-task! Sei un campione!');
                        this.closeMicroGoals();
                    }, 500);
                } else if (completedTasks > 0) {
                    Utils.showMessage(`✅ Task completato! ${completedTasks}/${totalTasks} - Continua così!`);
                }
            },

            closeMicroGoals() {
                document.getElementById('microGoalsModal').style.display = 'none';
                document.getElementById('mainGoal').value = '';
                document.getElementById('microTasksList').innerHTML = '';
            }
        };

        // ========================================
        // 🤖 STUDY ASSISTANT AI CHATBOT
        // ========================================
        const StudyAssistant = {
            isOpen: false,
            conversationHistory: [],

            toggle() {
                if (this.isOpen) {
                    this.close();
                } else {
                    this.open();
                }
            },

            open() {
                document.getElementById('studyAssistantModal').style.display = 'flex';
                this.isOpen = true;
                this.updateAISuggestion();
                
                setTimeout(() => {
                    document.getElementById('chatInput').focus();
                }, 300);
            },

            close() {
                document.getElementById('studyAssistantModal').style.display = 'none';
                this.isOpen = false;
            },

            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;
                
                this.addMessageToChat(message, 'user');
                input.value = '';
                
                this.showTypingIndicator();
                
                try {
                    const response = await this.getAIResponse(message);
                    this.removeTypingIndicator();
                    this.addMessageToChat(response, 'assistant');
                } catch (error) {
                    console.error('Errore nella risposta AI:', error);
                    this.removeTypingIndicator();
                    this.addMessageToChat('Mi dispiace, sto avendo alcuni problemi tecnici. Prova a riformulare la domanda o riprova più tardi.', 'assistant');
                }
            },

            addMessageToChat(message, sender) {
                const chatContainer = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}-message`;
                
                const bgColor = sender === 'user' ? 'var(--engineering)' : 'var(--secondary)';
                const alignment = sender === 'user' ? 'margin-left: 20%; margin-right: 0;' : 'margin-right: 20%; margin-left: 0;';
                
                messageDiv.innerHTML = `
                    <div style="background: ${bgColor}; color: white; padding: 0.75rem; border-radius: 12px; margin-bottom: 1rem; max-width: 80%; ${alignment}">
                        ${message}
                    </div>
                `;
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            },

            showTypingIndicator() {
                const chatContainer = document.getElementById('chatContainer');
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typingIndicator';
                typingDiv.className = 'chat-message assistant-message';
                
                typingDiv.innerHTML = `
                    <div style="background: var(--secondary); color: white; padding: 0.75rem; border-radius: 12px; margin-bottom: 1rem; max-width: 80%; margin-right: 20%; margin-left: 0;">
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <span>Sto pensando</span>
                            <div style="display: flex; gap: 2px;">
                                <div style="width: 4px; height: 4px; background: white; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
                                <div style="width: 4px; height: 4px; background: white; border-radius: 50%; animation: pulse 1.5s infinite 0.2s;"></div>
                                <div style="width: 4px; height: 4px; background: white; border-radius: 50%; animation: pulse 1.5s infinite 0.4s;"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                chatContainer.appendChild(typingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            },

            removeTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            },

            async getAIResponse(userMessage) {
                const userContext = this.prepareUserContext();
                
                const systemPrompt = `Sei un assistente di studio specializzato per studenti di Ingegneria Aerospaziale. Il tuo compito è fornire consigli pratici, motivazione e strategie di studio personalizzate.

DATI DELLO STUDENTE:
${userContext}

LINEE GUIDA:
- Rispondi sempre in italiano
- Sii motivazionale ma realistico
- Fornisci consigli pratici e actionable
- Usa un tono amichevole e incoraggiante
- Se l'utente ha problemi di procrastinazione, suggerisci tecniche specifiche
- Se chiede priorità nelle materie, usa i dati per dare consigli mirati
- Mantieni le risposte concise ma utili (max 200 parole)
- Usa emoji appropriati per rendere la comunicazione più friendly

DOMANDA UTENTE: ${userMessage}`;

                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 500,
                            messages: [
                                { role: "user", content: systemPrompt }
                            ]
                        })
                    });

                    const data = await response.json();
                    return data.content[0].text;
                    
                } catch (error) {
                    console.error('Errore API Claude:', error);
                    return this.getFallbackResponse(userMessage);
                }
            },

            prepareUserContext() {
                const activeSubjects = APP_STATE.materie.filter(m => m.status !== 'completato');
                const completedExams = APP_STATE.esami.length;
                const totalSessions = APP_STATE.studyData.totalSessions;
                const streak = APP_STATE.studyData.streak;
                
                const upcomingExams = activeSubjects
                    .filter(m => m.dataEsame)
                    .map(m => ({ nome: m.nome, giorni: Utils.getDaysToExam(m.dataEsame) }))
                    .filter(m => m.giorni > 0 && m.giorni <= 60)
                    .sort((a, b) => a.giorni - b.giorni);

                return `
- Materie in studio: ${activeSubjects.length}
- Esami completati: ${completedExams}
- Sessioni di studio totali: ${totalSessions}
- Streak giorni consecutivi: ${streak}
- Prossimi esami: ${upcomingExams.length > 0 ? upcomingExams.map(e => `${e.nome} (${e.giorni} giorni)`).join(', ') : 'Nessuno programmato'}
- Materie con priorità alta: ${activeSubjects.filter(m => m.priorita === 'alta').length}
                `.trim();
            },

            getFallbackResponse(message) {
                const messageLower = message.toLowerCase();
                
                if (messageLower.includes('procrastin')) {
                    return "🚀 Per combattere la procrastinazione, prova la tecnica dei 2 minuti: inizia a studiare per soli 2 minuti. Spesso l'inizio è la parte più difficile! Poi usa il timer Pomodoro per mantenere il ritmo. Ricorda: un piccolo passo è meglio di nessun passo! 💪";
                } else if (messageLower.includes('concentr')) {
                    return "🎯 Per migliorare la concentrazione: 1) Elimina tutte le distrazioni (telefono in modalità aereo) 2) Usa la tecnica Pomodoro (25min focus + 5min pausa) 3) Studia sempre nello stesso posto 4) Inizia con gli argomenti più difficili quando sei più fresco. La concentrazione è un muscolo che si allena! 🧠";
                } else if (messageLower.includes('motiv')) {
                    return "💪 Ricorda perché hai scelto Ingegneria: per costruire il futuro! Ogni formula che impari, ogni esercizio che risolvi ti avvicina al tuo sogno. Non stai solo studiando, stai diventando un ingegnere! I momenti difficili sono temporanei, ma il titolo di studio è per sempre. Continua così! 🚀";
                } else if (messageLower.includes('quale materia') || messageLower.includes('priorit')) {
                    return "📚 Per scegliere quale materia studiare: 1) Guarda le date degli esami più vicini 2) Considera la difficoltà della materia 3) Valuta i CFU 4) Pensa ai prerequisiti per altre materie. L'app ha un sistema intelligente che calcola automaticamente le priorità! Usa l'Helper per un piano personalizzato. 🎯";
                } else {
                    return "🤖 Sono qui per aiutarti con lo studio! Puoi chiedermi consigli su: procrastinazione, concentrazione, motivazione, pianificazione materie, tecniche di studio. Oppure usa le domande rapide qui sotto per suggerimenti specifici! 📚";
                }
            },

            quickQuestion(question) {
                document.getElementById('chatInput').value = question;
                this.sendMessage();
            },

            updateAISuggestion() {
                const suggestionEl = document.getElementById('aiSuggestion');
                if (!suggestionEl) return;
                
                const activeSubjects = APP_STATE.materie.filter(m => m.status !== 'completato');
                const todaySessions = APP_STATE.sessioni.filter(s => 
                    new Date(s.timestamp).toDateString() === new Date().toDateString()
                );
                
                let suggestion = "";
                
                if (todaySessions.length === 0 && activeSubjects.length > 0) {
                    const topSubject = activeSubjects
                        .map(m => ({ ...m, priority: Utils.calculateSmartPriority(m) }))
                        .sort((a, b) => b.priority - a.priority)[0];
                    
                    suggestion = `🎯 Buongiorno! Inizia la giornata con ${topSubject.nome} - è la materia con priorità più alta. Usa il Quick Start per rompere la procrastinazione!`;
                } else if (todaySessions.length > 0 && todaySessions.length < 4) {
                    suggestion = `💪 Ottimo lavoro! Hai già completato ${todaySessions.length} sessioni oggi. Continua così per raggiungere il tuo obiettivo giornaliero!`;
                } else if (todaySessions.length >= 4) {
                    suggestion = `🎉 Fantastico! Hai superato l'obiettivo di oggi. Considera di fare una pausa lunga o dedicarti al ripasso degli argomenti studiati.`;
                } else {
                    suggestion = `🤖 Ciao! Sono qui per aiutarti con consigli personalizzati. Clicca su "Chat" per parlare con me!`;
                }
                
                suggestionEl.innerHTML = `<div style="font-size: 0.9rem; opacity: 0.9;">${suggestion}</div>`;
            }
        };

        // ========================================
        // 🎓 SEMESTER PLANNING WIZARD
        // ========================================
        const SemesterWizard = {
            currentStep: 1,
            selectedPriorities: [],
            recommendedPlan: null,

            open() {
                if (APP_STATE.materie.length === 0) {
                    Utils.showMessage('❌ Aggiungi prima delle materie per usare il wizard', 'error');
                    return;
                }
                
                document.getElementById('semesterWizardModal').style.display = 'flex';
                this.currentStep = 1;
                this.showStep(1);
            },

            close() {
                document.getElementById('semesterWizardModal').style.display = 'none';
                this.currentStep = 1;
                this.selectedPriorities = [];
            },

            nextStep(step) {
                this.currentStep = step;
                this.showStep(step);
                
                if (step === 2) {
                    this.generateRecommendedPlan();
                }
            },

            showStep(step) {
                document.querySelectorAll('.wizard-step').forEach(s => s.classList.add('hidden'));
                document.getElementById(`wizardStep${step}`).classList.remove('hidden');
            },

            generateRecommendedPlan() {
                this.selectedPriorities = Array.from(document.querySelectorAll('#wizardStep1 input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
                
                const activeSubjects = APP_STATE.materie.filter(m => m.status !== 'completato');
                
                let sortedSubjects = [...activeSubjects];
                
                if (this.selectedPriorities.includes('scadenze')) {
                    sortedSubjects.sort((a, b) => {
                        const daysA = Utils.getDaysToExam(a.dataEsame) || 999;
                        const daysB = Utils.getDaysToExam(b.dataEsame) || 999;
                        return daysA - daysB;
                    });
                } else if (this.selectedPriorities.includes('cfu')) {
                    sortedSubjects.sort((a, b) => b.cfu - a.cfu);
                } else if (this.selectedPriorities.includes('difficolta')) {
                    sortedSubjects.sort((a, b) => (b.difficolta || 3) - (a.difficolta || 3));
                } else if (this.selectedPriorities.includes('media')) {
                    sortedSubjects.sort((a, b) => Utils.calculateSmartPriority(b) - Utils.calculateSmartPriority(a));
                } else {
                    sortedSubjects.sort((a, b) => Utils.calculateSmartPriority(b) - Utils.calculateSmartPriority(a));
                }
                
                this.recommendedPlan = sortedSubjects;
                this.displayRecommendedPlan();
            },

            displayRecommendedPlan() {
                const container = document.getElementById('recommendedPlan');
                
                container.innerHTML = `
                    <h5 style="margin-bottom: 1rem;">📋 Piano Raccomandato basato sulle tue priorità:</h5>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Priorità selezionate: ${this.selectedPriorities.length > 0 ? this.selectedPriorities.join(', ') : 'Algoritmo standard'}
                    </p>
                    
                    <div style="display: grid; gap: 1rem;">
                        ${this.recommendedPlan.map((materia, index) => {
                            const daysToExam = Utils.getDaysToExam(materia.dataEsame);
                            const priority = Utils.calculateSmartPriority(materia);
                            const progress = Utils.calculateProgress(materia);
                            
                            let priorityColor = 'var(--secondary)';
                            let priorityLabel = 'Normale';
                            
                            if (index === 0) { priorityColor = 'var(--danger)'; priorityLabel = 'MASSIMA'; }
                            else if (index === 1) { priorityColor = 'var(--warning)'; priorityLabel = 'Alta'; }
                            else if (index === 2) { priorityColor = 'var(--engineering)'; priorityLabel = 'Media-Alta'; }
                            
                            return `
                                <div style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; border-left: 4px solid ${priorityColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 1rem;">
                                        <strong style="color: var(--text-primary);">${index + 1}. ${materia.nome}</strong>
                                        <span style="background: ${priorityColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                            ${priorityLabel}
                                        </span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.4;">
                                        <div>CFU: ${materia.cfu} • Difficoltà: ${'★'.repeat(materia.difficolta || 3)} • Progresso: ${progress}%</div>
                                        ${daysToExam ? `<div style="color: ${daysToExam <= 30 ? 'var(--danger)' : 'var(--warning)'};">📅 Esame tra ${daysToExam} giorni</div>` : ''}
                                        <div style="margin-top: 0.5rem; font-style: italic;">
                                            ${this.getRecommendationReason(materia, index)}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(6, 214, 160, 0.1); border-radius: 8px; border: 1px solid rgba(6, 214, 160, 0.3);">
                        <h5 style="color: var(--secondary); margin-bottom: 0.5rem;">💡 Strategia Consigliata:</h5>
                        <p style="color: var(--text-primary); font-size: 0.9rem;">
                            ${this.getStrategyAdvice()}
                        </p>
                    </div>
                `;
            },

            getRecommendationReason(materia, index) {
                const daysToExam = Utils.getDaysToExam(materia.dataEsame);
                const progress = Utils.calculateProgress(materia);
                
                if (index === 0) {
                    if (daysToExam && daysToExam <= 30) {
                        return `🚨 Priorità massima: esame imminente`;
                    } else if (progress < 20) {
                        return `🎯 Priorità massima: materia indietro, servono più ore`;
                    } else {
                        return `⭐ Priorità massima: combinazione ottimale di fattori`;
                    }
                } else if (index <= 2) {
                    return `📚 Concentrati su questa dopo la prima - buon equilibrio tra urgenza e importanza`;
                } else {
                    return `⏰ Pianifica per dopo - meno urgente al momento`;
                }
            },

            getStrategyAdvice() {
                if (this.selectedPriorities.includes('scadenze')) {
                    return "Concentrati sulle scadenze più vicine. Dedica il 70% del tempo alle prime 2 materie.";
                } else if (this.selectedPriorities.includes('cfu')) {
                    return "Massimizza i CFU: concentrati sulle materie che valgono di più per accelerare la laurea.";
                } else if (this.selectedPriorities.includes('difficolta')) {
                    return "Affronta prima le materie difficili quando la mente è più fresca, poi procedi con quelle più semplici.";
                } else if (this.selectedPriorities.includes('media')) {
                    return "Bilancia lo studio per mantenere alta la media: non trascurare nessuna materia.";
                } else {
                    return "Piano bilanciato che considera tutti i fattori: scadenze, difficoltà, CFU e progresso attuale.";
                }
            },

            applyPlan() {
                if (!this.recommendedPlan) return;
                
                this.recommendedPlan.forEach((materia, index) => {
                    const original = APP_STATE.materie.find(m => m.id === materia.id);
                    if (original) {
                        if (index === 0) original.priorita = 'alta';
                        else if (index <= 2) original.priorita = 'media';
                        else original.priorita = 'bassa';
                    }
                });
                
                Utils.saveData();
                MaterieManager.load();
                SmartPlanner.generateTodaySchedule();
                PlanManager.generate();
                
                this.close();
                Utils.showMessage('✅ Piano semestre applicato! Le priorità sono state aggiornate.');
                
                Navigation.showSection('piano', document.querySelector('.nav-tab[onclick*=piano]'));
            }
        };

        // ========================================
        // ⚙️ SETTINGS E DATA MANAGER
        // ========================================
        const SettingsManager = {
            load() {
                document.getElementById('autoBackup').value = localStorage.getItem('autoBackup_v3') || 'daily';
                document.getElementById('examNotifications').value = localStorage.getItem('examNotifications_v3') || '7days';
            },

            updateAutoBackup() {
                const setting = document.getElementById('autoBackup').value;
                localStorage.setItem('autoBackup_v3', setting);
                APP_STATE.autoBackupEnabled = setting !== 'disabled';
                
                if (APP_STATE.autoBackupEnabled) {
                    Utils.showMessage('✅ Backup automatico attivato');
                } else {
                    Utils.showMessage('⚙️ Backup automatico disattivato');
                }
            },

            updateExamNotifications() {
                const setting = document.getElementById('examNotifications').value;
                localStorage.setItem('examNotifications_v3', setting);
                Utils.showMessage('🔔 Impostazioni notifiche aggiornate');
            }
        };

        // Data Manager
        const DataManager = {
            exportAll() {
                try {
                    const allData = {
                        materie: APP_STATE.materie,
                        esami: APP_STATE.esami,
                        sessioni: APP_STATE.sessioni,
                        curriculum: APP_STATE.curriculum,
                        calendarSessions: APP_STATE.calendarSessions,
                        sessionRatings: APP_STATE.sessionRatings,
                        timerSettings: {
                            sessionsToday: APP_STATE.timer.sessionsToday,
                            sessionGoal: APP_STATE.timer.sessionGoal,
                            lastSessionDate: APP_STATE.timer.lastSessionDate
                        },
                        studyData: APP_STATE.studyData,
                        exportDate: new Date().toISOString(),
                        version: '3.1'
                    };

                    const dataString = JSON.stringify(allData, null, 2);
                    const blob = new Blob([dataString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `piano_studio_backup_v3.1_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    Utils.showMessage('📤 Backup completo esportato con successo!');
                } catch (error) {
                    console.error('Errore nell\'esportazione:', error);
                    Utils.showMessage('❌ Errore nell\'esportazione dei dati', 'error');
                }
            },

            importAll() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            if (!this.validateImportData(data)) {
                                Utils.showMessage('❌ File di backup non valido o corrotto', 'error');
                                return;
                            }

                            const confirmMsg = `Importare il backup del ${new Date(data.exportDate).toLocaleDateString('it-IT')}?\n\nQuesta azione sostituirà TUTTI i dati correnti.`;
                            if (!confirm(confirmMsg)) return;

                            this.performImport(data);
                            
                        } catch (error) {
                            console.error('Errore nell\'importazione:', error);
                            Utils.showMessage('❌ Errore nella lettura del file di backup', 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            validateImportData(data) {
                const requiredFields = ['materie', 'esami', 'curriculum', 'exportDate'];
                return requiredFields.every(field => data.hasOwnProperty(field));
            },

            performImport(data) {
                try {
                    APP_STATE.materie = data.materie || [];
                    APP_STATE.esami = data.esami || [];
                    APP_STATE.curriculum = data.curriculum || [];
                    APP_STATE.sessioni = data.sessioni || [];
                    APP_STATE.calendarSessions = data.calendarSessions || {};
                    APP_STATE.sessionRatings = data.sessionRatings || {};

                    if (data.timerSettings) {
                        APP_STATE.timer.sessionGoal = data.timerSettings.sessionGoal || 8;
                        APP_STATE.timer.sessionsToday = data.timerSettings.sessionsToday || 0;
                        APP_STATE.timer.lastSessionDate = data.timerSettings.lastSessionDate || '';
                    }

                    if (data.studyData) {
                        APP_STATE.studyData = { ...APP_STATE.studyData, ...data.studyData };
                    }

                    Utils.saveData();
                    this.reloadAll();

                    Utils.showMessage('✅ Dati importati con successo! App ricaricata.');
                } catch (error) {
                    console.error('Errore nell\'importazione:', error);
                    Utils.showMessage('❌ Errore nell\'importazione dei dati', 'error');
                }
            },

            reloadAll() {
                MaterieManager.load();
                ExamManager.updateSection();
                CurriculumManager.load();
                SmartPlanner.generateTodaySchedule();
                PlanManager.generate();
                SessionManager.updateTodayList();
                CalendarManager.render();
                StatisticsManager.update();
                HeatmapManager.update();
                ProductivityAnalyzer.update();
                PomodoroManager.updateSessionDisplay();
                TimerManager.updateStreakDisplay();
                DashboardManager.update();
            },

            showResetConfirmation() {
                document.getElementById('resetConfirmationModal').style.display = 'flex';
            },

            closeResetModal() {
                document.getElementById('resetConfirmationModal').style.display = 'none';
                document.getElementById('resetConfirmText').value = '';
            },

            performReset() {
                const confirmText = document.getElementById('resetConfirmText').value.toUpperCase();
                
                if (confirmText !== 'RESET') {
                    Utils.showMessage('❌ Scrivi esattamente "RESET" per confermare', 'error');
                    return;
                }

                try {
                    const keysToRemove = [
                        'materie_v3', 'esami_v3', 'curriculum_v3', 'sessioni_v3',
                        'calendarSessions_v3', 'sessionRatings_v3', 'sessionsToday_v3',
                        'sessionGoal_v3', 'lastSessionDate_v3', 'studyStreak_v3',
                        'lastStudyDate_v3', 'totalSessions_v3', 'autoBackup_v3',
                        'examNotifications_v3'
                    ];

                    keysToRemove.forEach(key => localStorage.removeItem(key));

                    // Reset APP_STATE
                    APP_STATE.materie = [];
                    APP_STATE.esami = [];
                    APP_STATE.curriculum = [];
                    APP_STATE.sessioni = [];
                    APP_STATE.calendarSessions = {};
                    APP_STATE.sessionRatings = {};
                    APP_STATE.timer = {
                        minutes: 25, seconds: 0, isRunning: false, isBreak: false,
                        workTime: 25, breakTime: 5, interval: null,
                        sessionsToday: 0, sessionGoal: 8, lastSessionDate: ''
                    };
                    APP_STATE.studyData = {
                        streak: 0, lastStudyDate: '', totalSessions: 0
                    };
                    APP_STATE.currentSession = { materia: null, studyType: null, startTime: null, duration: 25 };
                    APP_STATE.editingMateriaId = null;

                    this.reloadAll();
                    Navigation.showSection('oggi', document.querySelector('.nav-tab[onclick*="oggi"]'));
                    this.closeResetModal();

                    Utils.showMessage('🗑️ Reset completo eseguito! App pulita e pronta all\'uso.');
                } catch (error) {
                    console.error('Errore nel reset:', error);
                    Utils.showMessage('❌ Errore durante il reset', 'error');
                }
            }
        };

             // ========================================
        // 🔔 NOTIFICATION MANAGER
        // ========================================
        const NotificationManager = {
            checkUpcomingExams() {
                const examSettings = localStorage.getItem('examNotifications_v3') || '7days';
                if (examSettings === 'disabled') return;
                
                const today = new Date().toDateString();
                const lastNotificationDate = localStorage.getItem('lastNotificationDate_v3');
                if (lastNotificationDate === today) return;
                
                const daysThreshold = {
                    '1day': 1,
                    '3days': 3,
                    '7days': 7
                }[examSettings] || 7;
                
                const upcomingExams = APP_STATE.materie.filter(materia => {
                    if (materia.status === 'completato' || !materia.dataEsame) return false;
                    const daysToExam = Utils.getDaysToExam(materia.dataEsame);
                    return daysToExam > 0 && daysToExam <= daysThreshold;
                });
                
                if (upcomingExams.length > 0) {
                    const closestExam = upcomingExams.sort((a, b) => 
                        Utils.getDaysToExam(a.dataEsame) - Utils.getDaysToExam(b.dataEsame)
                    )[0];
                    
                    const daysLeft = Utils.getDaysToExam(closestExam.dataEsame);
                    this.show(closestExam.nome, daysLeft);
                    
                    localStorage.setItem('lastNotificationDate_v3', today);
                }
            },
            
            show(subjectName, daysLeft) {
                const banner = document.getElementById('notificationBanner');
                const text = document.getElementById('notificationText');
                
                if (banner && text) {
                    text.textContent = `${subjectName} - ${daysLeft} ${daysLeft === 1 ? 'giorno' : 'giorni'} rimanenti!`;
                    banner.classList.add('show');
                    
                    setTimeout(() => {
                        if (banner.classList.contains('show')) {
                            banner.classList.remove('show');
                        }
                    }, 15000);
                }
            },

            hide() {
                const banner = document.getElementById('notificationBanner');
                if (banner) {
                    banner.classList.remove('show');
                    localStorage.setItem('lastNotificationDate_v3', new Date().toDateString());
                }
            }
        };

        // ========================================
        // 🎨 UI MANAGER
        // ========================================
        const UI = {
            showCustomTimerDialog() {
                document.getElementById('customTimerModal').style.display = 'flex';
            },

            closeCustomTimerModal() {
                document.getElementById('customTimerModal').style.display = 'none';
            },

            showAddSubjectModal() {
                document.getElementById('addSubjectModal').style.display = 'flex';
            },

            closeAddSubjectModal() {
                document.getElementById('addSubjectModal').style.display = 'none';
            },

            closeAddSessionModal() {
                document.getElementById('addSessionModal').style.display = 'none';
            },

            closeExamModal() {
                document.getElementById('examModal').style.display = 'none';
                document.getElementById('examGrade').value = '';
                document.getElementById('examLode').checked = false;
                document.getElementById('examDate').value = '';
            }
        };

        // ========================================
        // 🚀 INIZIALIZZAZIONE DELL'APPLICAZIONE
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('🚀 Piano Studio Smart v3.0 Ingegneria Edition inizializzato!');
                console.log('✅ Tutte le funzionalità implementate e operative');
                
                // Check if session count needs reset
                const today = new Date().toDateString();
                if (APP_STATE.timer.lastSessionDate !== today) {
                    APP_STATE.timer.sessionsToday = 0;
                    APP_STATE.timer.lastSessionDate = today;
                    localStorage.setItem('sessionsToday_v3', 0);
                    localStorage.setItem('lastSessionDate_v3', today);
                }
                
                // Initialize all components
                AntiProcrastination.init();
                StudyAssistant.updateAISuggestion();
                DashboardManager.update();
                MaterieManager.load();
                WeeklySlots.initialize();
                StarRating.setup();
                ExamManager.updateSection();
                CurriculumManager.load();
                SmartPlanner.generateTodaySchedule();
                PlanManager.generate();
                SessionManager.updateTodayList();
                CalendarManager.render();
                StatisticsManager.update();
                HeatmapManager.update();
                ProductivityAnalyzer.update();
                PomodoroManager.updateSessionDisplay();
                TimerManager.updateStreakDisplay();
                SettingsManager.load();
                
                // Check for exam notifications
                NotificationManager.checkUpcomingExams();
                
                // Update AI suggestions periodically
                setInterval(() => {
                    StudyAssistant.updateAISuggestion();
                    AntiProcrastination.showMotivationalQuote();
                }, 300000); // Every 5 minutes
                
                // Auto-save every 5 minutes
                setInterval(() => {
                    Utils.saveData();
                }, 300000);
                
                // Check notifications every hour
                setInterval(() => {
                    NotificationManager.checkUpcomingExams();
                }, 3600000);
                
            } catch (error) {
                console.error('❌ Errore nell\'inizializzazione:', error);
                Utils.showMessage('❌ Errore nell\'inizializzazione dell\'app', 'error');
            }
        });

        // ========================================
        // 🎯 EVENT LISTENERS E GESTIONE EVENTI
        // ========================================
        
        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.style.display = 'none';
                if (e.target.id === 'resetConfirmationModal') {
                    document.getElementById('resetConfirmText').value = '';
                }
                if (e.target.id === 'sessionRatingModal') {
                    document.getElementById('sessionNotes').value = '';
                }
            }
        });

        // Prevent modal closing when clicking inside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });

        // Close mobile navigation when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-container') && APP_STATE.mobileNavOpen) {
                Navigation.closeMobile();
            }
        });

        // ========================================
        // 🎉 FINE CODICE JAVASCRIPT
        // ========================================
    </script>
</body>
</html>

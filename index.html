// ===== MODAL FUNCTIONS =====
        function openModal(content) {
            try {
                const modal = document.getElementById('modal');
                const modalContent = document.getElementById('modalContent');
                
                if (modal && modalContent) {
                    if (content) {
                        modalContent.innerHTML = content;
                    }
                    modal.classList.add('active');
                    
                    // Focus management for accessibility
                    const firstInput = modal.querySelector('input, select, textarea, button');
                    if (firstInput) {
                        setTimeout(() => firstInput.focus(), 100);
                    }
                    
                    // Close modal on Escape key
                    document.addEventListener('keydown', handleModalEscape);
                    
                    // Prevent body scroll when modal is open
                    document.body.style.overflow = 'hidden';
                }
            } catch (error) {
                console.error('Modal error:', error);
                showMessage('Errore nell\'apertura modal', 'error');
            }
        }
        
        function closeModal() {
            try {
                const modal = document.getElementById('modal');
                if (modal) {
                    modal.classList.remove('active');
                    
                    // Clean up editing state
                    appData.editingId = null;
                    
                    // Remove escape key listener
                    document.removeEventListener('keydown', handleModalEscape);
                    
                    // Restore body scroll
                    document.body.style.overflow = '';
                }
            } catch (error) {
                console.error('Close modal error:', error);
            }
        }
        
        function handleModalEscape(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modal');
            const confirmDialog = document.getElementById('confirmDialog');
            
            if (event.target === modal) {
                closeModal();
            }
            
            if (event.target === confirmDialog) {
                confirmDialog.classList.remove('active');
            }
        });
        
        // ===== DATA MANAGEMENT =====
        function updateClientTotalSpent() {
            // Update client total spent based on transactions
            appData.clients.forEach(client => {
                const clientTransactions = appData.transactions.filter(t => 
                    t.type === 'revenue' && t.client === client.name
                );
                client.totalSpent = clientTransactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            });
        }
        
        // ===== SEARCH FUNCTIONALITY =====
        function setupSearchListeners() {
            const orderSearch = document.getElementById('orderSearch');
            const transactionSearch = document.getElementById('transactionSearch');
            const clientSearch = document.getElementById('clientSearch');
            const inventorySearch = document.getElementById('inventorySearch');
            
            if (orderSearch) {
                orderSearch.removeEventListener('input', debouncedFilterOrders);
                orderSearch.addEventListener('input', debouncedFilterOrders);
            }
            
            if (transactionSearch) {
                transactionSearch.removeEventListener('input', debouncedFilterTransactions);
                transactionSearch.addEventListener('input', debouncedFilterTransactions);
            }
            
            if (clientSearch) {
                clientSearch.removeEventListener('input', debouncedFilterClients);
                clientSearch.addEventListener('input', debouncedFilterClients);
            }
            
            if (inventorySearch) {
                inventorySearch.removeEventListener('input', debouncedFilterInventory);
                inventorySearch.addEventListener('input', debouncedFilterInventory);
            }
        }
        
        // ===== DATA PERSISTENCE =====
        function saveDataToLocalStorage() {
            try {
                const dataToSave = {
                    ...appData,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('retroaviaData', JSON.stringify(dataToSave));
                console.log('Data saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showMessage('Errore nel salvataggio automatico', 'error');
            }
        }
        
        function loadDataFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('retroaviaData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // Merge with default data to ensure all properties exist
                    appData = {
                        ...appData,
                        ...parsedData,
                        // Ensure arrays exist
                        transactions: parsedData.transactions || appData.transactions,
                        clients: parsedData.clients || appData.clients,
                        inventory: parsedData.inventory || appData.inventory,
                        orders: parsedData.orders || appData.orders
                    };
                    console.log('Data loaded from localStorage');
                    if (parsedData.lastSaved) {
                        console.log('Last saved:', new Date(parsedData.lastSaved).toLocaleString('it-IT'));
                    }
                    return true;
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                showMessage('Errore nel caricamento dati salvati', 'error');
            }
            return false;
        }
        
        // Auto-save data when changes are made
        const autoSave = debounce(() => {
            saveDataToLocalStorage();
        }, 1000);
        
        // ===== INITIALIZATION =====
        function initializeApp() {
            try {
                console.log('üï∑Ô∏è RetroAvia 3.1 Spider-System Initializing...');
                
                // Load saved data if available
                const dataLoaded = loadDataFromLocalStorage();
                if (dataLoaded) {
                    showMessage('üíæ Dati precedenti caricati con successo!');
                }
                
                // Update client spending
                updateClientTotalSpent();
                
                // Load current page
                showPage(appData.currentPage);
                
                // Initialize dashboard
                updateDashboard();
                
                // Setup search listeners after DOM is ready
                setTimeout(() => {
                    setupSearchListeners();
                }, 100);
                
                // Show version info
                console.log(`‚úÖ RetroAvia ${appData.version} Ready!`);
                console.log(`üìä Dati caricati: ${appData.transactions.length} transazioni, ${appData.clients.length} clienti, ${appData.inventory.length} componenti, ${appData.orders.length} ordini`);
                
                showMessage('üï∑Ô∏è RetroAvia 3.1 con Gestione Ordini Attivato!');
                
            } catch (error) {
                console.error('Initialization error:', error);
                showMessage('Errore nell\'inizializzazione sistema', 'error');
            }
        }
        
        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', function(event) {
            // Skip if modal or confirm dialog is open or user is typing in an input
            if (document.getElementById('modal').classList.contains('active') || 
                document.getElementById('confirmDialog').classList.contains('active') ||
                event.target.tagName === 'INPUT' || 
                event.target.tagName === 'TEXTAREA' || 
                event.target.tagName === 'SELECT') {
                return;
            }
            
            // Handle shortcuts with Ctrl key for safety
            if (event.ctrlKey) {
                switch(event.key.toLowerCase()) {
                    case 's':
                        event.preventDefault();
                        saveDataToLocalStorage();
                        showMessage('üíæ Dati salvati manualmente!');
                        break;
                    case 'b':
                        event.preventDefault();
                        exportBackup();
                        break;
                }
                return;
            }
            
            switch(event.key) {
                case '1':
                    showPage('dashboard');
                    break;
                case '2':
                    showPage('orders');
                    break;
                case '3':
                    showPage('transactions');
                    break;
                case '4':
                    showPage('clients');
                    break;
                case '5':
                    showPage('inventory');
                    break;
                case '6':
                    showPage('analytics');
                    break;
                case 'n':
                case 'N':
                    if (appData.currentPage === 'orders') {
                        event.preventDefault();
                        addOrder();
                    } else if (appData.currentPage === 'transactions') {
                        event.preventDefault();
                        addTransaction('revenue');
                    } else if (appData.currentPage === 'clients') {
                        event.preventDefault();
                        addClient();
                    } else if (appData.currentPage === 'inventory') {
                        event.preventDefault();
                        addInventoryItem();
                    }
                    break;
                case 'a':
                case 'A':
                    if (appData.currentPage === 'dashboard') {
                        event.preventDefault();
                        runAIAnalysis();
                    }
                    break;
            }
        });
        
        // ===== ERROR HANDLING =====
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            showMessage('Si √® verificato un errore inaspettato', 'error');
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showMessage('Errore nella comunicazione', 'error');
        });
        
        // ===== APP LIFECYCLE =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        // Save data before page unload
        window.addEventListener('beforeunload', function() {
            saveDataToLocalStorage();
        });
        
        // Auto-save every 5 minutes
        setInterval(() => {
            saveDataToLocalStorage();
        }, 5 * 60 * 1000);
        
        // ===== RESPONSIVE HELPERS =====
        function handleResize() {
            const isMobile = window.innerWidth <= 768;
            
            // Adjust modal size on mobile
            const modal = document.getElementById('modal');
            if (modal && isMobile) {
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.width = '95%';
                    modalContent.style.maxHeight = '90vh';
                }
            }
        }
        
        window.addEventListener('resize', debounce(handleResize, 250));
        
        // ===== ACCESSIBILITY ENHANCEMENTS =====
        
        // Skip to main content link
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Tab' && !event.shiftKey) {
                const focusedElement = document.activeElement;
                if (focusedElement === document.body) {
                    const firstPage = document.querySelector('.page.active');
                    if (firstPage) {
                        firstPage.setAttribute('tabindex', '-1');
                        firstPage.focus();
                        event.preventDefault();
                    }
                }
            }
        });
        
        // ===== PERFORMANCE MONITORING =====
        function logPerformance(operation, startTime) {
            const endTime = performance.now();
            const duration = endTime - startTime;
            if (duration > 100) { // Log slow operations (>100ms)
                console.warn(`Slow operation detected: ${operation} took ${duration.toFixed(2)}ms`);
            }
        }
        
        // ===== FINAL SETUP =====
        console.log('üï∑Ô∏è RetroAvia 3.1 Spider-System con Gestione Ordini Caricato!');
        console.log('üìã Nuove Funzionalit√† Versione 3.1:');
        console.log('  ‚úÖ Gestione Ordini Personalizzati completa');
        console.log('  ‚úÖ Form multi-sezione per specifiche Game Boy');
        console.log('  ‚úÖ Stati ordine (Pending, In Progress, Completed, Cancelled)');
        console.log('  ‚úÖ Vista dettagliata ordini con tutte le caratteristiche');
        console.log('  ‚úÖ Ricerca e filtri per ordini');
        console.log('  ‚úÖ Integrazione AI per analisi ordini');
        console.log('  ‚úÖ Backup include anche gli ordini');
        console.log('  ‚úÖ Keyboard shortcuts aggiornati');
        console.log('');
        console.log('üìã Keyboard Shortcuts Aggiornati:');
        console.log('  1: Dashboard | 2: Ordini | 3: Transazioni | 4: Clienti | 5: Inventario | 6: Analytics');
        console.log('  N: Nuovo item (context-dependent)');
        console.log('  A: AI Analysis (on dashboard)');
        console.log('  Ctrl+S: Manual save');
        console.log('  Ctrl+B: Export backup');
        console.log('  ESC: Close modal');
        console.log('');
        console.log('üìã Caratteristiche Ordini Gestite:');
        console.log('  üéÆ Modello Game Boy, Scocca, Pulsanti, Etichetta');
        console.log('  üîã Batteria, Audio, Display, Kit LED');
        console.log('  üì¶ Box, Cover, Game Boy Cliente, Altro, Note');
        
    </script>
</body>
</html>        
        // ===== ANALYTICS FUNCTIONS =====
        function loadAnalytics() {
            loadMonthlyTrends();
            loadTopClients();
            loadMonthlyPerformance();
            loadKPIDashboard();
        }
        
        function loadMonthlyTrends() {
            const container = document.getElementById('monthlyTrends');
            if (!container) return;
            
            const months = getLastSixMonths();
            const monthlyData = getTransactionsByMonth();
            
            // Fill in missing months with zero data
            const chartData = months.map(month => ({
                ...month,
                revenue: monthlyData[month.key]?.revenue || 0,
                expenses: monthlyData[month.key]?.expenses || 0,
                profit: (monthlyData[month.key]?.revenue || 0) - (monthlyData[month.key]?.expenses || 0)
            }));
            
            const maxValue = Math.max(...chartData.map(d => Math.max(d.revenue, d.expenses))) || 100;
            
            container.innerHTML = `
                <div style="margin-bottom: var(--space-4);">
                    <p style="color: var(--text-muted); font-size: 0.875rem;">
                        üìä Trend basati sui dati reali delle tue transazioni
                    </p>
                </div>
                <div style="display: flex; align-items: end; gap: 1rem; height: 200px; padding: 1rem;">
                    ${chartData.map(data => `
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="display: flex; flex-direction: column; gap: 0.25rem; width: 100%; height: 150px; justify-content: end;">
                                <!-- Revenue Bar -->
                                <div class="chart-bar" style="
                                    height: ${maxValue > 0 ? (data.revenue / maxValue) * 70 : 0}px;
                                    background: linear-gradient(135deg, var(--success), #059669);
                                    display: flex;
                                    align-items: end;
                                    justify-content: center;
                                    font-size: 0.7rem;
                                    color: white;
                                    font-weight: 600;
                                    padding: 0.125rem;
                                " title="Entrate: ${formatCurrency(data.revenue)}">
                                    ${data.revenue > 0 ? formatCurrency(data.revenue) : ''}
                                </div>
                                <!-- Expenses Bar -->
                                <div class="chart-bar" style="
                                    height: ${maxValue > 0 ? (data.expenses / maxValue) * 70 : 0}px;
                                    background: linear-gradient(135deg, var(--error), #dc2626);
                                    display: flex;
                                    align-items: end;
                                    justify-content: center;
                                    font-size: 0.7rem;
                                    color: white;
                                    font-weight: 600;
                                    padding: 0.125rem;
                                " title="Spese: ${formatCurrency(data.expenses)}">
                                    ${data.expenses > 0 ? formatCurrency(data.expenses) : ''}
                                </div>
                            </div>
                            <div style="margin-top: var(--space-2);">
                                <div style="font-size: 0.875rem; color: var(--text-muted); text-align: center;">
                                    ${data.monthName.substring(0, 3)}
                                </div>
                                <div style="font-size: 0.75rem; color: ${data.profit >= 0 ? 'var(--success)' : 'var(--error)'}; font-weight: 600; text-align: center;">
                                    ${formatCurrency(data.profit)}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; justify-content: center; gap: var(--space-4); margin-top: var(--space-4); font-size: 0.875rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 1rem; height: 1rem; background: linear-gradient(135deg, var(--success), #059669); border-radius: 0.25rem;"></div>
                        <span>Entrate</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 1rem; height: 1rem; background: linear-gradient(135deg, var(--error), #dc2626); border-radius: 0.25rem;"></div>
                        <span>Spese</span>
                    </div>
                </div>
            `;
        }
        
        function loadTopClients() {
            const container = document.getElementById('topClients');
            if (!container) return;
            
            // Calculate client spending from transactions
            const clientSpending = {};
            appData.transactions.filter(t => t.type === 'revenue' && t.client).forEach(transaction => {
                clientSpending[transaction.client] = (clientSpending[transaction.client] || 0) + parseFloat(transaction.amount);
            });
            
            const topClients = Object.entries(clientSpending)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            if (topClients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <p>Nessun dato cliente disponibile</p>
                        <p style="font-size: 0.875rem; margin-top: var(--space-2);">Aggiungi clienti alle transazioni per vedere le statistiche</p>
                    </div>
                `;
                return;
            }
            
            const maxSpending = Math.max(...topClients.map(([, amount]) => amount));
            
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    ${topClients.map(([client, amount], index) => {
                        const percentage = maxSpending > 0 ? (amount / maxSpending) * 100 : 0;
                        return `
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 1rem;
                                background: var(--surface);
                                border-radius: var(--radius-lg);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                position: relative;
                                overflow: hidden;
                            ">
                                <!-- Progress Background -->
                                <div style="
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    height: 100%;
                                    width: ${percentage}%;
                                    background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1));
                                    transition: width 1s ease;
                                "></div>
                                
                                <div style="display: flex; align-items: center; gap: 1rem; position: relative; z-index: 1;">
                                    <span style="
                                        background: var(--gradient-primary);
                                        color: white;
                                        width: 2rem;
                                        height: 2rem;
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-weight: 700;
                                        font-size: 0.875rem;
                                    ">${index + 1}</span>
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${client}</div>
                                        <div style="font-size: 0.875rem; color: var(--text-muted);">
                                            ${appData.transactions.filter(t => t.client === client && t.type === 'revenue').length} transazioni
                                        </div>
                                    </div>
                                </div>
                                <span style="color: var(--success); font-weight: 700; font-size: 1.1rem; position: relative; z-index: 1;">
                                    ${formatCurrency(amount)}
                                </span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function loadMonthlyPerformance() {
            const container = document.getElementById('monthlyPerformance');
            if (!container) return;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const previousMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            
            const monthlyData = getTransactionsByMonth();
            const currentData = monthlyData[currentMonthKey] || { revenue: 0, expenses: 0, count: 0 };
            const previousData = monthlyData[previousMonthKey] || { revenue: 0, expenses: 0, count: 0 };
            
            const revenueChange = previousData.revenue > 0 ? 
                ((currentData.revenue - previousData.revenue) / previousData.revenue * 100) : 0;
            const expenseChange = previousData.expenses > 0 ? 
                ((currentData.expenses - previousData.expenses) / previousData.expenses * 100) : 0;
            
            container.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">Spese Questo Mese</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--error);">${formatCurrency(currentData.expenses)}</div>
                            </div>
                            <div style="color: ${expenseChange <= 0 ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                                ${expenseChange <= 0 ? '‚ÜòÔ∏è' : '‚ÜóÔ∏è'} ${Math.abs(expenseChange).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">Profitto Questo Mese</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${(currentData.revenue - currentData.expenses) >= 0 ? 'var(--success)' : 'var(--error)'};">
                                    ${formatCurrency(currentData.revenue - currentData.expenses)}
                                </div>
                            </div>
                            <div style="color: var(--accent); font-weight: 600;">
                                üìä ${currentData.count} transazioni
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadKPIDashboard() {
            const container = document.getElementById('kpiDashboard');
            if (!container) return;
            
            const revenues = appData.transactions.filter(t => t.type === 'revenue');
            const expenses = appData.transactions.filter(t => t.type === 'expense');
            
            const totalRevenue = revenues.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const avgOrderValue = revenues.length > 0 ? totalRevenue / revenues.length : 0;
            const profitMargin = totalRevenue > 0 ? ((totalRevenue - totalExpenses) / totalRevenue * 100) : 0;
            
            // Low stock items
            const lowStockItems = appData.inventory.filter(item => item.quantity <= item.threshold);
            
            // Active clients (clients with transactions)
            const activeClients = new Set(appData.transactions.filter(t => t.client).map(t => t.client)).size;
            
            container.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Valore Medio Ordine</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary);">${formatCurrency(avgOrderValue)}</div>
                            </div>
                            <span style="font-size: 1.5rem;">üí∞</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Margine di Profitto</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: ${profitMargin >= 0 ? 'var(--success)' : 'var(--error)'};">${profitMargin.toFixed(1)}%</div>
                            </div>
                            <span style="font-size: 1.5rem;">üìà</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Clienti Attivi</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--accent);">${activeClients}</div>
                            </div>
                            <span style="font-size: 1.5rem;">üë•</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Scorte Basse</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: ${lowStockItems.length > 0 ? 'var(--error)' : 'var(--success)'};">${lowStockItems.length}</div>
                            </div>
                            <span style="font-size: 1.5rem;">${lowStockItems.length > 0 ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ===== SPIDER AI =====
        const SpiderAI = {
            analyze: function(data) {
                const suggestions = [];
                const { transactions = [], clients = [], inventory = [], orders = [] } = data;
                
                try {
                    const revenues = transactions.filter(t => t.type === 'revenue');
                    const totalRevenue = revenues.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                    
                    if (transactions.length === 0) {
                        suggestions.push('üï∑Ô∏è Spider-AI inizializzato! Aggiungi transazioni per analisi avanzate.');
                        suggestions.push('üöÄ Sistema pronto per machine learning sui tuoi dati business.');
                        return suggestions;
                    }
                    
                    if (totalRevenue > 0) {
                        suggestions.push(`üï∑Ô∏è Ottimo lavoro! Ricavi totali: ${formatCurrency(totalRevenue)}`);
                        if (totalRevenue > 1000) {
                            suggestions.push('üíé Milestone 1K raggiunta! AI suggerisce espansione strategica.');
                        }
                        if (totalRevenue > 5000) {
                            suggestions.push('üöÄ Business in crescita! Considera diversificazione prodotti.');
                        }
                    }
                    
                    // Orders analysis
                    if (orders.length > 0) {
                        const pendingOrders = orders.filter(o => o.status === 'pending').length;
                        const inProgressOrders = orders.filter(o => o.status === 'in-progress').length;
                        
                        if (pendingOrders > 0) {
                            suggestions.push(`üìã ${pendingOrders} ordini in attesa - organizza il workflow!`);
                        }
                        if (inProgressOrders > 0) {
                            suggestions.push(`üîß ${inProgressOrders} ordini in lavorazione - ottimo ritmo!`);
                        }
                        
                        suggestions.push(`üìä Gestione ordini attiva: ${orders.length} ordini personalizzati registrati`);
                    }
                    
                    // Client analysis
                    if (clients.length > 0) {
                        const avgClientValue = totalRevenue / clients.length;
                        suggestions.push(`üë§ Base clienti: ${clients.length} - Valore medio: ${formatCurrency(avgClientValue)}`);
                        
                        if (avgClientValue > 200) {
                            suggestions.push('üéØ Alto valore cliente! Implementa programma fedelt√†.');
                        }
                    }
                    
                    // Inventory analysis
                    const lowStock = inventory.filter(item => (item.quantity || 0) <= (item.threshold || 5));
                    if (lowStock.length > 0) {
                        suggestions.push(`üì¶ SPIDER-SENSE ALERT: ${lowStock.length} componenti sotto soglia!`);
                    }
                    
                    // Performance analysis
                    const expenses = transactions.filter(t => t.type === 'expense');
                    const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                    const profitMargin = totalRevenue > 0 ? ((totalRevenue - totalExpenses) / totalRevenue * 100) : 0;
                    
                    if (profitMargin > 50) {
                        suggestions.push('üí∞ Margine di profitto eccellente! Business sostenibile.');
                    } else if (profitMargin < 20 && profitMargin > 0) {
                        suggestions.push('‚ö†Ô∏è Margine basso. Rivedi struttura costi o prezzi.');
                    }
                    
                    // Trend analysis
                    const recentTransactions = transactions.slice(-5);
                    const recentRevenue = recentTransactions.filter(t => t.type === 'revenue').length;
                    const recentExpenses = recentTransactions.filter(t => t.type === 'expense').length;
                    
                    if (recentRevenue > recentExpenses) {
                        suggestions.push('üìà Trend positivo: pi√π entrate che spese nelle ultime transazioni!');
                    } else if (recentExpenses > recentRevenue) {
                        suggestions.push('‚ö†Ô∏è Attenzione: molte spese recenti. Monitora il cash flow.');
                    }
                    
                    // Seasonal insights
                    const currentMonth = new Date().getMonth();
                    if (currentMonth >= 10 || currentMonth <= 1) {
                        suggestions.push('üéÑ Stagione favorevole! Periodo natalizio ideale per retro gaming.');
                    }
                    
                } catch (error) {
                    console.error('AI Analysis error:', error);
                    suggestions.push('ü§ñ Spider-AI in manutenzione - Riprova tra poco!');
                }
                
                return suggestions.length > 0 ? suggestions : ['üï∑Ô∏è Spider-AI Neural Network attivo!'];
            },
            
            generatePredictions: function(data) {
                const { transactions = [], clients = [], inventory = [], orders = [] } = data;
                
                if (transactions.length < 3) {
                    return [{
                        title: "üîÆ Raccolta Dati in Corso",
                        description: "Il neural network necessita di pi√π dati per generare predizioni accurate.",
                        confidence: 85
                    }];
                }
                
                const predictions = [];
                
                // Revenue prediction based on historical data
                const revenues = transactions.filter(t => t.type === 'revenue');
                const avgRevenue = revenues.reduce((sum, t) => sum + parseFloat(t.amount), 0) / revenues.length;
                const trendMultiplier = revenues.length > 5 ? 1.15 : 1.08;
                
                predictions.push({
                    title: "üìà Proiezione Ricavi",
                    description: `Basandomi sui pattern recenti, prevedo ricavi medi di ${formatCurrency(avgRevenue * trendMultiplier)} per i prossimi ordini (+${Math.round((trendMultiplier - 1) * 100)}%).`,
                    confidence: Math.min(78 + revenues.length * 2, 95)
                });
                
                // Orders prediction
                if (orders.length > 0) {
                    const pendingOrders = orders.filter(o => o.status === 'pending').length;
                    const inProgressOrders = orders.filter(o => o.status === 'in-progress').length;
                    
                    if (pendingOrders > 0 || inProgressOrders > 0) {
                        predictions.push({
                            title: "üìã Gestione Ordini",
                            description: `${pendingOrders + inProgressOrders} ordini attivi. Tempo medio completamento stimato: 10-15 giorni. Pianifica risorse accordingly.`,
                            confidence: 88
                        });
                    }
                }
                
                // Client growth prediction
                if (clients.length > 2) {
                    const recentTransactions = transactions.slice(-10);
                    const uniqueRecentClients = new Set(recentTransactions.filter(t => t.client).map(t => t.client)).size;
                    
                    predictions.push({
                        title: "üë• Crescita Base Clienti",
                        description: `${uniqueRecentClients} clienti attivi negli ultimi ordini. Prevedo crescita del 20-30% nei prossimi 3 mesi con strategie di retention.`,
                        confidence: 82
                    });
                }
                
                // Inventory optimization
                const lowStockItems = inventory.filter(item => item.quantity <= item.threshold);
                if (lowStockItems.length > 0) {
                    predictions.push({
                        title: "üì¶ Ottimizzazione Scorte",
                        description: `${lowStockItems.length} componenti necessitano riordino. Costo stimato: ${formatCurrency(lowStockItems.reduce((sum, item) => sum + (item.price * item.threshold), 0))}.`,
                        confidence: 91
                    });
                }
                
                // Market trends
                const currentMonth = new Date().getMonth();
                if (currentMonth >= 10 || currentMonth <= 1) {
                    predictions.push({
                        title: "üéÑ Trend Stagionale",
                        description: "Periodo natalizio favorevole per prodotti retro. Aspettati incremento domanda del 25-40% e possibili aumenti di prezzo.",
                        confidence: 74
                    });
                } else if (currentMonth >= 5 && currentMonth <= 7) {
                    predictions.push({
                        title: "‚òÄÔ∏è Stagione Estiva",
                        description: "Periodo estivo: domanda stabile ma minori picchi. Momento ideale per manutenzione inventory e nuove acquisizioni.",
                        confidence: 68
                    });
                }
                
                // Business expansion prediction
                const totalRevenue = revenues.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                if (totalRevenue > 2000) {
                    predictions.push({
                        title: "üöÄ Espansione Business",
                        description: "Ricavi robusti suggeriscono potenziale per diversificazione: considera console retro aggiuntive (Nintendo, Sega) o servizi premium.",
                        confidence: 76
                    });
                }
                
                return predictions;
            }
        };
        
        function runAIAnalysis() {
            try {
                const analysis = SpiderAI.analyze(appData);
                const aiDiv = document.getElementById('aiSuggestions');
                if (aiDiv && analysis.length > 0) {
                    aiDiv.innerHTML = analysis.map(suggestion => `<p>‚Ä¢ ${suggestion}</p>`).join('');
                }
                showMessage('üß† Analisi AI completata!');
            } catch (error) {
                console.error('AI Analysis error:', error);
                showMessage('Errore nell\'analisi AI', 'error');
            }
        }
        
        function generatePredictions() {
            try {
                const predictions = SpiderAI.generatePredictions(appData);
                const content = `
                    <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">üîÆ Predizioni AI Spider-System</h3>
                    <div style="margin: var(--space-6) 0;">
                        ${predictions.map(pred => `
                            <div style="margin: var(--space-4) 0; padding: var(--space-4); background: rgba(59, 130, 246, 0.1); border-radius: var(--radius-lg); border: 1px solid var(--primary); position: relative; overflow: hidden;">
                                <!-- Confidence bar -->
                                <div style="position: absolute; bottom: 0; left: 0; height: 3px; width: ${pred.confidence}%; background: var(--accent); transition: width 1s ease;"></div>
                                
                                <h4 style="color: var(--primary); margin-bottom: var(--space-2); display: flex; align-items: center; justify-content: space-between;">
                                    ${pred.title}
                                    <span style="font-size: 0.75rem; color: var(--accent); font-weight: 600;">
                                        ${pred.confidence}% confidence
                                    </span>
                                </h4>
                                <p style="margin-bottom: var(--space-2); line-height: 1.6;">${pred.description}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div style="background: rgba(245, 158, 11, 0.1); padding: var(--space-4); border-radius: var(--radius-lg); margin: var(--space-4) 0; border: 1px solid var(--accent);">
                        <p style="font-size: 0.875rem; color: var(--text-muted);">
                            <strong>üí° Nota:</strong> Le predizioni sono basate sui tuoi dati storici e algoritmi di machine learning. 
                            Usa questi insights come supporto alle decisioni business.
                        </p>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-secondary" onclick="closeModal()">
                            <span>‚úÖ</span> Chiudi
                        </button>
                    </div>
                `;
                openModal(content);
            } catch (error) {
                console.error('Predictions error:', error);
                showMessage('Errore nella generazione predizioni', 'error');
            }
        }
        
        // ===== QUICK ACTIONS =====
        function openQuickSale() {
            addTransaction('revenue');
        }
        
        function openQuickClient() {
            addClient();
        }
        
        function openQuickInventory() {
            addInventoryItem();
        }
        
        function exportBackup() {
            try {
                const backup = {
                    version: appData.version,
                    timestamp: new Date().toISOString(),
                    data: appData,
                    meta: {
                        totalTransactions: appData.transactions.length,
                        totalClients: appData.clients.length,
                        totalInventoryItems: appData.inventory.length,
                        totalOrders: appData.orders.length,
                        exportedBy: 'RetroAvia Spider-System'
                    }
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `retroavia_backup_${formatDate().replace(/-/g, '')}_${Date.now()}.json`;
                link.click();
                
                // Clean up
                setTimeout(() => URL.revokeObjectURL(link.href), 100);
                
                showMessage('üì¶ Backup esportato con successo!');
                console.log('Backup exported successfully');
            } catch (error) {
                console.error('Export error:', error);
                showMessage('Errore nell\'esportazione backup', 'error');
            }
        } center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">Entrate Questo Mese</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${formatCurrency(currentData.revenue)}</div>
                            </div>
                            <div style="color: ${revenueChange >= 0 ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                                ${revenueChange >= 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è'} ${Math.abs(revenueChange).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items:        
        // ===== CLIENTS FUNCTIONS =====
        function loadClients() {
            const container = document.getElementById('clientsContainer');
            if (!container) return;
            
            if (appData.clients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <h3>Nessun cliente</h3>
                        <p>Inizia aggiungendo il tuo primo cliente!</p>
                    </div>
                `;
                return;
            }
            
            // Sort clients by total spent (highest first)
            const sortedClients = [...appData.clients].sort((a, b) => 
                (b.totalSpent || 0) - (a.totalSpent || 0)
            );
            
            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Telefono</th>
                            <th>Provenienza</th>
                            <th>Speso Totale</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedClients.map(client => {
                            const sourceEmoji = {
                                'vinted': 'üëï',
                                'wallapop': 'üõí',
                                'subito': 'üáÆüáπ',
                                'ebay': 'üè™',
                                'facebook': 'üë•',
                                'instagram': 'üì∑'
                            };
                            const sourceDisplay = sourceEmoji[client.source] || '‚ùì';
                            
                            return `
                                <tr data-id="${client.id}">
                                    <td><strong>${client.name}</strong></td>
                                    <td>${client.email}</td>
                                    <td>${client.phone}</td>
                                    <td>
                                        <span style="display: flex; align-items: center; gap: 0.5rem;">
                                            ${sourceDisplay} ${client.source ? client.source.charAt(0).toUpperCase() + client.source.slice(1) : 'Non specificato'}
                                        </span>
                                    </td>
                                    <td style="color: var(--success); font-weight: 600;">${formatCurrency(client.totalSpent || 0)}</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="editClient('${client.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                            ‚úèÔ∏è Modifica
                                        </button>
                                        <button class="btn btn-error" onclick="confirmDeleteClient('${client.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                            üóëÔ∏è Elimina
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            console.log('Clients loaded:', appData.clients.length);
        }
        
        function addClient() {
            const content = `
                <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">üë§ Nuovo Cliente</h3>
                <div class="form-group">
                    <label for="clientName">Nome</label>
                    <input type="text" id="clientName" required>
                </div>
                <div class="form-group">
                    <label for="clientEmail">Email</label>
                    <input type="email" id="clientEmail" required>
                </div>
                <div class="form-group">
                    <label for="clientPhone">Telefono</label>
                    <input type="tel" id="clientPhone" required>
                </div>
                <div class="form-group">
                    <label for="clientSource">Provenienza</label>
                    <select id="clientSource" required>
                        <option value="">Seleziona provenienza...</option>
                        <option value="vinted">üëï Vinted</option>
                        <option value="wallapop">üõí Wallapop</option>
                        <option value="subito">üáÆüáπ Subito</option>
                        <option value="ebay">üè™ eBay</option>
                        <option value="facebook">üë• Facebook</option>
                        <option value="instagram">üì∑ Instagram</option>
                    </select>
                </div>
                <div class="quick-actions">
                    <button type="button" class="btn btn-success" onclick="saveClientFromForm()" id="saveClientBtn">
                        <span>üíæ</span> Salva
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>‚ùå</span> Annulla
                    </button>
                </div>
            `;
            openModal(content);
        }
        
        function saveClientFromForm() {
            try {
                const saveBtn = document.getElementById('saveClientBtn');
                const originalText = '<span>üíæ</span> Salva';
                
                showLoading(saveBtn, 'Salvando...');
                
                const name = document.getElementById('clientName')?.value;
                const email = document.getElementById('clientEmail')?.value;
                const phone = document.getElementById('clientPhone')?.value;
                const source = document.getElementById('clientSource')?.value;
                
                if (!name || !email || !phone || !source) {
                    hideLoading(saveBtn, originalText);
                    showMessage('Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    hideLoading(saveBtn, originalText);
                    showMessage('Formato email non valido', 'error');
                    return;
                }
                
                // Check for duplicate email (except when editing)
                const existingClient = appData.clients.find(c => 
                    c.email === email && c.id !== appData.editingId
                );
                if (existingClient) {
                    hideLoading(saveBtn, originalText);
                    showMessage('Email gi√† esistente per un altro cliente', 'error');
                    return;
                }
                
                setTimeout(() => {
                    const formData = {
                        id: appData.editingId || generateId(),
                        name: name,
                        email: email,
                        phone: phone,
                        source: source,
                        totalSpent: 0
                    };
                    
                    if (appData.editingId) {
                        const index = appData.clients.findIndex(c => c.id === appData.editingId);
                        if (index !== -1) {
                            // Preserve totalSpent when editing
                            formData.totalSpent = appData.clients[index].totalSpent;
                            appData.clients[index] = formData;
                            showMessage('Cliente aggiornato con successo!');
                            console.log('Client updated:', formData);
                        }
                        appData.editingId = null;
                    } else {
                        appData.clients.push(formData);
                        showMessage('Cliente aggiunto con successo!');
                        console.log('Client added:', formData);
                    }
                    
                    hideLoading(saveBtn, originalText);
                    closeModal();
                    loadClients();
                    updateClientTotalSpent();
                    autoSave();
                }, 500);
                
            } catch (error) {
                console.error('Save client error:', error);
                showMessage('Errore nel salvataggio cliente', 'error');
            }
        }
        
        function editClient(id) {
            console.log('Editing client with ID:', id);
            const client = appData.clients.find(c => c.id === id);
            if (!client) {
                showMessage('Cliente non trovato', 'error');
                console.error('Client not found:', id);
                return;
            }
            
            appData.editingId = id;
            addClient();
            
            // Populate form with existing data
            setTimeout(() => {
                const nameEl = document.getElementById('clientName');
                const emailEl = document.getElementById('clientEmail');
                const phoneEl = document.getElementById('clientPhone');
                const sourceEl = document.getElementById('clientSource');
                
                if (nameEl) nameEl.value = client.name;
                if (emailEl) emailEl.value = client.email;
                if (phoneEl) phoneEl.value = client.phone;
                if (sourceEl) sourceEl.value = client.source || '';
            }, 100);
        }
        
        function confirmDeleteClient(id) {
            console.log('Confirming delete for client:', id);
            const client = appData.clients.find(c => c.id === id);
            if (!client) {
                showMessage('Cliente non trovato', 'error');
                return;
            }
            
            showConfirmDialog(
                'Elimina Cliente',
                `Sei sicuro di voler eliminare il cliente "${client.name}"? Questa azione non pu√≤ essere annullata.`,
                () => deleteClient(id)
            );
        }
        
        function deleteClient(id) {
            console.log('Deleting client with ID:', id);
            console.log('Clients before delete:', appData.clients.length);
            
            const initialLength = appData.clients.length;
            appData.clients = appData.clients.filter(c => c.id !== id);
            
            if (appData.clients.length < initialLength) {
                console.log('Client deleted successfully. New count:', appData.clients.length);
                showMessage('Cliente eliminato con successo!');
                loadClients();
                updateDashboard();
                autoSave();
            } else {
                console.error('Failed to delete client');
                showMessage('Errore nell\'eliminazione del cliente', 'error');
            }
        }
        
        const debouncedFilterClients = debounce(() => {
            const searchTerm = document.getElementById('clientSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#clientsContainer tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }, 300);
        
        // ===== INVENTORY FUNCTIONS =====
        function loadInventory() {
            const container = document.getElementById('inventoryContainer');
            if (!container) return;
            
            if (appData.inventory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>Nessun componente</h3>
                        <p>Inizia aggiungendo il tuo primo componente!</p>
                    </div>
                `;
                return;
            }
            
            // Sort inventory by status (low stock first) then by name
            const sortedInventory = [...appData.inventory].sort((a, b) => {
                const aIsLow = a.quantity <= a.threshold;
                const bIsLow = b.quantity <= b.threshold;
                if (aIsLow && !bIsLow) return -1;
                if (!aIsLow && bIsLow) return 1;
                return a.name.localeCompare(b.name);
            });
            
            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Quantit√†</th>
                            <th>Soglia</th>
                            <th>Prezzo</th>
                            <th>Fornitore</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedInventory.map(item => {
                            const isLowStock = item.quantity <= item.threshold;
                            return `
                                <tr data-id="${item.id}" ${isLowStock ? 'style="background: rgba(239, 68, 68, 0.1);"' : ''}>
                                    <td><strong>${item.name}</strong></td>
                                    <td style="color: ${isLowStock ? 'var(--error)' : 'var(--success)'}; font-weight: 600;">${item.quantity}</td>
                                    <td>${item.threshold}</td>
                                    <td>${formatCurrency(item.price)}</td>
                                    <td>${item.supplier}</td>
                                    <td>
                                        <span style="color: ${isLowStock ? 'var(--error)' : 'var(--success)'}; font-weight: 600;">
                                            ${isLowStock ? '‚ö†Ô∏è Scorte Basse' : '‚úÖ OK'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="editInventoryItem('${item.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                            ‚úèÔ∏è Modifica
                                        </button>
                                        <button class="btn btn-error" onclick="confirmDeleteInventoryItem('${item.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                            üóëÔ∏è Elimina
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            console.log('Inventory loaded:', appData.inventory.length);
        }
        
        function addInventoryItem() {
            const content = `
                <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">üì¶ Nuovo Componente</h3>
                <div class="form-group">
                    <label for="itemName">Nome Componente</label>
                    <input type="text" id="itemName" required>
                </div>
                <div class="form-group">
                    <label for="itemQuantity">Quantit√†</label>
                    <input type="number" id="itemQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="itemThreshold">Soglia Minima</label>
                    <input type="number" id="itemThreshold" min="0" required>
                </div>
                <div class="form-group">
                    <label for="itemPrice">Prezzo (‚Ç¨)</label>
                    <input type="number" id="itemPrice" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="itemSupplier">Fornitore</label>
                    <input type="text" id="itemSupplier" required>
                </div>
                <div class="quick-actions">
                    <button type="button" class="btn btn-success" onclick="saveInventoryItemFromForm()" id="saveInventoryBtn">
                        <span>üíæ</span> Salva
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>‚ùå</span> Annulla
                    </button>
                </div>
            `;
            openModal(content);
        }
        
        function saveInventoryItemFromForm() {
            try {
                const saveBtn = document.getElementById('saveInventoryBtn');
                const originalText = '<span>üíæ</span> Salva';
                
                showLoading(saveBtn, 'Salvando...');
                
                const name = document.getElementById('itemName')?.value;
                const quantity = document.getElementById('itemQuantity')?.value;
                const threshold = document.getElementById('itemThreshold')?.value;
                const price = document.getElementById('itemPrice')?.value;
                const supplier = document.getElementById('itemSupplier')?.value;
                
                if (!name || !quantity || !threshold || !price || !supplier) {
                    hideLoading(saveBtn, originalText);
                    showMessage('Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                // Validate quantities
                if (parseInt(quantity) < 0 || parseInt(threshold) < 0 || parseFloat(price) < 0) {
                    hideLoading(saveBtn, originalText);
                    showMessage('I valori numerici non possono essere negativi', 'error');
                    return;
                }
                
                setTimeout(() => {
                    const formData = {
                        id: appData.editingId || generateId(),
                        name: name,
                        quantity: parseInt(quantity),
                        threshold: parseInt(threshold),
                        price: parseFloat(price),
                        supplier: supplier
                    };
                    
                    if (appData.editingId) {
                        const index = appData.inventory.findIndex(i => i.id === appData.editingId);
                        if (index !== -1) {
                            appData.inventory[index] = formData;
                            showMessage('Componente aggiornato con successo!');
                            console.log('Inventory item updated:', formData);
                        }
                        appData.editingId = null;
                    } else {
                        appData.inventory.push(formData);
                        showMessage('Componente aggiunto con successo!');
                        console.log('Inventory item added:', formData);
                    }
                    
                    hideLoading(saveBtn, originalText);
                    closeModal();
                    loadInventory();
                    updateDashboard();
                    autoSave();
                }, 500);
                
            } catch (error) {
                console.error('Save inventory error:', error);
                showMessage('Errore nel salvataggio componente', 'error');
            }
        }
        
        function editInventoryItem(id) {
            console.log('Editing inventory item with ID:', id);
            const item = appData.inventory.find(i => i.id === id);
            if (!item) {
                showMessage('Componente non trovato', 'error');
                console.error('Inventory item not found:', id);
                return;
            }
            
            appData.editingId = id;
            addInventoryItem();
            
            // Populate form with existing data
            setTimeout(() => {
                const nameEl = document.getElementById('itemName');
                const quantityEl = document.getElementById('itemQuantity');
                const thresholdEl = document.getElementById('itemThreshold');
                const priceEl = document.getElementById('itemPrice');
                const supplierEl = document.getElementById('itemSupplier');
                
                if (nameEl) nameEl.value = item.name;
                if (quantityEl) quantityEl.value = item.quantity;
                if (thresholdEl) thresholdEl.value = item.threshold;
                if (priceEl) priceEl.value = item.price;
                if (supplierEl) supplierEl.value = item.supplier;
            }, 100);
        }
        
        function confirmDeleteInventoryItem(id) {
            console.log('Confirming delete for inventory item:', id);
            const item = appData.inventory.find(i => i.id === id);
            if (!item) {
                showMessage('Componente non trovato', 'error');
                return;
            }
            
            showConfirmDialog(
                'Elimina Componente',
                `Sei sicuro di voler eliminare il componente "${item.name}"? Questa azione non pu√≤ essere annullata.`,
                () => deleteInventoryItem(id)
            );
        }
        
        function deleteInventoryItem(id) {
            console.log('Deleting inventory item with ID:', id);
            console.log('Inventory before delete:', appData.inventory.length);
            
            const initialLength = appData.inventory.length;
            appData.inventory = appData.inventory.filter(i => i.id !== id);
            
            if (appData.inventory.length < initialLength) {
                console.log('Inventory item deleted successfully. New count:', appData.inventory.length);
                showMessage('Componente eliminato con successo!');
                loadInventory();
                updateDashboard();
                autoSave();
            } else {
                console.error('Failed to delete inventory item');
                showMessage('Errore nell\'eliminazione del componente', 'error');
            }
        }
        
        const debouncedFilterInventory = debounce(() => {
            const searchTerm = document.getElementById('inventorySearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#inventoryContainer tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }, 300);<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroAvia 2025 - Game Boy Business Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #3b82f6;
            --secondary: #10b981;
            --accent: #f59e0b;
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1b3c;
            --bg-tertiary: #252647;
            --surface: #2d2f52;
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-card: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            --space-2: 0.5rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(ellipse at top, rgba(59, 130, 246, 0.1) 0%, transparent 70%), var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
        }
        
        .header {
            text-align: center;
            margin-bottom: var(--space-8);
        }
        
        .logo {
            font-family: 'Orbitron', monospace;
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 900;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-2);
            animation: logoGlow 4s ease-in-out infinite alternate;
        }
        
        @keyframes logoGlow {
            0% { filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5)); }
            100% { filter: drop-shadow(0 0 40px rgba(102, 126, 234, 0.8)); }
        }
        
        .subtitle {
            font-size: 1.125rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: var(--space-4);
        }
        
        .version-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-xl);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: var(--space-4);
            margin: var(--space-8) 0;
            padding: var(--space-6);
            background: var(--gradient-card);
            border-radius: var(--radius-xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-xl);
        }
        
        .nav-btn {
            background: var(--surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .nav-btn:hover, .nav-btn:focus {
            transform: translateY(-2px);
            border-color: var(--primary);
            color: var(--text-primary);
            outline: none;
        }
        
        .nav-btn.active {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .page {
            display: none;
            animation: fadeInUp 0.6s ease-out;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: var(--gradient-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            margin: var(--space-6) 0;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-4px);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .card h3 {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            margin-bottom: var(--space-6);
            color: var(--accent);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }
        
        .grid {
            display: grid;
            gap: var(--space-6);
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
        
        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .stat-box {
            background: var(--gradient-primary);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            text-align: center;
            color: white;
            font-weight: 700;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-box:hover {
            transform: scale(1.05) translateY(-4px);
        }
        
        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        
        .stat-box:hover::before {
            transform: translateX(100%);
        }
        
        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 900;
            margin-bottom: var(--space-2);
            position: relative;
            z-index: 1;
        }
        
        .stat-label {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: var(--gradient-primary);
            border: none;
            color: white;
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            margin: var(--space-2);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover, .btn:focus {
            transform: translateY(-2px);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #d97706); }
        .btn-error { background: linear-gradient(135deg, var(--error), #dc2626); }
        .btn-secondary { background: var(--surface); color: var(--text-secondary); }
        
        .form-group {
            margin: var(--space-6) 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--space-2);
            color: var(--accent);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--space-4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            background: var(--surface);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-4);
            justify-content: center;
        }
        
        .ai-panel {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 2px solid var(--accent);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            margin: var(--space-6) 0;
            position: relative;
            box-shadow: 0 0 50px rgba(245, 158, 11, 0.2);
        }
        
        .ai-panel::before {
            content: 'ü§ñ SPIDER-AI NEURAL NETWORK';
            position: absolute;
            top: -15px;
            left: var(--space-6);
            background: var(--accent);
            color: var(--bg-primary);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-lg);
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 0.75rem;
        }
        
        .ai-suggestions {
            margin: var(--space-6) 0;
            padding: var(--space-6);
            background: rgba(245, 158, 11, 0.1);
            border-radius: var(--radius-lg);
            border: 1px solid var(--accent);
        }
        
        .ai-suggestions p {
            margin: var(--space-2) 0;
        }
        
        .message-box {
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            margin: var(--space-6) 0;
            display: none;
            font-weight: 500;
            border: 1px solid;
        }
        
        .error-box {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
            color: #fecaca;
            border-color: var(--error);
        }
        
        .success-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            color: #a7f3d0;
            border-color: var(--success);
        }
        
        .message-box.show {
            display: block;
            animation: slideInRight 0.5s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--gradient-card);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            max-width: 900px;
            width: 90%;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .close {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            font-size: 2rem;
            cursor: pointer;
            color: var(--error);
            transition: all 0.3s ease;
            background: none;
            border: none;
            padding: 0;
        }
        
        .close:hover, .close:focus {
            color: white;
            transform: rotate(90deg);
            outline: none;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--space-6) 0;
        }
        
        .data-table th,
        .data-table td {
            padding: var(--space-4);
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-table th {
            background: var(--surface);
            color: var(--accent);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        
        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .search-box {
            width: 100%;
            max-width: 400px;
            margin: 0 auto var(--space-6);
            padding: var(--space-4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            background: var(--surface);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-8);
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--space-4);
        }

        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Confirmation Dialog Styles */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .confirm-dialog.active {
            display: flex;
        }

        .confirm-content {
            background: var(--gradient-card);
            border: 2px solid var(--error);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px rgba(239, 68, 68, 0.3);
        }

        .confirm-icon {
            font-size: 4rem;
            color: var(--error);
            margin-bottom: var(--space-4);
        }

        .confirm-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            color: var(--error);
            margin-bottom: var(--space-4);
        }

        .confirm-message {
            color: var(--text-secondary);
            margin-bottom: var(--space-8);
            font-size: 1.1rem;
        }

        .confirm-actions {
            display: flex;
            gap: var(--space-4);
            justify-content: center;
        }

        /* Chart Styles */
        .chart-container {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin: var(--space-4) 0;
        }

        .chart-bar {
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .chart-bar:hover {
            transform: scaleY(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .chart-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: var(--space-2);
        }

        .chart-value {
            font-size: 0.75rem;
            color: white;
            font-weight: 600;
            text-align: center;
            padding: var(--space-1);
        }

        /* Order Status Styles */
        .order-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .order-status.pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .order-status.in-progress {
            background: rgba(59, 130, 246, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .order-status.completed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .order-status.cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }

        /* Form Grid for Orders */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-6);
        }

        .form-section {
            background: var(--surface);
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-section h4 {
            color: var(--accent);
            margin-bottom: var(--space-4);
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .order-card {
            background: var(--gradient-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin: var(--space-4) 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .order-card:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-xl);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-4);
        }

        .order-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            color: var(--accent);
            margin-bottom: var(--space-2);
        }

        .order-client {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .order-preview {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin: var(--space-4) 0;
        }

        .order-spec {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            border: 1px solid var(--primary);
        }

        .order-actions {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-4);
        }
        
        @media (max-width: 768px) {
            .container { 
                padding: var(--space-4); 
            }
            
            .nav { 
                flex-direction: column; 
                gap: var(--space-2);
            }
            
            .nav-btn { 
                width: 100%; 
                max-width: none;
                justify-content: center;
            }
            
            .grid-2, .grid-4 { 
                grid-template-columns: 1fr; 
            }
            
            .card { 
                padding: var(--space-6); 
            }
            
            .quick-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .quick-actions .btn {
                width: 100%;
                justify-content: center;
                margin: var(--space-2) 0;
            }
            
            .data-table {
                font-size: 0.875rem;
            }
            
            .data-table th,
            .data-table td {
                padding: var(--space-2);
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .order-actions {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .modal-content {
                width: 95%;
                padding: var(--space-6);
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .confirm-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="logo">üï∑Ô∏è RetroAvia</h1>
            <p class="subtitle">Advanced Game Boy Business Manager</p>
            <div class="version-badge">
                <span>‚ö°</span>
                Version 3.1 - 2025
            </div>
        </header>
        
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <button class="nav-btn active" onclick="showPage('dashboard')" aria-label="Dashboard">
                <span>üìä</span> Dashboard
            </button>
            <button class="nav-btn" onclick="showPage('orders')" aria-label="Ordini">
                <span>üìã</span> Ordini
            </button>
            <button class="nav-btn" onclick="showPage('transactions')" aria-label="Transazioni">
                <span>üí∞</span> Transazioni
            </button>
            <button class="nav-btn" onclick="showPage('clients')" aria-label="Clienti">
                <span>üë§</span> Clienti
            </button>
            <button class="nav-btn" onclick="showPage('inventory')" aria-label="Inventario">
                <span>üì¶</span> Inventario
            </button>
            <button class="nav-btn" onclick="showPage('analytics')" aria-label="Analytics">
                <span>üìà</span> Analytics
            </button>
        </nav>
        
        <div class="error-box message-box" id="errorBox" role="alert"></div>
        <div class="success-box message-box" id="successBox" role="status"></div>
        
        <!-- Dashboard Page -->
        <div class="page active" id="dashboard" role="main">
            <div class="grid grid-4">
                <div class="stat-box">
                    <div class="stat-value" id="totalRevenue">‚Ç¨0</div>
                    <div class="stat-label">Guadagni Totali</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalExpenses">‚Ç¨0</div>
                    <div class="stat-label">Spese Totali</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="netProfit">‚Ç¨0</div>
                    <div class="stat-label">Profitto Netto</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Ordini Totali</div>
                </div>
            </div>
            
            <div class="ai-panel">
                <h3>üß† Spider-AI Neural Analysis</h3>
                <div class="ai-suggestions" id="aiSuggestions">
                    <p>‚Ä¢ Benvenuto in RetroAvia 3.1! Sistema AI pronto per l'analisi.</p>
                    <p>‚Ä¢ Inizia aggiungendo transazioni per insights intelligenti.</p>
                </div>
                <div class="quick-actions">
                    <button class="btn" onclick="runAIAnalysis()">
                        <span>üß†</span> Analizza Ora
                    </button>
                    <button class="btn btn-secondary" onclick="generatePredictions()">
                        <span>üîÆ</span> Predizioni AI
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h3><span>‚ö°</span> Azioni Rapide</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="openQuickSale()">
                        <span>üí∞</span> Vendita Rapida
                    </button>
                    <button class="btn btn-warning" onclick="addOrder()">
                        <span>üìã</span> Nuovo Ordine
                    </button>
                    <button class="btn btn-warning" onclick="openQuickClient()">
                        <span>üë§</span> Cliente Rapido
                    </button>
                    <button class="btn" onclick="openQuickInventory()">
                        <span>üì¶</span> Componente Rapido
                    </button>
                    <button class="btn btn-secondary" onclick="exportBackup()">
                        <span>üíæ</span> Backup
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Orders Page -->
        <div class="page" id="orders" role="main">
            <div class="card">
                <h3><span>üìã</span> Gestione Ordini Personalizzati</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addOrder()">
                        <span>üìã</span> Nuovo Ordine
                    </button>
                </div>
                <input type="text" class="search-box" id="orderSearch" placeholder="üîç Cerca ordini..." aria-label="Cerca ordini">
                <div id="ordersContainer">
                    <!-- Orders will be loaded here -->
                </div>
            </div>
        <!--/div>
        
        <!-- Transactions Page -->
        <div class="page" id="transactions" role="main">
            <div class="card">
                <h3><span>üí∞</span> Gestione Transazioni</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addTransaction('revenue')">
                        <span>üí∞</span> Nuova Entrata
                    </button>
                    <button class="btn btn-error" onclick="addTransaction('expense')">
                        <span>üí∏</span> Nuova Spesa
                    </button>
                </div>
                <input type="text" class="search-box" id="transactionSearch" placeholder="üîç Cerca transazioni..." aria-label="Cerca transazioni">
                <div id="transactionsContainer">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Clients Page -->
        <div class="page" id="clients" role="main">
            <div class="card">
                <h3><span>üë§</span> Gestione Clienti</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addClient()">
                        <span>üë§</span> Nuovo Cliente
                    </button>
                </div>
                <input type="text" class="search-box" id="clientSearch" placeholder="üîç Cerca clienti..." aria-label="Cerca clienti">
                <div id="clientsContainer">
                    <!-- Clients will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Inventory Page -->
        <div class="page" id="inventory" role="main">
            <div class="card">
                <h3><span>üì¶</span> Gestione Inventario</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addInventoryItem()">
                        <span>üì¶</span> Nuovo Componente
                    </button>
                </div>
                <input type="text" class="search-box" id="inventorySearch" placeholder="üîç Cerca componenti..." aria-label="Cerca componenti">
                <div id="inventoryContainer">
                    <!-- Inventory will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Analytics Page -->
        <div class="page" id="analytics" role="main">
            <div class="card">
                <h3><span>üìà</span> Analytics Avanzate</h3>
                <div class="grid grid-2">
                    <div class="card">
                        <h4>üìä Trend Mensili (Ultimi 6 Mesi)</h4>
                        <div id="monthlyTrends" class="chart-container">
                            <!-- Monthly trends chart will be here -->
                        </div>
                    </div>
                    <div class="card">
                        <h4>üèÜ Top Clienti</h4>
                        <div id="topClients">
                            <!-- Top clients will be here -->
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <div class="card">
                        <h4>üìà Performance Mensile</h4>
                        <div id="monthlyPerformance">
                            <!-- Monthly performance metrics -->
                        </div>
                    </div>
                    <div class="card">
                        <h4>üéØ KPI Dashboard</h4>
                        <div id="kpiDashboard">
                            <!-- Key performance indicators -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Modal -->
    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <button class="close" onclick="closeModal()" aria-label="Chiudi finestra">&times;</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-icon">‚ö†Ô∏è</div>
            <h3 class="confirm-title" id="confirmTitle">Conferma Eliminazione</h3>
            <p class="confirm-message" id="confirmMessage">Sei sicuro di voler procedere?</p>
            <div class="confirm-actions">
                <button class="btn btn-error" id="confirmYes">
                    <span>üóëÔ∏è</span> Elimina
                </button>
                <button class="btn btn-secondary" id="confirmNo">
                    <span>‚ùå</span> Annulla
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ===== GLOBAL STATE =====
        let appData = {
            transactions: [
                { id: 'demo1', type: 'revenue', amount: 250, description: 'Vendita Game Boy Color ricondizionato', date: '2025-01-15', client: 'Mario Rossi' },
                { id: 'demo2', type: 'expense', amount: 50, description: 'Componenti sostituzione schermo', date: '2025-01-14', client: '' },
                { id: 'demo3', type: 'revenue', amount: 180, description: 'Riparazione Game Boy Advance', date: '2025-01-12', client: 'Giulia Bianchi' },
                { id: 'demo4', type: 'revenue', amount: 320, description: 'Vendita Game Boy Pocket modificato', date: '2024-12-28', client: 'Luca Verdi' },
                { id: 'demo5', type: 'expense', amount: 75, description: 'Batterie e accessori', date: '2024-12-20', client: '' },
                { id: 'demo6', type: 'revenue', amount: 150, description: 'Riparazione schermo Game Boy', date: '2024-11-15', client: 'Anna Neri' },
                { id: 'demo7', type: 'revenue', amount: 280, description: 'Vendita Game Boy Color Pikachu', date: '2024-10-22', client: 'Marco Bianchi' }
            ],
            clients: [
                { id: 'client1', name: 'Mario Rossi', email: 'mario.rossi@email.com', phone: '333-123-4567', source: 'vinted', totalSpent: 250 },
                { id: 'client2', name: 'Giulia Bianchi', email: 'giulia.bianchi@email.com', phone: '339-987-6543', source: 'facebook', totalSpent: 180 },
                { id: 'client3', name: 'Luca Verdi', email: 'luca.verdi@email.com', phone: '340-555-7890', source: 'wallapop', totalSpent: 320 },
                { id: 'client4', name: 'Anna Neri', email: 'anna.neri@email.com', phone: '338-444-3333', source: 'instagram', totalSpent: 150 },
                { id: 'client5', name: 'Marco Bianchi', email: 'marco.bianchi@email.com', phone: '347-222-1111', source: 'ebay', totalSpent: 280 }
            ],
            inventory: [
                { id: 'inv1', name: 'Schermo Game Boy Classic', quantity: 5, threshold: 3, price: 25, supplier: 'RetroTech' },
                { id: 'inv2', name: 'Batterie AA Ricaricabili', quantity: 20, threshold: 10, price: 8, supplier: 'PowerPlus' },
                { id: 'inv3', name: 'Custodie Protettive', quantity: 2, threshold: 5, price: 15, supplier: 'CaseMaster' }
            ],
            orders: [
                {
                    id: 'order1',
                    client: 'Mario Rossi',
                    status: 'in-progress',
                    createdDate: '2025-01-20',
                    estimatedCompletion: '2025-02-05',
                    gameboy: {
                        modello: 'Game Boy Color',
                        scocca: 'Trasparente Blu',
                        pulsanti: 'Bianchi custom',
                        etichetta: 'Personalizzata con nome',
                        batteria: 'Li-ion ricaricabile',
                        audio: 'Speaker migliorato',
                        display: 'IPS V2',
                        kitLed: 'LED RGB programmabili',
                        box: 'Box originale restaurata',
                        cover: 'Custodia rigida custom',
                        gameboyCliente: 'Game Boy Color difettoso fornito dal cliente',
                        altro: 'Porta USB-C per ricarica',
                        note: 'Cliente vuole colori che richiamano il mare. Particolare attenzione ai dettagli.'
                    }
                },
                {
                    id: 'order2',
                    client: 'Giulia Bianchi',
                    status: 'pending',
                    createdDate: '2025-01-22',
                    estimatedCompletion: '2025-02-10',
                    gameboy: {
                        modello: 'Game Boy Advance',
                        scocca: 'Rosa pastello',
                        pulsanti: 'Rosa scuro',
                        etichetta: 'Sticker kawaii personalizzato',
                        batteria: 'Batterie AA ricaricabili',
                        audio: 'Audio standard',
                        display: 'IPS V3 luminoso',
                        kitLed: 'Nessuno',
                        box: 'Non richiesta',
                        cover: 'Custodia morbida rosa',
                        gameboyCliente: 'Nessuno - acquisto completo',
                        altro: 'Adesivi extra kawaii',
                        note: 'Regalo per compleanno figlia. Tema principesse e unicorni.'
                    }
                }
            ],
            editingId: null,
            currentPage: 'dashboard',
            version: '3.1'
        };
        
        // ===== UTILITY FUNCTIONS =====
        function formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(parseFloat(amount || 0));
        }
        
        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function formatDate(date = new Date()) {
            if (date instanceof Date) {
                return date.toISOString().split('T')[0];
            }
            return date;
        }
        
        function showMessage(message, type = 'success') {
            const box = document.getElementById(type === 'error' ? 'errorBox' : 'successBox');
            if (!box) return;
            
            box.textContent = message;
            box.classList.add('show');
            
            setTimeout(() => {
                box.classList.remove('show');
            }, type === 'error' ? 6000 : 4000);
        }

        // ===== IMPROVED DEBOUNCE FUNCTION =====
        function debounce(func, wait, immediate) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    timeout = null;
                    if (!immediate) func(...args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func(...args);
            };
        }

        // ===== LOADING STATE MANAGEMENT =====
        function showLoading(buttonElement, originalText) {
            if (buttonElement) {
                buttonElement.disabled = true;
                buttonElement.innerHTML = `<span class="loading"></span> ${originalText}`;
            }
        }

        function hideLoading(buttonElement, originalText) {
            if (buttonElement) {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalText;
            }
        }

        // ===== DATE UTILITY FUNCTIONS =====
        function getMonthName(monthIndex) {
            const months = [
                'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
            ];
            return months[monthIndex];
        }

        function getLastSixMonths() {
            const months = [];
            const now = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    year: date.getFullYear(),
                    month: date.getMonth(),
                    monthName: getMonthName(date.getMonth()),
                    key: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`
                });
            }
            return months;
        }

        function getTransactionsByMonth() {
            const monthlyData = {};
            
            appData.transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[key]) {
                    monthlyData[key] = {
                        revenue: 0,
                        expenses: 0,
                        count: 0
                    };
                }
                
                if (transaction.type === 'revenue') {
                    monthlyData[key].revenue += parseFloat(transaction.amount || 0);
                } else if (transaction.type === 'expense') {
                    monthlyData[key].expenses += parseFloat(transaction.amount || 0);
                }
                monthlyData[key].count++;
            });
            
            return monthlyData;
        }

        // ===== CONFIRMATION DIALOG =====
        function showConfirmDialog(title, message, onConfirm) {
            const dialog = document.getElementById('confirmDialog');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            const yesBtn = document.getElementById('confirmYes');
            const noBtn = document.getElementById('confirmNo');

            if (!dialog || !titleEl || !messageEl || !yesBtn || !noBtn) {
                console.error('Confirmation dialog elements not found');
                return;
            }

            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Remove any existing event listeners
            const newYesBtn = yesBtn.cloneNode(true);
            const newNoBtn = noBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
            noBtn.parentNode.replaceChild(newNoBtn, noBtn);

            // Add new event listeners
            newYesBtn.addEventListener('click', () => {
                dialog.classList.remove('active');
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            });

            newNoBtn.addEventListener('click', () => {
                dialog.classList.remove('active');
            });

            dialog.classList.add('active');

            // Focus on the "No" button by default for safety
            setTimeout(() => newNoBtn.focus(), 100);
        }
        
        // ===== NAVIGATION =====
        function showPage(pageId) {
            try {
                // Remove active class from all pages and buttons
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to target page and button
                const targetPage = document.getElementById(pageId);
                const targetButton = document.querySelector(`[onclick="showPage('${pageId}')"]`);
                
                if (targetPage) {
                    targetPage.classList.add('active');
                }
                if (targetButton) {
                    targetButton.classList.add('active');
                }
                
                appData.currentPage = pageId;
                
                // Load page data
                switch(pageId) {
                    case 'dashboard':
                        updateDashboard();
                        break;
                    case 'orders':
                        loadOrders();
                        setTimeout(setupSearchListeners, 100);
                        break;
                    case 'transactions':
                        loadTransactions();
                        setTimeout(setupSearchListeners, 100);
                        break;
                    case 'clients':
                        loadClients();
                        setTimeout(setupSearchListeners, 100);
                        break;
                    case 'inventory':
                        loadInventory();
                        setTimeout(setupSearchListeners, 100);
                        break;
                    case 'analytics':
                        loadAnalytics();
                        break;
                }
                
                console.log(`Navigated to ${pageId}`);
                
            } catch (error) {
                console.error('Navigation error:', error);
                showMessage('Errore nella navigazione', 'error');
            }
        }
        
        // ===== ORDERS FUNCTIONS =====
        function loadOrders() {
            const container = document.getElementById('ordersContainer');
            if (!container) return;
            
            if (appData.orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>Nessun ordine</h3>
                        <p>Inizia aggiungendo il tuo primo ordine personalizzato!</p>
                    </div>
                `;
                return;
            }
            
            // Sort orders by date (newest first)
            const sortedOrders = [...appData.orders].sort((a, b) => 
                new Date(b.createdDate) - new Date(a.createdDate)
            );
            
            const ordersHTML = sortedOrders.map(order => {
                const statusClass = order.status;
                const statusText = {
                    'pending': '‚è≥ In Attesa',
                    'in-progress': 'üîß In Lavorazione',
                    'completed': '‚úÖ Completato',
                    'cancelled': '‚ùå Annullato'
                };
                
                // Create preview of main specs
                const specs = [];
                if (order.gameboy.modello) specs.push(order.gameboy.modello);
                if (order.gameboy.scocca) specs.push(`Scocca: ${order.gameboy.scocca}`);
                if (order.gameboy.display) specs.push(`Display: ${order.gameboy.display}`);
                if (order.gameboy.kitLed && order.gameboy.kitLed !== 'Nessuno') specs.push('LED Kit');
                
                return `
                    <div class="order-card" onclick="viewOrder('${order.id}')">
                        <div class="order-header">
                            <div>
                                <div class="order-title">Ordine #${order.id.slice(-6).toUpperCase()}</div>
                                <div class="order-client">üë§ ${order.client}</div>
                            </div>
                            <div class="order-status ${statusClass}">
                                ${statusText[order.status]}
                            </div>
                        </div>
                        
                        <div class="order-preview">
                            ${specs.slice(0, 4).map(spec => `<div class="order-spec">${spec}</div>`).join('')}
                            ${specs.length > 4 ? `<div class="order-spec">+${specs.length - 4} altro...</div>` : ''}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-4); font-size: 0.875rem; color: var(--text-muted);">
                            <span>üìÖ Creato: ${new Date(order.createdDate).toLocaleDateString('it-IT')}</span>
                            <span>üéØ Consegna: ${new Date(order.estimatedCompletion).toLocaleDateString('it-IT')}</span>
                        </div>
                        
                        <div class="order-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-secondary" onclick="editOrder('${order.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                ‚úèÔ∏è Modifica
                            </button>
                            <button class="btn btn-warning" onclick="changeOrderStatus('${order.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                üîÑ Stato
                            </button>
                            <button class="btn btn-error" onclick="confirmDeleteOrder('${order.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                üóëÔ∏è Elimina
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = ordersHTML;
            console.log('Orders loaded:', appData.orders.length);
        }

        function addOrder() {
            const content = `
                <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">üìã Nuovo Ordine Personalizzato</h3>
                
                <div class="form-group">
                    <label for="orderClient">Cliente</label>
                    <select id="orderClient" required>
                        <option value="">Seleziona cliente...</option>
                        ${appData.clients.map(client => `
                            <option value="${client.name}">${client.name}</option>
                        `).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="orderStatus">Stato Ordine</label>
                    <select id="orderStatus" required>
                        <option value="pending">‚è≥ In Attesa</option>
                        <option value="in-progress">üîß In Lavorazione</option>
                        <option value="completed">‚úÖ Completato</option>
                        <option value="cancelled">‚ùå Annullato</option>
                    </select>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="orderCreatedDate">Data Creazione</label>
                        <input type="date" id="orderCreatedDate" value="${formatDate()}" required>
                    </div>
                    <div class="form-group">
                        <label for="orderEstimatedCompletion">Data Consegna Prevista</label>
                        <input type="date" id="orderEstimatedCompletion" required>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-section">
                        <h4>üéÆ Specifiche Game Boy</h4>
                        
                        <div class="form-group">
                            <label for="gameboyModello">Modello Game Boy</label>
                            <select id="gameboyModello">
                                <option value="">Seleziona modello...</option>
                                <option value="Game Boy Classic">Game Boy Classic</option>
                                <option value="Game Boy Pocket">Game Boy Pocket</option>
                                <option value="Game Boy Color">Game Boy Color</option>
                                <option value="Game Boy Advance">Game Boy Advance</option>
                                <option value="Game Boy Advance SP">Game Boy Advance SP</option>
                                <option value="Game Boy Micro">Game Boy Micro</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="gameboyScocca">Scocca</label>
                            <input type="text" id="gameboyScocca" placeholder="Es: Trasparente blu, Rosa pastello...">
                        </div>
                        
                        <div class="form-group">
                            <label for="gameboyPulsanti">Pulsanti</label>
                            <input type="text" id="gameboyPulsanti" placeholder="Es: Bianchi custom, Originali...">
                        </div>
                        
                        <div class="form-group">
                            <label for="gameboyEtichetta">Etichetta</label>
                            <input type="text" id="gameboyEtichetta" placeholder="Es: Personalizzata, Originale...">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>üîã Componenti Tecnici</h4>
                        
                        <div class="form-group">
                            <label for="gameboyBatteria">Batteria</label>
                            <input type="text" id="gameboyBatteria" placeholder="Es: Li-ion ricaricabile, AA standard...">
                        </div>
                        
                        <div class="form-group">
                            <label for="gameboyAudio">Audio</label>
                            <input type="text" id="gameboyAudio" placeholder="Es: Speaker migliorato, Audio standard...">
                        </div>
                        
                        <div class="form-group">
                            <label for="gameboyDisplay">Display</label>
                            <input type="text" id="gameboyDisplay" placeholder="Es: IPS V2, LCD originale...">
                        </div>
                        
                        <div class="form-group">
                            <label for="gameboyKitLed">Kit LED</label>
                            <input type="text" id="gameboyKitLed" placeholder="Es: LED RGB programmabili, Nessuno...">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>üì¶ Accessori</h4>
                        
                        <div class="form-group">
                            <label for="gameboyBox">Box</label>
                            <input type="text" id="gameboyBox" placeholder="Es: Box originale restaurata, Non richiesta...">
                        </div>
                        
                        <div class="form-group">
                            <label for="gameboyCover">Cover</label>
                            <input type="text" id="gameboyCover" placeholder="Es: Custodia rigida custom, Morbida...">
                        </div>
                        
                        <div class="form-group">
                            <label for="gameboyCliente">Game Boy Cliente</label>
                            <input type="text" id="gameboyCliente" placeholder="Es: Game Boy difettoso fornito, Nessuno...">
                        </div>
                        
                        <div class="form-group">
                            <label for="gameboyAltro">Altro</label>
                            <input type="text" id="gameboyAltro" placeholder="Es: Porta USB-C, Adesivi extra...">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="gameboyNote">Note</label>
                    <textarea id="gameboyNote" placeholder="Note aggiuntive, richieste speciali del cliente..." rows="4"></textarea>
                </div>
                
                <div class="quick-actions">
                    <button type="button" class="btn btn-success" onclick="saveOrderFromForm()" id="saveOrderBtn">
                        <span>üíæ</span> Salva Ordine
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>‚ùå</span> Annulla
                    </button>
                </div>
            `;
            openModal(content);
        }

        function saveOrderFromForm() {
            try {
                const saveBtn = document.getElementById('saveOrderBtn');
                const originalText = '<span>üíæ</span> Salva Ordine';
                
                showLoading(saveBtn, 'Salvando...');
                
                // Get basic order info
                const client = document.getElementById('orderClient')?.value;
                const status = document.getElementById('orderStatus')?.value;
                const createdDate = document.getElementById('orderCreatedDate')?.value;
                const estimatedCompletion = document.getElementById('orderEstimatedCompletion')?.value;
                
                if (!client || !status || !createdDate || !estimatedCompletion) {
                    hideLoading(saveBtn, originalText);
                    showMessage('Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                // Validate dates
                const created = new Date(createdDate);
                const estimated = new Date(estimatedCompletion);
                if (estimated < created) {
                    hideLoading(saveBtn, originalText);
                    showMessage('La data di consegna non pu√≤ essere precedente alla data di creazione', 'error');
                    return;
                }
                
                setTimeout(() => {
                    const formData = {
                        id: appData.editingId || generateId(),
                        client: client,
                        status: status,
                        createdDate: createdDate,
                        estimatedCompletion: estimatedCompletion,
                        gameboy: {
                            modello: document.getElementById('gameboyModello')?.value || '',
                            scocca: document.getElementById('gameboyScocca')?.value || '',
                            pulsanti: document.getElementById('gameboyPulsanti')?.value || '',
                            etichetta: document.getElementById('gameboyEtichetta')?.value || '',
                            batteria: document.getElementById('gameboyBatteria')?.value || '',
                            audio: document.getElementById('gameboyAudio')?.value || '',
                            display: document.getElementById('gameboyDisplay')?.value || '',
                            kitLed: document.getElementById('gameboyKitLed')?.value || '',
                            box: document.getElementById('gameboyBox')?.value || '',
                            cover: document.getElementById('gameboyCover')?.value || '',
                            gameboyCliente: document.getElementById('gameboyCliente')?.value || '',
                            altro: document.getElementById('gameboyAltro')?.value || '',
                            note: document.getElementById('gameboyNote')?.value || ''
                        }
                    };
                    
                    if (appData.editingId) {
                        const index = appData.orders.findIndex(o => o.id === appData.editingId);
                        if (index !== -1) {
                            appData.orders[index] = formData;
                            showMessage('Ordine aggiornato con successo!');
                            console.log('Order updated:', formData);
                        }
                        appData.editingId = null;
                    } else {
                        appData.orders.push(formData);
                        showMessage('Ordine aggiunto con successo!');
                        console.log('Order added:', formData);
                    }
                    
                    hideLoading(saveBtn, originalText);
                    closeModal();
                    loadOrders();
                    updateDashboard();
                    autoSave();
                }, 500);
                
            } catch (error) {
                console.error('Save order error:', error);
                showMessage('Errore nel salvataggio ordine', 'error');
            }
        }

        function viewOrder(id) {
            const order = appData.orders.find(o => o.id === id);
            if (!order) {
                showMessage('Ordine non trovato', 'error');
                return;
            }
            
            const statusText = {
                'pending': '‚è≥ In Attesa',
                'in-progress': 'üîß In Lavorazione',
                'completed': '‚úÖ Completato',
                'cancelled': '‚ùå Annullato'
            };
            
            const content = `
                <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">
                    üìã Ordine #${order.id.slice(-6).toUpperCase()}
                </h3>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6); padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                    <div>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: var(--space-2);">üë§ ${order.client}</div>
                        <div style="color: var(--text-muted); font-size: 0.9rem;">
                            üìÖ Creato: ${new Date(order.createdDate).toLocaleDateString('it-IT')} | 
                            üéØ Consegna: ${new Date(order.estimatedCompletion).toLocaleDateString('it-IT')}
                        </div>
                    </div>
                    <div class="order-status ${order.status}" style="font-size: 1rem;">
                        ${statusText[order.status]}
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-section">
                        <h4>üéÆ Specifiche Game Boy</h4>
                        ${order.gameboy.modello ? `<p><strong>Modello:</strong> ${order.gameboy.modello}</p>` : ''}
                        ${order.gameboy.scocca ? `<p><strong>Scocca:</strong> ${order.gameboy.scocca}</p>` : ''}
                        ${order.gameboy.pulsanti ? `<p><strong>Pulsanti:</strong> ${order.gameboy.pulsanti}</p>` : ''}
                        ${order.gameboy.etichetta ? `<p><strong>Etichetta:</strong> ${order.gameboy.etichetta}</p>` : ''}
                    </div>
                    
                    <div class="form-section">
                        <h4>üîã Componenti Tecnici</h4>
                        ${order.gameboy.batteria ? `<p><strong>Batteria:</strong> ${order.gameboy.batteria}</p>` : ''}
                        ${order.gameboy.audio ? `<p><strong>Audio:</strong> ${order.gameboy.audio}</p>` : ''}
                        ${order.gameboy.display ? `<p><strong>Display:</strong> ${order.gameboy.display}</p>` : ''}
                        ${order.gameboy.kitLed ? `<p><strong>Kit LED:</strong> ${order.gameboy.kitLed}</p>` : ''}
                    </div>
                    
                    <div class="form-section">
                        <h4>üì¶ Accessori</h4>
                        ${order.gameboy.box ? `<p><strong>Box:</strong> ${order.gameboy.box}</p>` : ''}
                        ${order.gameboy.cover ? `<p><strong>Cover:</strong> ${order.gameboy.cover}</p>` : ''}
                        ${order.gameboy.gameboyCliente ? `<p><strong>Game Boy Cliente:</strong> ${order.gameboy.gameboyCliente}</p>` : ''}
                        ${order.gameboy.altro ? `<p><strong>Altro:</strong> ${order.gameboy.altro}</p>` : ''}
                    </div>
                </div>
                
                ${order.gameboy.note ? `
                    <div class="form-section" style="margin-top: var(--space-6);">
                        <h4>üìù Note</h4>
                        <p style="line-height: 1.6; color: var(--text-secondary);">${order.gameboy.note}</p>
                    </div>
                ` : ''}
                
                <div class="quick-actions" style="margin-top: var(--space-8);">
                    <button class="btn" onclick="editOrder('${order.id}')">
                        <span>‚úèÔ∏è</span> Modifica
                    </button>
                    <button class="btn btn-warning" onclick="changeOrderStatus('${order.id}')">
                        <span>üîÑ</span> Cambia Stato
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal()">
                        <span>‚úÖ</span> Chiudi
                    </button>
                </div>
            `;
            openModal(content);
        }

        function editOrder(id) {
            console.log('Editing order with ID:', id);
            const order = appData.orders.find(o => o.id === id);
            if (!order) {
                showMessage('Ordine non trovato', 'error');
                console.error('Order not found:', id);
                return;
            }
            
            appData.editingId = id;
            addOrder();
            
            // Populate form with existing data
            setTimeout(() => {
                document.getElementById('orderClient').value = order.client || '';
                document.getElementById('orderStatus').value = order.status || '';
                document.getElementById('orderCreatedDate').value = order.createdDate || '';
                document.getElementById('orderEstimatedCompletion').value = order.estimatedCompletion || '';
                
                // Populate gameboy specs
                document.getElementById('gameboyModello').value = order.gameboy.modello || '';
                document.getElementById('gameboyScocca').value = order.gameboy.scocca || '';
                document.getElementById('gameboyPulsanti').value = order.gameboy.pulsanti || '';
                document.getElementById('gameboyEtichetta').value = order.gameboy.etichetta || '';
                document.getElementById('gameboyBatteria').value = order.gameboy.batteria || '';
                document.getElementById('gameboyAudio').value = order.gameboy.audio || '';
                document.getElementById('gameboyDisplay').value = order.gameboy.display || '';
                document.getElementById('gameboyKitLed').value = order.gameboy.kitLed || '';
                document.getElementById('gameboyBox').value = order.gameboy.box || '';
                document.getElementById('gameboyCover').value = order.gameboy.cover || '';
                document.getElementById('gameboyCliente').value = order.gameboy.gameboyCliente || '';
                document.getElementById('gameboyAltro').value = order.gameboy.altro || '';
                document.getElementById('gameboyNote').value = order.gameboy.note || '';
            }, 100);
        }

        function changeOrderStatus(id) {
            const order = appData.orders.find(o => o.id === id);
            if (!order) {
                showMessage('Ordine non trovato', 'error');
                return;
            }
            
            const content = `
                <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">
                    üîÑ Cambia Stato Ordine #${order.id.slice(-6).toUpperCase()}
                </h3>
                
                <div style="margin: var(--space-6) 0; padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                    <p><strong>Cliente:</strong> ${order.client}</p>
                    <p><strong>Stato Attuale:</strong> <span class="order-status ${order.status}">${{
                        'pending': '‚è≥ In Attesa',
                        'in-progress': 'üîß In Lavorazione', 
                        'completed': '‚úÖ Completato',
                        'cancelled': '‚ùå Annullato'
                    }[order.status]}</span></p>
                </div>
                
                <div class="form-group">
                    <label for="newOrderStatus">Nuovo Stato</label>
                    <select id="newOrderStatus" required>
                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>‚è≥ In Attesa</option>
                        <option value="in-progress" ${order.status === 'in-progress' ? 'selected' : ''}>üîß In Lavorazione</option>
                        <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>‚úÖ Completato</option>
                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>‚ùå Annullato</option>
                    </select>
                </div>
                
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="updateOrderStatus('${id}')" id="updateStatusBtn">
                        <span>üîÑ</span> Aggiorna Stato
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal()">
                        <span>‚ùå</span> Annulla
                    </button>
                </div>
            `;
            openModal(content);
        }

        function updateOrderStatus(id) {
            try {
                const updateBtn = document.getElementById('updateStatusBtn');
                const originalText = '<span>üîÑ</span> Aggiorna Stato';
                
                showLoading(updateBtn, 'Aggiornando...');
                
                const newStatus = document.getElementById('newOrderStatus')?.value;
                if (!newStatus) {
                    hideLoading(updateBtn, originalText);
                    showMessage('Seleziona un nuovo stato', 'error');
                    return;
                }
                
                setTimeout(() => {
                    const orderIndex = appData.orders.findIndex(o => o.id === id);
                    if (orderIndex !== -1) {
                        appData.orders[orderIndex].status = newStatus;
                        showMessage('Stato ordine aggiornato con successo!');
                        console.log('Order status updated:', id, 'new status:', newStatus);
                        
                        hideLoading(updateBtn, originalText);
                        closeModal();
                        loadOrders();
                        autoSave();
                    } else {
                        hideLoading(updateBtn, originalText);
                        showMessage('Errore nell\'aggiornamento dello stato', 'error');
                    }
                }, 500);
                
            } catch (error) {
                console.error('Update order status error:', error);
                showMessage('Errore nell\'aggiornamento stato ordine', 'error');
            }
        }

        function confirmDeleteOrder(id) {
            console.log('Confirming delete for order:', id);
            const order = appData.orders.find(o => o.id === id);
            if (!order) {
                showMessage('Ordine non trovato', 'error');
                return;
            }
            
            showConfirmDialog(
                'Elimina Ordine',
                `Sei sicuro di voler eliminare l'ordine #${order.id.slice(-6).toUpperCase()} del cliente "${order.client}"? Questa azione non pu√≤ essere annullata.`,
                () => deleteOrder(id)
            );
        }

        function deleteOrder(id) {
            console.log('Deleting order with ID:', id);
            console.log('Orders before delete:', appData.orders.length);
            
            const initialLength = appData.orders.length;
            appData.orders = appData.orders.filter(o => o.id !== id);
            
            if (appData.orders.length < initialLength) {
                console.log('Order deleted successfully. New count:', appData.orders.length);
                showMessage('Ordine eliminato con successo!');
                loadOrders();
                updateDashboard();
                autoSave();
            } else {
                console.error('Failed to delete order');
                showMessage('Errore nell\'eliminazione dell\'ordine', 'error');
            }
        }

        const debouncedFilterOrders = debounce(() => {
            const searchTerm = document.getElementById('orderSearch')?.value.toLowerCase() || '';
            const orderCards = document.querySelectorAll('#ordersContainer .order-card');
            
            orderCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }, 300);
        
        // ===== DASHBOARD FUNCTIONS =====
        function updateDashboard() {
            try {
                const revenues = appData.transactions.filter(t => t.type === 'revenue');
                const expenses = appData.transactions.filter(t => t.type === 'expense');
                
                const totalRevenue = revenues.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                const netProfit = totalRevenue - totalExpenses;
                const totalOrders = revenues.length;
                
                // Update stat boxes with animation
                const elements = {
                    totalRevenue: formatCurrency(totalRevenue),
                    totalExpenses: formatCurrency(totalExpenses),
                    netProfit: formatCurrency(netProfit),
                    totalOrders: totalOrders
                };
                
                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        // Add subtle animation
                        element.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            element.textContent = value;
                            element.style.transform = 'scale(1)';
                        }, 150);
                    }
                });
                
                // Update profit color
                const profitElement = document.getElementById('netProfit');
                if (profitElement && profitElement.parentElement) {
                    const profitBox = profitElement.parentElement;
                    if (netProfit >= 0) {
                        profitBox.style.background = 'linear-gradient(135deg, var(--success), #059669)';
                    } else {
                        profitBox.style.background = 'linear-gradient(135deg, var(--error), #dc2626)';
                    }
                }
                
                // Update AI suggestions
                runAIAnalysis();
                
                console.log('Dashboard updated successfully');
                
            } catch (error) {
                console.error('Dashboard update error:', error);
                showMessage('Errore aggiornamento dashboard', 'error');
            }
        }

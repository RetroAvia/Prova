<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroAvia 4.2 - Enterprise Business Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https:; frame-ancestors 'none';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #059669;
            --secondary-dark: #047857;
            --accent: #dc2626;
            --accent-light: #ef4444;
            --warning: #d97706;
            --warning-light: #f59e0b;
            
            --bg-primary: #0a0a0f;
            --bg-secondary: #111827;
            --bg-tertiary: #1f2937;
            --surface: #374151;
            --surface-elevated: #4b5563;
            --surface-glass: rgba(31, 41, 55, 0.8);
            
            --text-primary: #ffffff;
            --text-secondary: #f3f4f6;
            --text-muted: #9ca3af;
            --text-inverse: #111827;
            
            --success: #10b981;
            --success-light: #34d399;
            --error: #ef4444;
            --error-light: #f87171;
            --info: #3b82f6;
            
            --gradient-primary: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            --gradient-secondary: linear-gradient(135deg, #059669 0%, #047857 100%);
            --gradient-accent: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            --gradient-surface: linear-gradient(135deg, var(--surface) 0%, var(--surface-elevated) 100%);
            --gradient-glass: linear-gradient(135deg, rgba(31, 41, 55, 0.9) 0%, rgba(75, 85, 99, 0.8) 100%);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.25), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.15);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            
            --border-radius: 0.75rem;
            --border-radius-lg: 1rem;
            --border-radius-xl: 1.5rem;
            --border-radius-2xl: 2rem;
            
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 0.75rem;
            --spacing-lg: 1rem;
            --spacing-xl: 1.5rem;
            --spacing-2xl: 2rem;
            --spacing-3xl: 3rem;
            --spacing-4xl: 4rem;
            
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: 
                radial-gradient(ellipse at top left, rgba(37, 99, 235, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(5, 150, 105, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at center, rgba(220, 38, 38, 0.05) 0%, transparent 70%),
                var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity var(--transition-slow);
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 3rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-xl);
            animation: pulse 2s infinite;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(37, 99, 235, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-lg);
        }
        
        .loading-text {
            color: var(--text-muted);
            font-size: 0.875rem;
            text-align: center;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Enhanced Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }
        
        .sidebar {
            width: 280px;
            background: var(--gradient-glass);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 1000;
            transform: translateX(0);
            transition: transform var(--transition-base);
            overflow-y: auto;
        }
        
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        
        .sidebar-header {
            padding: var(--spacing-2xl);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-sm);
        }
        
        .sidebar-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .sidebar-nav {
            padding: var(--spacing-xl);
        }
        
        .nav-section {
            margin-bottom: var(--spacing-2xl);
        }
        
        .nav-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: var(--spacing-lg);
            padding-left: var(--spacing-md);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all var(--transition-fast);
            margin-bottom: var(--spacing-xs);
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-lg);
        }
        
        .nav-item-icon {
            font-size: 1.125rem;
            min-width: 20px;
            text-align: center;
        }
        
        .nav-item-text {
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .nav-item-badge {
            margin-left: auto;
            background: var(--accent);
            color: white;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            transition: margin-left var(--transition-base);
            min-height: 100vh;
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        .topbar {
            height: 70px;
            background: var(--gradient-glass);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-2xl);
            position: sticky;
            top: 0;
            z-index: 999;
        }
        
        .topbar-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }
        
        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            transition: all var(--transition-fast);
        }
        
        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        .topbar-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--gradient-glass);
            border-radius: var(--border-radius-lg);
            font-size: 0.875rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            transition: all var(--transition-base);
        }
        
        .connection-status.connected { border-color: var(--success); }
        .connection-status.disconnected { border-color: var(--error); }
        .connection-status.syncing { border-color: var(--warning); }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected { background: var(--success); }
        .status-indicator.disconnected { background: var(--error); }
        .status-indicator.syncing { 
            background: var(--warning);
            animation: syncPulse 1s infinite;
        }
        
        @keyframes syncPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }
        
        .content-area {
            padding: var(--spacing-2xl);
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Pages */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: var(--gradient-glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-2xl);
            padding: var(--spacing-2xl);
            margin: var(--spacing-xl) 0;
            box-shadow: var(--shadow-xl);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }
        
        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-2xl);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-light);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin: 0;
        }
        
        .card-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        /* Grid System */
        .grid {
            display: grid;
            gap: var(--spacing-xl);
        }
        
        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
        .grid-auto { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        
        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin: var(--spacing-xl) 0;
        }
        
        .stat-card {
            background: var(--gradient-primary);
            border-radius: var(--border-radius-2xl);
            padding: var(--spacing-xl);
            color: white;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all var(--transition-base);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .stat-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-2xl);
        }
        
        .stat-card.revenue { background: var(--gradient-secondary); }
        .stat-card.expense { background: var(--gradient-accent); }
        .stat-card.orders { background: linear-gradient(135deg, var(--warning), var(--warning-light)); }
        .stat-card.clients { background: linear-gradient(135deg, var(--info), var(--primary)); }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
        }
        
        .stat-icon {
            font-size: 1.5rem;
            opacity: 0.9;
        }
        
        .stat-trend {
            font-size: 0.75rem;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: clamp(1.5rem, 4vw, 2.25rem);
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
            position: relative;
            z-index: 1;
        }
        
        .stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: var(--gradient-primary);
            border: none;
            color: white;
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            text-decoration: none;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            min-height: 44px;
            justify-content: center;
            user-select: none;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left var(--transition-slow);
        }
        
        .btn:hover::before { left: 100%; }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }
        .btn:active { transform: translateY(0) scale(0.98); }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-sm {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.75rem;
            min-height: 36px;
        }
        
        .btn-lg {
            padding: var(--spacing-lg) var(--spacing-2xl);
            font-size: 1rem;
            min-height: 52px;
        }
        
        .btn-success { background: var(--gradient-secondary); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), var(--warning-light)); }
        .btn-error { background: var(--gradient-accent); }
        .btn-info { background: linear-gradient(135deg, var(--info), var(--primary)); }
        .btn-secondary { 
            background: var(--gradient-surface); 
            color: var(--text-secondary); 
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            color: var(--primary-light);
            font-weight: 600;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .form-label.required::after {
            content: '*';
            color: var(--accent);
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-lg);
            background: var(--surface);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-sm);
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15), var(--shadow-md);
            transform: scale(1.01);
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .data-table th,
        .data-table td {
            padding: var(--spacing-lg);
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            vertical-align: top;
        }
        
        .data-table th {
            background: var(--surface);
            color: var(--primary-light);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: 'JetBrains Mono', monospace;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table tr {
            transition: all var(--transition-fast);
        }
        
        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .data-table .actions {
            white-space: nowrap;
        }
        
        .data-table .actions .btn {
            margin: 0 2px;
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
            min-height: 32px;
        }
        
        /* Search */
        .search-container {
            position: relative;
            margin-bottom: var(--spacing-xl);
        }
        
        .search-input {
            width: 100%;
            max-width: 400px;
            padding: var(--spacing-lg) var(--spacing-lg) var(--spacing-lg) 3rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-lg);
            background: var(--surface);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15), var(--shadow-lg);
            transform: scale(1.02);
        }
        
        .search-icon {
            position: absolute;
            left: var(--spacing-lg);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.125rem;
            pointer-events: none;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base);
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--gradient-glass);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-2xl);
            padding: var(--spacing-2xl);
            max-width: 800px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            backdrop-filter: blur(20px);
            transform: scale(0.95) translateY(-20px);
            transition: all var(--transition-base);
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            transition: all var(--transition-fast);
        }
        
        .modal-close:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .modal-body {
            margin-bottom: var(--spacing-xl);
        }
        
        .modal-footer {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: var(--spacing-lg);
        }
        
        /* Notifications */
        .notification-container {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 10000;
            max-width: 400px;
            pointer-events: none;
        }
        
        .notification {
            background: var(--gradient-glass);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(20px);
            transform: translateX(100%);
            transition: transform var(--transition-base);
            pointer-events: auto;
            border-left: 4px solid;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success { border-left-color: var(--success); }
        .notification.error { border-left-color: var(--error); }
        .notification.warning { border-left-color: var(--warning); }
        .notification.info { border-left-color: var(--info); }
        
        .notification-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-sm);
        }
        
        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        .notification-dismiss {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px;
            font-size: 1rem;
            transition: color var(--transition-fast);
        }
        
        .notification-dismiss:hover {
            color: var(--text-primary);
        }
        
        .notification-message {
            color: var(--text-secondary);
            font-size: 0.8125rem;
            line-height: 1.4;
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
            letter-spacing: 0.025em;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
        }
        
        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }
        
        .status-pending {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.2), rgba(245, 158, 11, 0.2));
            color: var(--warning-light);
            border: 1px solid var(--warning);
        }
        
        .status-in-progress {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.2), rgba(59, 130, 246, 0.2));
            color: var(--primary-light);
            border: 1px solid var(--primary);
        }
        
        .status-completed {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.2), rgba(16, 185, 129, 0.2));
            color: var(--success-light);
            border: 1px solid var(--success);
        }
        
        .status-cancelled {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.2), rgba(239, 68, 68, 0.2));
            color: var(--error-light);
            border: 1px solid var(--error);
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: var(--spacing-4xl) var(--spacing-xl);
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-lg);
            opacity: 0.7;
        }
        
        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }
        
        .empty-state-description {
            margin-bottom: var(--spacing-xl);
            line-height: 1.6;
        }
        
        /* Sync Queue */
        .sync-queue {
            position: fixed;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            background: var(--gradient-glass);
            border: 1px solid var(--warning);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            color: var(--warning);
            font-size: 0.875rem;
            display: none;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-lg);
            z-index: 999;
            backdrop-filter: blur(20px);
            animation: slideInUp 0.3s ease;
        }
        
        .sync-queue.show { display: flex; }
        
        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 0.8s linear infinite;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .topbar {
                padding: 0 var(--spacing-lg);
            }
            
            .content-area {
                padding: var(--spacing-lg);
            }
            
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: var(--spacing-md);
            }
            
            .card {
                padding: var(--spacing-xl);
                margin: var(--spacing-lg) 0;
            }
            
            .modal-content {
                width: 95%;
                padding: var(--spacing-xl);
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                font-size: 0.75rem;
            }
            
            .data-table th,
            .data-table td {
                padding: var(--spacing-sm);
            }
        }
        
        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            }
        }
        
        /* Print styles */
        @media print {
            .sidebar,
            .topbar,
            .modal-overlay,
            .notification-container,
            .sync-queue {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">🚀 RetroAvia</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Inizializzazione sistema enterprise...</div>
    </div>

    <!-- App Container -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">🚀 RetroAvia</div>
                <div class="sidebar-subtitle">Enterprise Edition v4.2</div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Dashboard</div>
                    <a href="#" class="nav-item active" data-page="dashboard">
                        <span class="nav-item-icon">📊</span>
                        <span class="nav-item-text">Panoramica</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Gestione</div>
                    <a href="#" class="nav-item" data-page="orders">
                        <span class="nav-item-icon">📋</span>
                        <span class="nav-item-text">Ordini</span>
                        <span class="nav-item-badge" id="ordersCount">0</span>
                    </a>
                    <a href="#" class="nav-item" data-page="transactions">
                        <span class="nav-item-icon">💰</span>
                        <span class="nav-item-text">Transazioni</span>
                    </a>
                    <a href="#" class="nav-item" data-page="clients">
                        <span class="nav-item-icon">👤</span>
                        <span class="nav-item-text">Clienti</span>
                        <span class="nav-item-badge" id="clientsCount">0</span>
                    </a>
                    <a href="#" class="nav-item" data-page="inventory">
                        <span class="nav-item-icon">📦</span>
                        <span class="nav-item-text">Inventario</span>
                        <span class="nav-item-badge" id="lowStockCount">0</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Analisi</div>
                    <a href="#" class="nav-item" data-page="calendar">
                        <span class="nav-item-icon">📅</span>
                        <span class="nav-item-text">Calendario</span>
                    </a>
                    <a href="#" class="nav-item" data-page="analytics">
                        <span class="nav-item-icon">📈</span>
                        <span class="nav-item-text">Analytics</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Top Bar -->
            <header class="topbar">
                <div class="topbar-left">
                    <button class="sidebar-toggle" id="sidebarToggle">☰</button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                
                <div class="topbar-right">
                    <div class="connection-status" id="connectionStatus">
                        <div class="status-indicator" id="statusIndicator"></div>
                        <span id="statusText">Connessione...</span>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Page -->
                <div class="page active" id="dashboard">
                    <!-- Business Overview -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>💼</span>
                                Panoramica Business
                            </h2>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-info" onclick="App.sync()">
                                    <span>🔄</span> Sincronizza
                                </button>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card revenue">
                                <div class="stat-header">
                                    <span class="stat-icon">💰</span>
                                    <span class="stat-trend" id="revenueTrend">+0%</span>
                                </div>
                                <div class="stat-value" id="totalRevenue">€0</div>
                                <div class="stat-label">Entrate Totali</div>
                            </div>
                            
                            <div class="stat-card expense">
                                <div class="stat-header">
                                    <span class="stat-icon">💸</span>
                                    <span class="stat-trend" id="expenseTrend">+0%</span>
                                </div>
                                <div class="stat-value" id="totalExpenses">€0</div>
                                <div class="stat-label">Spese Totali</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-header">
                                    <span class="stat-icon">📈</span>
                                    <span class="stat-trend" id="profitTrend">+0%</span>
                                </div>
                                <div class="stat-value" id="netProfit">€0</div>
                                <div class="stat-label">Profitto Netto</div>
                            </div>
                            
                            <div class="stat-card orders">
                                <div class="stat-header">
                                    <span class="stat-icon">📋</span>
                                    <span class="stat-trend" id="ordersTrend">+0%</span>
                                </div>
                                <div class="stat-value" id="totalOrders">0</div>
                                <div class="stat-label">Ordini Totali</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Insights -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>🧠</span>
                                Spider-AI Intelligence
                            </h2>
                            <div class="card-actions">
                                <button class="btn btn-sm" onclick="App.AI.analyze()">
                                    <span>🧠</span> Analizza
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="App.AI.predict()">
                                    <span>🔮</span> Predizioni
                                </button>
                            </div>
                        </div>
                        
                        <div id="aiInsights" class="ai-insights">
                            <p>• Sistema enterprise completamente operativo</p>
                            <p>• Analisi intelligente dei dati abilitata</p>
                            <p>• Pronto per l'analisi avanzata del business</p>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>⚡</span>
                                Azioni Rapide
                            </h2>
                        </div>
                        
                        <div class="grid grid-auto">
                            <button class="btn btn-success" onclick="App.QuickActions.sale()">
                                <span>💰</span> Vendita Rapida
                            </button>
                            <button class="btn btn-warning" onclick="App.QuickActions.order()">
                                <span>📋</span> Nuovo Ordine
                            </button>
                            <button class="btn btn-info" onclick="App.QuickActions.client()">
                                <span>👤</span> Cliente Rapido
                            </button>
                            <button class="btn" onclick="App.QuickActions.inventory()">
                                <span>📦</span> Componente
                            </button>
                            <button class="btn btn-secondary" onclick="App.DataManager.export()">
                                <span>💾</span> Esporta
                            </button>
                            <button class="btn btn-secondary" onclick="App.UI.showImportModal()">
                                <span>📂</span> Importa
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Orders Page -->
                <div class="page" id="orders">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>📋</span>
                                Gestione Ordini
                            </h2>
                            <div class="card-actions">
                                <button class="btn btn-success" onclick="App.Orders.add()">
                                    <span>📋</span> Nuovo Ordine
                                </button>
                            </div>
                        </div>
                        
                        <div class="search-container">
                            <div class="search-icon">🔍</div>
                            <input type="text" class="search-input" id="orderSearch" placeholder="Cerca ordini..." />
                        </div>
                        
                        <div id="ordersContainer">
                            <!-- Orders will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Transactions Page -->
                <div class="page" id="transactions">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>💰</span>
                                Gestione Transazioni
                            </h2>
                            <div class="card-actions">
                                <button class="btn btn-success" onclick="App.Transactions.add('revenue')">
                                    <span>💰</span> Entrata
                                </button>
                                <button class="btn btn-error" onclick="App.Transactions.add('expense')">
                                    <span>💸</span> Spesa
                                </button>
                            </div>
                        </div>
                        
                        <div class="search-container">
                            <div class="search-icon">🔍</div>
                            <input type="text" class="search-input" id="transactionSearch" placeholder="Cerca transazioni..." />
                        </div>
                        
                        <div id="transactionsContainer">
                            <!-- Transactions will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Clients Page -->
                <div class="page" id="clients">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>👤</span>
                                Gestione Clienti
                            </h2>
                            <div class="card-actions">
                                <button class="btn btn-success" onclick="App.Clients.add()">
                                    <span>👤</span> Nuovo Cliente
                                </button>
                            </div>
                        </div>
                        
                        <div class="search-container">
                            <div class="search-icon">🔍</div>
                            <input type="text" class="search-input" id="clientSearch" placeholder="Cerca clienti..." />
                        </div>
                        
                        <div id="clientsContainer">
                            <!-- Clients will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Inventory Page -->
                <div class="page" id="inventory">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>📦</span>
                                Gestione Inventario
                            </h2>
                            <div class="card-actions">
                                <button class="btn btn-success" onclick="App.Inventory.add()">
                                    <span>📦</span> Nuovo Componente
                                </button>
                                <button class="btn btn-warning" onclick="App.Inventory.checkLowStock()">
                                    <span>⚠️</span> Verifica Scorte
                                </button>
                            </div>
                        </div>
                        
                        <div class="search-container">
                            <div class="search-icon">🔍</div>
                            <input type="text" class="search-input" id="inventorySearch" placeholder="Cerca componenti..." />
                        </div>
                        
                        <div id="inventoryContainer">
                            <!-- Inventory will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Calendar Page -->
                <div class="page" id="calendar">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>📅</span>
                                Calendario Business
                            </h2>
                        </div>
                        
                        <div id="calendarContainer">
                            <!-- Calendar will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Analytics Page -->
                <div class="page" id="analytics">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>📈</span>
                                Analytics Avanzate
                            </h2>
                        </div>
                        
                        <div class="grid grid-2">
                            <div class="card">
                                <h3>📊 Trend Mensili</h3>
                                <div id="monthlyTrends"></div>
                            </div>
                            <div class="card">
                                <h3>🏆 Top Clienti</h3>
                                <div id="topClients"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-2">
                            <div class="card">
                                <h3>📈 Performance Mensile</h3>
                                <div id="monthlyPerformance"></div>
                            </div>
                            <div class="card">
                                <h3>🎯 KPI Dashboard</h3>
                                <div id="kpiDashboard"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Modal Title</h3>
                <button class="modal-close" onclick="App.UI.closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Sync Queue -->
    <div class="sync-queue" id="syncQueue">
        <div class="loading"></div>
        <span id="syncQueueText">Sincronizzazione in corso...</span>
    </div>

    <script>
        // ===== ENTERPRISE APPLICATION ARCHITECTURE =====
        
        class RetroAviaApp {
            constructor() {
                this.version = '4.2.0';
                this.state = new AppState();
                this.supabase = null;
                this.initialized = false;
                
                // Initialize all modules
                this.DataManager = new DataManager(this);
                this.UI = new UIManager(this);
                this.Sync = new SyncManager(this);
                this.Analytics = new AnalyticsManager(this);
                this.AI = new AIManager(this);
                this.Calendar = new CalendarManager(this);
                this.Validation = new ValidationManager(this);
                this.Performance = new PerformanceManager(this);
                
                // Business modules
                this.Orders = new OrdersManager(this);
                this.Transactions = new TransactionsManager(this);
                this.Clients = new ClientsManager(this);
                this.Inventory = new InventoryManager(this);
                this.QuickActions = new QuickActionsManager(this);
                
                this.initializeApp();
            }
            
            async initializeApp() {
                try {
                    console.log('🚀 RetroAvia Enterprise v4.2 - Initializing...');
                    
                    // Show loading screen
                    this.UI.showLoadingScreen();
                    
                    // Initialize Supabase
                    await this.initializeSupabase();
                    
                    // Load data
                    await this.DataManager.loadFromLocalStorage();
                    this.Validation.validateDataIntegrity();
                    
                    // Initialize UI
                    this.UI.initialize();
                    this.setupEventListeners();
                    
                    // Update dashboard
                    this.updateDashboard();
                    
                    // Try to sync
                    if (this.state.connected) {
                        setTimeout(() => this.sync(), 1000);
                    }
                    
                    // Hide loading and show app
                    this.UI.hideLoadingScreen();
                    
                    this.initialized = true;
                    console.log('✅ RetroAvia Enterprise initialized successfully');
                    
                    this.UI.showNotification(
                        'Sistema Operativo',
                        'RetroAvia Enterprise v4.2 è pronto all\'uso',
                        'success'
                    );
                    
                } catch (error) {
                    console.error('❌ Initialization failed:', error);
                    this.UI.showNotification(
                        'Errore Inizializzazione',
                        'Si è verificato un errore. Ricarica la pagina.',
                        'error'
                    );
                }
            }
            
            async initializeSupabase() {
                try {
                    const supabaseUrl = 'https://lzcphhnakmmimoglknon.supabase.co';
                    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6Y3BoaG5ha21taW1vZ2xrbm9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MDQxMTgsImV4cCI6MjA3MzE4MDExOH0.2hACcRIDxd9GbSq4_eq2_Stpn8yWyLf7YYY1xSzPTMU';
                    
                    this.supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    
                    // Test connection
                    const { data, error } = await this.supabase
                        .from('transactions')
                        .select('id', { count: 'exact', head: true })
                        .limit(1);
                    
                    if (error) throw error;
                    
                    this.state.connected = true;
                    this.UI.updateConnectionStatus('connected', 'Connesso');
                    
                    return true;
                } catch (error) {
                    console.warn('Supabase connection failed:', error);
                    this.state.connected = false;
                    this.UI.updateConnectionStatus('disconnected', 'Offline');
                    return false;
                }
            }
            
            setupEventListeners() {
                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = item.dataset.page;
                        if (page) this.navigateTo(page);
                    });
                });
                
                // Sidebar toggle
                const sidebarToggle = document.getElementById('sidebarToggle');
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                
                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', () => {
                        sidebar.classList.toggle('open');
                        mainContent.classList.toggle('expanded');
                    });
                }
                
                // Modal close on overlay click
                const modalOverlay = document.getElementById('modalOverlay');
                if (modalOverlay) {
                    modalOverlay.addEventListener('click', (e) => {
                        if (e.target === modalOverlay) {
                            this.UI.closeModal();
                        }
                    });
                }
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    this.handleKeyboardShortcuts(e);
                });
                
                // Network events
                window.addEventListener('online', () => {
                    this.state.isOnline = true;
                    this.initializeSupabase();
                    if (this.state.syncQueue.length > 0) {
                        setTimeout(() => this.Sync.processSyncQueue(), 1000);
                    }
                });
                
                window.addEventListener('offline', () => {
                    this.state.isOnline = false;
                    this.UI.updateConnectionStatus('disconnected', 'Offline');
                });
                
                // Before unload warning
                window.addEventListener('beforeunload', (e) => {
                    if (this.state.syncQueue.length > 0) {
                        e.preventDefault();
                        e.returnValue = 'Ci sono dati non sincronizzati. Sei sicuro di voler uscire?';
                    }
                });
            }
            
            handleKeyboardShortcuts(e) {
                // Skip if in input field
                if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
                    return;
                }
                
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            this.sync();
                            break;
                        case 'e':
                            e.preventDefault();
                            this.DataManager.export();
                            break;
                        case 'n':
                            e.preventDefault();
                            this.handleQuickAdd();
                            break;
                    }
                }
                
                // Escape key
                if (e.key === 'Escape') {
                    this.UI.closeModal();
                }
                
                // Number keys for navigation
                if (e.key >= '1' && e.key <= '7' && !e.ctrlKey && !e.metaKey) {
                    const pages = ['dashboard', 'orders', 'transactions', 'clients', 'inventory', 'calendar', 'analytics'];
                    const pageIndex = parseInt(e.key) - 1;
                    if (pageIndex < pages.length) {
                        this.navigateTo(pages[pageIndex]);
                    }
                }
            }
            
            handleQuickAdd() {
                const currentPage = this.state.currentPage;
                switch (currentPage) {
                    case 'orders': this.Orders.add(); break;
                    case 'transactions': this.QuickActions.sale(); break;
                    case 'clients': this.Clients.add(); break;
                    case 'inventory': this.Inventory.add(); break;
                }
            }
            
            navigateTo(page) {
                this.state.currentPage = page;
                
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const activeNavItem = document.querySelector(`[data-page="${page}"]`);
                if (activeNavItem) {
                    activeNavItem.classList.add('active');
                }
                
                // Update page title
                const titles = {
                    dashboard: 'Dashboard',
                    orders: 'Ordini',
                    transactions: 'Transazioni',
                    clients: 'Clienti',
                    inventory: 'Inventario',
                    calendar: 'Calendario',
                    analytics: 'Analytics'
                };
                
                const pageTitle = document.getElementById('pageTitle');
                if (pageTitle) {
                    pageTitle.textContent = titles[page] || 'RetroAvia';
                }
                
                // Show/hide pages
                document.querySelectorAll('.page').forEach(p => {
                    p.classList.remove('active');
                });
                
                const targetPage = document.getElementById(page);
                if (targetPage) {
                    targetPage.classList.add('active');
                }
                
                // Load page content
                this.loadPageContent(page);
                
                // Update sidebar badge counts
                this.updateSidebarBadges();
            }
            
            loadPageContent(page) {
                switch (page) {
                    case 'dashboard':
                        this.updateDashboard();
                        break;
                    case 'orders':
                        this.Orders.loadPage();
                        break;
                    case 'transactions':
                        this.Transactions.loadPage();
                        break;
                    case 'clients':
                        this.Clients.loadPage();
                        break;
                    case 'inventory':
                        this.Inventory.loadPage();
                        break;
                    case 'calendar':
                        this.Calendar.loadPage();
                        break;
                    case 'analytics':
                        this.Analytics.loadPage();
                        break;
                }
            }
            
            updateDashboard() {
                this.updateStats();
                this.updateSidebarBadges();
            }
            
            updateStats() {
                const revenue = this.Analytics.getTotalRevenue();
                const expenses = this.Analytics.getTotalExpenses();
                const profit = revenue - expenses;
                const orders = this.state.data.orders.length;
                
                // Update stat values
                this.UI.updateElement('totalRevenue', this.formatCurrency(revenue));
                this.UI.updateElement('totalExpenses', this.formatCurrency(expenses));
                this.UI.updateElement('netProfit', this.formatCurrency(profit));
                this.UI.updateElement('totalOrders', orders);
                
                // Update trends
                const trends = this.Analytics.calculateTrends();
                this.UI.updateElement('revenueTrend', this.formatTrend(trends.revenue));
                this.UI.updateElement('expenseTrend', this.formatTrend(trends.expenses));
                this.UI.updateElement('profitTrend', this.formatTrend(trends.profit));
                this.UI.updateElement('ordersTrend', this.formatTrend(trends.orders));
            }
            
            updateSidebarBadges() {
                const activeOrders = this.state.data.orders.filter(o => 
                    o.status !== 'completed' && o.status !== 'cancelled'
                ).length;
                
                const lowStockItems = this.state.data.inventory.filter(item => 
                    item.quantity <= (item.threshold || 5)
                ).length;
                
                this.UI.updateElement('ordersCount', activeOrders);
                this.UI.updateElement('clientsCount', this.state.data.clients.length);
                this.UI.updateElement('lowStockCount', lowStockItems);
            }
            
            async sync() {
                try {
                    this.UI.updateConnectionStatus('syncing', 'Sincronizzazione...');
                    
                    if (!this.state.connected) {
                        const connected = await this.initializeSupabase();
                        if (!connected) {
                            throw new Error('Connessione non disponibile');
                        }
                    }
                    
                    await this.Sync.syncData();
                    this.updateDashboard();
                    this.loadPageContent(this.state.currentPage);
                    
                } catch (error) {
                    console.error('Sync error:', error);
                    this.UI.showNotification(
                        'Errore Sincronizzazione',
                        error.message,
                        'error'
                    );
                }
            }
            
            // Utility methods
            formatCurrency(amount) {
                return new Intl.NumberFormat('it-IT', {
                    style: 'currency',
                    currency: 'EUR'
                }).format(parseFloat(amount || 0));
            }
            
            formatDate(date = new Date()) {
                if (typeof date === 'string') date = new Date(date);
                return date.toISOString().split('T')[0];
            }
            
            formatDateTime(date = new Date()) {
                if (typeof date === 'string') date = new Date(date);
                return date.toISOString();
            }
            
            formatTrend(value) {
                if (value > 0) return `+${value.toFixed(1)}%`;
                if (value < 0) return `${value.toFixed(1)}%`;
                return '0%';
            }
            
            generateId() {
                return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
        }
        
        // ===== APPLICATION STATE MANAGEMENT =====
        
        class AppState {
            constructor() {
                this.data = {
                    orders: [],
                    transactions: [],
                    clients: [],
                    inventory: []
                };
                
                this.ui = {
                    currentPage: 'dashboard',
                    editingId: null,
                    searchFilters: {},
                    calendarDate: new Date()
                };
                
                this.sync = {
                    connected: false,
                    isOnline: navigator.onLine,
                    syncQueue: [],
                    lastSync: null
                };
            }
            
            get currentPage() { return this.ui.currentPage; }
            set currentPage(page) { this.ui.currentPage = page; }
            
            get editingId() { return this.ui.editingId; }
            set editingId(id) { this.ui.editingId = id; }
            
            get connected() { return this.sync.connected; }
            set connected(status) { this.sync.connected = status; }
            
            get isOnline() { return this.sync.isOnline; }
            set isOnline(status) { this.sync.isOnline = status; }
            
            get syncQueue() { return this.sync.syncQueue; }
            
            addToSyncQueue(operation) {
                this.sync.syncQueue.push({
                    ...operation,
                    timestamp: Date.now()
                });
            }
            
            clearSyncQueue() {
                this.sync.syncQueue = [];
            }
        }
        
        // ===== DATA MANAGEMENT =====
        
        class DataManager {
            constructor(app) {
                this.app = app;
                this.storageKey = 'retroavia_enterprise_data';
            }
            
            async loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem(this.storageKey);
                    if (saved) {
                        const data = JSON.parse(saved);
                        
                        this.app.state.data.orders = Array.isArray(data.orders) ? data.orders : [];
                        this.app.state.data.transactions = Array.isArray(data.transactions) ? data.transactions : [];
                        this.app.state.data.clients = Array.isArray(data.clients) ? data.clients : [];
                        this.app.state.data.inventory = Array.isArray(data.inventory) ? data.inventory : [];
                        
                        console.log('📥 Data loaded from localStorage:', {
                            orders: this.app.state.data.orders.length,
                            transactions: this.app.state.data.transactions.length,
                            clients: this.app.state.data.clients.length,
                            inventory: this.app.state.data.inventory.length
                        });
                        
                        this.updateClientTotalSpent();
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('❌ LocalStorage load failed:', error);
                    return false;
                }
            }
            
            saveToLocalStorage() {
                try {
                    const dataToSave = {
                        ...this.app.state.data,
                        version: this.app.version,
                        lastSaved: new Date().toISOString()
                    };
                    
                    localStorage.setItem(this.storageKey, JSON.stringify(dataToSave));
                    console.log('💾 Data saved to localStorage');
                    return true;
                } catch (error) {
                    console.error('❌ LocalStorage save failed:', error);
                    this.app.UI.showNotification(
                        'Errore Salvataggio',
                        'Impossibile salvare localmente',
                        'error'
                    );
                    return false;
                }
            }
            
            updateClientTotalSpent() {
                this.app.state.data.clients.forEach(client => {
                    const totalSpent = this.app.state.data.transactions
                        .filter(t => t.type === 'revenue' && t.client === client.client_name)
                        .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                    client.total_spent = totalSpent;
                });
            }
            
            export() {
                try {
                    const backup = {
                        version: this.app.version,
                        timestamp: new Date().toISOString(),
                        data: this.app.state.data,
                        meta: {
                            totalTransactions: this.app.state.data.transactions.length,
                            totalClients: this.app.state.data.clients.length,
                            totalInventoryItems: this.app.state.data.inventory.length,
                            totalOrders: this.app.state.data.orders.length,
                            exportedBy: 'RetroAvia Enterprise v4.2'
                        }
                    };
                    
                    const dataStr = JSON.stringify(backup, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `retroavia_backup_${this.app.formatDate().replace(/-/g, '')}_${Date.now()}.json`;
                    link.click();
                    
                    setTimeout(() => URL.revokeObjectURL(link.href), 100);
                    
                    this.app.UI.showNotification(
                        'Backup Esportato',
                        'File salvato con successo',
                        'success'
                    );
                    
                } catch (error) {
                    console.error('Export error:', error);
                    this.app.UI.showNotification(
                        'Errore Esportazione',
                        'Impossibile creare il backup',
                        'error'
                    );
                }
            }
            
            async import(file) {
                try {
                    const text = await file.text();
                    const backup = JSON.parse(text);
                    
                    if (!backup.data || !backup.version) {
                        throw new Error('File backup non valido');
                    }
                    
                    // Import data
                    this.app.state.data.orders = Array.isArray(backup.data.orders) ? backup.data.orders : [];
                    this.app.state.data.transactions = Array.isArray(backup.data.transactions) ? backup.data.transactions : [];
                    this.app.state.data.clients = Array.isArray(backup.data.clients) ? backup.data.clients : [];
                    this.app.state.data.inventory = Array.isArray(backup.data.inventory) ? backup.data.inventory : [];
                    
                    // Save and update
                    this.saveToLocalStorage();
                    this.updateClientTotalSpent();
                    
                    // Clear sync queue and refresh
                    this.app.state.clearSyncQueue();
                    this.app.updateDashboard();
                    this.app.loadPageContent(this.app.state.currentPage);
                    
                    this.app.UI.showNotification(
                        'Backup Importato',
                        'Dati caricati con successo',
                        'success'
                    );
                    
                    return true;
                } catch (error) {
                    console.error('Import error:', error);
                    this.app.UI.showNotification(
                        'Errore Importazione',
                        error.message,
                        'error'
                    );
                    return false;
                }
            }
        }
        
        // ===== UI MANAGEMENT =====
        
        class UIManager {
            constructor(app) {
                this.app = app;
            }
            
            initialize() {
                this.setupSearchHandlers();
            }
            
            showLoadingScreen() {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.remove('hidden');
                }
            }
            
            hideLoadingScreen() {
                const loadingScreen = document.getElementById('loadingScreen');
                const appContainer = document.getElementById('appContainer');
                
                if (loadingScreen && appContainer) {
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                        appContainer.style.display = 'flex';
                    }, 500);
                }
            }
            
            updateConnectionStatus(status, text) {
                this.app.state.connected = (status === 'connected');
                
                const statusEl = document.getElementById('connectionStatus');
                const indicatorEl = document.getElementById('statusIndicator');
                const textEl = document.getElementById('statusText');
                
                if (statusEl && indicatorEl && textEl) {
                    statusEl.className = `connection-status ${status}`;
                    indicatorEl.className = `status-indicator ${status}`;
                    textEl.textContent = text || status;
                }
            }
            
            showModal(title, content) {
                const modalOverlay = document.getElementById('modalOverlay');
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                
                if (modalOverlay && modalTitle && modalBody) {
                    modalTitle.textContent = title;
                    modalBody.innerHTML = content;
                    modalOverlay.classList.add('active');
                    
                    // Focus management
                    setTimeout(() => {
                        const firstInput = modalBody.querySelector('input, select, textarea, button');
                        if (firstInput) firstInput.focus();
                    }, 100);
                }
            }
            
            closeModal() {
                const modalOverlay = document.getElementById('modalOverlay');
                if (modalOverlay) {
                    modalOverlay.classList.remove('active');
                    this.app.state.editingId = null;
                }
            }
            
            showNotification(title, message, type = 'info', duration = 4000) {
                const container = document.getElementById('notificationContainer');
                if (!container) return;
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const iconMap = {
                    success: '✅',
                    error: '❌',
                    warning: '⚠️',
                    info: 'ℹ️'
                };
                
                notification.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-title">${iconMap[type]} ${title}</span>
                        <button class="notification-dismiss">&times;</button>
                    </div>
                    <div class="notification-message">${message}</div>
                `;
                
                container.appendChild(notification);
                
                // Show animation
                setTimeout(() => notification.classList.add('show'), 100);
                
                // Setup dismiss button
                const dismissBtn = notification.querySelector('.notification-dismiss');
                if (dismissBtn) {
                    dismissBtn.addEventListener('click', () => {
                        this.removeNotification(notification);
                    });
                }
                
                // Auto remove
                setTimeout(() => {
                    this.removeNotification(notification);
                }, duration);
            }
            
            removeNotification(notification) {
                if (notification && notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }
            
            updateElement(id, content) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = content;
                }
            }
            
            showSyncQueue(text) {
                const queueEl = document.getElementById('syncQueue');
                const textEl = document.getElementById('syncQueueText');
                
                if (queueEl && textEl) {
                    textEl.textContent = text;
                    queueEl.classList.add('show');
                }
            }
            
            hideSyncQueue() {
                const queueEl = document.getElementById('syncQueue');
                if (queueEl) {
                    queueEl.classList.remove('show');
                }
            }
            
            showImportModal() {
                const content = `
                    <div class="form-group">
                        <label class="form-label required">Seleziona File Backup (.json)</label>
                        <input type="file" class="form-input" id="backupFile" accept=".json" required>
                        <div class="form-help">Supportati solo file JSON esportati da RetroAvia Enterprise</div>
                    </div>
                    <div id="filePreview" style="display: none; margin: var(--spacing-lg) 0; padding: var(--spacing-lg); background: var(--surface); border-radius: var(--border-radius-lg);">
                        <!-- File preview will be shown here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-warning" onclick="App.processImportFile()" id="importBtn" disabled>
                            📂 Importa Dati
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="App.UI.closeModal()">
                            ❌ Annulla
                        </button>
                    </div>
                `;
                
                this.showModal('📂 Importa Backup', content);
                
                setTimeout(() => {
                    const fileInput = document.getElementById('backupFile');
                    if (fileInput) {
                        fileInput.addEventListener('change', this.previewImportFile.bind(this));
                    }
                }, 100);
            }
            
            previewImportFile(event) {
                const file = event.target.files[0];
                const previewDiv = document.getElementById('filePreview');
                const importBtn = document.getElementById('importBtn');

                if (!file) {
                    previewDiv.style.display = 'none';
                    importBtn.disabled = true;
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (!backup.data || !backup.version) {
                            throw new Error('File backup non valido');
                        }

                        const data = backup.data;
                        
                        previewDiv.innerHTML = `
                            <h4 style="color: var(--success-light); margin-bottom: var(--spacing-lg);">✅ File Valido</h4>
                            <div class="grid grid-4" style="font-size: 0.875rem;">
                                <div><strong>Versione:</strong> ${backup.version}</div>
                                <div><strong>Data:</strong> ${new Date(backup.timestamp).toLocaleDateString('it-IT')}</div>
                                <div><strong>Ordini:</strong> ${(data.orders || []).length}</div>
                                <div><strong>Transazioni:</strong> ${(data.transactions || []).length}</div>
                                <div><strong>Clienti:</strong> ${(data.clients || []).length}</div>
                                <div><strong>Inventario:</strong> ${(data.inventory || []).length}</div>
                            </div>
                        `;
                        previewDiv.style.display = 'block';
                        importBtn.disabled = false;
                        
                        window.backupToImport = backup;

                    } catch (error) {
                        previewDiv.innerHTML = `
                            <h4 style="color: var(--error-light); margin-bottom: var(--spacing-sm);">❌ File Non Valido</h4>
                            <p style="color: var(--text-muted);">Errore: ${error.message}</p>
                        `;
                        previewDiv.style.display = 'block';
                        importBtn.disabled = true;
                        window.backupToImport = null;
                    }
                };
                reader.readAsText(file);
            }
            
            setupSearchHandlers() {
                const searchInputs = ['orderSearch', 'transactionSearch', 'clientSearch', 'inventorySearch'];
                
                searchInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', this.debounce((e) => {
                            const query = e.target.value.toLowerCase().trim();
                            this.handleSearch(inputId, query);
                        }, 300));
                    }
                });
            }
            
            handleSearch(inputId, query) {
                const pageMap = {
                    orderSearch: 'orders',
                    transactionSearch: 'transactions',
                    clientSearch: 'clients',
                    inventorySearch: 'inventory'
                };
                
                const page = pageMap[inputId];
                if (page && this.app[this.capitalize(page)]) {
                    this.app[this.capitalize(page)].search(query);
                }
            }
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            capitalize(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }
        }
        
        // ===== SYNC MANAGEMENT =====
        
        class SyncManager {
            constructor(app) {
                this.app = app;
                this.retryAttempts = 0;
                this.maxRetryAttempts = 3;
            }
            
            async syncData() {
                try {
                    this.app.UI.showNotification('Sincronizzazione', 'Avviata sincronizzazione dati', 'info');
                    
                    // Process sync queue first
                    await this.processSyncQueue();
                    
                    // Load fresh data from server
                    const results = await Promise.allSettled([
                        this.loadFromSupabase('orders'),
                        this.loadFromSupabase('transactions'),
                        this.loadFromSupabase('clients'),
                        this.loadFromSupabase('inventory')
                    ]);
                    
                    // Update data
                    const [orders, transactions, clients, inventory] = results;
                    
                    if (orders.status === 'fulfilled') this.app.state.data.orders = orders.value;
                    if (transactions.status === 'fulfilled') this.app.state.data.transactions = transactions.value;
                    if (clients.status === 'fulfilled') this.app.state.data.clients = clients.value;
                    if (inventory.status === 'fulfilled') this.app.state.data.inventory = inventory.value;
                    
                    // Save locally
                    this.app.DataManager.saveToLocalStorage();
                    this.app.DataManager.updateClientTotalSpent();
                    
                    // Update sync timestamp
                    this.app.state.sync.lastSync = new Date().toISOString();
                    
                    const failures = results.filter(r => r.status === 'rejected');
                    if (failures.length > 0) {
                        this.app.UI.showNotification(
                            'Sincronizzazione Parziale',
                            `${failures.length} errori durante la sincronizzazione`,
                            'warning'
                        );
                    } else {
                        this.app.UI.showNotification(
                            'Sincronizzazione Completata',
                            'Tutti i dati sono aggiornati',
                            'success'
                        );
                    }
                    
                    this.app.UI.updateConnectionStatus('connected', 'Connesso');
                    
                } catch (error) {
                    console.error('Sync error:', error);
                    this.app.UI.updateConnectionStatus('disconnected', 'Errore sync');
                    throw error;
                }
            }
            
            async processSyncQueue() {
                const queue = [...this.app.state.syncQueue];
                if (queue.length === 0) {
                    this.app.UI.hideSyncQueue();
                    return;
                }
                
                this.app.UI.showSyncQueue(`Sincronizzando ${queue.length} operazioni...`);
                
                let successCount = 0;
                let errorCount = 0;
                
                // Clear queue optimistically
                this.app.state.clearSyncQueue();
                
                for (const operation of queue) {
                    try {
                        if (operation.action === 'upsert') {
                            await this.saveToSupabase(operation.table, operation.data);
                        } else if (operation.action === 'delete') {
                            await this.deleteFromSupabase(operation.table, operation.id);
                        }
                        successCount++;
                    } catch (error) {
                        console.error('Sync queue operation failed:', error);
                        this.app.state.addToSyncQueue(operation);
                        errorCount++;
                    }
                }
                
                if (errorCount > 0) {
                    this.app.UI.showSyncQueue(`${errorCount} operazioni in attesa`);
                } else {
                    this.app.UI.hideSyncQueue();
                }
                
                if (successCount > 0) {
                    console.log(`✅ Sync completed: ${successCount} successes, ${errorCount} errors`);
                }
            }
            
            async saveToSupabase(table, data) {
                if (!this.app.state.connected) {
                    this.app.state.addToSyncQueue({ action: 'upsert', table, data });
                    throw new Error('Offline - added to queue');
                }
                
                const cleanData = this.app.Validation.cleanAndValidate(table, data);
                
                const { data: result, error } = await this.app.supabase
                    .from(table)
                    .upsert(cleanData, { 
                        onConflict: 'id',
                        ignoreDuplicates: false 
                    })
                    .select();
                
                if (error) {
                    console.error(`Supabase save error for ${table}:`, error);
                    this.app.state.addToSyncQueue({ action: 'upsert', table, data: cleanData });
                    throw error;
                }
                
                return result;
            }
            
            async loadFromSupabase(table) {
                if (!this.app.state.connected) {
                    return [];
                }
                
                const { data, error } = await this.app.supabase
                    .from(table)
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error(`Supabase load error for ${table}:`, error);
                    throw error;
                }
                
                return data || [];
            }
            
            async deleteFromSupabase(table, id) {
                if (!this.app.state.connected) {
                    this.app.state.addToSyncQueue({ action: 'delete', table, id });
                    throw new Error('Offline - added to queue');
                }
                
                const { error } = await this.app.supabase
                    .from(table)
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    console.error(`Supabase delete error for ${table}:`, error);
                    this.app.state.addToSyncQueue({ action: 'delete', table, id });
                    throw error;
                }
                
                return true;
            }
        }
        
        // ===== ANALYTICS MANAGEMENT =====
        
        class AnalyticsManager {
            constructor(app) {
                this.app = app;
            }
            
            getTotalRevenue() {
                return this.app.state.data.transactions
                    .filter(t => t.type === 'revenue')
                    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
            }
            
            getTotalExpenses() {
                return this.app.state.data.transactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
            }
            
            calculateTrends() {
                const currentMonth = new Date();
                const lastMonth = new Date();
                lastMonth.setMonth(lastMonth.getMonth() - 1);
                
                const currentData = this.getMonthlyData(currentMonth);
                const lastData = this.getMonthlyData(lastMonth);
                
                return {
                    revenue: this.calculatePercentageChange(lastData.revenue, currentData.revenue),
                    expenses: this.calculatePercentageChange(lastData.expenses, currentData.expenses),
                    profit: this.calculatePercentageChange(lastData.profit, currentData.profit),
                    orders: this.calculatePercentageChange(lastData.orders, currentData.orders)
                };
            }
            
            getMonthlyData(date) {
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                const revenue = this.app.state.data.transactions
                    .filter(t => t.type === 'revenue' && (t.transaction_date || t.created_at).startsWith(monthKey))
                    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                
                const expenses = this.app.state.data.transactions
                    .filter(t => t.type === 'expense' && (t.transaction_date || t.created_at).startsWith(monthKey))
                    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                
                const orders = this.app.state.data.orders
                    .filter(o => o.created_at.startsWith(monthKey)).length;
                
                return {
                    revenue,
                    expenses,
                    profit: revenue - expenses,
                    orders
                };
            }
            
            calculatePercentageChange(oldValue, newValue) {
                if (oldValue === 0 && newValue === 0) return 0;
                if (oldValue === 0) return 100;
                return ((newValue - oldValue) / oldValue) * 100;
            }
            
            loadPage() {
                this.generateMonthlyTrends();
                this.generateTopClients();
                this.generateMonthlyPerformance();
                this.generateKPIDashboard();
            }
            
            generateMonthlyTrends() {
                const container = document.getElementById('monthlyTrends');
                if (!container) return;
                
                const months = [];
                const revenues = [];
                const expenses = [];
                
                for (let i = 5; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    const data = this.getMonthlyData(date);
                    
                    months.push(date.toLocaleDateString('it-IT', { month: 'short', year: 'numeric' }));
                    revenues.push(data.revenue);
                    expenses.push(data.expenses);
                }
                
                let html = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Mese</th>
                                    <th>Entrate</th>
                                    <th>Spese</th>
                                    <th>Profitto</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                months.forEach((month, index) => {
                    const revenue = revenues[index];
                    const expense = expenses[index];
                    const profit = revenue - expense;
                    
                    html += `
                        <tr>
                            <td>${month}</td>
                            <td style="color: var(--success-light);">${this.app.formatCurrency(revenue)}</td>
                            <td style="color: var(--error-light);">${this.app.formatCurrency(expense)}</td>
                            <td style="color: ${profit >= 0 ? 'var(--success-light)' : 'var(--error-light)'};">${this.app.formatCurrency(profit)}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                </div>
                `;
                
                container.innerHTML = html;
            }
            
            generateTopClients() {
                const container = document.getElementById('topClients');
                if (!container) return;
                
                const topClients = this.app.state.data.clients
                    .filter(client => client.total_spent > 0)
                    .sort((a, b) => (b.total_spent || 0) - (a.total_spent || 0))
                    .slice(0, 5);
                
                if (topClients.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">👤</div>
                            <div class="empty-state-title">Nessun Cliente</div>
                            <div class="empty-state-description">Nessun cliente con acquisti registrati</div>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pos.</th>
                                    <th>Cliente</th>
                                    <th>Totale</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                topClients.forEach((client, index) => {
                    const medals = ['🥇', '🥈', '🥉', '4°', '5°'];
                    
                    html += `
                        <tr>
                            <td>${medals[index]}</td>
                            <td>${client.client_name}</td>
                            <td style="color: var(--success-light); font-weight: bold;">${this.app.formatCurrency(client.total_spent)}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                </div>
                `;
                
                container.innerHTML = html;
            }
            
            generateMonthlyPerformance() {
                const container = document.getElementById('monthlyPerformance');
                if (!container) return;
                
                const currentData = this.getMonthlyData(new Date());
                const lastData = this.getMonthlyData(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000));
                
                const revenueGrowth = this.calculatePercentageChange(lastData.revenue, currentData.revenue);
                const orderGrowth = this.calculatePercentageChange(lastData.orders, currentData.orders);
                
                const html = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${this.app.formatCurrency(currentData.revenue)}</div>
                            <div class="stat-label">Entrate Mese</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${this.app.formatTrend(revenueGrowth)}</div>
                            <div class="stat-label">Crescita Entrate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${currentData.orders}</div>
                            <div class="stat-label">Ordini Mese</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${this.app.formatTrend(orderGrowth)}</div>
                            <div class="stat-label">Crescita Ordini</div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            }
            
            generateKPIDashboard() {
                const container = document.getElementById('kpiDashboard');
                if (!container) return;
                
                const totalRevenue = this.getTotalRevenue();
                const completedOrders = this.app.state.data.orders.filter(o => o.status === 'completed').length;
                const totalOrders = this.app.state.data.orders.length;
                const completionRate = totalOrders > 0 ? (completedOrders / totalOrders * 100) : 0;
                
                const activeClients = new Set(
                    this.app.state.data.transactions
                        .filter(t => {
                            const date = new Date(t.transaction_date || t.created_at);
                            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                            return date >= thirtyDaysAgo;
                        })
                        .map(t => t.client)
                        .filter(client => client)
                ).size;
                
                const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
                const lowStockItems = this.app.state.data.inventory.filter(i => i.quantity <= (i.threshold || 5)).length;
                
                const html = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${completionRate.toFixed(1)}%</div>
                            <div class="stat-label">Tasso Completamento</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${activeClients}</div>
                            <div class="stat-label">Clienti Attivi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${this.app.formatCurrency(avgOrderValue)}</div>
                            <div class="stat-label">Valore Medio Ordine</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${lowStockItems}</div>
                            <div class="stat-label">Scorte Basse</div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            }
        }
        
        // ===== AI MANAGEMENT =====
        
        class AIManager {
            constructor(app) {
                this.app = app;
            }
            
            analyze() {
                const insights = document.getElementById('aiInsights');
                if (!insights) return;
                
                insights.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <div class="loading" style="margin: 0 auto var(--spacing-sm);"></div>
                        <p>Spider-AI sta analizzando i tuoi dati...</p>
                    </div>
                `;
                
                setTimeout(() => {
                    const analysis = this.generateAnalysis();
                    insights.innerHTML = analysis;
                }, 2000);
            }
            
            predict() {
                const insights = document.getElementById('aiInsights');
                if (!insights) return;
                
                insights.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <div class="loading" style="margin: 0 auto var(--spacing-sm);"></div>
                        <p>Spider-AI sta generando predizioni...</p>
                    </div>
                `;
                
                setTimeout(() => {
                    const predictions = this.generatePredictions();
                    insights.innerHTML = predictions;
                }, 2500);
            }
            
            generateAnalysis() {
                const totalRevenue = this.app.Analytics.getTotalRevenue();
                const totalExpenses = this.app.Analytics.getTotalExpenses();
                const profitMargin = totalRevenue > 0 ? ((totalRevenue - totalExpenses) / totalRevenue * 100) : 0;
                
                const pendingOrders = this.app.state.data.orders.filter(o => o.status === 'pending').length;
                const lowStockItems = this.app.state.data.inventory.filter(item => 
                    item.quantity <= (item.threshold || 5)
                ).length;
                
                let suggestions = [];
                
                // Revenue analysis
                if (totalRevenue > 1000) {
                    suggestions.push(`• Eccellente! Hai generato ${this.app.formatCurrency(totalRevenue)} di entrate totali`);
                } else if (totalRevenue > 0) {
                    suggestions.push(`• Buon inizio con ${this.app.formatCurrency(totalRevenue)} di entrate`);
                } else {
                    suggestions.push(`• Inizia a registrare le tue prime vendite per vedere le analisi`);
                }
                
                // Profit margin analysis
                if (profitMargin > 30) {
                    suggestions.push(`• Eccellente margine di profitto del ${profitMargin.toFixed(1)}%`);
                } else if (profitMargin > 10) {
                    suggestions.push(`• Margine di profitto buono (${profitMargin.toFixed(1)}%). Cerca di ottimizzare i costi`);
                } else if (profitMargin > 0) {
                    suggestions.push(`• Margine di profitto basso (${profitMargin.toFixed(1)}%). Riduci le spese`);
                } else if (totalRevenue > 0) {
                    suggestions.push(`• Attenzione: stai operando in perdita. Rivedi la strategia`);
                }
                
                // Orders analysis
                if (pendingOrders > 0) {
                    suggestions.push(`• Hai ${pendingOrders} ordini in sospeso. Prioritizza il completamento`);
                }
                
                // Inventory analysis
                if (lowStockItems > 0) {
                    suggestions.push(`• ⚠️ ${lowStockItems} componenti hanno scorte basse`);
                }
                
                // Client analysis
                const topClients = this.app.state.data.clients
                    .sort((a, b) => (b.total_spent || 0) - (a.total_spent || 0))
                    .slice(0, 3);
                
                if (topClients.length > 0 && topClients[0].total_spent > 0) {
                    suggestions.push(`• Il tuo miglior cliente è ${topClients[0].client_name} con ${this.app.formatCurrency(topClients[0].total_spent)}`);
                }
                
                return suggestions.map(s => `<p>${s}</p>`).join('');
            }
            
            generatePredictions() {
                const currentData = this.app.Analytics.getMonthlyData(new Date());
                const predictions = [];
                
                // Revenue prediction
                if (currentData.revenue > 0) {
                    const projectedRevenue = currentData.revenue * 1.15;
                    predictions.push(`🔮 Proiezione entrate prossimo mese: ${this.app.formatCurrency(projectedRevenue)}`);
                    predictions.push(`📈 Crescita stimata: +15% basata sui trend attuali`);
                }
                
                // Order prediction
                if (currentData.orders > 0) {
                    const projectedOrders = Math.ceil(currentData.orders * 1.1);
                    predictions.push(`📋 Ordini previsti prossimo mese: ${projectedOrders}`);
                }
                
                // Seasonal predictions
                const seasonalTips = [
                    "Gennaio: Ottimo periodo per riparazioni post-feste",
                    "Febbraio: San Valentino - considera offerte speciali",
                    "Marzo: Primavera - tempo di pulizie e manutenzione", 
                    "Aprile: Pasqua - possibili regali tecnologici",
                    "Maggio: Festa della mamma - mercato regali attivo",
                    "Giugno: Lauree e matrimoni - alta domanda",
                    "Luglio: Vacanze estive - rallentamento normale",
                    "Agosto: Ferie - preparati per settembre",
                    "Settembre: Ritorno a scuola/lavoro - boom di richieste",
                    "Ottobre: Halloween - gaming e intrattenimento",
                    "Novembre: Black Friday - massimizza le vendite",
                    "Dicembre: Natale - picco annuale di vendite"
                ];
                
                const currentMonth = new Date().getMonth();
                predictions.push(`🎯 ${seasonalTips[currentMonth]}`);
                
                predictions.push(`🕹️ Trend: Il mercato retrogaming cresce del 20% annuo`);
                predictions.push(`💡 Suggerimento: Investi in componenti rare per Game Boy Color`);
                
                return predictions.map(p => `<p>${p}</p>`).join('');
            }
        }
        
        // ===== CALENDAR MANAGEMENT =====
        
        class CalendarManager {
            constructor(app) {
                this.app = app;
                this.currentDate = new Date();
            }
            
            loadPage() {
                this.render();
            }
            
            render() {
                const container = document.getElementById('calendarContainer');
                if (!container) return;
                
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                // Update title
                const monthNames = [
                    'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                    'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
                ];
                
                container.innerHTML = `
                    <div class="calendar-header">
                        <div class="calendar-title">${monthNames[month]} ${year}</div>
                        <div class="calendar-nav">
                            <button class="btn btn-sm btn-secondary" onclick="App.Calendar.previousMonth()">‹ Precedente</button>
                            <button class="btn btn-sm" onclick="App.Calendar.today()">📅 Oggi</button>
                            <button class="btn btn-sm btn-secondary" onclick="App.Calendar.nextMonth()">Successivo ›</button>
                        </div>
                    </div>
                    <div id="calendarGrid"></div>
                `;
                
                const grid = document.getElementById('calendarGrid');
                
                // Create calendar grid
                grid.innerHTML = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Lun</th>
                                    <th>Mar</th>
                                    <th>Mer</th>
                                    <th>Gio</th>
                                    <th>Ven</th>
                                    <th>Sab</th>
                                    <th>Dom</th>
                                </tr>
                            </thead>
                            <tbody id="calendarBody">
                            </tbody>
                        </table>
                    </div>
                `;
                
                this.renderCalendarDays();
            }
            
            renderCalendarDays() {
                const tbody = document.getElementById('calendarBody');
                if (!tbody) return;
                
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                
                // Adjust first day (Monday = 0)
                let startDay = firstDay.getDay() - 1;
                if (startDay < 0) startDay = 6;
                
                let html = '';
                let dayCount = 1;
                const today = new Date();
                
                // Generate calendar rows
                for (let week = 0; week < 6; week++) {
                    html += '<tr>';
                    
                    for (let day = 0; day < 7; day++) {
                        if ((week === 0 && day < startDay) || dayCount > daysInMonth) {
                            html += '<td></td>';
                        } else {
                            const currentDate = new Date(year, month, dayCount);
                            const dateStr = this.app.formatDate(currentDate);
                            const isToday = currentDate.toDateString() === today.toDateString();
                            
                            // Get events for this day
                            const events = this.getEventsForDate(dateStr);
                            
                            html += `
                                <td style="vertical-align: top; padding: var(--spacing-sm); ${isToday ? 'background: rgba(37, 99, 235, 0.1);' : ''}">
                                    <div style="font-weight: bold; margin-bottom: var(--spacing-xs);">${dayCount}</div>
                                    <div style="font-size: 0.75rem;">
                                        ${events.map(event => `
                                            <div style="background: ${event.color}; color: white; padding: 1px 4px; margin: 1px 0; border-radius: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                ${event.icon} ${event.title}
                                            </div>
                                        `).join('')}
                                    </div>
                                </td>
                            `;
                            dayCount++;
                        }
                    }
                    
                    html += '</tr>';
                    
                    if (dayCount > daysInMonth) break;
                }
                
                tbody.innerHTML = html;
            }
            
            getEventsForDate(dateStr) {
                const events = [];
                
                // Add orders due on this date
                const orders = this.app.state.data.orders.filter(order => {
                    const orderDate = this.app.formatDate(new Date(order.due_date));
                    return orderDate === dateStr;
                });
                
                orders.forEach(order => {
                    events.push({
                        title: order.client_name,
                        icon: '📋',
                        color: order.status === 'completed' ? 'var(--success)' : 
                               order.status === 'cancelled' ? 'var(--error)' : 'var(--warning)'
                    });
                });
                
                // Add transactions on this date
                const transactions = this.app.state.data.transactions.filter(transaction => {
                    const transactionDate = this.app.formatDate(new Date(transaction.transaction_date || transaction.created_at));
                    return transactionDate === dateStr;
                });
                
                transactions.forEach(transaction => {
                    events.push({
                        title: this.app.formatCurrency(transaction.amount),
                        icon: transaction.type === 'revenue' ? '💰' : '💸',
                        color: transaction.type === 'revenue' ? 'var(--success)' : 'var(--error)'
                    });
                });
                
                return events.slice(0, 3); // Limit to 3 events per day
            }
            
            previousMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                this.render();
            }
            
            nextMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                this.render();
            }
            
            today() {
                this.currentDate = new Date();
                this.render();
            }
        }
        
        // ===== VALIDATION MANAGEMENT =====
        
        class ValidationManager {
            constructor(app) {
                this.app = app;
                this.schemas = {
                    orders: {
                        id: 'string',
                        client_name: 'string',
                        client_email: 'string',
                        status: 'string',
                        created_at: 'string',
                        due_date: 'string',
                        specs: 'object'
                    },
                    transactions: {
                        id: 'string',
                        type: 'string',
                        amount: 'number',
                        description: 'string',
                        transaction_date: 'string',
                        client: 'string',
                        created_at: 'string'
                    },
                    clients: {
                        id: 'string',
                        client_name: 'string',
                        client_email: 'string',
                        client_phone: 'string',
                        client_source: 'string',
                        total_spent: 'number',
                        created_at: 'string'
                    },
                    inventory: {
                        id: 'string',
                        item_name: 'string',
                        quantity: 'number',
                        threshold: 'number',
                        price: 'number',
                        supplier: 'string',
                        created_at: 'string'
                    }
                };
            }
            
            validateDataIntegrity() {
                try {
                    // Check for duplicate IDs
                    const allIds = [
                        ...this.app.state.data.orders.map(item => item.id),
                        ...this.app.state.data.transactions.map(item => item.id),
                        ...this.app.state.data.clients.map(item => item.id),
                        ...this.app.state.data.inventory.map(item => item.id)
                    ];
                    
                    const uniqueIds = new Set(allIds);
                    if (allIds.length !== uniqueIds.size) {
                        console.warn('⚠️ Duplicate IDs detected - cleaning up...');
                        this.cleanupDuplicateIds();
                    }
                    
                    console.log('✅ Data integrity check completed');
                    return true;
                } catch (error) {
                    console.error('❌ Data integrity check failed:', error);
                    return false;
                }
            }
            
            cleanupDuplicateIds() {
                const seenIds = new Set();
                
                ['orders', 'transactions', 'clients', 'inventory'].forEach(table => {
                    this.app.state.data[table] = this.app.state.data[table].filter(item => {
                        if (seenIds.has(item.id)) {
                            return false;
                        }
                        seenIds.add(item.id);
                        return true;
                    });
                });
                
                this.app.DataManager.saveToLocalStorage();
                console.log('✅ Duplicate IDs cleaned up');
            }
            
            cleanAndValidate(table, data) {
                const schema = this.schemas[table];
                if (!schema) {
                    throw new Error(`Unknown table: ${table}`);
                }
                
                const cleaned = {};
                
                Object.keys(schema).forEach(field => {
                    let value = data[field];
                    
                    // Handle missing required fields
                    if (value === undefined || value === null) {
                        switch (field) {
                            case 'id':
                                value = this.app.generateId();
                                break;
                            case 'created_at':
                                value = this.app.formatDateTime();
                                break;
                            case 'total_spent':
                                value = 0;
                                break;
                            case 'specs':
                                value = {};
                                break;
                            default:
                                value = '';
                        }
                    }
                    
                    // Type conversion
                    switch (schema[field]) {
                        case 'number':
                            cleaned[field] = parseFloat(value) || 0;
                            break;
                        case 'object':
                            if (typeof value === 'string') {
                                try {
                                    cleaned[field] = JSON.parse(value);
                                } catch {
                                    cleaned[field] = {};
                                }
                            } else {
                                cleaned[field] = value || {};
                            }
                            break;
                        case 'string':
                        default:
                            cleaned[field] = String(value || '');
                    }
                });
                
                // Special date formatting
                if (cleaned.transaction_date) {
                    cleaned.transaction_date = this.app.formatDate(new Date(cleaned.transaction_date));
                }
                if (cleaned.due_date) {
                    cleaned.due_date = this.app.formatDate(new Date(cleaned.due_date));
                }
                
                return cleaned;
            }
        }
        
        // ===== PERFORMANCE MANAGEMENT =====
        
        class PerformanceManager {
            constructor(app) {
                this.app = app;
                this.metrics = {
                    loadTimes: new Map(),
                    renderTimes: new Map(),
                    errorCount: 0
                };
            }
            
            startTimer(operation) {
                return performance.now();
            }
            
            endTimer(operation, startTime) {
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                if (!this.metrics.loadTimes.has(operation)) {
                    this.metrics.loadTimes.set(operation, []);
                }
                
                this.metrics.loadTimes.get(operation).push(duration);
                
                // Keep only last 10 measurements
                const times = this.metrics.loadTimes.get(operation);
                if (times.length > 10) {
                    times.shift();
                }
                
                console.log(`⏱️ ${operation}: ${duration.toFixed(2)}ms`);
                return duration;
            }
            
            logError(error, context = 'Unknown') {
                this.metrics.errorCount++;
                console.error(`❌ Error in ${context}:`, error);
            }
            
            getMetrics() {
                const avgTimes = new Map();
                
                this.metrics.loadTimes.forEach((times, operation) => {
                    const avg = times.reduce((sum, time) => sum + time, 0) / times.length;
                    avgTimes.set(operation, avg);
                });
                
                return {
                    averageLoadTimes: Object.fromEntries(avgTimes),
                    errorCount: this.metrics.errorCount,
                    memoryUsage: this.getMemoryUsage()
                };
            }
            
            getMemoryUsage() {
                if (performance.memory) {
                    return {
                        used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                        total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                        limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
                    };
                }
                return null;
            }
        }
        
        // ===== BUSINESS MANAGERS =====
        
        class OrdersManager {
            constructor(app) {
                this.app = app;
                this.searchQuery = '';
            }
            
            loadPage() {
                const container = document.getElementById('ordersContainer');
                if (!container) return;
                
                const orders = this.getFilteredOrders();
                
                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <div class="empty-state-title">Nessun ordine presente</div>
                            <div class="empty-state-description">Inizia creando il tuo primo ordine</div>
                            <button class="btn btn-success" onclick="App.Orders.add()">
                                📋 Nuovo Ordine
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Descrizione</th>
                                    <th>Stato</th>
                                    <th>Scadenza</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                orders.forEach(order => {
                    const dueDate = new Date(order.due_date);
                    const isOverdue = dueDate < new Date() && order.status !== 'completed';
                    
                    html += `
                        <tr>
                            <td>
                                <strong>${order.client_name}</strong><br>
                                <small style="color: var(--text-muted);">${order.client_email || 'N/A'}</small>
                            </td>
                            <td>${order.specs?.description || 'N/A'}</td>
                            <td>
                                <div class="status-badge status-${order.status}">
                                    ${order.status}
                                </div>
                                ${isOverdue ? '<div style="color: var(--error-light); font-size: 0.75rem; margin-top: 4px;">⚠️ In ritardo</div>' : ''}
                            </td>
                            <td>${dueDate.toLocaleDateString('it-IT')}</td>
                            <td class="actions">
                                <button class="btn btn-sm btn-secondary" onclick="App.Orders.edit('${order.id}')">
                                    ✏️ Modifica
                                </button>
                                <button class="btn btn-sm btn-error" onclick="App.Orders.delete('${order.id}')">
                                    🗑️ Elimina
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.innerHTML = html;
            }
            
            getFilteredOrders() {
                if (!this.searchQuery) {
                    return this.app.state.data.orders;
                }
                
                return this.app.state.data.orders.filter(order =>
                    order.client_name.toLowerCase().includes(this.searchQuery) ||
                    (order.client_email && order.client_email.toLowerCase().includes(this.searchQuery)) ||
                    (order.specs?.description && order.specs.description.toLowerCase().includes(this.searchQuery)) ||
                    order.status.toLowerCase().includes(this.searchQuery)
                );
            }
            
            search(query) {
                this.searchQuery = query.toLowerCase();
                this.loadPage();
            }
            
            add() {
                this.app.QuickActions.order();
            }
            
            edit(id) {
                const order = this.app.state.data.orders.find(o => o.id === id);
                if (!order) return;
                
                this.app.state.editingId = id;
                
                const content = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Nome Cliente</label>
                            <input type="text" class="form-input" id="clientName" value="${order.client_name}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Cliente</label>
                            <input type="email" class="form-input" id="clientEmail" value="${order.client_email || ''}">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label required">Specifiche Ordine</label>
                            <textarea class="form-textarea" id="orderSpecs" required>${order.specs?.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Data Scadenza</label>
                            <input type="date" class="form-input" id="dueDate" value="${this.app.formatDate(new Date(order.due_date))}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Stato</label>
                            <select class="form-select" id="orderStatus" required>
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>In Attesa</option>
                                <option value="in-progress" ${order.status === 'in-progress' ? 'selected' : ''}>In Lavorazione</option>
                                <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completato</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Annullato</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-warning" onclick="App.Orders.save()">
                            💾 Salva Modifiche
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="App.UI.closeModal()">
                            ❌ Annulla
                        </button>
                    </div>
                `;
                
                this.app.UI.showModal('📋 Modifica Ordine', content);
            }
            
            async save() {
                const clientName = document.getElementById('clientName')?.value;
                const clientEmail = document.getElementById('clientEmail')?.value;
                const orderSpecs = document.getElementById('orderSpecs')?.value;
                const dueDate = document.getElementById('dueDate')?.value;
                const orderStatus = document.getElementById('orderStatus')?.value;
                
                if (!clientName || !orderSpecs || !dueDate || !orderStatus) {
                    this.app.UI.showNotification('Errore', 'Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                const orderData = {
                    id: this.app.state.editingId || this.app.generateId(),
                    client_name: clientName,
                    client_email: clientEmail || '',
                    specs: { description: orderSpecs },
                    due_date: dueDate,
                    status: orderStatus,
                    created_at: this.app.state.editingId ? 
                        this.app.state.data.orders.find(o => o.id === this.app.state.editingId)?.created_at :
                        this.app.formatDateTime()
                };
                
                try {
                    // Save locally
                    const index = this.app.state.editingId ? 
                        this.app.state.data.orders.findIndex(o => o.id === this.app.state.editingId) : -1;
                    
                    if (index !== -1) {
                        this.app.state.data.orders[index] = orderData;
                    } else {
                        this.app.state.data.orders.push(orderData);
                    }
                    
                    this.app.DataManager.saveToLocalStorage();
                    
                    // Try to sync
                    try {
                        await this.app.Sync.saveToSupabase('orders', orderData);
                        this.app.UI.showNotification('Successo', 'Ordine salvato e sincronizzato', 'success');
                    } catch (error) {
                        this.app.UI.showNotification('Salvato Localmente', 'Ordine salvato, sincronizzazione in attesa', 'warning');
                    }
                    
                    this.app.UI.closeModal();
                    this.loadPage();
                    this.app.updateDashboard();
                    
                } catch (error) {
                    this.app.UI.showNotification('Errore', 'Impossibile salvare l\'ordine', 'error');
                }
            }
            
            delete(id) {
                const order = this.app.state.data.orders.find(o => o.id === id);
                if (!order) return;
                
                if (confirm(`Sei sicuro di voler eliminare l'ordine di ${order.client_name}?`)) {
                    // Remove locally
                    this.app.state.data.orders = this.app.state.data.orders.filter(o => o.id !== id);
                    this.app.DataManager.saveToLocalStorage();
                    
                    // Add to sync queue
                    this.app.state.addToSyncQueue({ action: 'delete', table: 'orders', id });
                    
                    this.app.UI.showNotification('Eliminato', 'Ordine eliminato con successo', 'success');
                    this.loadPage();
                    this.app.updateDashboard();
                }
            }
        }
        
        class TransactionsManager {
            constructor(app) {
                this.app = app;
                this.searchQuery = '';
            }
            
            loadPage() {
                const container = document.getElementById('transactionsContainer');
                if (!container) return;
                
                const transactions = this.getFilteredTransactions();
                
                if (transactions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">💰</div>
                            <div class="empty-state-title">Nessuna transazione presente</div>
                            <div class="empty-state-description">Inizia registrando la tua prima transazione</div>
                            <div class="grid grid-2" style="max-width: 400px; margin: var(--spacing-xl) auto 0;">
                                <button class="btn btn-success" onclick="App.Transactions.add('revenue')">
                                    💰 Nuova Entrata
                                </button>
                                <button class="btn btn-error" onclick="App.Transactions.add('expense')">
                                    💸 Nuova Spesa
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Importo</th>
                                    <th>Descrizione</th>
                                    <th>Cliente</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                transactions
                    .sort((a, b) => new Date(b.transaction_date || b.created_at) - new Date(a.transaction_date || a.created_at))
                    .forEach(transaction => {
                        const isRevenue = transaction.type === 'revenue';
                        const date = new Date(transaction.transaction_date || transaction.created_at);
                        
                        html += `
                            <tr>
                                <td>${date.toLocaleDateString('it-IT')}</td>
                                <td>
                                    <span style="color: ${isRevenue ? 'var(--success-light)' : 'var(--error-light)'};">
                                        ${isRevenue ? '💰 Entrata' : '💸 Spesa'}
                                    </span>
                                </td>
                                <td>
                                    <strong style="color: ${isRevenue ? 'var(--success-light)' : 'var(--error-light)'};">
                                        ${isRevenue ? '+' : '-'}${this.app.formatCurrency(Math.abs(transaction.amount))}
                                    </strong>
                                </td>
                                <td>${transaction.description}</td>
                                <td>${transaction.client || 'N/A'}</td>
                                <td class="actions">
                                    <button class="btn btn-sm btn-secondary" onclick="App.Transactions.edit('${transaction.id}')">
                                        ✏️ Modifica
                                    </button>
                                    <button class="btn btn-sm btn-error" onclick="App.Transactions.delete('${transaction.id}')">
                                        🗑️ Elimina
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.innerHTML = html;
            }
            
            getFilteredTransactions() {
                if (!this.searchQuery) {
                    return this.app.state.data.transactions;
                }
                
                return this.app.state.data.transactions.filter(transaction =>
                    transaction.description.toLowerCase().includes(this.searchQuery) ||
                    (transaction.client && transaction.client.toLowerCase().includes(this.searchQuery)) ||
                    transaction.type.toLowerCase().includes(this.searchQuery)
                );
            }
            
            search(query) {
                this.searchQuery = query.toLowerCase();
                this.loadPage();
            }
            
            add(type) {
                if (type === 'revenue') {
                    this.app.QuickActions.sale();
                } else {
                    this.showExpenseModal();
                }
            }
            
            showExpenseModal() {
                const content = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Importo Spesa</label>
                            <input type="number" class="form-input" id="expenseAmount" step="0.01" min="0" required placeholder="es. 25.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Descrizione</label>
                            <input type="text" class="form-input" id="expenseDescription" required placeholder="es. Componenti elettronici">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Data</label>
                            <input type="date" class="form-input" id="expenseDate" value="${this.app.formatDate()}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" id="expenseCategory">
                                <option value="">Seleziona categoria...</option>
                                <option value="Componenti">Componenti</option>
                                <option value="Attrezzature">Attrezzature</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Trasporti">Trasporti</option>
                                <option value="Altro">Altro</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-error" onclick="App.Transactions.saveExpense()">
                            💸 Registra Spesa
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="App.UI.closeModal()">
                            ❌ Annulla
                        </button>
                    </div>
                `;
                
                this.app.UI.showModal('💸 Nuova Spesa', content);
            }
            
            async saveExpense() {
                const amount = document.getElementById('expenseAmount')?.value;
                const description = document.getElementById('expenseDescription')?.value;
                const date = document.getElementById('expenseDate')?.value;
                const category = document.getElementById('expenseCategory')?.value;
                
                if (!amount || !description) {
                    this.app.UI.showNotification('Errore', 'Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                const transaction = {
                    id: this.app.generateId(),
                    type: 'expense',
                    amount: parseFloat(amount),
                    description: description,
                    client: category || 'Spesa Generale',
                    transaction_date: date,
                    created_at: this.app.formatDateTime()
                };
                
                await this.saveTransaction(transaction);
            }
            
            edit(id) {
                const transaction = this.app.state.data.transactions.find(t => t.id === id);
                if (!transaction) return;
                
                this.app.state.editingId = id;
                
                const isRevenue = transaction.type === 'revenue';
                const content = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Importo</label>
                            <input type="number" class="form-input" id="transactionAmount" step="0.01" min="0" required value="${transaction.amount}">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Descrizione</label>
                            <input type="text" class="form-input" id="transactionDescription" required value="${transaction.description}">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Data</label>
                            <input type="date" class="form-input" id="transactionDate" value="${this.app.formatDate(new Date(transaction.transaction_date || transaction.created_at))}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${isRevenue ? 'Cliente' : 'Categoria'}</label>
                            ${isRevenue ? `
                                <select class="form-select" id="transactionClient">
                                    <option value="">Cliente Generico</option>
                                    ${this.app.state.data.clients.map(client => 
                                        `<option value="${client.client_name}" ${transaction.client === client.client_name ? 'selected' : ''}>${client.client_name}</option>`
                                    ).join('')}
                                </select>
                            ` : `
                                <select class="form-select" id="transactionClient">
                                    <option value="">Seleziona categoria...</option>
                                    <option value="Componenti" ${transaction.client === 'Componenti' ? 'selected' : ''}>Componenti</option>
                                    <option value="Attrezzature" ${transaction.client === 'Attrezzature' ? 'selected' : ''}>Attrezzature</option>
                                    <option value="Marketing" ${transaction.client === 'Marketing' ? 'selected' : ''}>Marketing</option>
                                    <option value="Trasporti" ${transaction.client === 'Trasporti' ? 'selected' : ''}>Trasporti</option>
                                    <option value="Altro" ${transaction.client === 'Altro' ? 'selected' : ''}>Altro</option>
                                </select>
                            `}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn ${isRevenue ? 'btn-success' : 'btn-error'}" onclick="App.Transactions.save()">
                            💾 Salva Modifiche
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="App.UI.closeModal()">
                            ❌ Annulla
                        </button>
                    </div>
                `;
                
                this.app.UI.showModal(`${isRevenue ? '💰' : '💸'} Modifica ${isRevenue ? 'Entrata' : 'Spesa'}`, content);
            }
            
            async save() {
                const amount = document.getElementById('transactionAmount')?.value;
                const description = document.getElementById('transactionDescription')?.value;
                const date = document.getElementById('transactionDate')?.value;
                const client = document.getElementById('transactionClient')?.value;
                
                if (!amount || !description) {
                    this.app.UI.showNotification('Errore', 'Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                const existingTransaction = this.app.state.data.transactions.find(t => t.id === this.app.state.editingId);
                
                const transaction = {
                    ...existingTransaction,
                    amount: parseFloat(amount),
                    description: description,
                    client: client || 'N/A',
                    transaction_date: date
                };
                
                await this.saveTransaction(transaction);
            }
            
            async saveTransaction(transaction) {
                try {
                    // Save locally
                    const index = this.app.state.editingId ? 
                        this.app.state.data.transactions.findIndex(t => t.id === this.app.state.editingId) : -1;
                    
                    if (index !== -1) {
                        this.app.state.data.transactions[index] = transaction;
                    } else {
                        this.app.state.data.transactions.push(transaction);
                    }
                    
                    this.app.DataManager.saveToLocalStorage();
                    this.app.DataManager.updateClientTotalSpent();
                    
                    // Try to sync
                    try {
                        await this.app.Sync.saveToSupabase('transactions', transaction);
                        this.app.UI.showNotification('Successo', 'Transazione salvata e sincronizzata', 'success');
                    } catch (error) {
                        this.app.UI.showNotification('Salvato Localmente', 'Transazione salvata, sincronizzazione in attesa', 'warning');
                    }
                    
                    this.app.UI.closeModal();
                    this.loadPage();
                    this.app.updateDashboard();
                    
                } catch (error) {
                    this.app.UI.showNotification('Errore', 'Impossibile salvare la transazione', 'error');
                }
            }
            
            delete(id) {
                const transaction = this.app.state.data.transactions.find(t => t.id === id);
                if (!transaction) return;
                
                if (confirm(`Sei sicuro di voler eliminare la transazione "${transaction.description}"?`)) {
                    // Remove locally
                    this.app.state.data.transactions = this.app.state.data.transactions.filter(t => t.id !== id);
                    this.app.DataManager.saveToLocalStorage();
                    this.app.DataManager.updateClientTotalSpent();
                    
                    // Add to sync queue
                    this.app.state.addToSyncQueue({ action: 'delete', table: 'transactions', id });
                    
                    this.app.UI.showNotification('Eliminato', 'Transazione eliminata con successo', 'success');
                    this.loadPage();
                    this.app.updateDashboard();
                }
            }
        }
        
        class ClientsManager {
            constructor(app) {
                this.app = app;
                this.searchQuery = '';
            }
            
            loadPage() {
                const container = document.getElementById('clientsContainer');
                if (!container) return;
                
                const clients = this.getFilteredClients();
                
                if (clients.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">👤</div>
                            <div class="empty-state-title">Nessun cliente presente</div>
                            <div class="empty-state-description">Inizia aggiungendo il tuo primo cliente</div>
                            <button class="btn btn-success" onclick="App.Clients.add()">
                                👤 Nuovo Cliente
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Contatti</th>
                                    <th>Fonte</th>
                                    <th>Totale Speso</th>
                                    <th>Ultimo Ordine</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                clients
                    .sort((a, b) => (b.total_spent || 0) - (a.total_spent || 0))
                    .forEach(client => {
                        const lastOrder = this.app.state.data.orders
                            .filter(o => o.client_name === client.client_name)
                            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
                        
                        html += `
                            <tr>
                                <td>
                                    <strong>${client.client_name}</strong><br>
                                    <small style="color: var(--text-muted);">Cliente dal ${new Date(client.created_at).toLocaleDateString('it-IT')}</small>
                                </td>
                                <td>
                                    ${client.client_email ? `📧 ${client.client_email}<br>` : ''}
                                    ${client.client_phone ? `📞 ${client.client_phone}` : ''}
                                    ${!client.client_email && !client.client_phone ? 'N/A' : ''}
                                </td>
                                <td>${client.client_source || 'N/A'}</td>
                                <td>
                                    <strong style="color: var(--success-light);">
                                        ${this.app.formatCurrency(client.total_spent || 0)}
                                    </strong>
                                </td>
                                <td>${lastOrder ? new Date(lastOrder.created_at).toLocaleDateString('it-IT') : 'Nessuno'}</td>
                                <td class="actions">
                                    <button class="btn btn-sm btn-secondary" onclick="App.Clients.edit('${client.id}')">
                                        ✏️ Modifica
                                    </button>
                                    <button class="btn btn-sm btn-error" onclick="App.Clients.delete('${client.id}')">
                                        🗑️ Elimina
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.innerHTML = html;
            }
            
            getFilteredClients() {
                if (!this.searchQuery) {
                    return this.app.state.data.clients;
                }
                
                return this.app.state.data.clients.filter(client =>
                    client.client_name.toLowerCase().includes(this.searchQuery) ||
                    (client.client_email && client.client_email.toLowerCase().includes(this.searchQuery)) ||
                    (client.client_phone && client.client_phone.toLowerCase().includes(this.searchQuery)) ||
                    (client.client_source && client.client_source.toLowerCase().includes(this.searchQuery))
                );
            }
            
            search(query) {
                this.searchQuery = query.toLowerCase();
                this.loadPage();
            }
            
            add() {
                this.app.QuickActions.client();
            }
            
            edit(id) {
                const client = this.app.state.data.clients.find(c => c.id === id);
                if (!client) return;
                
                this.app.state.editingId = id;
                
                const content = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Nome Cliente</label>
                            <input type="text" class="form-input" id="clientName" required value="${client.client_name}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="clientEmail" value="${client.client_email || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefono</label>
                            <input type="tel" class="form-input" id="clientPhone" value="${client.client_phone || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Come ci ha conosciuto</label>
                            <select class="form-select" id="clientSource">
                                <option value="">Seleziona...</option>
                                <option value="Instagram" ${client.client_source === 'Instagram' ? 'selected' : ''}>Instagram</option>
                                <option value="Wallapop" ${client.client_source === 'Wallapop' ? 'selected' : ''}>Wallapop</option>
                                <option value="Subito" ${client.client_source === 'Subito' ? 'selected' : ''}>Subito</option>
                                <option value="Vinted" ${client.client_source === 'Vinted' ? 'selected' : ''}>Vinted</option>
                                <option value="Facebook" ${client.client_source === 'Facebook' ? 'selected' : ''}>Facebook</option>
                                <option value="Ebay" ${client.client_source === 'Ebay' ? 'selected' : ''}>Ebay</option>
                                <option value="Altro" ${client.client_source === 'Altro' ? 'selected' : ''}>Altro</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-warning" onclick="App.Clients.save()">
                            💾 Salva Modifiche
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="App.UI.closeModal()">
                            ❌ Annulla
                        </button>
                    </div>
                `;
                
                this.app.UI.showModal('👤 Modifica Cliente', content);
            }
            
            async save() {
                const name = document.getElementById('clientName')?.value;
                const email = document.getElementById('clientEmail')?.value;
                const phone = document.getElementById('clientPhone')?.value;
                const source = document.getElementById('clientSource')?.value;
                
                if (!name) {
                    this.app.UI.showNotification('Errore', 'Il nome del cliente è obbligatorio', 'error');
                    return;
                }
                
                // Check for duplicates (excluding current client)
                const existingClient = this.app.state.data.clients.find(c => 
                    c.id !== this.app.state.editingId &&
                    (c.client_name.toLowerCase() === name.toLowerCase() ||
                     (email && c.client_email.toLowerCase() === email.toLowerCase()))
                );
                
                if (existingClient) {
                    this.app.UI.showNotification('Errore', 'Cliente già esistente', 'error');
                    return;
                }
                
                const clientData = {
                    id: this.app.state.editingId || this.app.generateId(),
                    client_name: name,
                    client_email: email || '',
                    client_phone: phone || '',
                    client_source: source || '',
                    total_spent: this.app.state.editingId ? 
                        this.app.state.data.clients.find(c => c.id === this.app.state.editingId)?.total_spent || 0 : 0,
                    created_at: this.app.state.editingId ? 
                        this.app.state.data.clients.find(c => c.id === this.app.state.editingId)?.created_at :
                        this.app.formatDateTime()
                };
                
                try {
                    // Save locally
                    const index = this.app.state.editingId ? 
                        this.app.state.data.clients.findIndex(c => c.id === this.app.state.editingId) : -1;
                    
                    if (index !== -1) {
                        this.app.state.data.clients[index] = clientData;
                    } else {
                        this.app.state.data.clients.push(clientData);
                    }
                    
                    this.app.DataManager.saveToLocalStorage();
                    
                    // Try to sync
                    try {
                        await this.app.Sync.saveToSupabase('clients', clientData);
                        this.app.UI.showNotification('Successo', 'Cliente salvato e sincronizzato', 'success');
                    } catch (error) {
                        this.app.UI.showNotification('Salvato Localmente', 'Cliente salvato, sincronizzazione in attesa', 'warning');
                    }
                    
                    this.app.UI.closeModal();
                    this.loadPage();
                    this.app.updateDashboard();
                    
                } catch (error) {
                    this.app.UI.showNotification('Errore', 'Impossibile salvare il cliente', 'error');
                }
            }
            
            delete(id) {
                const client = this.app.state.data.clients.find(c => c.id === id);
                if (!client) return;
                
                if (confirm(`Sei sicuro di voler eliminare il cliente ${client.client_name}?`)) {
                    // Remove locally
                    this.app.state.data.clients = this.app.state.data.clients.filter(c => c.id !== id);
                    this.app.DataManager.saveToLocalStorage();
                    
                    // Add to sync queue
                    this.app.state.addToSyncQueue({ action: 'delete', table: 'clients', id });
                    
                    this.app.UI.showNotification('Eliminato', 'Cliente eliminato con successo', 'success');
                    this.loadPage();
                    this.app.updateDashboard();
                }
            }
        }
        
        class InventoryManager {
            constructor(app) {
                this.app = app;
                this.searchQuery = '';
            }
            
            loadPage() {
                const container = document.getElementById('inventoryContainer');
                if (!container) return;
                
                const inventory = this.getFilteredInventory();
                
                if (inventory.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📦</div>
                            <div class="empty-state-title">Nessun componente in inventario</div>
                            <div class="empty-state-description">Inizia aggiungendo il tuo primo componente</div>
                            <button class="btn btn-success" onclick="App.Inventory.add()">
                                📦 Nuovo Componente
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Componente</th>
                                    <th>Quantità</th>
                                    <th>Soglia</th>
                                    <th>Prezzo</th>
                                    <th>Fornitore</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                inventory.forEach(item => {
                    const isLowStock = item.quantity <= (item.threshold || 5);
                    
                    html += `
                        <tr ${isLowStock ? 'style="background-color: rgba(239, 68, 68, 0.1);"' : ''}>
                            <td>
                                <strong>${item.item_name}</strong>
                                ${isLowStock ? '<br><small style="color: var(--error-light);">⚠️ Scorte basse</small>' : ''}
                            </td>
                            <td>
                                <strong style="color: ${isLowStock ? 'var(--error-light)' : 'var(--success-light)'};">
                                    ${item.quantity}
                                </strong>
                            </td>
                            <td>${item.threshold || 5}</td>
                            <td>${this.app.formatCurrency(item.price || 0)}</td>
                            <td>${item.supplier || 'N/A'}</td>
                            <td class="actions">
                                <button class="btn btn-sm btn-secondary" onclick="App.Inventory.edit('${item.id}')">
                                    ✏️ Modifica
                                </button>
                                <button class="btn btn-sm btn-error" onclick="App.Inventory.delete('${item.id}')">
                                    🗑️ Elimina
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.innerHTML = html;
            }
            
            getFilteredInventory() {
                if (!this.searchQuery) {
                    return this.app.state.data.inventory;
                }
                
                return this.app.state.data.inventory.filter(item =>
                    item.item_name.toLowerCase().includes(this.searchQuery) ||
                    (item.supplier && item.supplier.toLowerCase().includes(this.searchQuery))
                );
            }
            
            search(query) {
                this.searchQuery = query.toLowerCase();
                this.loadPage();
            }
            
            add() {
                this.app.QuickActions.inventory();
            }
            
            edit(id) {
                const item = this.app.state.data.inventory.find(i => i.id === id);
                if (!item) return;
                
                this.app.state.editingId = id;
                
                const content = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Nome Componente</label>
                            <input type="text" class="form-input" id="itemName" required value="${item.item_name}">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Quantità</label>
                            <input type="number" class="form-input" id="itemQuantity" min="0" required value="${item.quantity}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Soglia Minima</label>
                            <input type="number" class="form-input" id="itemThreshold" min="0" value="${item.threshold || 5}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prezzo Unitario</label>
                            <input type="number" class="form-input" id="itemPrice" step="0.01" min="0" value="${item.price || 0}">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Fornitore</label>
                            <input type="text" class="form-input" id="itemSupplier" value="${item.supplier || ''}">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" onclick="App.Inventory.save()">
                            💾 Salva Modifiche
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="App.UI.closeModal()">
                            ❌ Annulla
                        </button>
                    </div>
                `;
                
                this.app.UI.showModal('📦 Modifica Componente', content);
            }
            
            async save() {
                const name = document.getElementById('itemName')?.value;
                const quantity = document.getElementById('itemQuantity')?.value;
                const threshold = document.getElementById('itemThreshold')?.value;
                const price = document.getElementById('itemPrice')?.value;
                const supplier = document.getElementById('itemSupplier')?.value;
                
                if (!name || !quantity) {
                    this.app.UI.showNotification('Errore', 'Nome e quantità sono obbligatori', 'error');
                    return;
                }
                
                const itemData = {
                    id: this.app.state.editingId || this.app.generateId(),
                    item_name: name,
                    quantity: parseInt(quantity),
                    threshold: parseInt(threshold) || 5,
                    price: parseFloat(price) || 0,
                    supplier: supplier || '',
                    created_at: this.app.state.editingId ? 
                        this.app.state.data.inventory.find(i => i.id === this.app.state.editingId)?.created_at :
                        this.app.formatDateTime()
                };
                
                try {
                    // Save locally
                    const index = this.app.state.editingId ? 
                        this.app.state.data.inventory.findIndex(i => i.id === this.app.state.editingId) : -1;
                    
                    if (index !== -1) {
                        this.app.state.data.inventory[index] = itemData;
                    } else {
                        this.app.state.data.inventory.push(itemData);
                    }
                    
                    this.app.DataManager.saveToLocalStorage();
                    
                    // Try to sync
                    try {
                        await this.app.Sync.saveToSupabase('inventory', itemData);
                        this.app.UI.showNotification('Successo', 'Componente salvato e sincronizzato', 'success');
                    } catch (error) {
                        this.app.UI.showNotification('Salvato Localmente', 'Componente salvato, sincronizzazione in attesa', 'warning');
                    }
                    
                    this.app.UI.closeModal();
                    this.loadPage();
                    this.app.updateDashboard();
                    
                } catch (error) {
                    this.app.UI.showNotification('Errore', 'Impossibile salvare il componente', 'error');
                }
            }
            
            delete(id) {
                const item = this.app.state.data.inventory.find(i => i.id === id);
                if (!item) return;
                
                if (confirm(`Sei sicuro di voler eliminare il componente "${item.item_name}"?`)) {
                    // Remove locally
                    this.app.state.data.inventory = this.app.state.data.inventory.filter(i => i.id !== id);
                    this.app.DataManager.saveToLocalStorage();
                    
                    // Add to sync queue
                    this.app.state.addToSyncQueue({ action: 'delete', table: 'inventory', id });
                    
                    this.app.UI.showNotification('Eliminato', 'Componente eliminato con successo', 'success');
                    this.loadPage();
                    this.app.updateDashboard();
                }
            }
            
            checkLowStock() {
                const lowStockItems = this.app.state.data.inventory.filter(item => 
                    item.quantity <= (item.threshold || 5)
                );
                
                if (lowStockItems.length === 0) {
                    this.app.UI.showNotification('Stock OK', 'Tutte le scorte sono sufficienti', 'success');
                } else {
                    const itemNames = lowStockItems.map(item => item.item_name).join(', ');
                    this.app.UI.showNotification(
                        'Scorte Basse', 
                        `${lowStockItems.length} componenti hanno scorte basse: ${itemNames}`, 
                        'warning'
                    );
                    
                    // Refresh view to highlight low stock items
                    this.loadPage();
                }
            }
        }
        
        // ===== QUICK ACTIONS MANAGER =====
        
        class QuickActionsManager {
            constructor(app) {
                this.app = app;
            }
            
            sale() {
                const content = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Importo Vendita</label>
                            <input type="number" class="form-input" id="saleAmount" step="0.01" min="0" required placeholder="es. 45.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cliente</label>
                            <select class="form-select" id="saleClient">
                                <option value="">Cliente Generico</option>
                                ${this.app.state.data.clients.map(client => 
                                    `<option value="${client.client_name}">${client.client_name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label required">Descrizione</label>
                            <input type="text" class="form-input" id="saleDescription" required placeholder="es. Riparazione Game Boy DMG">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Data</label>
                            <input type="date" class="form-input" id="saleDate" value="${this.app.formatDate()}" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="App.QuickActions.processSale()">
                            💰 Registra Vendita
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="App.UI.closeModal()">
                            ❌ Annulla
                        </button>
                    </div>
                `;
                
                this.app.UI.showModal('💰 Vendita Rapida', content);
            }
            
            async processSale() {
                const amount = document.getElementById('saleAmount')?.value;
                const client = document.getElementById('saleClient')?.value || 'Cliente Generico';
                const description = document.getElementById('saleDescription')?.value;
                const date = document.getElementById('saleDate')?.value;
                
                if (!amount || !description) {
                    this.app.UI.showNotification('Errore', 'Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                const transaction = {
                    id: this.app.generateId(),
                    type: 'revenue',
                    amount: parseFloat(amount),
                    description: description,
                    client: client,
                    transaction_date: date,
                    created_at: this.app.formatDateTime()
                };
                
                await this.app.Transactions.saveTransaction(transaction);
            }
            
            order() {
                const content = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Nome Cliente</label>
                            <input type="text" class="form-input" id="orderClientName" required placeholder="es. Mario Rossi">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Cliente</label>
                            <input type="email" class="form-input" id="orderClientEmail" placeholder="es. mario@email.com">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label required">Specifiche Ordine</label>
                            <textarea class="form-textarea" id="orderSpecs" placeholder="es. Riparazione Game Boy DMG - sostituzione schermo" required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Data Scadenza</label>
                            <input type="date" class="form-input" id="orderDueDate" value="${this.app.formatDate(new Date(Date.now() + 7*24*60*60*1000))}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Stato</label>
                            <select class="form-select" id="orderStatus" required>
                                <option value="pending">In Attesa</option>
                                <option value="in-progress">In Lavorazione</option>
                                <option value="completed">Completato</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-warning" onclick="App.QuickActions.processOrder()">
                            📋 Crea Ordine
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="App.UI.closeModal()">
                            ❌ Annulla
                        </button>
                    </div>
                `;
                
                this.app.UI.showModal('📋 Nuovo Ordine Rapido', content);
            }
            
            async processOrder() {
                const clientName = document.getElementById('orderClientName')?.value;
                const clientEmail = document.getElementById('orderClientEmail')?.value;
                const specs = document.getElementById('orderSpecs')?.value;
                const dueDate = document.getElementById('orderDueDate')?.value;
                const status = document.getElementById('orderStatus')?.value;
                
                if (!clientName || !specs || !dueDate || !status) {
                    this.app.UI.showNotification('Errore', 'Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                const order = {
                    id: this.app.generateId(),
                    client_name: clientName,
                    client_email: clientEmail || '',
                    specs: { description: specs },
                    due_date: dueDate,
                    status: status,
                    created_at: this.app.formatDateTime()
                };
                
                await this.app.Orders.save();
                
                // Add client if not exists
                const existingClient = this.app.state.data.clients.find(c => c.client_name === clientName);
                if (!existingClient && clientEmail) {
                    const newClient = {
                        id: this.app.generateId(),
                        client_name: clientName,
                        client_email: clientEmail,
                        client_phone: '',
                        client_source: 'Ordine Rapido',
                        total_spent: 0,
                        created_at: this.app.formatDateTime()
                    };
                    
                    await this.app.Clients.save();
                }
            }
            
            client() {
                const content = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Nome Cliente</label>
                            <input type="text" class="form-input" id="clientName" required placeholder="es. Mario Rossi">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="clientEmail" placeholder="es. mario@email.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefono</label>
                            <input type="tel" class="form-input" id="clientPhone" placeholder="es. +39 123 456 7890">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Come ci ha conosciuto</label>
                            <select class="form-select" id="clientSource">
                                <option value="">Seleziona...</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Wallapop">Wallapop</option>
                                <option value="Subito">Subito</option>
                                <option value="Vinted">Vinted</option>
                                <option value="Facebook">Facebook</option>
                                <option value="Ebay">Ebay</option>
                                <option value="Altro">Altro</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-warning" onclick="App.QuickActions.processClient()">
                            👤 Aggiungi Cliente
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="App.UI.closeModal()">
                            ❌ Annulla
                        </button>
                    </div>
                `;
                
                this.app.UI.showModal('👤 Cliente Rapido', content);
            }
            
            async processClient() {
                const name = document.getElementById('clientName')?.value;
                const email = document.getElementById('clientEmail')?.value;
                const phone = document.getElementById('clientPhone')?.value;
                const source = document.getElementById('clientSource')?.value;
                
                if (!name) {
                    this.app.UI.showNotification('Errore', 'Il nome del cliente è obbligatorio', 'error');
                    return;
                }
                
                // Check if client already exists
                const existingClient = this.app.state.data.clients.find(c => 
                    c.client_name.toLowerCase() === name.toLowerCase() ||
                    (email && c.client_email.toLowerCase() === email.toLowerCase())
                );
                
                if (existingClient) {
                    this.app.UI.showNotification('Errore', 'Cliente già esistente', 'error');
                    return;
                }
                
                const client = {
                    id: this.app.generateId(),
                    client_name: name,
                    client_email: email || '',
                    client_phone: phone || '',
                    client_source: source || '',
                    total_spent: 0,
                    created_at: this.app.formatDateTime()
                };
                
                await this.app.Clients.save();
            }
            
            inventory() {
                const content = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Nome Componente</label>
                            <input type="text" class="form-input" id="itemName" required placeholder="es. Schermo LCD Game Boy DMG">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Quantità</label>
                            <input type="number" class="form-input" id="itemQuantity" min="0" required value="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Soglia Minima</label>
                            <input type="number" class="form-input" id="itemThreshold" min="0" value="5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prezzo Unitario</label>
                            <input type="number" class="form-input" id="itemPrice" step="0.01" min="0" placeholder="es. 25.00">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Fornitore</label>
                            <input type="text" class="form-input" id="itemSupplier" placeholder="es. TechParts Italia">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" onclick="App.QuickActions.processInventory()">
                            📦 Aggiungi Componente
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="App.UI.closeModal()">
                            ❌ Annulla
                        </button>
                    </div>
                `;
                
                this.app.UI.showModal('📦 Componente Rapido', content);
            }
            
            async processInventory() {
                const name = document.getElementById('itemName')?.value;
                const quantity = document.getElementById('itemQuantity')?.value;
                const threshold = document.getElementById('itemThreshold')?.value;
                const price = document.getElementById('itemPrice')?.value;
                const supplier = document.getElementById('itemSupplier')?.value;
                
                if (!name || !quantity) {
                    this.app.UI.showNotification('Errore', 'Nome e quantità sono obbligatori', 'error');
                    return;
                }
                
                const item = {
                    id: this.app.generateId(),
                    item_name: name,
                    quantity: parseInt(quantity),
                    threshold: parseInt(threshold) || 5,
                    price: parseFloat(price) || 0,
                    supplier: supplier || '',
                    created_at: this.app.formatDateTime()
                };
                
                await this.app.Inventory.save();
            }
        }
        
        // ===== GLOBAL FUNCTIONS =====
        
        // Global function for import processing
        window.processImportFile = async function() {
            if (!window.backupToImport) {
                App.UI.showNotification('Errore', 'Nessun file valido selezionato', 'error');
                return;
            }

            try {
                const success = await App.DataManager.import(new File([JSON.stringify(window.backupToImport)], 'backup.json', { type: 'application/json' }));
                if (success) {
                    window.backupToImport = null;
                }
            } catch (error) {
                console.error('Import processing error:', error);
                App.UI.showNotification('Errore', 'Errore durante l\'importazione', 'error');
            }
        };
        
        // ===== APPLICATION INITIALIZATION =====
        
        // Global App instance
        let App;
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('🚀 Initializing RetroAvia Enterprise v4.2...');
                
                // Create global app instance
                App = new RetroAviaApp();
                
                // Make app globally available for debugging
                window.App = App;
                window.RetroAvia = {
                    version: App.version,
                    data: App.state.data,
                    sync: () => App.sync(),
                    export: () => App.DataManager.export(),
                    validate: () => App.Validation.validateDataIntegrity(),
                    performance: () => App.Performance.getMetrics()
                };
                
                console.log('✅ RetroAvia Enterprise v4.2 - Ready for business!');
                
            } catch (error) {
                console.error('❌ Failed to initialize RetroAvia:', error);
                
                // Show error in UI
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.innerHTML = `
                        <div class="loading-logo">❌ RetroAvia</div>
                        <div class="loading-text" style="color: var(--error-light);">
                            Errore di inizializzazione<br>
                            <small style="margin-top: 1rem; display: block;">Ricarica la pagina per riprovare</small>
                        </div>
                    `;
                }
            }
        });
        
        // ===== ERROR HANDLING =====
        
        // Global error handler
        window.addEventListener('error', (event) => {
            if (App && App.Performance) {
                App.Performance.logError(event.error, 'Global Error');
            }
            console.error('Global error:', event.error);
        });
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
            if (App && App.Performance) {
                App.Performance.logError(event.reason, 'Unhandled Promise');
            }
            console.error('Unhandled promise rejection:', event.reason);
            event.preventDefault();
        });
        
        // ===== ADVANCED FEATURES =====
        
        // Auto-save functionality
        let autoSaveInterval;
        
        const startAutoSave = () => {
            autoSaveInterval = setInterval(() => {
                if (App && App.state.connected && App.state.syncQueue.length > 0) {
                    console.log('🔄 Auto-sync triggered...');
                    App.Sync.processSyncQueue();
                }
            }, 5 * 60 * 1000); // Every 5 minutes
        };
        
        const stopAutoSave = () => {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
        };
        
        // Start auto-save when app is ready
        window.addEventListener('load', () => {
            setTimeout(startAutoSave, 10000); // Start after 10 seconds
        });
        
        // Stop auto-save on unload
        window.addEventListener('beforeunload', () => {
            stopAutoSave();
        });
        
        // ===== PERFORMANCE MONITORING =====
        
        // Performance observer for monitoring
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    if (entry.entryType === 'navigation') {
                        console.log(`📊 Page load time: ${entry.loadEventEnd - entry.fetchStart}ms`);
                    } else if (entry.entryType === 'paint') {
                        console.log(`🎨 ${entry.name}: ${entry.startTime}ms`);
                    }
                }
            });
            
            try {
                observer.observe({ entryTypes: ['navigation', 'paint'] });
            } catch (error) {
                console.warn('Performance observer not fully supported:', error);
            }
        }
        
        // ===== KEYBOARD SHORTCUTS =====
        
        const enhancedKeyboardShortcuts = {
            'F1': () => showKeyboardShortcuts(),
            'ctrl+shift+e': () => App?.DataManager?.export(),
            'ctrl+shift+r': () => App?.sync(),
            'f2': () => {
                const currentPage = App?.state?.currentPage;
                if (currentPage === 'orders') App?.Orders?.add();
                else if (currentPage === 'transactions') App?.QuickActions?.sale();
                else if (currentPage === 'clients') App?.Clients?.add();
                else if (currentPage === 'inventory') App?.Inventory?.add();
            }
        };
        
        const showKeyboardShortcuts = () => {
            const shortcuts = `
                <div class="grid grid-2">
                    <div>
                        <h4 style="color: var(--primary-light); margin-bottom: var(--spacing-lg);">Navigazione</h4>
                        <div style="margin-bottom: var(--spacing-sm);"><kbd>1-6</kbd> Cambia pagina</div>
                        <div style="margin-bottom: var(--spacing-sm);"><kbd>Esc</kbd> Chiudi modali</div>
                        <div style="margin-bottom: var(--spacing-sm);"><kbd>F1</kbd> Aiuto</div>
                    </div>
                    <div>
                        <h4 style="color: var(--primary-light); margin-bottom: var(--spacing-lg);">Azioni</h4>
                        <div style="margin-bottom: var(--spacing-sm);"><kbd>Ctrl+S</kbd> Sincronizza</div>
                        <div style="margin-bottom: var(--spacing-sm);"><kbd>Ctrl+E</kbd> Esporta</div>
                        <div style="margin-bottom: var(--spacing-sm);"><kbd>F2</kbd> Nuovo elemento</div>
                    </div>
                </div>
                <style>
                    kbd {
                        background: var(--surface);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 4px;
                        padding: 2px 6px;
                        font-family: 'JetBrains Mono', monospace;
                        font-size: 0.75rem;
                        color: var(--text-primary);
                    }
                </style>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="App.UI.closeModal()">
                        Chiudi
                    </button>
                </div>
            `;
            
            if (App && App.UI) {
                App.UI.showModal('⌨️ Scorciatoie da Tastiera', shortcuts);
            }
        };
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            const key = [
                e.ctrlKey && 'ctrl',
                e.shiftKey && 'shift',
                e.altKey && 'alt',
                e.key.toLowerCase()
            ].filter(Boolean).join('+');
            
            const simpleKey = e.key;
            
            const action = enhancedKeyboardShortcuts[key] || enhancedKeyboardShortcuts[simpleKey];
            if (action && !['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
                e.preventDefault();
                action();
            }
        });
        
        // ===== ACCESSIBILITY ENHANCEMENTS =====
        
        // Skip link for keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.altKey && e.key === 's') {
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.focus();
                    mainContent.scrollIntoView();
                }
            }
        });
        
        // ===== FINAL INITIALIZATION =====
        
        // Performance monitoring final setup
        if (window.performance && window.performance.mark) {
            window.performance.mark('retroavia-script-loaded');
        }
        
        // Final status message
        console.log('%c🚀 RetroAvia 4.2 Enterprise Edition', 'font-size: 24px; color: #2563eb; font-weight: bold;');
        console.log('%c✅ All systems operational and ready for business!', 'font-size: 14px; color: #10b981;');
        console.log('%c📖 Press F1 for keyboard shortcuts', 'font-size: 12px; color: #6b7280;');
        console.log('%c🔧 Access window.RetroAvia for debugging tools', 'font-size: 12px; color: #6b7280;');
        console.log('%c💼 Enterprise features fully loaded', 'font-size: 12px; color: #8b5cf6;');
        
        // Final ready state
        document.documentElement.setAttribute('data-retroavia-ready', 'true');
        
        console.log('🎯 RetroAvia 4.2 Enterprise - Application fully initialized and ready for production use!');
    </script>
</body>
</html>

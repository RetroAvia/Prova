import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { 
    Plus, Minus, TrendingUp, TrendingDown, Calendar, BarChart3, PieChart, 
    Wallet, Settings, Filter, Eye, EyeOff, Edit, Trash2, Save, X,
    ArrowUpCircle, ArrowDownCircle, Search, SortAsc, SortDesc,
    Download, Upload, Target, Award, AlertCircle, CheckCircle,
    DollarSign, CreditCard, Bell, Moon, Sun, Menu, ChevronLeft, ChevronRight
} from 'lucide-react';
import { 
    LineChart, Line, AreaChart, Area, BarChart, Bar, 
    PieChart as RechartsPieChart, Pie, Cell, XAxis, YAxis, 
    CartesianGrid, Tooltip, Legend, ResponsiveContainer 
} from 'recharts';

// Utility functions
const formatCurrency = (amount) => {
    return new Intl.NumberFormat('it-IT', {
        style: 'currency',
        currency: 'EUR'
    }).format(amount || 0);
};

const generateId = () => Date.now() + Math.random();

const validateAmount = (amount) => {
    const num = parseFloat(amount);
    return !isNaN(num) && num > 0 && num <= 999999;
};

const validateText = (text, maxLength = 100) => {
    return text && text.trim().length > 0 && text.trim().length <= maxLength;
};

// Initial data
const initialCategories = [
    { id: 1, name: 'Stipendio', type: 'income', color: '#10B981', icon: 'üí∞' },
    { id: 2, name: 'Freelance', type: 'income', color: '#059669', icon: 'üíª' },
    { id: 3, name: 'Investimenti', type: 'income', color: '#047857', icon: 'üìà' },
    { id: 4, name: 'Bonus', type: 'income', color: '#065F46', icon: 'üéÅ' },
    { id: 5, name: 'Alimentari', type: 'expense', color: '#EF4444', icon: 'üõí' },
    { id: 6, name: 'Trasporti', type: 'expense', color: '#DC2626', icon: 'üöó' },
    { id: 7, name: 'Bollette', type: 'expense', color: '#B91C1C', icon: '‚ö°' },
    { id: 8, name: 'Intrattenimento', type: 'expense', color: '#991B1B', icon: 'üé¨' },
    { id: 9, name: 'Salute', type: 'expense', color: '#7F1D1D', icon: 'üè•' },
    { id: 10, name: 'Abbigliamento', type: 'expense', color: '#450A0A', icon: 'üëï' }
];

const initialTransactions = [
    {
        id: 1,
        type: 'income',
        amount: 2800,
        category: 1,
        description: 'Stipendio mensile dicembre',
        date: '2024-12-01',
        timestamp: '2024-12-01T10:00:00.000Z'
    },
    {
        id: 2,
        type: 'expense',
        amount: 450,
        category: 5,
        description: 'Spesa settimanale supermercato',
        date: '2024-12-15',
        timestamp: '2024-12-15T15:30:00.000Z'
    },
    {
        id: 3,
        type: 'expense',
        amount: 85,
        category: 6,
        description: 'Rifornimento carburante auto',
        date: '2024-12-18',
        timestamp: '2024-12-18T08:15:00.000Z'
    }
];

// Notification Component
const NotificationList = ({ notifications, removeNotification }) => (
    <div className="fixed top-4 right-4 z-50 space-y-2 max-w-sm">
        {notifications.map(notification => (
            <div 
                key={notification.id}
                className={`bg-white/10 backdrop-blur-xl rounded-xl p-4 border-l-4 transition-all duration-300 transform translate-x-0 ${
                    notification.type === 'success' ? 'border-emerald-400' : 'border-rose-400'
                }`}
                style={{ animation: 'slideInRight 0.3s ease-out' }}
            >
                <div className="flex items-center space-x-3">
                    {notification.type === 'success' ? (
                        <CheckCircle className="text-emerald-400 flex-shrink-0" size={20} />
                    ) : (
                        <AlertCircle className="text-rose-400 flex-shrink-0" size={20} />
                    )}
                    <span className="text-white font-medium text-sm">{notification.message}</span>
                    <button
                        onClick={() => removeNotification(notification.id)}
                        className="text-white/60 hover:text-white ml-auto flex-shrink-0"
                        aria-label="Chiudi notifica"
                    >
                        <X size={16} />
                    </button>
                </div>
            </div>
        ))}
    </div>
);

// Stats Card Component
const StatsCard = ({ title, value, icon: Icon, type, showBalance, count, gradient }) => (
    <div className={`bg-white/10 backdrop-blur-xl rounded-2xl p-6 border border-white/20 hover:bg-white/15 transition-all duration-300 ${gradient}`}>
        <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-bold text-white">{title}</h3>
            <div className={`p-3 rounded-xl ${type === 'income' ? 'bg-emerald-500/20' : type === 'expense' ? 'bg-rose-500/20' : 'bg-blue-500/20'}`}>
                <Icon className={`${type === 'income' ? 'text-emerald-400' : type === 'expense' ? 'text-rose-400' : 'text-blue-400'}`} size={24} />
            </div>
        </div>
        <p className={`text-3xl font-black mb-2 ${type === 'income' ? 'text-emerald-400' : type === 'expense' ? 'text-rose-400' : value >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
            {showBalance ? formatCurrency(value) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
        </p>
        {count !== undefined && (
            <p className="text-white/60 text-sm font-medium">
                {count} transazioni
            </p>
        )}
    </div>
);

// Transaction Item Component
const TransactionItem = ({ transaction, category, onDelete, formatCurrency }) => (
    <div className="flex items-center justify-between bg-white/5 rounded-xl p-4 hover:bg-white/10 transition-all duration-200 border border-white/10 group">
        <div className="flex items-center space-x-4">
            <div className={`p-3 rounded-xl ${transaction.type === 'income' ? 'bg-emerald-500/20' : 'bg-rose-500/20'}`}>
                <span className="text-2xl">{category?.icon || 'üìù'}</span>
            </div>
            <div>
                <p className="text-white font-bold">{category?.name || 'Categoria non trovata'}</p>
                <p className="text-white/70 text-sm">{transaction.description || 'Nessuna descrizione'}</p>
                <div className="flex items-center space-x-3 mt-1">
                    <p className="text-white/50 text-xs">
                        {new Date(transaction.date).toLocaleDateString('it-IT', { 
                            weekday: 'short', 
                            day: 'numeric', 
                            month: 'short' 
                        })}
                    </p>
                    <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                        transaction.type === 'income' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'
                    }`}>
                        {transaction.type === 'income' ? 'Entrata' : 'Uscita'}
                    </span>
                </div>
            </div>
        </div>
        <div className="flex items-center space-x-3">
            <p className={`font-black text-lg ${transaction.type === 'income' ? 'text-emerald-400' : 'text-rose-400'}`}>
                {transaction.type === 'income' ? '+' : '-'}{formatCurrency(transaction.amount)}
            </p>
            <button
                onClick={() => onDelete(transaction.id)}
                className="text-rose-400 hover:text-rose-300 transition-colors p-2 rounded-lg hover:bg-rose-500/20 opacity-0 group-hover:opacity-100"
                aria-label="Elimina transazione"
            >
                <Trash2 size={16} />
            </button>
        </div>
    </div>
);

// Main Component
const FinanceTracker = () => {
    // State management
    const [activeTab, setActiveTab] = useState('dashboard');
    const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
    const [notifications, setNotifications] = useState([]);
    
    const [transactions, setTransactions] = useState(initialTransactions);
    const [categories, setCategories] = useState(initialCategories);
    const [budgets, setBudgets] = useState([]);
    
    // Form states
    const [formData, setFormData] = useState({
        amount: '',
        category: '',
        description: '',
        date: new Date().toISOString().split('T')[0],
        type: 'expense'
    });
    
    const [categoryForm, setCategoryForm] = useState({
        name: '',
        type: 'expense',
        color: '#667eea',
        icon: 'üìù'
    });
    
    const [budgetForm, setBudgetForm] = useState({
        category: '',
        amount: '',
        period: 'monthly'
    });
    
    // UI states
    const [showBalance, setShowBalance] = useState(true);
    const [editingCategory, setEditingCategory] = useState(null);
    const [filterPeriod, setFilterPeriod] = useState('all');
    const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
    const [searchTerm, setSearchTerm] = useState('');
    const [sortOrder, setSortOrder] = useState('desc');
    const [transactionFilter, setTransactionFilter] = useState('all');
    const [formErrors, setFormErrors] = useState({});
    
    // Notification system
    const showNotification = useCallback((message, type = 'success') => {
        const id = Date.now();
        const notification = { id, message, type };
        setNotifications(prev => [...prev, notification]);
        
        setTimeout(() => {
            setNotifications(prev => prev.filter(n => n.id !== id));
        }, 4000);
    }, []);
    
    const removeNotification = useCallback((id) => {
        setNotifications(prev => prev.filter(n => n.id !== id));
    }, []);
    
    // Validation
    const validateForm = useCallback((data, type = 'transaction') => {
        const errors = {};
        
        if (type === 'transaction') {
            if (!validateAmount(data.amount)) {
                errors.amount = 'Inserisci un importo valido (0.01 - 999,999)';
            }
            if (!data.category) {
                errors.category = 'Seleziona una categoria';
            }
            if (data.description && !validateText(data.description)) {
                errors.description = 'La descrizione non pu√≤ superare i 100 caratteri';
            }
        } else if (type === 'category') {
            if (!validateText(data.name, 20)) {
                errors.name = 'Il nome deve essere tra 1 e 20 caratteri';
            }
        } else if (type === 'budget') {
            if (!data.category) {
                errors.category = 'Seleziona una categoria';
            }
            if (!validateAmount(data.amount)) {
                errors.amount = 'Inserisci un importo valido';
            }
        }
        
        return errors;
    }, []);
    
    // Transaction operations
    const addTransaction = useCallback(() => {
        const errors = validateForm(formData, 'transaction');
        if (Object.keys(errors).length > 0) {
            setFormErrors(errors);
            showNotification('Correggi gli errori nel form', 'error');
            return;
        }
        
        const newTransaction = {
            id: generateId(),
            type: formData.type,
            amount: parseFloat(formData.amount),
            category: parseInt(formData.category),
            description: formData.description.trim(),
            date: formData.date,
            timestamp: new Date().toISOString()
        };
        
        setTransactions(prev => [newTransaction, ...prev]);
        setFormData({
            amount: '',
            category: '',
            description: '',
            date: new Date().toISOString().split('T')[0],
            type: 'expense'
        });
        setFormErrors({});
        
        showNotification('Transazione aggiunta con successo!');
        
        setTimeout(() => setActiveTab('transactions'), 800);
    }, [formData, validateForm, showNotification]);
    
    const deleteTransaction = useCallback((id) => {
        if (confirm('Sei sicuro di voler eliminare questa transazione?')) {
            setTransactions(prev => prev.filter(t => t.id !== id));
            showNotification('Transazione eliminata con successo!');
        }
    }, [showNotification]);
    
    // Category operations
    const addCategory = useCallback(() => {
        const errors = validateForm(categoryForm, 'category');
        if (Object.keys(errors).length > 0) {
            showNotification('Nome categoria non valido', 'error');
            return;
        }
        
        const newCategory = {
            id: generateId(),
            name: categoryForm.name.trim(),
            type: categoryForm.type,
            color: categoryForm.color,
            icon: categoryForm.icon
        };
        
        setCategories(prev => [...prev, newCategory]);
        setCategoryForm({
            name: '',
            type: 'expense',
            color: '#667eea',
            icon: 'üìù'
        });
        
        showNotification('Categoria aggiunta con successo!');
    }, [categoryForm, validateForm, showNotification]);
    
    const updateCategory = useCallback((id, updatedData) => {
        setCategories(prev => prev.map(cat => 
            cat.id === id ? { ...cat, ...updatedData } : cat
        ));
        setEditingCategory(null);
        showNotification('Categoria aggiornata con successo!');
    }, [showNotification]);
    
    const deleteCategory = useCallback((id) => {
        if (confirm('Sei sicuro di voler eliminare questa categoria?')) {
            setCategories(prev => prev.filter(cat => cat.id !== id));
            showNotification('Categoria eliminata con successo!');
        }
    }, [showNotification]);
    
    // Budget operations
    const addBudget = useCallback(() => {
        const errors = validateForm(budgetForm, 'budget');
        if (Object.keys(errors).length > 0) {
            showNotification('Dati budget non validi', 'error');
            return;
        }
        
        const newBudget = {
            id: generateId(),
            category: parseInt(budgetForm.category),
            amount: parseFloat(budgetForm.amount),
            period: budgetForm.period,
            createdAt: new Date().toISOString()
        };
        
        setBudgets(prev => [...prev, newBudget]);
        setBudgetForm({
            category: '',
            amount: '',
            period: 'monthly'
        });
        
        showNotification('Budget aggiunto con successo!');
    }, [budgetForm, validateForm, showNotification]);
    
    const deleteBudget = useCallback((id) => {
        if (confirm('Sei sicuro di voler eliminare questo budget?')) {
            setBudgets(prev => prev.filter(b => b.id !== id));
            showNotification('Budget eliminato con successo!');
        }
    }, [showNotification]);
    
    // Filtered transactions
    const filteredTransactions = useMemo(() => {
        let filtered = transactions;
        
        if (filterPeriod !== 'all') {
            const now = new Date();
            filtered = filtered.filter(t => {
                const transactionDate = new Date(t.date);
                
                switch (filterPeriod) {
                    case 'today':
                        return transactionDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return transactionDate >= weekAgo;
                    case 'month':
                        return transactionDate.getMonth() === selectedMonth && 
                               transactionDate.getFullYear() === selectedYear;
                    case 'year':
                        return transactionDate.getFullYear() === selectedYear;
                    default:
                        return true;
                }
            });
        }
        
        if (searchTerm) {
            filtered = filtered.filter(t => {
                const category = categories.find(c => c.id === t.category);
                return (
                    t.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (category && category.name.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            });
        }
        
        if (transactionFilter !== 'all') {
            filtered = filtered.filter(t => t.type === transactionFilter);
        }
        
        filtered.sort((a, b) => {
            const dateA = new Date(a.date);
            const dateB = new Date(b.date);
            return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
        });
        
        return filtered;
    }, [transactions, filterPeriod, selectedMonth, selectedYear, searchTerm, transactionFilter, sortOrder, categories]);
    
    // Calculations
    const totalIncome = useMemo(() => 
        filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0)
    , [filteredTransactions]);
    
    const totalExpenses = useMemo(() => 
        filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0)
    , [filteredTransactions]);
    
    const balance = totalIncome - totalExpenses;
    
    // Chart data
    const chartData = useMemo(() => {
        const monthlyData = {};
        
        filteredTransactions.forEach(t => {
            const date = new Date(t.date);
            const monthKey = date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
            
            if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = { 
                    month: new Date(date.getFullYear(), date.getMonth()).toLocaleDateString('it-IT', { month: 'short', year: 'numeric' }),
                    income: 0, 
                    expenses: 0 
                };
            }
            
            if (t.type === 'income') {
                monthlyData[monthKey].income += t.amount;
            } else {
                monthlyData[monthKey].expenses += t.amount;
            }
        });
        
        return Object.keys(monthlyData).sort().map(key => monthlyData[key]);
    }, [filteredTransactions]);
    
    const categoryData = useMemo(() => {
        const data = {};
        
        filteredTransactions.forEach(t => {
            const category = categories.find(c => c.id === t.category);
            if (category) {
                if (!data[category.name]) {
                    data[category.name] = { 
                        name: category.name, 
                        value: 0, 
                        color: category.color,
                        type: category.type
                    };
                }
                data[category.name].value += t.amount;
            }
        });
        
        return Object.values(data);
    }, [filteredTransactions, categories]);
    
    // Budget status
    const budgetStatus = useMemo(() => {
        return budgets.map(budget => {
            const category = categories.find(c => c.id === budget.category);
            const spent = filteredTransactions
                .filter(t => t.category === budget.category && t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const percentage = budget.amount > 0 ? (spent / budget.amount) * 100 : 0;
            
            return {
                ...budget,
                category: category,
                spent,
                remaining: budget.amount - spent,
                percentage: Math.min(percentage, 100),
                isOverBudget: spent > budget.amount
            };
        });
    }, [budgets, categories, filteredTransactions]);
    
    // Tab navigation
    const tabs = [
        { id: 'dashboard', label: 'Dashboard', icon: BarChart3 },
        { id: 'add', label: 'Aggiungi', icon: Plus },
        { id: 'transactions', label: 'Transazioni', icon: Wallet },
        { id: 'categories', label: 'Categorie', icon: Settings },
        { id: 'budgets', label: 'Budget', icon: Target },
        { id: 'analytics', label: 'Analisi', icon: PieChart }
    ];
    
    // Dashboard Component
    const Dashboard = () => (
        <div className="space-y-6">
            {/* Stats Cards */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="relative">
                    <StatsCard
                        title="Saldo Totale"
                        value={balance}
                        icon={Wallet}
                        showBalance={showBalance}
                        gradient="bg-gradient-to-br from-blue-500/20 to-purple-600/20"
                    />
                    <button 
                        onClick={() => setShowBalance(!showBalance)}
                        className="absolute top-4 right-4 text-white/70 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10"
                        aria-label={showBalance ? "Nascondi saldo" : "Mostra saldo"}
                    >
                        {showBalance ? <Eye size={20} /> : <EyeOff size={20} />}
                    </button>
                </div>
                
                <StatsCard
                    title="Entrate"
                    value={totalIncome}
                    icon={ArrowUpCircle}
                    type="income"
                    showBalance={showBalance}
                    count={filteredTransactions.filter(t => t.type === 'income').length}
                    gradient="bg-gradient-to-br from-emerald-500/20 to-emerald-600/20"
                />
                
                <StatsCard
                    title="Uscite"
                    value={totalExpenses}
                    icon={ArrowDownCircle}
                    type="expense"
                    showBalance={showBalance}
                    count={filteredTransactions.filter(t => t.type === 'expense').length}
                    gradient="bg-gradient-to-br from-rose-500/20 to-rose-600/20"
                />
            </div>
            
            {/* Filters */}
            <div className="bg-white/10 backdrop-blur-xl rounded-2xl p-6 border border-white/20">
                <div className="flex flex-wrap gap-4 items-center">
                    <div className="flex items-center space-x-2">
                        <Filter className="text-white" size={20} />
                        <span className="text-white font-bold">Filtri:</span>
                    </div>
                    
                    <select 
                        value={filterPeriod}
                        onChange={(e) => setFilterPeriod(e.target.value)}
                        className="bg-white/20 border border-white/30 rounded-xl px-4 py-2 text-white backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                        aria-label="Seleziona periodo"
                    >
                        <option value="all">Tutto il tempo</option>
                        <option value="today">Oggi</option>
                        <option value="week">Ultima settimana</option>
                        <option value="month">Questo mese</option>
                        <option value="year">Quest'anno</option>
                    </select>
                    
                    {filterPeriod === 'month' && (
                        <>
                            <select
                                value={selectedMonth}
                                onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                                className="bg-white/20 border border-white/30 rounded-xl px-4 py-2 text-white backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                                aria-label="Seleziona mese"
                            >
                                {Array.from({length: 12}, (_, i) => (
                                    <option key={i} value={i}>
                                        {new Date(2024, i).toLocaleDateString('it-IT', { month: 'long' })}
                                    </option>
                                ))}
                            </select>
                            <input
                                type="number"
                                value={selectedYear}
                                onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                                className="bg-white/20 border border-white/30 rounded-xl px-4 py-2 text-white w-24 backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                                min="2020"
                                max="2030"
                                aria-label="Seleziona anno"
                            />
                        </>
                    )}
                </div>
            </div>
            
            {/* Charts */}
            <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <div className="bg-white/10 backdrop-blur-xl rounded-2xl p-6 border border-white/20">
                    <h3 className="text-xl font-bold text-white mb-6 flex items-center">
                        <BarChart3 className="mr-2" size={24} />
                        Andamento Mensile
                    </h3>
                    <ResponsiveContainer width="100%" height={300}>
                        <AreaChart data={chartData}>
                            <defs>
                                <linearGradient id="incomeGradient" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#10B981" stopOpacity={0.8}/>
                                    <stop offset="95%" stopColor="#10B981" stopOpacity={0.1}/>
                                </linearGradient>
                                <linearGradient id="expenseGradient" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#EF4444" stopOpacity={0.8}/>
                                    <stop offset="95%" stopColor="#EF4444" stopOpacity={0.1}/>
                                </linearGradient>
                            </defs>
                            <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
                            <XAxis dataKey="month" stroke="rgba(255,255,255,0.8)" fontSize={12} />
                            <YAxis stroke="rgba(255,255,255,0.8)" fontSize={12} />
                            <Tooltip 
                                contentStyle={{ 
                                    backgroundColor: 'rgba(15, 23, 42, 0.95)', 
                                    border: '1px solid rgba(255,255,255,0.2)',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}
                                formatter={(value) => formatCurrency(value)}
                            />
                            <Area type="monotone" dataKey="income" stroke="#10B981" fill="url(#incomeGradient)" strokeWidth={2} />
                            <Area type="monotone" dataKey="expenses" stroke="#EF4444" fill="url(#expenseGradient)" strokeWidth={2} />
                        </AreaChart>
                    </ResponsiveContainer>
                </div>
                
                <div className="bg-white/10 backdrop-blur-xl rounded-2xl p-6 border border-white/20">
                    <h3 className="text-xl font-bold text-white mb-6 flex items-center">
                        <PieChart className="mr-2" size={24} />
                        Distribuzione Spese
                    </h3>
                    <ResponsiveContainer width="100%" height={300}>
                        <RechartsPieChart>
                            <Pie
                                data={categoryData.filter(cat => cat.type === 'expense')}
                                cx="50%"
                                cy="50%"
                                outerRadius={100}
                                dataKey="value"
                                stroke="rgba(255,255,255,0.1)"
                                strokeWidth={2}
                            >
                                {categoryData.filter(cat => cat.type === 'expense').map((entry, index) => (
                                    <Cell key={`cell-${index}`} fill={entry.color} />
                                ))}
                            </Pie>
                            <Tooltip 
                                contentStyle={{ 
                                    backgroundColor: 'rgba(15, 23, 42, 0.95)', 
                                    border: '1px solid rgba(255,255,255,0.2)',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}
                                formatter={(value) => formatCurrency(value)}
                            />
                        </RechartsPieChart>
                    </ResponsiveContainer>
                </div>
            </div>
            
            {/* Recent Transactions */}
            <div className="bg-white/10 backdrop-blur-xl rounded-2xl p-6 border border-white/20">
                <div className="flex items-center justify-between mb-6">
                    <h3 className="text-xl font-bold text-white">Transazioni Recenti</h3>
                    <button 
                        onClick={() => setActiveTab('transactions')}
                        className="bg-blue-600 hover:bg-blue-700 px-4 py-2 text-white rounded-lg font-medium transition-colors"
                    >
                        Vedi tutte
                    </button>
                </div>
                <div className="space-y-3 max-h-96 overflow-y-auto">
                    {filteredTransactions.slice(0, 5).map(transaction => {
                        const category = categories.find(c => c.id === transaction.category);
                        return (
                            <TransactionItem 
                                key={transaction.id}
                                transaction={transaction}
                                category={category}
                                onDelete={deleteTransaction}
                                formatCurrency={formatCurrency}
                            />
                        );
                    })}
                    {filteredTransactions.length === 0 && (
                        <div className="text-center py-8 text-white/60">
                            <div className="text-4xl mb-4">üìä</div>
                            <p className="font-bold">Nessuna transazione trovata</p>
                            <p className="text-sm">Inizia aggiungendo la tua prima transazione!</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
    
    // Add Transaction Component
    const AddTransaction = () => (
        <div className="max-w-2xl mx-auto">
            <div className="bg-white/10 backdrop-blur-xl rounded-2xl p-8 border border-white/20">
                <div className="flex items-center space-x-4 mb-8">
                    <div className="bg-blue-600 p-3 rounded-xl">
                        <Plus className="text-white" size={24} />
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold text-white">Aggiungi Transazione</h2>
                        <p className="text-white/70">Registra una nuova entrata o uscita</p>
                    </div>
                </div>
                
                <div className="space-y-6">
                    {/* Transaction Type */}
                    <div>
                        <label className="block text-white/90 font-bold mb-3">Tipo di Transazione</label>
                        <div className="grid grid-cols-2 gap-4">
                            <button
                                onClick={() => setFormData(prev => ({ ...prev, type: 'income' }))}
                                className={`p-4 rounded-xl font-bold transition-all ${
                                    formData.type === 'income' 
                                        ? 'bg-emerald-600 text-white' 
                                        : 'bg-white/10 text-white/70 hover:bg-white/20'
                                }`}
                            >
                                <ArrowUpCircle className="inline mr-2" size={20} />
                                Entrata
                            </button>
                            <button
                                onClick={() => setFormData(prev => ({ ...prev, type: 'expense' }))}
                                className={`p-4 rounded-xl font-bold transition-all ${
                                    formData.type === 'expense' 
                                        ? 'bg-rose-600 text-white' 
                                        : 'bg-white/10 text-white/70 hover:bg-white/20'
                                }`}
                            >
                                <ArrowDownCircle className="inline mr-2" size={20} />
                                Uscita
                            </button>
                        </div>
                    </div>
                    
                    {/* Amount and Category */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-white/90 font-bold mb-3">Importo (‚Ç¨)</label>
                            <div className="relative">
                                <DollarSign className="absolute left-3 top-1/2 transform -translate-y-1/2 text-white/50" size={20} />
                                <input
                                    type="number"
                                    value={formData.amount}
                                    onChange={(e) => {
                                        setFormData(prev => ({ ...prev, amount: e.target.value }));
                                        setFormErrors(prev => ({ ...prev, amount: undefined }));
                                    }}
                                    className={`w-full pl-12 pr-4 py-3 bg-white/10 border rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 ${
                                        formErrors.amount ? 'border-rose-400' : 'border-white/30'
                                    }`}
                                    placeholder="0,00"
                                    step="0.01"
                                    min="0.01"
                                    max="999999"
                                />
                            </div>
                            {formErrors.amount && (
                                <p className="text-rose-400 text-sm mt-1">{formErrors.amount}</p>
                            )}
                        </div>
                        
                        <div>
                            <label className="block text-white/90 font-bold mb-3">Categoria</label>
                            <select
                                value={formData.category}
                                onChange={(e) => {
                                    setFormData(prev => ({ ...prev, category: e.target.value }));
                                    setFormErrors(prev => ({ ...prev, category: undefined }));
                                }}
                                className={`w-full px-4 py-3 bg-white/10 border rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-400 ${
                                    formErrors.category ? 'border-rose-400' : 'border-white/30'
                                }`}
                            >
                                <option value="">Seleziona categoria</option>
                                {categories
                                    .filter(cat => cat.type === formData.type)
                                    .map(category => (
                                        <option key={category.id} value={category.id} className="bg-slate-800">
                                            {category.icon} {category.name}
                                        </option>
                                    ))}
                            </select>
                            {formErrors.category && (
                                <p className="text-rose-400 text-sm mt-1">{formErrors.category}</p>
                            )}
                        </div>
                    </div>
                    
                    {/* Description */}
                    <div>
                        <label className="block text-white/90 font-bold mb-3">Descrizione (opzionale)</label>
                        <input
                            type="text"
                            value={formData.description}
                            onChange={(e) => {
                                setFormData(prev => ({ ...prev, description: e.target.value }));
                                setFormErrors(prev => ({ ...prev, description: undefined }));
                            }}
                            className={`w-full px-4 py-3 bg-white/10 border rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 ${
                                formErrors.description ? 'border-rose-400' : 'border-white/30'
                            }`}
                            placeholder="Descrizione della transazione"
                            maxLength="100"
                        />
                        {formErrors.description && (
                            <p className="text-rose-400 text-sm mt-1">{formErrors.description}</p>
                        )}
                        <p className="text-white/50 text-sm mt-1">{formData.description.length}/100 caratteri</p>
                    </div>
                    
                    {/* Date */}
                    <div>
                        <label className="block text-white/90 font-bold mb-3">Data</label>
                        <input
                            type="date"
                            value={formData.date}
                            onChange={(e) => setFormData(prev => ({ ...prev, date: e.target.value }))}
                            className="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-400"
                        />
                    </div>
                    
                    {/* Submit Button */}
                    <button
                        onClick={addTransaction}
                        disabled={!formData.amount || !formData.category || parseFloat(formData.amount) <= 0}
                        className="w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-bold"
                    >
                        <Save className="inline mr-2" size={20} />
                        Salva Transazione
                    </button>
                </div>
            </div>
        </div>
    );
    
    // Transactions List Component
    const TransactionsList = () => (
        <div className="space-y-6">
            <div className="bg-white/10 backdrop-blur-xl rounded-2xl p-6 border border-white/20">
                <div className="flex flex-col lg:flex-row lg:items-center justify-between mb-6 space-y-4 lg:space-y-0">
                    <div className="flex items-center space-x-4">
                        <div className="bg-blue-600 p-3 rounded-xl">
                            <Wallet className="text-white" size={24} />
                        </div>
                        <div>
                            <h2 className="text-2xl font-bold text-white">Tutte le Transazioni</h2>
                            <p className="text-white/70">{filteredTransactions.length} transazioni trovate</p>
                        </div>
                    </div>
                    
                    <div className="flex flex-wrap gap-4">
                        <div className="relative">
                            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-white/50" size={20} />
                            <input
                                type="text"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="pl-10 pr-4 py-2 bg-white/10 border border-white/30 rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 min-w-48"
                                placeholder="Cerca transazioni..."
                            />
                        </div>
                        
                        <button
                            onClick={() => setSortOrder(sortOrder === 'desc' ? 'asc' : 'desc')}
                            className="px-4 py-2 bg-white/10 text-white rounded-xl hover:bg-white/20 transition-colors border border-white/20 flex items-center space-x-2"
                            aria-label="Ordina per data"
                        >
                            {sortOrder === 'desc' ? <SortDesc size={20} /> : <SortAsc size={20} />}
                            <span>Data</span>
                        </button>
                    </div>
                </div>
                
                {/* Filter Tabs */}
                <div className="flex space-x-1 mb-6 bg-white/10 p-1 rounded-xl">
                    <button
                        onClick={() => setTransactionFilter('all')}
                        className={`flex-1 py-2 px-4 rounded-lg font-bold transition-all ${
                            transactionFilter === 'all' 
                                ? 'bg-white/20 text-white' 
                                : 'text-white/70 hover:text-white'
                        }`}
                    >
                        Tutte ({filteredTransactions.length})
                    </button>
                    <button
                        onClick={() => setTransactionFilter('income')}
                        className={`flex-1 py-2 px-4 rounded-lg font-bold transition-all ${
                            transactionFilter === 'income' 
                                ? 'bg-emerald-600 text-white' 
                                : 'text-white/70 hover:text-white'
                        }`}
                    >
                        Entrate ({transactions.filter(t => t.type === 'income').length})
                    </button>
                    <button
                        onClick={() => setTransactionFilter('expense')}
                        className={`flex-1 py-2 px-4 rounded-lg font-bold transition-all ${
                            transactionFilter === 'expense' 
                                ? 'bg-rose-600 text-white' 
                                : 'text-white/70 hover:text-white'
                        }`}
                    >
                        Uscite ({transactions.filter(t => t.type === 'expense').length})
                    </button>
                </div>
                
                {/* Transactions List */}
                <div className="space-y-3 max-h-96 overflow-y-auto">
                    {filteredTransactions.map(transaction => {
                        const category = categories.find(c => c.id === transaction.category);
                        return (
                            <TransactionItem 
                                key={transaction.id}
                                transaction={transaction}
                                category={category}
                                onDelete={deleteTransaction}
                                formatCurrency={formatCurrency}
                            />
                        );
                    })}
                    {filteredTransactions.length === 0 && (
                        <div className="text-center py-12 text-white/60">
                            <div className="text-6xl mb-4">üìä</div>
                            <p className="text-lg font-bold">Nessuna transazione trovata</p>
                            <p>Prova a modificare i filtri o aggiungi una nuova transazione!</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
    
    // Categories Component
    const Categories = () => (
        <div className="space-y-6">
            <div className="bg-white/10 backdrop-blur-xl rounded-2xl p-8 border border-white/20">
                <div className="flex items-center space-x-4 mb-8">
                    <div className="bg-blue-600 p-3 rounded-xl">
                        <Settings className="text-white" size={24} />
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold text-white">Gestione Categorie</h2>
                        <p className="text-white/70">Personalizza le tue categorie di entrate e uscite</p>
                    </div>
                </div>
                
                {/* Add Category Form */}
                <div className="bg-white/5 rounded-xl p-6 mb-8 border border-white/10">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center">
                        <Plus className="mr-2" size={20} />
                        Aggiungi Nuova Categoria
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <div className="md:col-span-2">
                            <input
                                type="text"
                                value={categoryForm.name}
                                onChange={(e) => setCategoryForm(prev => ({ ...prev, name: e.target.value }))}
                                className="w-full px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                placeholder="Nome categoria"
                                maxLength="20"
                            />
                        </div>
                        <select
                            value={categoryForm.type}
                            onChange={(e) => setCategoryForm(prev => ({ ...prev, type: e.target.value }))}
                            className="px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400"
                        >
                            <option value="income" className="bg-slate-800">Entrata</option>
                            <option value="expense" className="bg-slate-800">Uscita</option>
                        </select>
                        <input
                            type="color"
                            value={categoryForm.color}
                            onChange={(e) => setCategoryForm(prev => ({ ...prev, color: e.target.value }))}
                            className="w-full h-10 bg-white/10 border border-white/30 rounded-lg cursor-pointer"
                            title="Scegli colore"
                        />
                        <input
                            type="text"
                            value={categoryForm.icon}
                            onChange={(e) => setCategoryForm(prev => ({ ...prev, icon: e.target.value }))}
                            className="px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-white/50 text-center focus:outline-none focus:ring-2 focus:ring-blue-400"
                            placeholder="üè∑Ô∏è"
                            maxLength="2"
                        />
                        <button
                            onClick={addCategory}
                            disabled={!categoryForm.name.trim()}
                            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all font-bold"
                        >
                            <Plus size={16} />
                        </button>
                    </div>
                </div>
                
                {/* Categories Lists */}
                <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <div className="bg-emerald-500/10 rounded-xl p-6 border border-emerald-400/20">
                        <h3 className="text-xl font-bold text-emerald-400 mb-4 flex items-center">
                            <TrendingUp className="mr-2" size={24} />
                            Categorie Entrate ({categories.filter(cat => cat.type === 'income').length})
                        </h3>
                        <div className="space-y-3">
                            {categories.filter(cat => cat.type === 'income').map(category => (
                                <div key={category.id} className="flex items-center justify-between bg-white/5 rounded-lg p-3 hover:bg-white/10 transition-all border border-white/10 group">
                                    {editingCategory === category.id ? (
                                        <div className="flex items-center space-x-3 flex-1">
                                            <input
                                                type="text"
                                                defaultValue={category.name}
                                                className="bg-white/20 border border-white/30 rounded px-2 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-400"
                                                onKeyDown={(e) => {
                                                    if (e.key === 'Enter' && e.target.value.trim()) {
                                                        updateCategory(category.id, { name: e.target.value.trim() });
                                                    }
                                                    if (e.key === 'Escape') {
                                                        setEditingCategory(null);
                                                    }
                                                }}
                                                onBlur={(e) => {
                                                    if (e.target.value.trim()) {
                                                        updateCategory(category.id, { name: e.target.value.trim() });
                                                    } else {
                                                        setEditingCategory(null);
                                                    }
                                                }}
                                                autoFocus
                                            />
                                            <button
                                                onClick={() => setEditingCategory(null)}
                                                className="text-white/60 hover:text-white"
                                            >
                                                <X size={14} />
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center space-x-3 flex-1">
                                            <div 
                                                className="p-2 rounded-lg"
                                                style={{ backgroundColor: category.color + '20' }}
                                            >
                                                <span className="text-lg">{category.icon}</span>
                                            </div>
                                            <div>
                                                <span className="text-white font-bold">{category.name}</span>
                                                <div className="flex items-center space-x-2 mt-1">
                                                    <div 
                                                        className="w-2 h-2 rounded-full"
                                                        style={{ backgroundColor: category.color }}
                                                    ></div>
                                                    <span className="text-white/50 text-xs">
                                                        {transactions.filter(t => t.category === category.id).length} transazioni
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    <div className="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button
                                            onClick={() => setEditingCategory(category.id)}
                                            className="text-blue-400 hover:text-blue-300 p-1 rounded hover:bg-blue-500/20 transition-colors"
                                            aria-label="Modifica categoria"
                                        >
                                            <Edit size={14} />
                                        </button>
                                        <button
                                            onClick={() => deleteCategory(category.id)}
                                            className="text-rose-400 hover:text-rose-300 p-1 rounded hover:bg-rose-500/20 transition-colors"
                                            aria-label="Elimina categoria"
                                        >
                                            <Trash2 size={14} />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div className="bg-rose-500/10 rounded-xl p-6 border border-rose-400/20">
                        <h3 className="text-xl font-bold text-rose-400 mb-4 flex items-center">
                            <TrendingDown className="mr-2" size={24} />
                            Categorie Uscite ({categories.filter(cat => cat.type === 'expense').length})
                        </h3>
                        <div className="space-y-3">
                            {categories.filter(cat => cat.type === 'expense').map(category => (
                                <div key={category.id} className="flex items-center justify-between bg-white/5 rounded-lg p-3 hover:bg-white/10 transition-all border border-white/10 group">
                                    {editingCategory === category.id ? (
                                        <div className="flex items-center space-x-3 flex-1">
                                            <input
                                                type="text"
                                                defaultValue={category.name}
                                                className="bg-white/20 border border-white/30 rounded px-2 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-400"
                                                onKeyDown={(e) => {
                                                    if (e.key === 'Enter' && e.target.value.trim()) {
                                                        updateCategory(category.id, { name: e.target.value.trim() });
                                                    }
                                                    if (e.key === 'Escape') {
                                                        setEditingCategory(null);
                                                    }
                                                }}
                                                onBlur={(e) => {
                                                    if (e.target.value.trim()) {
                                                        updateCategory(category.id, { name: e.target.value.trim() });
                                                    } else {
                                                        setEditingCategory(null);
                                                    }
                                                }}
                                                autoFocus
                                            />
                                            <button
                                                onClick={() => setEditingCategory(null)}
                                                className="text-white/60 hover:text-white"
                                            >
                                                <X size={14} />
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center space-x-3 flex-1">
                                            <div 
                                                className="p-2 rounded-lg"
                                                style={{ backgroundColor: category.color + '20' }}
                                            >
                                                <span className="text-lg">{category.icon}</span>
                                            </div>
                                            <div>
                                                <span className="text-white font-bold">{category.name}</span>
                                                <div className="flex items-center space-x-2 mt-1">
                                                    <div 
                                                        className="w-2 h-2 rounded-full"
                                                        style={{ backgroundColor: category.color }}
                                                    ></div>
                                                    <span className="text-white/50 text-xs">
                                                        {transactions.filter(t => t.category === category.id).length} transazioni
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    <div className="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button
                                            onClick={() => setEditingCategory(category.id)}
                                            className="text-blue-400 hover:text-blue-300 p-1 rounded hover:bg-blue-500/20 transition-colors"
                                            aria-label="Modifica categoria"
                                        >
                                            <Edit size={14} />
                                        </button>
                                        <button
                                            onClick={() => deleteCategory(category.id)}
                                            className="text-rose-400 hover:text-rose-300 p-1 rounded hover:bg-rose-500/20 transition-colors"
                                            aria-label="Elimina categoria"
                                        >
                                            <Trash2 size={14} />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
    
    // Budgets Component
    const Budgets = () => (
        <div className="space-y-6">
            <div className="bg-white/10 backdrop-blur-xl rounded-2xl p-8 border border-white/20">
                <div className="flex items-center space-x-4 mb-8">
                    <div className="bg-blue-600 p-3 rounded-xl">
                        <Target className="text-white" size={24} />
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold text-white">Gestione Budget</h2>
                        <p className="text-white/70">Imposta e monitora i tuoi obiettivi di spesa</p>
                    </div>
                </div>
                
                {/* Add Budget Form */}
                <div className="bg-white/5 rounded-xl p-6 mb-8 border border-white/10">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center">
                        <Plus className="mr-2" size={20} />
                        Aggiungi Nuovo Budget
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <select
                            value={budgetForm.category}
                            onChange={(e) => setBudgetForm(prev => ({ ...prev, category: e.target.value }))}
                            className="px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400"
                        >
                            <option value="">Seleziona categoria</option>
                            {categories.filter(cat => cat.type === 'expense').map(category => (
                                <option key={category.id} value={category.id} className="bg-slate-800">
                                    {category.icon} {category.name}
                                </option>
                            ))}
                        </select>
                        
                        <input
                            type="number"
                            value={budgetForm.amount}
                            onChange={(e) => setBudgetForm(prev => ({ ...prev, amount: e.target.value }))}
                            className="px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400"
                            placeholder="Importo budget"
                            step="0.01"
                            min="0.01"
                        />
                        
                        <select
                            value={budgetForm.period}
                            onChange={(e) => setBudgetForm(prev => ({ ...prev, period: e.target.value }))}
                            className="px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400"
                        >
                            <option value="monthly" className="bg-slate-800">Mensile</option>
                            <option value="yearly" className="bg-slate-800">Annuale</option>
                        </select>
                        
                        <button
                            onClick={addBudget}
                            disabled={!budgetForm.category || !budgetForm.amount || parseFloat(budgetForm.amount) <= 0}
                            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all font-bold"
                        >
                            <Plus size={16} />
                        </button>
                    </div>
                </div>
                
                {/* Budget List */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {budgetStatus.map(budget => (
                        <div key={budget.id} className="bg-white/5 rounded-xl p-6 border border-white/10 hover:bg-white/10 transition-all">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center space-x-3">
                                    <div className="p-2 rounded-lg" style={{ backgroundColor: budget.category?.color + '20' }}>
                                        <span className="text-lg">{budget.category?.icon}</span>
                                    </div>
                                    <div>
                                        <h4 className="text-white font-bold">{budget.category?.name}</h4>
                                        <span className={`text-xs px-2 py-1 rounded-full ${
                                            budget.isOverBudget ? 'bg-rose-500/20 text-rose-400' : 'bg-emerald-500/20 text-emerald-400'
                                        }`}>
                                            {budget.period === 'monthly' ? 'Mensile' : 'Annuale'}
                                        </span>
                                    </div>
                                </div>
                                <button
                                    onClick={() => deleteBudget(budget.id)}
                                    className="text-rose-400 hover:text-rose-300 p-1 rounded hover:bg-rose-500/20 transition-colors"
                                    aria-label="Elimina budget"
                                >
                                    <Trash2 size={16} />
                                </button>
                            </div>
                            
                            <div className="space-y-3">
                                <div className="flex justify-between text-sm">
                                    <span className="text-white/70">Speso:</span>
                                    <span className={budget.isOverBudget ? 'text-rose-400 font-bold' : 'text-white'}>
                                        {formatCurrency(budget.spent)}
                                    </span>
                                </div>
                                
                                <div className="w-full bg-white/10 rounded-full h-2 overflow-hidden">
                                    <div 
                                        className={`h-2 rounded-full transition-all duration-500 ${
                                            budget.isOverBudget ? 'bg-rose-400' : 'bg-emerald-400'
                                        }`}
                                        style={{ width: `${Math.min(budget.percentage, 100)}%` }}
                                    ></div>
                                </div>
                                
                                <div className="flex justify-between text-sm">
                                    <span className={budget.isOverBudget ? 'text-rose-400 font-bold' : 'text-emerald-400 font-bold'}>
                                        {budget.percentage.toFixed(1)}%
                                    </span>
                                    <span className="text-white/70">
                                        Budget: {formatCurrency(budget.amount)}
                                    </span>
                                </div>
                                
                                <div className="mt-3 p-3 rounded-lg bg-white/5">
                                    <div className="flex justify-between text-sm">
                                        <span className="text-white/70">Rimanente:</span>
                                        <span className={budget.remaining >= 0 ? 'text-emerald-400 font-bold' : 'text-rose-400 font-bold'}>
                                            {formatCurrency(budget.remaining)}
                                        </span>
                                    </div>
                                </div>
                                
                                {budget.isOverBudget && (
                                    <div className="mt-3 p-3 rounded-lg bg-rose-500/10 border border-rose-500/20">
                                        <div className="flex items-center space-x-2">
                                            <AlertCircle className="text-rose-400" size={14} />
                                            <span className="text-rose-400 text-xs font-medium">
                                                Budget superato di {formatCurrency(Math.abs(budget.remaining))}
                                            </span>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                    
                    {budgetStatus.length === 0 && (
                        <div className="col-span-full text-center py-12 text-white/60">
                            <div className="text-6xl mb-4">üéØ</div>
                            <p className="text-xl font-bold mb-2">Nessun budget impostato</p>
                            <p>Inizia aggiungendo il tuo primo budget!</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
    
    // Analytics Component
    const Analytics = () => (
        <div className="space-y-6">
            <div className="bg-white/10 backdrop-blur-xl rounded-2xl p-8 border border-white/20">
                <div className="flex items-center space-x-4 mb-8">
                    <div className="bg-blue-600 p-3 rounded-xl">
                        <BarChart3 className="text-white" size={24} />
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold text-white">Analisi Dettagliate</h2>
                        <p className="text-white/70">Insights approfonditi sulle tue finanze</p>
                    </div>
                </div>
                
                {/* Key Metrics */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div className="bg-emerald-500/10 rounded-xl p-6 border border-emerald-400/30">
                        <h4 className="text-emerald-400 text-sm font-bold mb-2 uppercase tracking-wide">Media Entrate</h4>
                        <p className="text-emerald-400 text-2xl font-bold">
                            {formatCurrency(totalIncome / Math.max(1, new Set(transactions.map(t => t.date.substring(0, 7))).size))}
                        </p>
                        <p className="text-emerald-300/60 text-xs mt-1">Per mese</p>
                    </div>
                    
                    <div className="bg-rose-500/10 rounded-xl p-6 border border-rose-400/30">
                        <h4 className="text-rose-400 text-sm font-bold mb-2 uppercase tracking-wide">Media Uscite</h4>
                        <p className="text-rose-400 text-2xl font-bold">
                            {formatCurrency(totalExpenses / Math.max(1, new Set(transactions.map(t => t.date.substring(0, 7))).size))}
                        </p>
                        <p className="text-rose-300/60 text-xs mt-1">Per mese</p>
                    </div>
                    
                    <div className="bg-blue-500/10 rounded-xl p-6 border border-blue-400/30">
                        <h4 className="text-blue-400 text-sm font-bold mb-2 uppercase tracking-wide">Tasso Risparmio</h4>
                        <p className="text-blue-400 text-2xl font-bold">
                            {totalIncome > 0 ? Math.round((balance / totalIncome) * 100) : 0}%
                        </p>
                        <p className="text-blue-300/60 text-xs mt-1">Del reddito</p>
                    </div>
                    
                    <div className="bg-purple-500/10 rounded-xl p-6 border border-purple-400/30">
                        <h4 className="text-purple-400 text-sm font-bold mb-2 uppercase tracking-wide">Transazioni</h4>
                        <p className="text-purple-400 text-2xl font-bold">{transactions.length}</p>
                        <p className="text-purple-300/60 text-xs mt-1">Totali</p>
                    </div>
                </div>
                
                {/* Comparison Chart */}
                <div className="bg-white/5 rounded-xl p-6 mb-8 border border-white/10">
                    <h3 className="text-xl font-bold text-white mb-6 flex items-center">
                        <BarChart3 className="mr-2" size={24} />
                        Confronto Entrate vs Uscite
                    </h3>
                    <ResponsiveContainer width="100%" height={400}>
                        <BarChart data={chartData}>
                            <defs>
                                <linearGradient id="incomeBarGradient" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#10B981" stopOpacity={0.9}/>
                                    <stop offset="95%" stopColor="#10B981" stopOpacity={0.6}/>
                                </linearGradient>
                                <linearGradient id="expenseBarGradient" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#EF4444" stopOpacity={0.9}/>
                                    <stop offset="95%" stopColor="#EF4444" stopOpacity={0.6}/>
                                </linearGradient>
                            </defs>
                            <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
                            <XAxis dataKey="month" stroke="rgba(255,255,255,0.8)" fontSize={12} />
                            <YAxis stroke="rgba(255,255,255,0.8)" fontSize={12} />
                            <Tooltip 
                                contentStyle={{ 
                                    backgroundColor: 'rgba(15, 23, 42, 0.95)', 
                                    border: '1px solid rgba(255,255,255,0.2)',
                                    borderRadius: '12px',
                                    color: 'white'
                                }}
                                formatter={(value) => formatCurrency(value)}
                            />
                            <Legend />
                            <Bar dataKey="income" fill="url(#incomeBarGradient)" name="Entrate" radius={[4, 4, 0, 0]} />
                            <Bar dataKey="expenses" fill="url(#expenseBarGradient)" name="Uscite" radius={[4, 4, 0, 0]} />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
                
                {/* Top Categories */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-rose-500/10 rounded-xl p-6 border border-rose-400/20">
                        <h3 className="text-xl font-bold text-rose-400 mb-6 flex items-center">
                            <TrendingDown className="mr-2" size={24} />
                            Top Categorie Uscite
                        </h3>
                        <div className="space-y-3">
                            {categoryData
                                .filter(cat => transactions.some(t => {
                                    const category = categories.find(c => c.id === t.category);
                                    return category && category.name === cat.name && category.type === 'expense';
                                }))
                                .sort((a, b) => b.value - a.value)
                                .slice(0, 5)
                                .map((cat, index) => {
                                    const percentage = totalExpenses > 0 ? (cat.value / totalExpenses) * 100 : 0;
                                    return (
                                        <div key={index} className="flex items-center justify-between bg-white/5 rounded-lg p-3">
                                            <div className="flex items-center space-x-3">
                                                <span className="text-white/50 font-bold text-sm">#{index + 1}</span>
                                                <div 
                                                    className="w-4 h-4 rounded-full"
                                                    style={{ backgroundColor: cat.color }}
                                                ></div>
                                                <div>
                                                    <span className="text-white font-bold">{cat.name}</span>
                                                    <p className="text-white/60 text-sm">{percentage.toFixed(1)}% del totale</p>
                                                </div>
                                            </div>
                                            <span className="text-rose-400 font-bold">{formatCurrency(cat.value)}</span>
                                        </div>
                                    );
                                })}
                        </div>
                    </div>
                    
                    <div className="bg-emerald-500/10 rounded-xl p-6 border border-emerald-400/20">
                        <h3 className="text-xl font-bold text-emerald-400 mb-6 flex items-center">
                            <TrendingUp className="mr-2" size={24} />
                            Top Categorie Entrate
                        </h3>
                        <div className="space-y-3">
                            {categoryData
                                .filter(cat => transactions.some(t => {
                                    const category = categories.find(c => c.id === t.category);
                                    return category && category.name === cat.name && category.type === 'income';
                                }))
                                .sort((a, b) => b.value - a.value)
                                .slice(0, 5)
                                .map((cat, index) => {
                                    const percentage = totalIncome > 0 ? (cat.value / totalIncome) * 100 : 0;
                                    return (
                                        <div key={index} className="flex items-center justify-between bg-white/5 rounded-lg p-3">
                                            <div className="flex items-center space-x-3">
                                                <span className="text-white/50 font-bold text-sm">#{index + 1}</span>
                                                <div 
                                                    className="w-4 h-4 rounded-full"
                                                    style={{ backgroundColor: cat.color }}
                                                ></div>
                                                <div>
                                                    <span className="text-white font-bold">{cat.name}</span>
                                                    <p className="text-white/60 text-sm">{percentage.toFixed(1)}% del totale</p>
                                                </div>
                                            </div>
                                            <span className="text-emerald-400 font-bold">{formatCurrency(cat.value)}</span>
                                        </div>
                                    );
                                })}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
    
    // Main render
    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 relative overflow-hidden">
            {/* Background elements */}
            <div className="absolute inset-0 bg-gradient-to-br from-blue-600/10 via-purple-600/5 to-indigo-800/10"></div>
            
            <NotificationList notifications={notifications} removeNotification={removeNotification} />
            
            <div className="relative z-10 container mx-auto px-4 py-6">
                {/* Header */}
                <div className="flex flex-col lg:flex-row lg:items-center justify-between mb-8 space-y-4 lg:space-y-0">
                    <div className="flex items-center space-x-4">
                        <div className="bg-blue-600 p-3 rounded-2xl shadow-lg">
                            <Wallet className="text-white" size={32} />
                        </div>
                        <div>
                            <h1 className="text-4xl font-black text-white mb-1">
                                FinanceTracker Pro
                            </h1>
                            <p className="text-white/70 text-lg">La tua app intelligente per gestire le finanze personali</p>
                        </div>
                    </div>
                    <div className="bg-white/10 backdrop-blur-xl rounded-xl p-4 border border-white/20">
                        <p className="text-white/70 text-sm font-bold">Ultimo aggiornamento</p>
                        <p className="text-white font-bold">{new Date().toLocaleDateString('it-IT', {
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric'
                        })}</p>
                    </div>
                </div>
                
                {/* Navigation */}
                <div className="mb-8">
                    {/* Desktop Navigation */}
                    <div className="hidden lg:flex gap-2 bg-white/10 backdrop-blur-xl rounded-2xl p-2 border border-white/20">
                        {tabs.map(tab => {
                            const Icon = tab.icon;
                            return (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex items-center space-x-2 px-4 py-3 rounded-xl font-bold transition-all ${
                                        activeTab === tab.id
                                            ? 'bg-blue-600 text-white shadow-lg'
                                            : 'text-white/70 hover:text-white hover:bg-white/10'
                                    }`}
                                >
                                    <Icon size={20} />
                                    <span>{tab.label}</span>
                                </button>
                            );
                        })}
                    </div>
                    
                    {/* Mobile Navigation */}
                    <div className="lg:hidden">
                        <button
                            onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
                            className="w-full flex items-center justify-between bg-white/10 backdrop-blur-xl rounded-xl p-4 border border-white/20 text-white"
                        >
                            <div className="flex items-center space-x-3">
                                {React.createElement(tabs.find(tab => tab.id === activeTab)?.icon || BarChart3, { size: 20 })}
                                <span className="font-bold">{tabs.find(tab => tab.id === activeTab)?.label || 'Dashboard'}</span>
                            </div>
                            <Menu size={20} />
                        </button>
                        
                        {isMobileMenuOpen && (
                            <div className="mt-2 bg-white/10 backdrop-blur-xl rounded-xl border border-white/20 overflow-hidden">
                                {tabs.map(tab => {
                                    const Icon = tab.icon;
                                    return (
                                        <button
                                            key={tab.id}
                                            onClick={() => {
                                                setActiveTab(tab.id);
                                                setIsMobileMenuOpen(false);
                                            }}
                                            className={`w-full flex items-center space-x-3 px-4 py-3 text-left font-bold transition-all ${
                                                activeTab === tab.id
                                                    ? 'bg-blue-600 text-white'
                                                    : 'text-white/70 hover:text-white hover:bg-white/10'
                                            }`}
                                        >
                                            <Icon size={20} />
                                            <span>{tab.label}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
                
                {/* Main Content */}
                <div className="space-y-6">
                    {activeTab === 'dashboard' && <Dashboard />}
                    {activeTab === 'add' && <AddTransaction />}
                    {activeTab === 'transactions' && <TransactionsList />}
                    {activeTab === 'categories' && <Categories />}
                    {activeTab === 'budgets' && <Budgets />}
                    {activeTab === 'analytics' && <Analytics />}
                </div>
            </div>
            
            <style jsx>{`
                @keyframes slideInRight {
                    from {
                        opacity: 0;
                        transform: translateX(100%);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
            `}</style>
        </div>
    );
};

export default FinanceTracker;
